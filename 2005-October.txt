From afayolle at berlios.de  Mon Oct  3 10:13:04 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Mon, 3 Oct 2005 10:13:04 +0200
Subject: [Maay-svncheckins] r106 - trunk
Message-ID: <200510030813.j938D4ZH009671@sheep.berlios.de>

Author: afayolle
Date: 2005-10-03 10:13:03 +0200 (Mon, 03 Oct 2005)
New Revision: 106

Added:
   trunk/README.txt
Modified:
   trunk/MANIFEST.in
   trunk/setup.py
Log:
Fixed a couple of errors in setup.py and MANIFEST.in.
Added a README document


Modified: trunk/MANIFEST.in
===================================================================
--- trunk/MANIFEST.in	2005-09-30 15:51:52 UTC (rev 105)
+++ trunk/MANIFEST.in	2005-10-03 08:13:03 UTC (rev 106)
@@ -1,3 +1,3 @@
-recursive-include maay/test/*
-recursive-include maay/data/*
-recursive-include maay/sql/*.sql
+recursive-include maay/test/ *.py *.txt *.txt.bz2 *.txt.gz *.xml *.html *.ini
+recursive-include maay/data/ *.html *.css *.gif *.png *.jpg *.ico
+recursive-include maay/sql *.sql

Added: trunk/README.txt
===================================================================
--- trunk/README.txt	2005-09-30 15:51:52 UTC (rev 105)
+++ trunk/README.txt	2005-10-03 08:13:03 UTC (rev 106)
@@ -0,0 +1,103 @@
+What is Maay?
+=============
+
+Maay is a P2P indexation and search engine. You can use it to index
+files on your computer, and export them to other members of the Maay
+P2P network. You can also issue searches which will look for documents
+on your computer as well as on other nodes of the P2P network.
+
+What is in the current implementation?
+======================================
+
+The current Maay implementation features:
+
+ * an indexer, which can handle the following document formats: raw
+   text, HTML, Microsoft Word, Rich Text Format, Portable Document
+   Format. 
+
+ * a web interface which can be used to issue queries (currently
+   queries are ontly dispatched on the current node, i.e. the P2P
+   functionnality is not available for now, though we are working on
+   it. 
+
+How do I install Maay from source?
+==================================
+
+These instruction are intended for people using a unix-like
+OS. Windows users are strongly advised to use the prebuilt package
+(see below).
+
+A few Python libraries are required to make the whole think work. Most
+of them should be available in your OS distribution too :
+
+ * logilab common libraries (http://www.logilab.org/projects/common)
+ * mysql-python (http://sourceforge.net/projects/mysql-python)
+ * python-twisted (http://twistedmatrix.com/)
+ * python-twisted-web (http://twistedmatrix.com/)
+ * python-nevow (http://nevow.com/)
+
+You will also need a few helper applications to perform the conversion
+of various binary formats to something that Maay can index. There is
+probably a prebuilt binary available for your OS distribution
+somewhere. You will need to download and install :
+
+ * pdftohtml (http://pdftohtml.sourceforge.net/)
+ * antiword (http://www.winfield.demon.nl/)
+ * unrtf (http://www.gnu.org/software/unrtf/unrtf.html)
+
+The indexation part uses a MySQL database, so 
+
+Once everything else is installed, you can point you web browser to
+http://developer.berlios.de/projects/maay/ and download the latest
+source tarball. Unpack it, go to the newly created directory and run::
+
+ # python setup.py install
+
+It is now necessary to create the MySQL database instance that will
+store the indexation data::
+
+ # mysql -u root mysql
+ mysql> \. sql/mysql.sql
+
+You're done !
+
+How do I install Maay from a package?
+=====================================
+
+For now, only a Windows installer is available. Download it from
+http://developer.berlios.de/projects/maay/ and run it. This should
+install and setup everything properly. 
+
+A package for the Debian GNU/Linux distribution will soon be made
+available. 
+
+How do I start using Maay?
+==========================
+
+First, start the Maay service. On Windows, use the start menu to
+launch "Maay Server". On unix systems, use /usr/bin/maay-server
+
+You can now visit http://localhost:8080/ which will display the Maay
+search page. Issuing a search will probably not yield any result since
+you have not indexed any files yet.
+
+Launch the indexer. On Windows, this is done through the start menu
+again by choosing "Maay Indexer". On Unix systems, use
+/usr/bin/maay-indexer. The indexer will look for files on your hard
+disks and index them by sending indexation requests to the
+server. Once the indexation is done, queries issued through the web
+interface should give results. 
+
+Where can I get help?
+=====================
+
+For now the best place to ask for help is on the development mailing
+list of Maay. You can subscribe from
+
+https://lists.berlios.de/mailman/listinfo/maay-svncheckins
+
+You may also use the bug tracker on the Berlios project page at 
+http://developer.berlios.de/projects/maay/
+
+
+ Alexandre Fayolle <alexandre.fayolle>, Mon,  3 Oct 2005 10:09:28 +0200


Property changes on: trunk/README.txt
___________________________________________________________________
Name: svn:keywords
   + "Id"
Name: svn:eol-style
   + native

Modified: trunk/setup.py
===================================================================
--- trunk/setup.py	2005-09-30 15:51:52 UTC (rev 105)
+++ trunk/setup.py	2005-10-03 08:13:03 UTC (rev 106)
@@ -6,6 +6,7 @@
 
 version = '0.1.0'
 author = "France Telecom R&D and Logilab"
+author_email = "maay-svncheckins at lists.berlios.de"
 copyright = "Copyright (c)2005 France Telecom R&D and Logilab"
 description = "a network of peers for document search"
 name = "Maay"
@@ -44,6 +45,7 @@
 		version = version,
 		description = description,
 		author = author,
+                author_email = author_email,
 		copyright = copyright,
 		url = url
                 )
@@ -53,9 +55,10 @@
 		name = name,
 		version = version,
 		author = author,
+                author_email = author_email,
 		copyright = copyright,
 		description = description,
 		url = url,
 		data_files = data_files,
 		packages = packages
-                )
\ No newline at end of file
+                )



From afayolle at berlios.de  Mon Oct  3 10:19:18 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Mon, 3 Oct 2005 10:19:18 +0200
Subject: [Maay-svncheckins] r107 - in trunk/maay: . bin
Message-ID: <200510030819.j938JIG0009996@sheep.berlios.de>

Author: afayolle
Date: 2005-10-03 10:19:18 +0200 (Mon, 03 Oct 2005)
New Revision: 107

Added:
   trunk/maay/bin/
   trunk/maay/bin/maay-indexer
   trunk/maay/bin/maay-server
Log:
added helper scripts to start server and indexer


Added: trunk/maay/bin/maay-indexer
===================================================================
--- trunk/maay/bin/maay-indexer	2005-10-03 08:13:03 UTC (rev 106)
+++ trunk/maay/bin/maay-indexer	2005-10-03 08:19:18 UTC (rev 107)
@@ -0,0 +1,5 @@
+#!/usr/bin/python
+__revision__ = '$Id$'
+from maay.indexer import run
+run()
+


Property changes on: trunk/maay/bin/maay-indexer
___________________________________________________________________
Name: svn:executable
   + *

Added: trunk/maay/bin/maay-server
===================================================================
--- trunk/maay/bin/maay-server	2005-10-03 08:13:03 UTC (rev 106)
+++ trunk/maay/bin/maay-server	2005-10-03 08:19:18 UTC (rev 107)
@@ -0,0 +1,4 @@
+#!/usr/bin/python
+__revision__ = '$Id$'
+from maay.main import run
+run()


Property changes on: trunk/maay/bin/maay-server
___________________________________________________________________
Name: svn:executable
   + *



From afayolle at berlios.de  Mon Oct  3 10:22:19 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Mon, 3 Oct 2005 10:22:19 +0200
Subject: [Maay-svncheckins] r108 - trunk
Message-ID: <200510030822.j938MJes010257@sheep.berlios.de>

Author: afayolle
Date: 2005-10-03 10:22:19 +0200 (Mon, 03 Oct 2005)
New Revision: 108

Modified:
   trunk/setup.py
Log:
installed scripts

Modified: trunk/setup.py
===================================================================
--- trunk/setup.py	2005-10-03 08:19:18 UTC (rev 107)
+++ trunk/setup.py	2005-10-03 08:22:19 UTC (rev 108)
@@ -14,6 +14,7 @@
 packages = ['maay']
 data_files = [('maay/data', glob('maay/data/*')+glob('maay/data/images/*')),
                   ('maay/sql', glob('maay/sql/*.sql')),]
+scripts = ['maay/bin/maay-server', 'maay/bin/maay-indexer']
 
 
 class Target:
@@ -61,4 +62,5 @@
 		url = url,
 		data_files = data_files,
 		packages = packages
+                scripts = scripts
                 )



From afayolle at berlios.de  Mon Oct  3 13:42:25 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Mon, 3 Oct 2005 13:42:25 +0200
Subject: [Maay-svncheckins] r109 - trunk
Message-ID: <200510031142.j93BgP7u001219@sheep.berlios.de>

Author: afayolle
Date: 2005-10-03 13:42:23 +0200 (Mon, 03 Oct 2005)
New Revision: 109

Modified:
   trunk/MANIFEST.in
   trunk/setup.py
Log:
fixed typo in setup.py
added scripts in MANIFEST.in


Modified: trunk/MANIFEST.in
===================================================================
--- trunk/MANIFEST.in	2005-10-03 08:22:19 UTC (rev 108)
+++ trunk/MANIFEST.in	2005-10-03 11:42:23 UTC (rev 109)
@@ -1,3 +1,5 @@
 recursive-include maay/test/ *.py *.txt *.txt.bz2 *.txt.gz *.xml *.html *.ini
 recursive-include maay/data/ *.html *.css *.gif *.png *.jpg *.ico
 recursive-include maay/sql *.sql
+include maay/bin/maay-server
+include maay/bin/maay-indexer

Modified: trunk/setup.py
===================================================================
--- trunk/setup.py	2005-10-03 08:22:19 UTC (rev 108)
+++ trunk/setup.py	2005-10-03 11:42:23 UTC (rev 109)
@@ -61,6 +61,6 @@
 		description = description,
 		url = url,
 		data_files = data_files,
-		packages = packages
+		packages = packages,
                 scripts = scripts
                 )



From afayolle at berlios.de  Mon Oct  3 14:17:02 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Mon, 3 Oct 2005 14:17:02 +0200
Subject: [Maay-svncheckins] r110 - trunk
Message-ID: <200510031217.j93CH27Y014593@sheep.berlios.de>

Author: afayolle
Date: 2005-10-03 14:17:01 +0200 (Mon, 03 Oct 2005)
New Revision: 110

Added:
   trunk/ChangeLog
   trunk/ReleaseNotes
Modified:
   trunk/MANIFEST.in
Log:
added changelog release notes and updated MANIFEST.in


Added: trunk/ChangeLog
===================================================================
--- trunk/ChangeLog	2005-10-03 11:42:23 UTC (rev 109)
+++ trunk/ChangeLog	2005-10-03 12:17:01 UTC (rev 110)
@@ -0,0 +1,6 @@
+Maay-0.1.0 2005-10-03
+	* First release of the new code base
+
+	
+
+	

Modified: trunk/MANIFEST.in
===================================================================
--- trunk/MANIFEST.in	2005-10-03 11:42:23 UTC (rev 109)
+++ trunk/MANIFEST.in	2005-10-03 12:17:01 UTC (rev 110)
@@ -3,3 +3,5 @@
 recursive-include maay/sql *.sql
 include maay/bin/maay-server
 include maay/bin/maay-indexer
+include ReleaseNotes
+include ChangeLog

Added: trunk/ReleaseNotes
===================================================================
--- trunk/ReleaseNotes	2005-10-03 11:42:23 UTC (rev 109)
+++ trunk/ReleaseNotes	2005-10-03 12:17:01 UTC (rev 110)
@@ -0,0 +1,11 @@
+See README.txt for installation and quick start instructions. 
+
+This release is alpha-level software. We support local indexation and
+search, and no P2P features are yet available.
+
+The windows installer will install and set up all the required
+dependencies (including mysql and twisted). It uses Inno Setup and
+Py2exe.
+
+
+



From afayolle at berlios.de  Mon Oct  3 15:15:07 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Mon, 3 Oct 2005 15:15:07 +0200
Subject: [Maay-svncheckins] r111 - /
Message-ID: <200510031315.j93DF7AL019390@sheep.berlios.de>

Author: afayolle
Date: 2005-10-03 15:15:07 +0200 (Mon, 03 Oct 2005)
New Revision: 111

Added:
   tags/
Log:
directory for tags



From afayolle at berlios.de  Mon Oct  3 15:16:52 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Mon, 3 Oct 2005 15:16:52 +0200
Subject: [Maay-svncheckins] r112 - tags
Message-ID: <200510031316.j93DGqjI019574@sheep.berlios.de>

Author: afayolle
Date: 2005-10-03 15:16:52 +0200 (Mon, 03 Oct 2005)
New Revision: 112

Added:
   tags/release-0.1.0/
Log:
tagged release 0.1.0

Copied: tags/release-0.1.0 (from rev 111, trunk)



From afayolle at berlios.de  Tue Oct  4 11:35:44 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Tue, 4 Oct 2005 11:35:44 +0200
Subject: [Maay-svncheckins] r113 - in trunk: . maay maay/bin
Message-ID: <200510040935.j949ZipK027482@sheep.berlios.de>

Author: afayolle
Date: 2005-10-04 11:35:43 +0200 (Tue, 04 Oct 2005)
New Revision: 113

Added:
   trunk/maay/server.py
Removed:
   trunk/maay/main.py
Modified:
   trunk/maay/bin/maay-server
   trunk/setup.py
Log:
renamed maay/main.py to maay/server.py


Modified: trunk/maay/bin/maay-server
===================================================================
--- trunk/maay/bin/maay-server	2005-10-03 13:16:52 UTC (rev 112)
+++ trunk/maay/bin/maay-server	2005-10-04 09:35:43 UTC (rev 113)
@@ -1,4 +1,4 @@
 #!/usr/bin/python
 __revision__ = '$Id$'
-from maay.main import run
+from maay.server import run
 run()

Deleted: trunk/maay/main.py
===================================================================
--- trunk/maay/main.py	2005-10-03 13:16:52 UTC (rev 112)
+++ trunk/maay/main.py	2005-10-04 09:35:43 UTC (rev 113)
@@ -1,238 +0,0 @@
-"""maay local web UI script"""
-
-__revision__ = '$Id$'
-
-import warnings
-warnings.filterwarnings("ignore", ".*", DeprecationWarning, "nevow.static")
-warnings.filterwarnings("ignore", ".*", DeprecationWarning, "twisted.python.reflect")
-
-from zope.interface import implements
-
-from twisted.cred import portal, checkers, error
-from twisted.cred.checkers import ANONYMOUS, AllowAnonymousAccess, \
-     ICredentialsChecker
-from twisted.cred.credentials import IAnonymous, IUsernamePassword
-from twisted.internet import reactor, defer
-from twisted.web import server
-from twisted.web import static
-from twisted.python import failure
-
-from nevow import inevow, rend, tags, guard, loaders, appserver
-# this is to help py2exe
-import nevow.flat.flatstan
-import nevow.query
-import twisted.web.woven.guard
-import MySQLdb
-
-from logilab.common.textutils import normalize_text
-
-from maay.querier import MaayQuerier, IQuerier, MaayAuthenticationError
-from maay.rpc import MaayRPCServer
-from maay.configuration import get_path_of, Configuration
-
-class MaayPage(rend.Page):
-    child_maaycss = static.File(get_path_of('maay.css'))
-    child_images = static.File(get_path_of('images/'))
-
-
-
-class LoginForm(MaayPage):
-    """a basic login form. This page is rendered until the user
-    is logged.
-    """
-    addSlash = True
-    docFactory = loaders.stan(
-        tags.html[
-            tags.head[tags.title["Maay Login Page"]],
-            tags.body[
-                tags.form(action=guard.LOGIN_AVATAR, method='post')[
-                    tags.table(_class="loginTable")[
-                        tags.tr[
-                            tags.td[ "Username:" ],
-                            tags.td[ tags.input(type='text', name='username') ],
-                            ],
-                        tags.tr[
-                            tags.td[ "Password:" ],
-                            tags.td[ tags.input(type='password', name='password') ],
-                            ]
-                        ],
-                    tags.input(type='submit'),
-                    tags.p,
-                    ]
-                ]
-            ]
-        )
-    
-
-class SearchForm(MaayPage):
-    """default search form"""
-    docFactory = loaders.xmlfile(get_path_of('searchform.html'))
-    addSlash = True
-
-    def __init__(self, maayId, querier):
-        MaayPage.__init__(self)
-        self.maayId = maayId
-        self.querier = querier
-
-    def logout(self):
-        print "Bye"
-        # XXX: logout message should be forwarded to registration server
-        return None
-
-    def child_search(self, context):
-        query = unicode(context.arg('words'))
-        results = self.querier.findDocuments(query)
-        return ResultsPage(results, query)
-
-    # XXX make sure that the requested document is really in the database
-    # XXX don't forget to update the download statistics of the document
-    def child_download(self, context):
-        docid = context.arg('docid')
-        query = unicode(context.arg('words'))
-        docurl = self.querier.notifyDownload(docid, query)
-        if docurl:
-            return  static.File(docurl)
-        else:
-            return NotFoundPage()
-
-class ResultsPage(MaayPage):
-    """default results page"""
-    docFactory = loaders.xmlfile(get_path_of('resultpage.html'))
-    addSlash = False
-    
-    def __init__(self, results, query):
-        MaayPage.__init__(self)
-        self.results = results
-        self.query = unicode(query)
-
-    def data_results(self, context, data):
-        return self.results
-
-    def render_title(self, context, data):
-        context.fillSlots('words', self.query)
-        return context.tag
-    
-    def render_row(self, context, data):
-        document = data
-        context.fillSlots('doctitle',  document.title)
-        # XXX abstract attribute should be a unicode string
-        try:
-            abstract = normalize_text(unicode(document.abstract))
-        except Exception, exc:
-            print exc
-            abstract = u'No abstract available for this document [%s]' % exc
-        context.fillSlots('abstract', abstract)
-        context.fillSlots('docid', document.db_document_id)
-        context.fillSlots('docurl', document.url)
-        context.fillSlots('words', self.query)
-        context.fillSlots('readable_size', document.readable_size())
-        return context.tag
-
-
-## nevow app/server setup ############################################
-class MaayRealm:
-    """simple realm for Maay application"""
-    implements(portal.IRealm)
-
-    def __init__(self):
-        self._sessions = {}
-
-    def createUserSession(self, avatarId, querier):
-        self._sessions[avatarId] = querier
-
-
-    def requestAvatar(self, avatarId, mind, *interfaces):
-        for iface in interfaces:
-            if iface is inevow.IResource:
-                if avatarId is ANONYMOUS:
-                    resc = LoginForm()
-                    return inevow.IResource, resc, lambda: None
-                else:
-                    querier = self._getQuerier(avatarId)
-                    if querier is None:
-                        return inevow.IResource, LoginForm(), lambda: None
-                    else:
-                        resc = SearchForm(avatarId, querier)
-                        return inevow.IResource, resc, resc.logout
-            elif iface is IQuerier:
-                querier = self._getQuerier(avatarId)
-                if querier is None:
-                    return IQuerier, None, lambda: None
-                else:
-                    return IQuerier, querier, querier.close
-
-    def _getQuerier(self, avatarId):
-        try:
-            querier = self._sessions[avatarId]
-            print "Hit cache !"
-        except KeyError:
-            print "Ouch ! What am I supposed to do ?!!"
-            querier = None
-        return querier
-
-class MaayPortal(portal.Portal):
-    """Portal for Maay authentication system"""
-    def __init__(self, webappConfig):
-        realm = MaayRealm()
-        checker = DBAuthChecker(realm, webappConfig.db_host,
-                                webappConfig.db_name)
-        portal.Portal.__init__(self, realm, (checker,))
-        self.registerChecker(AllowAnonymousAccess(), IAnonymous)
-    
-
-class DBAuthChecker:
-    """user authentication checker
-    cf. twisted's CRED system for more details
-    """
-    implements(ICredentialsChecker)
-    credentialInterfaces = (IUsernamePassword,)
-    
-    def __init__(self, realm, dbhost, dbname):
-        self.realm = realm
-        self.dbhost = dbhost
-        self.dbname = dbname
-    
-    def requestAvatarId(self, creds):
-        try:
-            querier = MaayQuerier(host=self.dbhost, database=self.dbname,
-                                  user=creds.username, password=creds.password)
-        except MaayAuthenticationError:
-            print "Got Authentication Error !"
-            return failure.Failure(error.UnauthorizedLogin())
-        self.realm.createUserSession(creds.username, querier)
-        return defer.succeed(creds.username)
-
-
-class NotFoundPage(rend.FourOhFour):
-    pass
-
-class WebappConfiguration(Configuration):
-    options = [
-        ('db-name',
-         {'type' : "string", 'metavar' : "<dbname>", 'short' : "d",
-          'help' : "name of the Maay database",
-          'default' : "maay",
-          }),
-        ('db-host',
-         {'type' : "string", 'metavar' : "<dbhost>", 'short' : "H",
-          'help' : "which server hosts the database",
-          'default' : "localhost",
-          }),
-        ]
-
-    config_file = 'webapp.ini'
-
-    
-def run():
-    webappConfig = WebappConfiguration()
-    webappConfig.load()
-    maayPortal = MaayPortal(webappConfig)
-    website = appserver.NevowSite(guard.SessionWrapper(maayPortal))
-    rpcserver = server.Site(MaayRPCServer(maayPortal))
-    reactor.listenTCP(8080, website)
-    reactor.listenTCP(6789, rpcserver)
-    print "Go !"
-    reactor.run()
-
-if __name__ == '__main__':
-    run()

Copied: trunk/maay/server.py (from rev 105, trunk/maay/main.py)

Modified: trunk/setup.py
===================================================================
--- trunk/setup.py	2005-10-03 13:16:52 UTC (rev 112)
+++ trunk/setup.py	2005-10-04 09:35:43 UTC (rev 113)
@@ -23,7 +23,7 @@
         
 maay_server = Target(description = "The maay server application",
 			    icon_resources=[(1,  "maay/data/images/maay.ico"),],
-			    script = 'maay/main.py',
+			    script = 'maay/server.py',
                             includes = ["MySQLdb"],
 			    dest_base = "maay_server")
 maay_indexer = Target(description = "The maay indexer application (CLI)",



From adimasci at berlios.de  Tue Oct  4 12:06:22 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Tue, 4 Oct 2005 12:06:22 +0200
Subject: [Maay-svncheckins] r114 - trunk/maay/test
Message-ID: <200510041006.j94A6MFe030421@sheep.berlios.de>

Author: adimasci
Date: 2005-10-04 12:06:22 +0200 (Tue, 04 Oct 2005)
New Revision: 114

Modified:
   trunk/maay/test/test_configuration.py
   trunk/maay/test/test_rpc.py
Log:
maay.main is now maay.server

Modified: trunk/maay/test/test_configuration.py
===================================================================
--- trunk/maay/test/test_configuration.py	2005-10-04 09:35:43 UTC (rev 113)
+++ trunk/maay/test/test_configuration.py	2005-10-04 10:06:22 UTC (rev 114)
@@ -4,7 +4,7 @@
 import sys
 import os.path as osp
 
-from maay.main import WebappConfiguration
+from maay.server import WebappConfiguration
 
 class WebappConfigTC(unittest.TestCase):
 

Modified: trunk/maay/test/test_rpc.py
===================================================================
--- trunk/maay/test/test_rpc.py	2005-10-04 09:35:43 UTC (rev 113)
+++ trunk/maay/test/test_rpc.py	2005-10-04 10:06:22 UTC (rev 114)
@@ -17,7 +17,7 @@
 
 from maay import rpc
 from maay.querier import MaayQuerier
-from maay.main import MaayPortal, WebappConfiguration
+from maay.server import MaayPortal, WebappConfiguration
 
 class FakeConnection:
     def cursor(self):



From afayolle at berlios.de  Tue Oct  4 13:35:16 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Tue, 4 Oct 2005 13:35:16 +0200
Subject: [Maay-svncheckins] r116 - trunk/maay
Message-ID: <200510041135.j94BZGPA009497@sheep.berlios.de>

Author: afayolle
Date: 2005-10-04 13:35:06 +0200 (Tue, 04 Oct 2005)
New Revision: 116

Modified:
   trunk/maay/createdb.py
Log:
fixed path

Modified: trunk/maay/createdb.py
===================================================================
--- trunk/maay/createdb.py	2005-10-04 10:33:33 UTC (rev 115)
+++ trunk/maay/createdb.py	2005-10-04 11:35:06 UTC (rev 116)
@@ -1,16 +1,16 @@
-""" helper to create the maay mysql instance on windows platform"""
-import os
-
-def do_create():
-	pipe = os.popen('mysql/bin/mysql.exe -u root mysql', 'w')
-	print pipe
-	data = file('mysql.sql','rb').read()
-	print data
-	pipe.write(data)
-	pipe.close()
-	print 'done'
-	
-if __name__ == '__main__':
-	do_create()
-	
+""" helper to create the maay mysql instance on windows platform"""
+import os
+
+def do_create():
+	pipe = os.popen(r'mysql\bin\mysql.exe -u root mysql', 'w')
+	print pipe
+	data = file('mysql.sql','rb').read()
+	print data
+	pipe.write(data)
+	pipe.close()
+	print 'done'
 	
+if __name__ == '__main__':
+	do_create()
+	
+	



From afayolle at berlios.de  Tue Oct  4 13:37:31 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Tue, 4 Oct 2005 13:37:31 +0200
Subject: [Maay-svncheckins] r117 - trunk/maay
Message-ID: <200510041137.j94BbVi4010453@sheep.berlios.de>

Author: afayolle
Date: 2005-10-04 13:37:27 +0200 (Tue, 04 Oct 2005)
New Revision: 117

Modified:
   trunk/maay/configuration.py
Log:
fixed non reachable code

Modified: trunk/maay/configuration.py
===================================================================
--- trunk/maay/configuration.py	2005-10-04 11:35:06 UTC (rev 116)
+++ trunk/maay/configuration.py	2005-10-04 11:37:27 UTC (rev 117)
@@ -16,8 +16,8 @@
     __maay_dir = os.path.abspath(os.path.dirname(maay.__file__))
     if sys.platform == "win32":
         __maay_dir = os.path.normpath(os.path.join(__maay_dir, '..','..'))
-        return  os.path.join(__maay_dir,'data') 
         os.environ[PATH] = os.environ[PATH] + u';"%(dir)s\antiword";"%(dir)s\pdftohtml";"%(dir)s\mysql\bin"' % {"dir" : __maay_dir}
+        return  os.path.join(__maay_dir,'data')
     else:
         if __maay_dir.startswith('/home') or __maay_dir.startswith('/Users'):
             # we are in a development directory
@@ -37,6 +37,13 @@
     assert os.path.exists(path), "cannot find %s"%path
     return path
 
+def get_config_dirs():
+    if sys.platform == "win32":
+        return [os.path.normpath(os.path.join(__get_data_dir(), '..'))]
+    else:
+        return ['/etc/maay', os.path.expanduser('~/.maay'), '.']                            
+    
+
 class Configuration(BaseConfiguration):
     options = []
     config_file = None
@@ -46,9 +53,11 @@
                                    config_file=self.config_file)
 
     def load(self):
-        # first, load config from file
-        if self.config_file and os.path.exists(self.config_file):
-            self.load_file_configuration(self.config_file)
+        if self.config_file:
+            for directory in get_config_dirs():
+                path = os.path.join(directory, self.config_file)
+                if os.path.exists(path):
+                    self.load_file_configuration(path)
         # then override with command-line options
         self.load_command_line_configuration()
     



From adimasci at berlios.de  Tue Oct  4 13:37:35 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Tue, 4 Oct 2005 13:37:35 +0200
Subject: [Maay-svncheckins] r118 - in trunk/maay: . test
Message-ID: <200510041137.j94BbZKc010464@sheep.berlios.de>

Author: adimasci
Date: 2005-10-04 13:37:28 +0200 (Tue, 04 Oct 2005)
New Revision: 118

Modified:
   trunk/maay/test/test_dbentity.py
   trunk/maay/test/test_fileiteration.py
   trunk/maay/texttool.py
Log:
small test-related fixes


Modified: trunk/maay/test/test_dbentity.py
===================================================================
--- trunk/maay/test/test_dbentity.py	2005-10-04 11:37:27 UTC (rev 117)
+++ trunk/maay/test/test_dbentity.py	2005-10-04 11:37:28 UTC (rev 118)
@@ -13,7 +13,7 @@
         for p in params[:-1]:
             self.assertEquals(type(p), unicode)
         self.assertEquals(len(params), params[-1] + 1)
-        expected = "SELECT D.document_id, D.title, D.size, D.text, D.url, D.mime_type FROM documents D, document_scores DS WHERE DS.db_document_id=D.db_document_id AND DS.word IN (%s, %s, %s, %s) GROUP BY DS.db_document_id HAVING count(DS.db_document_id) = %s"
+        expected = "SELECT D.db_document_id, D.document_id, D.title, D.size, D.text, D.url, D.mime_type FROM documents D, document_scores DS WHERE DS.db_document_id=D.db_document_id AND DS.word IN (%s, %s, %s, %s) GROUP BY DS.db_document_id HAVING count(DS.db_document_id) = %s"
         self.assertEquals(query, expected)
         q = query%tuple(params) # sanity check for argument count
         

Modified: trunk/maay/test/test_fileiteration.py
===================================================================
--- trunk/maay/test/test_fileiteration.py	2005-10-04 11:37:27 UTC (rev 117)
+++ trunk/maay/test/test_fileiteration.py	2005-10-04 11:37:28 UTC (rev 118)
@@ -6,7 +6,7 @@
 import os
 from os.path import join, abspath, dirname, exists
 
-from maay.indexer import FileIterator as BaseFileIterator
+from maay.indexer import FileIterator
 
 HERE = dirname(__file__)
 DATADIR = join(HERE, 'data')
@@ -17,18 +17,6 @@
     fp = file(filename, 'w')
     fp.close()
 
-
-class FileIterator(BaseFileIterator):
-    """just transforms relative paths to absolute paths"""
-    def __init__(self, indexed, skipped=None):
-        indexed = [abspath(path) for path in indexed]
-        if skipped:
-            skipped = [abspath(path) for path in skipped]
-        else:
-            skipped = []
-        BaseFileIterator.__init__(self, indexed, skipped)
-            
-
 class FileIterationTC(unittest.TestCase):
     def setUp(self):
         self.pathList = [
@@ -84,12 +72,16 @@
                     ]
         self.assertEquals(list(it), expected)
 
+    def testRelativePathConversion(self):
+        """FileIterator should automatically convert relative paths"""
+        paths = [(['data/a'], ['data/b']),
+                 (['/data/a'], ['/data/b', 'data/c'])]
+        for indexed, skipped in paths:
+            onRelatives = list(FileIterator(indexed, skipped))
+            absIndexed = [abspath(path) for path in indexed]
+            absSkipped = [abspath(path) for path in skipped]
+            onAbspaths = list(FileIterator(absIndexed, absSkipped))
+            self.assertEquals(onRelatives, onAbspaths)
 
-    def testFailOnRelativePath(self):
-        """make sure FileIterator forbids relative paths"""
-        self.assertRaises(AssertionError, BaseFileIterator, ['data/a'], ['data/b'])
-        self.assertRaises(AssertionError, BaseFileIterator, ['/data/a'], ['/data/b', 'data/c'])
-        
-
 if __name__ == '__main__':
     unittest.main()

Modified: trunk/maay/texttool.py
===================================================================
--- trunk/maay/texttool.py	2005-10-04 11:37:27 UTC (rev 117)
+++ trunk/maay/texttool.py	2005-10-04 11:37:28 UTC (rev 118)
@@ -22,11 +22,11 @@
 
 CHARSET_RGX = re.compile(r'charset=[\s"]*([^\s"]+)', re.I | re.S | re.U)
 XML_ENCODING_RGX = re.compile(r'^<\?xml version=[^\s]*\s*encoding=([^\s]*)\s*\?>', re.I | re.S | re.U)
-
-class ParsingError(Exception):
-    """raised when an error occures during the indexation of a file"""
-    pass
 
+class ParsingError(Exception):
+    """raised when an error occurs during the indexation of a file"""
+    pass
+
 def normalizeHtmlEncoding(htmlEncoding):
     # XXX FIXME: this function probably already exists somewhere ...
     if htmlEncoding in ('iso8859-1', 'iso-latin1', 'iso-latin-1', 'latin-1',
@@ -106,10 +106,10 @@
         TODO: port original code from htmltotext
         :param encoding: if None, then need to be guessed
         """
-        encoding = encoding or guessEncoding(filename)
+        encoding = encoding or guessEncoding(filename)
         try:
-            stream = open(filename, 'rb', encoding, errors='ignore')
-        except LookupError:
+            stream = open(filename, 'rb', encoding, errors='ignore')
+        except LookupError:
             raise ParsingError('Unsupported document encoding %s' % encoding)
         try:
             return self.parseString(stream.read())



From adimasci at berlios.de  Tue Oct  4 13:50:36 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Tue, 4 Oct 2005 13:50:36 +0200
Subject: [Maay-svncheckins] r119 - trunk/maay/test
Message-ID: <200510041150.j94BoaPG017033@sheep.berlios.de>

Author: adimasci
Date: 2005-10-04 13:50:04 +0200 (Tue, 04 Oct 2005)
New Revision: 119

Added:
   trunk/maay/test/runtests.py
Log:
I was a bit tired of launching each test suite separately ...


Added: trunk/maay/test/runtests.py
===================================================================
--- trunk/maay/test/runtests.py	2005-10-04 11:37:28 UTC (rev 118)
+++ trunk/maay/test/runtests.py	2005-10-04 11:50:04 UTC (rev 119)
@@ -0,0 +1,5 @@
+from logilab.common.testlib import main
+
+if __name__ == '__main__':
+    import sys, os
+    main(os.path.dirname(sys.argv[0]) or '.')



From afayolle at berlios.de  Tue Oct  4 14:42:24 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Tue, 4 Oct 2005 14:42:24 +0200
Subject: [Maay-svncheckins] r120 - trunk/maay
Message-ID: <200510041242.j94CgOtq001288@sheep.berlios.de>

Author: afayolle
Date: 2005-10-04 14:42:24 +0200 (Tue, 04 Oct 2005)
New Revision: 120

Modified:
   trunk/maay/server.py
Log:
EOL fix

Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-04 11:50:04 UTC (rev 119)
+++ trunk/maay/server.py	2005-10-04 12:42:24 UTC (rev 120)
@@ -21,8 +21,8 @@
 from nevow import inevow, rend, tags, guard, loaders, appserver
 # this is to help py2exe
 import nevow.flat.flatstan
-import nevow.query
-import twisted.web.woven.guard
+import nevow.query
+import twisted.web.woven.guard
 import MySQLdb
 
 from logilab.common.textutils import normalize_text



From alexandre.fayolle at logilab.fr  Tue Oct  4 13:48:26 2005
From: alexandre.fayolle at logilab.fr (Alexandre Fayolle)
Date: Tue, 4 Oct 2005 13:48:26 +0200
Subject: [Maay-svncheckins] Re: Maay
In-Reply-To: <35cde7700510040249n2e32dd44u5326d41f38f692fb@mail.gmail.com>
References: <35cde7700510040249n2e32dd44u5326d41f38f692fb@mail.gmail.com>
Message-ID: <20051004114825.GF5896@logilab.fr>

On Tue, Oct 04, 2005 at 11:49:26AM +0200, Fr?d?ric Dang Ngoc wrote:
> Bonjour,
> 
> 1) J'ai essay? l'auto-installeur sous Windows, il marche bien.
> 
> J'aurais juste qq remarques (vous les avez peut-?tre d?j? corrig?s):
> - le programme createdb.exe ne marche pas (remplacer les '/' par des '\\'
> dans le fichier createdb.py)

Corrig? dans le svn. 

> - les convertisseurs ne marchent pas (mettre le chemin en tenant
> compte des r?pertoires : antiword\\antiword.exe).

Corrig? dans svn (en ajoutant les r?pertoires ? la variable
d'environnement PATH pour le moment)

> (? qui dois-je retransmettre les bugs ?)

http://developer.berlios.de/bugs/?group_id=4720

> 
> 2) est ce que tu pourrais me rajouter dans le projet maay sur berlios
> (login:dnf).

Fait. 

> Je ne pense pas faire bcp de modifs en ce moment comme j'ai pas mal de boulots
> dans les deux semaines qui viennent (correction m?moire de th?se).

Pas de probl?me. 

Pour discuter, on peut utiliser pour le moment la liste maay-checkins
(https://lists.berlios.de/mailman/listinfo/maay-svncheckins)
 
> 3) La machine Windows est disponible, vous pouvez venir la chercher
> quand vous voulez.

C'est not?.
 

-- 
Alexandre Fayolle                              LOGILAB, Paris (France).
http://www.logilab.com   http://www.logilab.fr  http://www.logilab.org
Offre d'emploi en CDI sur Paris (France) : http://www.logilab.fr/inge1
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 481 bytes
Desc: Digital signature
URL: <https://lists.berlios.de/pipermail/maay-svncheckins/attachments/20051004/d7b40b01/attachment.pgp>

From afayolle at berlios.de  Tue Oct  4 15:16:24 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Tue, 4 Oct 2005 15:16:24 +0200
Subject: [Maay-svncheckins] r121 - trunk/maay
Message-ID: <200510041316.j94DGOiR005681@sheep.berlios.de>

Author: afayolle
Date: 2005-10-04 15:16:23 +0200 (Tue, 04 Oct 2005)
New Revision: 121

Modified:
   trunk/maay/configuration.py
Log:
quoting bug

Modified: trunk/maay/configuration.py
===================================================================
--- trunk/maay/configuration.py	2005-10-04 12:42:24 UTC (rev 120)
+++ trunk/maay/configuration.py	2005-10-04 13:16:23 UTC (rev 121)
@@ -14,9 +14,14 @@
     """Return the name of the directory where data files are stored,
     depending on the platform and application setup"""
     __maay_dir = os.path.abspath(os.path.dirname(maay.__file__))
-    if sys.platform == "win32":
+    if sys.platform == "win32":
         __maay_dir = os.path.normpath(os.path.join(__maay_dir, '..','..'))
-        os.environ[PATH] = os.environ[PATH] + u';"%(dir)s\antiword";"%(dir)s\pdftohtml";"%(dir)s\mysql\bin"' % {"dir" : __maay_dir}
+        envpath = os.environ.get('PATH', '')
+        if envpath:
+            envpath += ';'
+        envpath += u'"%(dir)s\antiword";"%(dir)s\pdftohtml";"%(dir)s\mysql\bin"' % \
+                   {"dir" : __maay_dir}
+        os.environ['PATH'] =  envpath
         return  os.path.join(__maay_dir,'data')
     else:
         if __maay_dir.startswith('/home') or __maay_dir.startswith('/Users'):



From afayolle at berlios.de  Tue Oct  4 15:34:26 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Tue, 4 Oct 2005 15:34:26 +0200
Subject: [Maay-svncheckins] r122 - in trunk/maay: . test
Message-ID: <200510041334.j94DYQph006978@sheep.berlios.de>

Author: afayolle
Date: 2005-10-04 15:34:26 +0200 (Tue, 04 Oct 2005)
New Revision: 122

Modified:
   trunk/maay/configuration.py
   trunk/maay/test/test_configuration.py
Log:
refactored update_env_path
added missing unit test for that function


Modified: trunk/maay/configuration.py
===================================================================
--- trunk/maay/configuration.py	2005-10-04 13:16:23 UTC (rev 121)
+++ trunk/maay/configuration.py	2005-10-04 13:34:26 UTC (rev 122)
@@ -13,27 +13,32 @@
 def __get_data_dir():
     """Return the name of the directory where data files are stored,
     depending on the platform and application setup"""
-    __maay_dir = os.path.abspath(os.path.dirname(maay.__file__))
+    maay_dir = os.path.abspath(os.path.dirname(maay.__file__))
     if sys.platform == "win32":
-        __maay_dir = os.path.normpath(os.path.join(__maay_dir, '..','..'))
-        envpath = os.environ.get('PATH', '')
-        if envpath:
-            envpath += ';'
-        envpath += u'"%(dir)s\antiword";"%(dir)s\pdftohtml";"%(dir)s\mysql\bin"' % \
-                   {"dir" : __maay_dir}
-        os.environ['PATH'] =  envpath
-        return  os.path.join(__maay_dir,'data')
+        maay_dir = os.path.normpath(os.path.join(maay_dir, '..','..'))
+        _update_env_path(maay_dir)
+        return  os.path.join(maay_dir,'data')
     else:
-        if __maay_dir.startswith('/home') or __maay_dir.startswith('/Users'):
+        if maay_dir.startswith('/home') or maay_dir.startswith('/Users'):
             # we are in a development directory
-            return os.path.join(__maay_dir, 'data')
+            return os.path.join(maay_dir, 'data')
         else:
             # the application has been installed
-            base, last = os.path.split(__maay_dir)
+            base, last = os.path.split(maay_dir)
             while last and last != 'lib': 
                 base, last = os.path.split(base)
             return os.path.join(base,'share', 'maay')
     raise AssertionError("Unknown platform setup")
+
+def _update_env_path(maay_dir):
+    assert sys.platform == 'win32', 'This method must not be called on non windows platforms'
+    path = []
+    if os.environ.get('PATH'):
+        path.append(os.environ.get('PATH'))
+    for directory in (u'antiword', u'pdftohtml', os.path.join(u'mysql', u'bin')):
+        path.append(os.path.join(maay_dir, directory))
+    os.environ['PATH'] =  u';'.join(path)
+
         
 def get_path_of(datafile):
     """return the path of a data file, depending on the platform

Modified: trunk/maay/test/test_configuration.py
===================================================================
--- trunk/maay/test/test_configuration.py	2005-10-04 13:16:23 UTC (rev 121)
+++ trunk/maay/test/test_configuration.py	2005-10-04 13:34:26 UTC (rev 122)
@@ -2,8 +2,11 @@
 
 import unittest
 import sys
+import os
 import os.path as osp
+import re
 
+from maay import configuration
 from maay.server import WebappConfiguration
 
 class WebappConfigTC(unittest.TestCase):
@@ -40,5 +43,17 @@
         self.assertEquals(config.db_name, 'muche')
 
 
+class Win32ConfigTC(unittest.TestCase):
+
+    def test_update_env_path(self):
+        platform = sys.platform
+        sys.platform = 'win32'
+        try:
+            configuration._update_env_path("tmp")
+            envpath = os.environ['PATH']
+            self.failUnless(re.match(r'.*;tmp[/\\]antiword;tmp[/\\]pdftohtml;tmp[/\\]mysql[/\\]bin$', envpath)), envpath
+        finally:
+            sys.platform = platform
+            
 if __name__ == '__main__':
     unittest.main()



From afayolle at berlios.de  Tue Oct  4 15:35:23 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Tue, 4 Oct 2005 15:35:23 +0200
Subject: [Maay-svncheckins] r123 - trunk/maay/test
Message-ID: <200510041335.j94DZNQ0007055@sheep.berlios.de>

Author: afayolle
Date: 2005-10-04 15:35:23 +0200 (Tue, 04 Oct 2005)
New Revision: 123

Modified:
   trunk/maay/test/test_configuration.py
Log:
more readable test

Modified: trunk/maay/test/test_configuration.py
===================================================================
--- trunk/maay/test/test_configuration.py	2005-10-04 13:34:26 UTC (rev 122)
+++ trunk/maay/test/test_configuration.py	2005-10-04 13:35:23 UTC (rev 123)
@@ -51,7 +51,8 @@
         try:
             configuration._update_env_path("tmp")
             envpath = os.environ['PATH']
-            self.failUnless(re.match(r'.*;tmp[/\\]antiword;tmp[/\\]pdftohtml;tmp[/\\]mysql[/\\]bin$', envpath)), envpath
+            regexp = r'.*;tmp[/\\]antiword;tmp[/\\]pdftohtml;tmp[/\\]mysql[/\\]bin$'
+            self.failUnless(re.match(regexp, envpath)), envpath
         finally:
             sys.platform = platform
             



From afayolle at berlios.de  Tue Oct  4 16:00:50 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Tue, 4 Oct 2005 16:00:50 +0200
Subject: [Maay-svncheckins] r124 - trunk/maay/test
Message-ID: <200510041400.j94E0o2a008863@sheep.berlios.de>

Author: afayolle
Date: 2005-10-04 16:00:50 +0200 (Tue, 04 Oct 2005)
New Revision: 124

Modified:
   trunk/maay/test/test_configuration.py
Log:
restore PATH

Modified: trunk/maay/test/test_configuration.py
===================================================================
--- trunk/maay/test/test_configuration.py	2005-10-04 13:35:23 UTC (rev 123)
+++ trunk/maay/test/test_configuration.py	2005-10-04 14:00:50 UTC (rev 124)
@@ -47,6 +47,7 @@
 
     def test_update_env_path(self):
         platform = sys.platform
+        oldpath = os.environ['PATH']
         sys.platform = 'win32'
         try:
             configuration._update_env_path("tmp")
@@ -55,6 +56,7 @@
             self.failUnless(re.match(regexp, envpath)), envpath
         finally:
             sys.platform = platform
+            os.environ['PATH'] = oldpath 
             
 if __name__ == '__main__':
     unittest.main()



From adimasci at berlios.de  Tue Oct  4 17:17:17 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Tue, 4 Oct 2005 17:17:17 +0200
Subject: [Maay-svncheckins] r125 - in trunk/maay: . data test
Message-ID: <200510041517.j94FHHXg015934@sheep.berlios.de>

Author: adimasci
Date: 2005-10-04 17:15:33 +0200 (Tue, 04 Oct 2005)
New Revision: 125

Modified:
   trunk/maay/data/maay.css
   trunk/maay/data/resultpage.html
   trunk/maay/dbentity.py
   trunk/maay/querier.py
   trunk/maay/server.py
   trunk/maay/test/test_texttool.py
   trunk/maay/texttool.py
Log:
- several minor UI changes. (essentially try to emphasis query's words
  in the document's abstract)
- had to add some small funcs / tests



Modified: trunk/maay/data/maay.css
===================================================================
--- trunk/maay/data/maay.css	2005-10-04 14:00:50 UTC (rev 124)
+++ trunk/maay/data/maay.css	2005-10-04 15:15:33 UTC (rev 125)
@@ -20,8 +20,13 @@
   margin-bottom: 5px;
 }
 
-pre.resultDesc {
-  font-size: 80%;
+div.resultDesc {
+  /* display: block; */
+  font-size: 90%;
+  font-family: "New Century Schoolbook", serif;
+  margin-bottom: 0px;
+  padding: 0 0 0 0;
+  width: 40%;
 }
 
 a.docTitle {
@@ -29,6 +34,9 @@
 }
 
 span.resultUrl {
+  font-size: 90%;
+  font-family: "New Century Schoolbook", serif;
+  font-weight: bold;
   color: green;
   text-decoration: none;
 }

Modified: trunk/maay/data/resultpage.html
===================================================================
--- trunk/maay/data/resultpage.html	2005-10-04 14:00:50 UTC (rev 124)
+++ trunk/maay/data/resultpage.html	2005-10-04 15:15:33 UTC (rev 125)
@@ -20,10 +20,8 @@
 	<td>
 	  <div class="resultItem">
 	    <a class="docTitle"><nevow:attr name="href">/download?docid=<nevow:slot name="docid" />&amp;words=<nevow:slot name="words" /></nevow:attr><nevow:slot name="doctitle">DOC TITLE</nevow:slot></a>
-	    <pre class="resultDesc">
-	      <nevow:slot name="abstract">doc abstract</nevow:slot>
-	    </pre>
-	    <span class="resultUrl"><nevow:attr name="href"><nevow:slot name="docurl" /></nevow:attr><nevow:slot name="docurl" /> - <nevow:slot name="readable_size" /></span>
+	    <div class="resultDesc"><nevow:slot name="abstract" /></div>
+	    <span class="resultUrl"><nevow:attr name="href"><nevow:slot name="docurl" /></nevow:attr><nevow:slot name="docurl" /> - <nevow:slot name="readable_size" /> - <nevow:slot name="publication_date" /></span>
 	  </div>
 	</td>
       </tr>

Modified: trunk/maay/dbentity.py
===================================================================
--- trunk/maay/dbentity.py	2005-10-04 14:00:50 UTC (rev 124)
+++ trunk/maay/dbentity.py	2005-10-04 15:15:33 UTC (rev 125)
@@ -4,6 +4,8 @@
 __all__ = ['Document', 'FileInfo', 'DocumentProvider', 'DocumentScore',
            'Word', 'Node', 'NodeInterest']
 
+import re
+
 from maay.texttool import normalizeText, WORD_MIN_LEN, WORD_MAX_LEN
 
 class DBEntity:
@@ -101,7 +103,7 @@
     def __str__(self):
         return '%s: %s' % (self.__class__.__name__,
                            ', '.join(['%s=%s' % (attr, getattr(self, attr))
-                                      for attr in self.attributes]))
+                                      for attr in self.boundAttributes()]))
     def __repr__(self):
         return str(self)
     
@@ -185,8 +187,7 @@
             return u'%s MB' % (bytes / 10**6)
         else:
             return u'%s GB' % (bytes / 10**9)
-
-
+            
     def get_abstract(self):
         return self.text[:200]
     abstract = property(get_abstract)
@@ -210,7 +211,8 @@
                         "D.size, "
                         "D.text, "
                         "D.url, "
-                        "D.mime_type "
+                        "D.mime_type, "
+                        "D.publication_time "
                  "FROM documents D, document_scores DS "
                  "WHERE DS.db_document_id=D.db_document_id "
                      "AND DS.word IN (%s) "
@@ -227,7 +229,7 @@
         if query:
             cursor.execute(query, params)
             results = cursor.fetchall()
-            return [cls(**dict(zip(['db_document_id', 'document_id', 'title', 'size', 'text', 'url', 'mime_type'],
+            return [cls(**dict(zip(['db_document_id', 'document_id', 'title', 'size', 'text', 'url', 'mime_type', 'publication_time'],
                                    row)))
                     for row in results]
         else:

Modified: trunk/maay/querier.py
===================================================================
--- trunk/maay/querier.py	2005-10-04 14:00:50 UTC (rev 124)
+++ trunk/maay/querier.py	2005-10-04 15:15:33 UTC (rev 125)
@@ -75,7 +75,6 @@
         print "hello ?"
         if connection is None:
             dbapiMod = get_dbapi_compliant_module('mysql')
-            print "Got", dbapiMod
             try:
                 connection = dbapiMod.connect(host=host, database=database,
                                               user=user, password=password,

Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-04 14:00:50 UTC (rev 124)
+++ trunk/maay/server.py	2005-10-04 15:15:33 UTC (rev 125)
@@ -2,6 +2,7 @@
 
 __revision__ = '$Id$'
 
+from datetime import datetime
 import warnings
 warnings.filterwarnings("ignore", ".*", DeprecationWarning, "nevow.static")
 warnings.filterwarnings("ignore", ".*", DeprecationWarning, "twisted.python.reflect")
@@ -30,6 +31,7 @@
 from maay.querier import MaayQuerier, IQuerier, MaayAuthenticationError
 from maay.rpc import MaayRPCServer
 from maay.configuration import get_path_of, Configuration
+from maay.texttool import makeAbstract
 
 class MaayPage(rend.Page):
     child_maaycss = static.File(get_path_of('maay.css'))
@@ -106,7 +108,7 @@
         self.results = results
         self.query = unicode(query)
 
-    def data_results(self, context, data):
+    def data_results(self, context, data):        
         return self.results
 
     def render_title(self, context, data):
@@ -118,18 +120,20 @@
         context.fillSlots('doctitle',  document.title)
         # XXX abstract attribute should be a unicode string
         try:
-            abstract = normalize_text(unicode(document.abstract))
+            abstract = makeAbstract(document.text, self.query.split())
+            abstract = normalize_text(unicode(abstract))
         except Exception, exc:
             print exc
             abstract = u'No abstract available for this document [%s]' % exc
-        context.fillSlots('abstract', abstract)
+        context.fillSlots('abstract', tags.xml(abstract))
         context.fillSlots('docid', document.db_document_id)
         context.fillSlots('docurl', document.url)
         context.fillSlots('words', self.query)
         context.fillSlots('readable_size', document.readable_size())
+        date = datetime.fromtimestamp(document.publication_time)
+        context.fillSlots('publication_date', date.strftime('%d/%m/%Y'))
         return context.tag
 
-
 ## nevow app/server setup ############################################
 class MaayRealm:
     """simple realm for Maay application"""

Modified: trunk/maay/test/test_texttool.py
===================================================================
--- trunk/maay/test/test_texttool.py	2005-10-04 14:00:50 UTC (rev 124)
+++ trunk/maay/test/test_texttool.py	2005-10-04 15:15:33 UTC (rev 125)
@@ -1,10 +1,10 @@
-# -*- coding: ISO-8859-1 -*-
+# -*- coding: iso-8859-1 -*-
 """unit tests for Text and HTML parsers"""
 
 import unittest
 from os.path import join, dirname
 
-from maay.texttool import MaayHTMLParser, guessEncoding, open
+from maay.texttool import MaayHTMLParser, guessEncoding, open, untagText
 
 ROW_TEXT = u"foo ?t? bar baz top bim bam boum"
 
@@ -103,5 +103,10 @@
         self.assertEquals(type(data), unicode)
         self.failUnless(u'ent?te' in data)
 
+class UtilitiesTC(unittest.TestCase):
+    def testUntag(self):
+        text = 'Hello <a href="foo.bar.com">world <b>!</b></a><img alt="" />'
+        self.assertEquals(untagText(text), 'Hello world !')
+
 if __name__ == '__main__':
     unittest.main()

Modified: trunk/maay/texttool.py
===================================================================
--- trunk/maay/texttool.py	2005-10-04 14:00:50 UTC (rev 124)
+++ trunk/maay/texttool.py	2005-10-04 15:15:33 UTC (rev 125)
@@ -1,4 +1,4 @@
-# -*- coding: ISO-8859-1 -*-
+# -*- coding: iso-8859-1 -*-
 """this module provide text / parsing tools"""
 
 __revision__ = '$Id$'
@@ -224,3 +224,36 @@
     return ' '.join(text.split())
 
 del _table
+
+
+def untagText(text):
+    """remove every tag in <text>
+    >>> text = <a href="...">hello <b>world</b></a>
+    >>> untagText(text)
+    hello world
+    """
+    rgx = re.compile('<.*?>')
+    return rgx.sub('', text)
+    
+def makeAbstract(text, words):
+    """return the original text with HTML emphasis tags
+    around <words> occurences
+    XXX: this is a quick and dirty implementation
+    """
+    rgx = re.compile('|'.join(words), re.I)
+    text = untagText(text)
+    buf = []
+    size = 0
+    for occurence in rgx.finditer(text):
+        wordFound = occurence.group(0)
+        start, end = occurence.start(), occurence.end()
+        before = text[start-30:start-1]
+        after = text[end+1:end+30]
+        size += len(wordFound) + 60
+        buf.append('%s <b>%s</b> %s' % (before, wordFound, after))
+        if size >= 200:
+            break
+    else:
+        # case where we have less than 200 characters to display
+        print "should do something sensible here"
+    return ' <b>[...]</b> '.join(buf)



From afayolle at berlios.de  Tue Oct  4 17:47:12 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Tue, 4 Oct 2005 17:47:12 +0200
Subject: [Maay-svncheckins] r126 - trunk/maay
Message-ID: <200510041547.j94FlCEm018216@sheep.berlios.de>

Author: afayolle
Date: 2005-10-04 17:47:11 +0200 (Tue, 04 Oct 2005)
New Revision: 126

Modified:
   trunk/maay/configuration.py
Log:
moved get_config_dir to class Configuration

Modified: trunk/maay/configuration.py
===================================================================
--- trunk/maay/configuration.py	2005-10-04 15:15:33 UTC (rev 125)
+++ trunk/maay/configuration.py	2005-10-04 15:47:11 UTC (rev 126)
@@ -3,14 +3,13 @@
 __revision__ = '$Id$'
 
 import os
-
 import sys
 
 from logilab.common.configuration import Configuration as BaseConfiguration
 
 import maay
 
-def __get_data_dir():
+def _get_data_dir():
     """Return the name of the directory where data files are stored,
     depending on the platform and application setup"""
     maay_dir = os.path.abspath(os.path.dirname(maay.__file__))
@@ -37,21 +36,16 @@
         path.append(os.environ.get('PATH'))
     for directory in (u'antiword', u'pdftohtml', os.path.join(u'mysql', u'bin')):
         path.append(os.path.join(maay_dir, directory))
-    os.environ['PATH'] =  u';'.join(path)
+    os.environ['PATH'] =  os.pathsep.join(path)
 
         
 def get_path_of(datafile):
     """return the path of a data file, depending on the platform
     Handles development paths for testing as well as deployed paths"""
-    path = os.path.join(__get_data_dir(), datafile)
+    path = os.path.join(_get_data_dir(), datafile)
     assert os.path.exists(path), "cannot find %s"%path
     return path
 
-def get_config_dirs():
-    if sys.platform == "win32":
-        return [os.path.normpath(os.path.join(__get_data_dir(), '..'))]
-    else:
-        return ['/etc/maay', os.path.expanduser('~/.maay'), '.']                            
     
 
 class Configuration(BaseConfiguration):
@@ -64,7 +58,7 @@
 
     def load(self):
         if self.config_file:
-            for directory in get_config_dirs():
+            for directory in self.get_config_dirs():
                 path = os.path.join(directory, self.config_file)
                 if os.path.exists(path):
                     self.load_file_configuration(path)
@@ -72,8 +66,14 @@
         self.load_command_line_configuration()
     
 
+    def get_config_dirs(self):
+        if sys.platform == "win32":
+            return [os.path.normpath(os.path.join(_get_data_dir(), '..'))]
+        else:
+            return ['/etc/maay', os.path.expanduser('~/.maay'), '.']
+
     def __getattr__(self, attrname):
-        """deletage to self.config when accessing attr on
+        """delegate to self.config when accessing attr on
         Configuration objects. (convenience method)
         """
         try:



From afayolle at berlios.de  Tue Oct  4 17:47:52 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Tue, 4 Oct 2005 17:47:52 +0200
Subject: [Maay-svncheckins] r127 - trunk/maay
Message-ID: <200510041547.j94Flqwo018311@sheep.berlios.de>

Author: afayolle
Date: 2005-10-04 17:47:52 +0200 (Tue, 04 Oct 2005)
New Revision: 127

Modified:
   trunk/maay/server.py
Log:
generate node id when needed

Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-04 15:47:11 UTC (rev 126)
+++ trunk/maay/server.py	2005-10-04 15:47:52 UTC (rev 127)
@@ -8,6 +8,12 @@
 warnings.filterwarnings("ignore", ".*", DeprecationWarning, "twisted.python.reflect")
 warnings.filterwarnings("ignore", ".*", DeprecationWarning, "twisted.web.woven")
 
+import platform
+import sha
+import time
+import os
+import re
+
 from zope.interface import implements
 
 from twisted.cred import portal, checkers, error
@@ -19,9 +25,9 @@
 from twisted.web import static
 from twisted.python import failure
 
-from nevow import inevow, rend, tags, guard, loaders, appserver
-# this is to help py2exe
-import nevow.flat.flatstan
+from nevow import inevow, rend, tags, guard, loaders, appserver
+# this is to help py2exe
+import nevow.flat.flatstan
 import nevow.query
 import twisted.web.woven.guard
 import MySQLdb
@@ -96,7 +102,7 @@
         if docurl:
             return  static.File(docurl)
         else:
-            return NotFoundPage()
+            return PageNotFound()
 
 class ResultsPage(MaayPage):
     """default results page"""
@@ -208,7 +214,7 @@
         return defer.succeed(creds.username)
 
 
-class NotFoundPage(rend.FourOhFour):
+class PageNotFound(rend.FourOhFour):
     pass
 
 class WebappConfiguration(Configuration):
@@ -227,7 +233,62 @@
 
     config_file = 'webapp.ini'
 
+    def __init__(self):
+        Configuration.__init__(self)
+        self.node_id = None
+
+    def get_node_id(self):
+        if not self.node_id:
+            self.node_id = self._read_node_id()
+        return self.node_id
+
+    def _read_node_id(self):
+        for directory in self.get_config_dirs():
+            try:
+                filename = os.path.join(directory,'node_id')
+                f = open(filename,'r')
+                for line in f:
+                    line = line.strip()
+                    if not line or line.startswith('#'):
+                        continue
+                    node_id = line.strip()
+                    assert re.match('^[0-9a-fA-F]{40}$', node_id)
+                    f.close()
+                    return node_id    
+            except IOError:
+                continue
+        self._write_node_id()
+        return self._read_node_id()
+
+    def _generate_node_id(self):
+        hasher = sha.sha()
+        hasher.update(''.join(platform.uname()))
+        hasher.update('%s' % id(self))
+        hasher.update('%s' % time.time())
+        return hasher.hexdigest()
+
+    def _write_node_id(self):
+        node_id = self._generate_node_id()
+        for directory in self.get_config_dirs():
+            try:
+                filename = os.path.join(directory, 'node_id')
+                f = open(filename, 'w')
+                lines = ['# This file contains the Node Identifier for your computer\n',
+                         '# Do not edit it or erase it, or this will corrupt the database\n',
+                         '# of your Maay instance.\n',
+                         '# This id was generated on %s\n' % time.asctime(),
+                         '%s\n' % node_id
+                         ]
+                f.writelines(lines)
+                f.close()
+                return
+            except IOError:
+                continue
+        raise ValueError('Unable to find a writable directory to store the node id')
+                
     
+
+    
 def run():
     webappConfig = WebappConfiguration()
     webappConfig.load()



From afayolle at berlios.de  Tue Oct  4 19:02:23 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Tue, 4 Oct 2005 19:02:23 +0200
Subject: [Maay-svncheckins] r128 - trunk/maay
Message-ID: <200510041702.j94H2NNm017272@sheep.berlios.de>

Author: afayolle
Date: 2005-10-04 19:02:22 +0200 (Tue, 04 Oct 2005)
New Revision: 128

Modified:
   trunk/maay/querier.py
   trunk/maay/rpc.py
   trunk/maay/server.py
Log:
added node management to the indexation part of the program

Modified: trunk/maay/querier.py
===================================================================
--- trunk/maay/querier.py	2005-10-04 15:47:52 UTC (rev 127)
+++ trunk/maay/querier.py	2005-10-04 17:02:22 UTC (rev 128)
@@ -16,7 +16,7 @@
 from logilab.common.db import get_dbapi_compliant_module
 
 from maay.dbentity import Document, FileInfo, DocumentProvider, DocumentScore, \
-     Word
+     Word, Node
 from maay.texttool import normalizeText, WORDS_RGX
 
 class MaayAuthenticationError(Exception):
@@ -38,7 +38,7 @@
         """returns a list of indexed file names as strings
         """
 
-    def indexDocument(filename, title, text, fileSize, lastModifiedOn,
+    def indexDocument(nodeId, filename, title, text, fileSize, lastModifiedOn,
                       content_hash, mime_type, state, file_state):
         """Inserts or update information in table documents,
         file_info, document_score and word"""
@@ -51,13 +51,16 @@
         `document_providers` table reference them, as well as the
         corresponding `document_scores` rows"""
         
-    def notifyDownload(self, docId, query):
+    def notifyDownload(docId, query):
         """check that a document is downloadable and update the
         download statistics for the document.
 
         Return document url if the document is downloadable and and
         empty string otherwise"""
         
+    def registerNode(nodeId):
+        """register the current running node in the database"""
+        
     def close():
         """closes the DB connection"""
 
@@ -163,7 +166,7 @@
         print "removed %d rows related to unreferenced documents" % rows
         return rows
 
-    def indexDocument(self, filename, title, text, fileSize, lastModifiedOn,
+    def indexDocument(self, nodeId, filename, title, text, fileSize, lastModifiedOn,
                       content_hash, mime_type, state, file_state):
         """Inserts or update information in table documents,
         file_info, document_score and word"""
@@ -228,6 +231,14 @@
             fileinfo.commit(cursor, update=False)
 
         self._updateScores(cursor, doc.db_document_id, text)
+        provider = DocumentProvider.selectOrInsertWhere(cursor,
+                                          db_document_id=doc.db_document_id,
+                                          node_id=nodeId)[0]
+        provider.last_providing_time = int(time.time())
+        provider.commit(cursor, update=True)
+        node = Node.selectWhere(cursor, node_id=nodeId)[0]
+        node.last_seen_time = int(time.time())
+        node.commit(cursor, update=True)
         cursor.close()
         self._cnx.commit()        
         
@@ -347,5 +358,15 @@
         self._cnx.commit()
 
 
+    def registerNode(self, nodeId, ip, port, bandwidth):
+        cursor = self._cnx.cursor()
+        node = Node.selectOrInsertWhere(cursor, node_id=nodeId)[0]
+        node.ip = ip
+        node.port = port
+        node.bandwidth = bandwidth
+        node.last_seen_time = int(time.time())
+        node.commit(cursor, update=True)
+
+
 def hoeffding_deviation(occurence, confidence=0.9):
      return sqrt(-log(confidence / 2) / (2 * occurence))

Modified: trunk/maay/rpc.py
===================================================================
--- trunk/maay/rpc.py	2005-10-04 15:47:52 UTC (rev 127)
+++ trunk/maay/rpc.py	2005-10-04 17:02:22 UTC (rev 128)
@@ -21,6 +21,7 @@
         XMLRPC.__init__(self)
         self._sessions = {}
         self.portal = portal
+        self.node_id = portal.config.get_node_id()
         
     def _attachUser(self, (interface, querier, logout), username, password):
         if interface is not IQuerier or querier is None:
@@ -86,7 +87,7 @@
         text = unicode(text)
         if self.cnxIsValid(cnxId):
             querier = self._sessions[cnxId]
-            querier.indexDocument(filename, title, text, fileSize,
+            querier.indexDocument(self.node_id, filename, title, text, fileSize,
                                   lastModifiedOn, content_hash, mime_type, state,
                                   file_state)
         return 0

Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-04 15:47:52 UTC (rev 127)
+++ trunk/maay/server.py	2005-10-04 17:02:22 UTC (rev 128)
@@ -13,6 +13,7 @@
 import time
 import os
 import re
+import socket
 
 from zope.interface import implements
 
@@ -149,6 +150,8 @@
         self._sessions = {}
 
     def createUserSession(self, avatarId, querier):
+        """associate a querier to an avatarId.
+        Use avatarId=None for the internal private database connection"""
         self._sessions[avatarId] = querier
 
 
@@ -189,8 +192,20 @@
                                 webappConfig.db_name)
         portal.Portal.__init__(self, realm, (checker,))
         self.registerChecker(AllowAnonymousAccess(), IAnonymous)
-    
-
+        self.config = webappConfig
+        realm.createUserSession(None,
+                                MaayQuerier(host=webappConfig.db_host,
+                                            database=webappConfig.db_name,
+                                            user=webappConfig.user,
+                                            password=webappConfig.password))
+        querier = realm._getQuerier(None)
+        # FIXME: put these values in a configuration file somewhere
+        querier.registerNode(webappConfig.get_node_id(),
+                             ip=socket.gethostbyname(socket.gethostname()),
+                             port=6789,
+                             bandwidth=10)
+        
+        
 class DBAuthChecker:
     """user authentication checker
     cf. twisted's CRED system for more details
@@ -229,6 +244,19 @@
           'help' : "which server hosts the database",
           'default' : "localhost",
           }),
+        ('user',
+         {'type': 'string',
+          'metavar': '<userid>', 'short': 'u',
+          'help': 'identifier to use to connect to the database',
+          'default' : "maay",
+          }),
+
+        ('password',
+         {'type': 'string',
+          'metavar': '<password>', 'short' : "p",
+          'help': 'password to use to connect to the database',
+          'default' : "maay",
+          }),
         ]
 
     config_file = 'webapp.ini'



From afayolle at berlios.de  Tue Oct  4 20:03:55 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Tue, 4 Oct 2005 20:03:55 +0200
Subject: [Maay-svncheckins] r129 - trunk/maay
Message-ID: <200510041803.j94I3tXa016607@sheep.berlios.de>

Author: afayolle
Date: 2005-10-04 20:03:55 +0200 (Tue, 04 Oct 2005)
New Revision: 129

Modified:
   trunk/maay/rpc.py
Log:
try to remove the cannot serialize output problem

Modified: trunk/maay/rpc.py
===================================================================
--- trunk/maay/rpc.py	2005-10-04 17:02:22 UTC (rev 128)
+++ trunk/maay/rpc.py	2005-10-04 18:03:55 UTC (rev 129)
@@ -12,7 +12,7 @@
 def make_uid(username, password):
     """forge a unique identifier"""
     # FIXME: need a better implementation
-    return long(hash(username+password) + hash(time()) + randint(-1000, 1000))
+    return int(hash(username+password) + hash(time()) + randint(-1000, 1000))
 
 
 class MaayRPCServer(XMLRPC):
@@ -29,7 +29,7 @@
             print errmsg
             return '',  errmsg # raise UnauthorizedLogin()
         digest = make_uid(username, password)
-        print "Registering querier for %s (digets=%s)" % (username, digest)
+        print "Registering querier for %s (digest=%s)" % (username, digest)
         self._sessions[digest] = querier
         return digest, ''
 



From afayolle at berlios.de  Wed Oct  5 10:17:30 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Wed, 5 Oct 2005 10:17:30 +0200
Subject: [Maay-svncheckins] r130 - trunk/maay
Message-ID: <200510050817.j958HURl000166@sheep.berlios.de>

Author: afayolle
Date: 2005-10-05 10:17:30 +0200 (Wed, 05 Oct 2005)
New Revision: 130

Modified:
   trunk/maay/rpc.py
Log:
fixed "cannot serialize output" bug


Modified: trunk/maay/rpc.py
===================================================================
--- trunk/maay/rpc.py	2005-10-04 18:03:55 UTC (rev 129)
+++ trunk/maay/rpc.py	2005-10-05 08:17:30 UTC (rev 130)
@@ -12,7 +12,7 @@
 def make_uid(username, password):
     """forge a unique identifier"""
     # FIXME: need a better implementation
-    return int(hash(username+password) + hash(time()) + randint(-1000, 1000))
+    return '%X' % abs(hash(username+password) + hash(time()) + randint(-1000, 1000))
 
 
 class MaayRPCServer(XMLRPC):



From afayolle at berlios.de  Wed Oct  5 11:47:59 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Wed, 5 Oct 2005 11:47:59 +0200
Subject: [Maay-svncheckins] r131 - in trunk: . debian
Message-ID: <200510050947.j959lxL5006893@sheep.berlios.de>

Author: afayolle
Date: 2005-10-05 11:47:59 +0200 (Wed, 05 Oct 2005)
New Revision: 131

Added:
   trunk/debian/
   trunk/debian/README.Debian
   trunk/debian/changelog
   trunk/debian/compat
   trunk/debian/control
   trunk/debian/copyright
   trunk/debian/dirs
   trunk/debian/docs
   trunk/debian/examples
   trunk/debian/install
   trunk/debian/rules
Log:
first attempt at debian packaging

Added: trunk/debian/README.Debian
===================================================================
--- trunk/debian/README.Debian	2005-10-05 08:17:30 UTC (rev 130)
+++ trunk/debian/README.Debian	2005-10-05 09:47:59 UTC (rev 131)
@@ -0,0 +1,6 @@
+maay for Debian
+---------------
+
+<possible notes regarding this package - if none, delete this file>
+
+ -- Alexandre Fayolle <afayolle at debian.org>, Wed,  5 Oct 2005 11:16:23 +0200

Added: trunk/debian/changelog
===================================================================
--- trunk/debian/changelog	2005-10-05 08:17:30 UTC (rev 130)
+++ trunk/debian/changelog	2005-10-05 09:47:59 UTC (rev 131)
@@ -0,0 +1,6 @@
+maay (0.1.0-1) unstable; urgency=low
+
+  * First release
+
+ -- Alexandre Fayolle <afayolle at debian.org>  Wed,  5 Oct 2005 11:16:23 +0200
+

Added: trunk/debian/compat
===================================================================
--- trunk/debian/compat	2005-10-05 08:17:30 UTC (rev 130)
+++ trunk/debian/compat	2005-10-05 09:47:59 UTC (rev 131)
@@ -0,0 +1 @@
+4

Added: trunk/debian/control
===================================================================
--- trunk/debian/control	2005-10-05 08:17:30 UTC (rev 130)
+++ trunk/debian/control	2005-10-05 09:47:59 UTC (rev 131)
@@ -0,0 +1,26 @@
+Source: maay
+Section: unknown
+Priority: optional
+Maintainer: Alexandre Fayolle <afayolle at debian.org>
+Build-Depends: debhelper (>= 4.0.0), python-dev, python
+Standards-Version: 3.6.2
+
+Package: maay
+Architecture: all
+Depends: ${shlibs:Depends}, ${misc:Depends}, mysql-server-4.1, python, python-mysql, python-nevow, python-twisted
+Recommends: antiword, unrtf, pdftohtml, 
+Description: peer to peer indexation and search engine
+ Maay can index files on your computer, and export them to other
+ members of the Maay P2P network. You can also issue searches which
+ will look for documents on your computer as well as on other nodes of
+ the P2P network.
+ .
+ Maay can index raw text, html, pdf, ms word and rtf documents. Other
+ formats are planned for a future release.
+ .
+ Queries are issued using a web interface. In the current version
+ queries are ontly dispatched on the current node, i.e. the P2P
+ functionnality is not available for now.
+ . 
+ Homepage: http://maay.netofpeers.net/
+

Added: trunk/debian/copyright
===================================================================
--- trunk/debian/copyright	2005-10-05 08:17:30 UTC (rev 130)
+++ trunk/debian/copyright	2005-10-05 09:47:59 UTC (rev 131)
@@ -0,0 +1,26 @@
+This package was debianized by Alexandre Fayolle <afayolle at debian.org> on
+Wed,  5 Oct 2005 11:16:23 +0200.
+
+It was downloaded from http://download.berlios.de/maay/
+
+Copyright Holder: copyright (c) 2004-2005 France Telecom R&D
+
+License:
+
+   This package is free software; you can redistribute it and/or modify
+   it under the terms of the GNU General Public License as published by
+   the Free Software Foundation; either version 2 of the License, or
+   (at your option) any later version.
+
+   This package is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+   GNU General Public License for more details.
+
+   You should have received a copy of the GNU General Public License
+   along with this package; if not, write to the Free Software
+   Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
+On Debian systems, the complete text of the GNU General
+Public License can be found in `/usr/share/common-licenses/GPL'.
+

Added: trunk/debian/dirs
===================================================================
--- trunk/debian/dirs	2005-10-05 08:17:30 UTC (rev 130)
+++ trunk/debian/dirs	2005-10-05 09:47:59 UTC (rev 131)
@@ -0,0 +1,5 @@
+usr/bin
+usr/share/doc/maay/examples
+usr/lib/python2.3/site-packages/maay
+usr/share/maay
+etc/maay

Added: trunk/debian/docs
===================================================================
--- trunk/debian/docs	2005-10-05 08:17:30 UTC (rev 130)
+++ trunk/debian/docs	2005-10-05 09:47:59 UTC (rev 131)
@@ -0,0 +1 @@
+README.txt

Added: trunk/debian/examples
===================================================================
--- trunk/debian/examples	2005-10-05 08:17:30 UTC (rev 130)
+++ trunk/debian/examples	2005-10-05 09:47:59 UTC (rev 131)
@@ -0,0 +1 @@
+maay/configuration/*.ini

Added: trunk/debian/install
===================================================================
--- trunk/debian/install	2005-10-05 08:17:30 UTC (rev 130)
+++ trunk/debian/install	2005-10-05 09:47:59 UTC (rev 131)
@@ -0,0 +1 @@
+maay/data/* usr/share/maay

Added: trunk/debian/rules
===================================================================
--- trunk/debian/rules	2005-10-05 08:17:30 UTC (rev 130)
+++ trunk/debian/rules	2005-10-05 09:47:59 UTC (rev 131)
@@ -0,0 +1,70 @@
+#!/usr/bin/make -f
+# -*- makefile -*-
+# Sample debian/rules that uses debhelper.
+# This file was originally written by Joey Hess and Craig Small.
+# As a special exception, when this file is copied by dh-make into a
+# dh-make output file, you may use that output file without restriction.
+# This special exception was added by Craig Small in version 0.37 of dh-make.
+
+# Uncomment this to turn on verbose mode.
+#export DH_VERBOSE=1
+
+
+
+
+CFLAGS = -Wall -g
+
+ifneq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
+	CFLAGS += -O0
+else
+	CFLAGS += -O2
+endif
+
+configure: configure-stamp
+configure-stamp:
+	dh_testdir
+	touch configure-stamp
+
+
+build: build-stamp
+
+build-stamp: configure-stamp 
+	dh_testdir
+	python setup.py build
+	touch build-stamp
+
+clean:
+	dh_testdir
+	dh_testroot
+	rm -f build-stamp configure-stamp
+	rm -rf build dist
+	dh_clean 
+
+install: build
+	dh_testdir
+	dh_testroot
+	dh_clean -k 
+	dh_installdirs
+
+	python setup.py install --prefix=$(CURDIR)/debian/maay
+
+
+binary-indep: build install
+	dh_testdir
+	dh_testroot
+	dh_installchangelogs ChangeLog
+	dh_installdocs
+	dh_installexamples
+	dh_install
+	dh_installman
+	dh_compress
+	dh_fixperms
+	dh_python
+	dh_installdeb
+	dh_shlibdeps
+	dh_gencontrol
+	dh_md5sums
+	dh_builddeb
+
+binary: binary-indep 
+.PHONY: build clean binary-indep binary-arch binary install configure


Property changes on: trunk/debian/rules
___________________________________________________________________
Name: svn:executable
   + *



From adimasci at berlios.de  Wed Oct  5 12:51:08 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Wed, 5 Oct 2005 12:51:08 +0200
Subject: [Maay-svncheckins] r132 - trunk/maay/test
Message-ID: <200510051051.j95Ap8Hj030092@sheep.berlios.de>

Author: adimasci
Date: 2005-10-05 12:50:43 +0200 (Wed, 05 Oct 2005)
New Revision: 132

Added:
   trunk/maay/test/test_server.py
Log:
testsuite for raw query parsing


Added: trunk/maay/test/test_server.py
===================================================================
--- trunk/maay/test/test_server.py	2005-10-05 09:47:59 UTC (rev 131)
+++ trunk/maay/test/test_server.py	2005-10-05 10:50:43 UTC (rev 132)
@@ -0,0 +1,64 @@
+import unittest
+
+from maay.server import Query
+
+class UtilsTC(unittest.TestCase):
+
+    def testBasicQuery(self):
+        query = Query.fromRawQuery(u"hello")
+        self.assertEquals(query.words, u"hello")
+        # excplitly check for unicode-ness ('hello' == u'hello')
+        self.assertEquals(type(query.words), unicode)
+        self.assertEquals(query.filename, None)
+        self.assertEquals(query.filetype, None)
+        self.assertEquals(query.offset, 0)
+        
+    def testBasicQueryWithSeveralWords(self):
+        query = Query.fromRawQuery(u"hello world")
+        self.assertEquals(query.words, u"hello world")
+        # excplitly check for unicode-ness ('hello' == u'hello')
+        self.assertEquals(type(query.words), unicode)
+        self.assertEquals(query.filename, None)
+        self.assertEquals(query.filetype, None)
+        self.assertEquals(query.offset, 0)
+        
+    def testOneWordRestrictedQuery(self):
+        query = Query.fromRawQuery(u"hello filetype:pdf")
+        self.assertEquals(query.words, u"hello")
+        # excplitly check for unicode-ness ('hello' == u'hello')
+        self.assertEquals(type(query.words), unicode)
+        self.assertEquals(query.filename, None)
+        self.assertEquals(query.filetype, 'application/pdf')
+        self.assertEquals(query.offset, 0)
+
+    def testTwoWordsRestrictedQuery(self):
+        query = Query.fromRawQuery(u"hello filetype:pdf world")
+        self.assertEquals(query.words, u"hello world")
+        # excplitly check for unicode-ness ('hello' == u'hello')
+        self.assertEquals(type(query.words), unicode)
+        self.assertEquals(query.filename, None)
+        self.assertEquals(query.filetype, 'application/pdf')
+        self.assertEquals(query.offset, 0)
+
+    def testTwoWordsRestrictedQueryAndOffset(self):
+        query = Query.fromRawQuery(u"hello filetype:pdf world", 12)
+        self.assertEquals(query.words, u"hello world")
+        # excplitly check for unicode-ness ('hello' == u'hello')
+        self.assertEquals(type(query.words), unicode)
+        self.assertEquals(query.filename, None)
+        self.assertEquals(query.filetype, 'application/pdf')
+        self.assertEquals(query.offset, 12)
+
+    # Commented because not sure how filename should be handled  :
+    # (regexps ? LIKE %...% ?, etc.)
+##     def testSeveralWordsAndSeveralRestrictions(self):
+##         query = Query.fromRawQuery(u"hello filetype:pdf world filename:foo")
+##         self.assertEquals(query.words, u"hello world")
+##         self.assertEquals(query.filename, u"foo")
+##         self.assertEquals(query.filetype, 'text/pdf')
+
+
+if __name__ == '__main__':
+    unittest.main()
+
+



From adimasci at berlios.de  Wed Oct  5 12:53:26 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Wed, 5 Oct 2005 12:53:26 +0200
Subject: [Maay-svncheckins] r133 - trunk/maay
Message-ID: <200510051053.j95ArQne031940@sheep.berlios.de>

Author: adimasci
Date: 2005-10-05 12:53:24 +0200 (Wed, 05 Oct 2005)
New Revision: 133

Modified:
   trunk/maay/dbentity.py
   trunk/maay/querier.py
   trunk/maay/server.py
   trunk/maay/texttool.py
Log:
- add optional restrictions for search queries
  (e.g. : "python filetype:pdf" only looks for PDFs files)
- insert mimetypes at indexation time



Modified: trunk/maay/dbentity.py
===================================================================
--- trunk/maay/dbentity.py	2005-10-05 10:50:43 UTC (rev 132)
+++ trunk/maay/dbentity.py	2005-10-05 10:53:24 UTC (rev 133)
@@ -193,18 +193,26 @@
     abstract = property(get_abstract)
 
 
-    def _selectContainingQuery(cls, words):
+    def _selectContainingQuery(cls, words, mimetype=None, offset=0):
         words = [normalizeText(unicode(w))
                  for w in words
                  if WORD_MIN_LEN <= len(w) <= WORD_MAX_LEN]
         if not words:
             return ''
-
+        # XXX mimetype handling is a HACK. It needs to be integrated
+        #     nicely in order to handle any kind of restrictions easily
+        if mimetype is not None:
+            restriction = " AND D.mime_type=%s "
+            restrictionParams = [mimetype]
+        else:
+            restriction = ""
+            restrictionParams = []
         # Question: what is the HAVING clause supposed to do ?
         # Answer: we select all documents containing one of the words
         # that we are looking for, group them by their identifier, and
         # only keep those identifier which appeared once for each word
         # we were looking for.
+        # XXX: LIMIT clause should be optional
         query = ("SELECT D.db_document_id, "
                         "D.document_id, "
                         "D.title, "
@@ -215,18 +223,21 @@
                         "D.publication_time "
                  "FROM documents D, document_scores DS "
                  "WHERE DS.db_document_id=D.db_document_id "
-                     "AND DS.word IN (%s) "
-                   "GROUP BY DS.db_document_id "
-                   "HAVING count(DS.db_document_id) = %%s" % \
-                   (', '.join(['%s'] * len(words))))
+                 "AND DS.word IN (%s) "
+                 " %s "
+                 "GROUP BY DS.db_document_id "
+                 "HAVING count(DS.db_document_id) = %%s "
+                 "LIMIT 15 OFFSET %s" % \
+                 (', '.join(['%s'] * len(words)), restriction, offset))
 
-        return query, words + [len(words)]
+        return query, words + restrictionParams + [len(words)]
 
     _selectContainingQuery = classmethod(_selectContainingQuery)
 
-    def selectContaining(cls, cursor, words):
-        query, params= cls._selectContainingQuery(words)
+    def selectContaining(cls, cursor, words, mimetype=None, offset=0):
+        query, params= cls._selectContainingQuery(words, mimetype, offset=offset)
         if query:
+            print "QUERY =", query, "params =", params
             cursor.execute(query, params)
             results = cursor.fetchall()
             return [cls(**dict(zip(['db_document_id', 'document_id', 'title', 'size', 'text', 'url', 'mime_type', 'publication_time'],

Modified: trunk/maay/querier.py
===================================================================
--- trunk/maay/querier.py	2005-10-05 10:50:43 UTC (rev 132)
+++ trunk/maay/querier.py	2005-10-05 10:53:24 UTC (rev 133)
@@ -117,11 +117,11 @@
     
     def findDocuments(self, query):
         """Find all indexed documents matching the query"""
-        words = WORDS_RGX.findall(normalizeText(query))
+        words = WORDS_RGX.findall(normalizeText(query.words))
         self._updateQueryStatistics(words)
         try:
             cursor = self._cnx.cursor()
-            return Document.selectContaining(cursor, words)
+            return Document.selectContaining(cursor, words, query.filetype)
         finally:
             cursor.close()
 
@@ -195,6 +195,7 @@
                                            fileSize,
                                            lastModifiedOn,
                                            filename,
+                                           mime_type,
                                            state)
                 fileinfo.db_document_id = doc.db_document_id
             else:
@@ -220,6 +221,7 @@
                                            fileSize,
                                            lastModifiedOn,
                                            filename,
+                                           mime_type,
                                            state)
                 doc = Document.selectWhere(cursor, document_id=content_hash)[0]
 
@@ -243,7 +245,7 @@
         self._cnx.commit()        
         
     def _createDocument(self, cursor, content_hash, title, text, fileSize,
-                        lastModifiedOn, filename, state):
+                        lastModifiedOn, filename, mime_type, state):
         doc = Document(document_id=content_hash,
                        title=title,
                        text=text,
@@ -251,6 +253,7 @@
                        publication_time=lastModifiedOn,
                        download_count=0.,
                        url=filename,
+                       mime_type=mime_type,
                        matching=0.,
                        indexed='1',
                        state=state)

Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-05 10:50:43 UTC (rev 132)
+++ trunk/maay/server.py	2005-10-05 10:53:24 UTC (rev 133)
@@ -38,7 +38,7 @@
 from maay.querier import MaayQuerier, IQuerier, MaayAuthenticationError
 from maay.rpc import MaayRPCServer
 from maay.configuration import get_path_of, Configuration
-from maay.texttool import makeAbstract
+from maay.texttool import makeAbstract, WORDS_RGX, normalizeText
 
 class MaayPage(rend.Page):
     child_maaycss = static.File(get_path_of('maay.css'))
@@ -73,7 +73,42 @@
             ]
         )
     
+def normalizeMimetype(fileExtension):
+    import mimetypes
+    return mimetypes.types_map.get('.%s' % fileExtension)
 
+class Query(object):
+    restrictions = ('filetype', 'filename')
+
+    def __init__(self, words, offset=0, filetype=None, filename=None):
+        self.words = words # unicode string 
+        self.offset = offset
+        self.filetype = normalizeMimetype(filetype)
+        self.filename = filename
+
+    def fromRawQuery(rawQuery, offset=0):
+        rawWords = rawQuery.split()
+        words = []
+        restrictions = {}
+        for word in rawWords:
+            try:
+                restType, restValue = [s.strip() for s in word.split(':')]
+            except ValueError:
+                words.append(word)
+            else:
+                if restType in Query.restrictions:
+                    # Python does not support unicode keywords !
+                    # (note: restType is pure ASCII, so no pb with str())
+                    restrictions[str(restType)] = restValue
+                else:
+                    words.append(word)
+        return Query(u' '.join(words), offset, **restrictions)
+    fromRawQuery = staticmethod(fromRawQuery)
+
+    def __repr__(self):
+        return 'Query Object (%s, %s, %s)' % (self.words, self.filetype,
+                                              self.filename)
+
 class SearchForm(MaayPage):
     """default search form"""
     docFactory = loaders.xmlfile(get_path_of('searchform.html'))
@@ -90,7 +125,9 @@
         return None
 
     def child_search(self, context):
-        query = unicode(context.arg('words'))
+        # query = unicode(context.arg('words'))
+        offset = int(context.arg('offset', 0))
+        query = Query.fromRawQuery(unicode(context.arg('words')), offset)
         results = self.querier.findDocuments(query)
         return ResultsPage(results, query)
 
@@ -98,10 +135,11 @@
     # XXX don't forget to update the download statistics of the document
     def child_download(self, context):
         docid = context.arg('docid')
-        query = unicode(context.arg('words'))
-        docurl = self.querier.notifyDownload(docid, query)
+        # query = unicode(context.arg('words'))
+        query = Query.fromRawQuery(unicode(context.arg('words')))
+        docurl = self.querier.notifyDownload(docid, query.words)
         if docurl:
-            return  static.File(docurl)
+            return static.File(docurl)
         else:
             return PageNotFound()
 
@@ -113,14 +151,27 @@
     def __init__(self, results, query):
         MaayPage.__init__(self)
         self.results = results
-        self.query = unicode(query)
+        self.query = query.words # unicode(query)
 
-    def data_results(self, context, data):        
+    def data_results(self, context, data):
         return self.results
 
     def render_title(self, context, data):
         context.fillSlots('words', self.query)
         return context.tag
+
+    def render_prevset_url(self, context, data):
+        words = WORDS_RGX.findall(normalizeText(unicode(context.arg('words'))))
+        offset = int(context.arg('offset', 0))
+        if offset:
+            offset -= 15
+        return 'search?words=%s&offset=%s' % ('+'.join(words), offset)
+
+    def render_nextset_url(self, context, data):
+        words = WORDS_RGX.findall(normalizeText(unicode(context.arg('words'))))
+        offset = int(context.arg('offset', 0)) + 15
+        return 'search?words=%s&offset=%s' % ('+'.join(words), offset)
+
     
     def render_row(self, context, data):
         document = data

Modified: trunk/maay/texttool.py
===================================================================
--- trunk/maay/texttool.py	2005-10-05 10:50:43 UTC (rev 132)
+++ trunk/maay/texttool.py	2005-10-05 10:53:24 UTC (rev 133)
@@ -219,7 +219,7 @@
 
     :param text: **unicode** string to normalize
     """
-    assert type(text) is unicode
+    assert type(text) is unicode, "got %s instead of unicode !" % type(text)
     text = text.lower().translate(table)
     return ' '.join(text.split())
 



From adimasci at berlios.de  Wed Oct  5 13:02:06 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Wed, 5 Oct 2005 13:02:06 +0200
Subject: [Maay-svncheckins] r134 - trunk/maay/data
Message-ID: <200510051102.j95B26Ws003329@sheep.berlios.de>

Author: adimasci
Date: 2005-10-05 13:02:04 +0200 (Wed, 05 Oct 2005)
New Revision: 134

Modified:
   trunk/maay/data/maay.css
   trunk/maay/data/resultpage.html
Log:
add experimental links (prev and next) because search results are
now displayed by block of 15 results

Note on this checkin and the last 2 ones :

 - next/prev is very basic (it even doesn't work at all ;-)
   (offset argument doesn't seem to be passed all the way
    along until SQL query)
 - the LIMIT clause for search queries is hard-coded, which means
   that 'selectContainingQuery' will *always* return blocks of 
   15 elements. There is a test failing in test_dbentity caused by
   the addition of the LIMIT clause. This test was explicitly left
   failing because the current way of handling LIMIT clause is
   probably not the good way
 - filetype restrictions should be handled in a more general way
   in order to handle any other restrictions (filename for instance)
   easily.



Modified: trunk/maay/data/maay.css
===================================================================
--- trunk/maay/data/maay.css	2005-10-05 10:53:24 UTC (rev 133)
+++ trunk/maay/data/maay.css	2005-10-05 11:02:04 UTC (rev 134)
@@ -40,3 +40,13 @@
   color: green;
   text-decoration: none;
 }
+
+div.prevnext {
+  width: 100%;
+}
+
+div.prevnext a {
+  font-size: 110%;
+  font-weight: bold;
+  color: blue;
+}

Modified: trunk/maay/data/resultpage.html
===================================================================
--- trunk/maay/data/resultpage.html	2005-10-05 10:53:24 UTC (rev 133)
+++ trunk/maay/data/resultpage.html	2005-10-05 11:02:04 UTC (rev 134)
@@ -26,5 +26,6 @@
 	</td>
       </tr>
     </table>
+    <div class="prevnext"><a><nevow:attr name="href" nevow:render="prevset_url"/>Previous</a> - <a><nevow:attr name="href" nevow:render="nextset_url"/>Next</a></div>
   </body>  
 </html>



From afayolle at berlios.de  Wed Oct  5 13:45:41 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Wed, 5 Oct 2005 13:45:41 +0200
Subject: [Maay-svncheckins] r135 - trunk/maay
Message-ID: <200510051145.j95Bjfnt026592@sheep.berlios.de>

Author: afayolle
Date: 2005-10-05 13:45:37 +0200 (Wed, 05 Oct 2005)
New Revision: 135

Added:
   trunk/maay/cleandb.py
Log:
helper script

Added: trunk/maay/cleandb.py
===================================================================
--- trunk/maay/cleandb.py	2005-10-05 11:02:04 UTC (rev 134)
+++ trunk/maay/cleandb.py	2005-10-05 11:45:37 UTC (rev 135)
@@ -0,0 +1,21 @@
+#!/usr/bin/python
+"""Utility script to clean the database. This forces full reindexation
+on the following indexer run
+"""
+
+from maay.indexer import IndexerConfiguration
+from logilab.common.db import get_dbapi_compliant_module
+
+config = IndexerConfiguration()
+config.load()
+
+
+dbapiMod = get_dbapi_compliant_module('mysql')
+connection = dbapiMod.connect(host=config.host, database='maay',
+                              user=config.user, password=config.password,
+                              unicode=True)
+
+cursor = connection.cursor()
+for table in ('nodes', 'document_providers', 'documents', 'document_scores', 'words', 'files', 'node_interests'):
+    cursor.execute('DELETE FROM %s;' % table)
+connection.commit()


Property changes on: trunk/maay/cleandb.py
___________________________________________________________________
Name: svn:keywords
   + "Id"
Name: svn:eol-style
   + native



From afayolle at berlios.de  Wed Oct  5 13:57:31 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Wed, 5 Oct 2005 13:57:31 +0200
Subject: [Maay-svncheckins] r136 - trunk/maay
Message-ID: <200510051157.j95BvV6l000796@sheep.berlios.de>

Author: afayolle
Date: 2005-10-05 13:57:30 +0200 (Wed, 05 Oct 2005)
New Revision: 136

Modified:
   trunk/maay/cleandb.py
Log:
display some information about cleaned tables

Modified: trunk/maay/cleandb.py
===================================================================
--- trunk/maay/cleandb.py	2005-10-05 11:45:37 UTC (rev 135)
+++ trunk/maay/cleandb.py	2005-10-05 11:57:30 UTC (rev 136)
@@ -17,5 +17,6 @@
 
 cursor = connection.cursor()
 for table in ('nodes', 'document_providers', 'documents', 'document_scores', 'words', 'files', 'node_interests'):
-    cursor.execute('DELETE FROM %s;' % table)
+    nrows = cursor.execute('DELETE FROM %s;' % table)
+    print "Deleted %d rows from table %s" % (nrows, table)
 connection.commit()



From afayolle at berlios.de  Wed Oct  5 13:58:54 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Wed, 5 Oct 2005 13:58:54 +0200
Subject: [Maay-svncheckins] r137 - trunk/maay
Message-ID: <200510051158.j95Bwsw7001621@sheep.berlios.de>

Author: afayolle
Date: 2005-10-05 13:58:41 +0200 (Wed, 05 Oct 2005)
New Revision: 137

Modified:
   trunk/maay/converter.py
Log:
EOL fix

Modified: trunk/maay/converter.py
===================================================================
--- trunk/maay/converter.py	2005-10-05 11:57:30 UTC (rev 136)
+++ trunk/maay/converter.py	2005-10-05 11:58:41 UTC (rev 137)
@@ -69,10 +69,10 @@
 
         :returns: a word-vector
         """
-        parser = self.getParser()
+        parser = self.getParser()
         try:
-            return parser.parseFile(filename, self.OUTPUT_ENCODING)
-        except ParsingError, exc:
+            return parser.parseFile(filename, self.OUTPUT_ENCODING)
+        except ParsingError, exc:
             raise IndexationFailure("Cannot index document %s (%s)" % (filename, exc))
 
 



From afayolle at berlios.de  Wed Oct  5 14:02:13 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Wed, 5 Oct 2005 14:02:13 +0200
Subject: [Maay-svncheckins] r138 - in trunk/maay: . configuration test test/data
Message-ID: <200510051202.j95C2DfV002874@sheep.berlios.de>

Author: afayolle
Date: 2005-10-05 14:02:10 +0200 (Wed, 05 Oct 2005)
New Revision: 138

Added:
   trunk/maay/configuration/
   trunk/maay/configuration/indexer.ini
   trunk/maay/configuration/webapp.ini
Modified:
   trunk/maay/configuration.py
   trunk/maay/indexer.py
   trunk/maay/server.py
   trunk/maay/test/data/webapp1.ini
   trunk/maay/test/data/webapp2.ini
   trunk/maay/test/test_configuration.py
Log:
fixed configuration file handling (mainly, use INDEXER and SERVER instead of Default section)
handle '~' in index-dir and skip-dir


Added: trunk/maay/configuration/indexer.ini
===================================================================
--- trunk/maay/configuration/indexer.ini	2005-10-05 11:58:41 UTC (rev 137)
+++ trunk/maay/configuration/indexer.ini	2005-10-05 12:02:10 UTC (rev 138)
@@ -0,0 +1,8 @@
+[INDEXER]
+host: localhost
+port: 6789
+user: maay
+password: maay
+index-dir:~/
+#skip-dir:~/.firefox,~/.mozilla
+verbose: yes

Added: trunk/maay/configuration/webapp.ini
===================================================================
--- trunk/maay/configuration/webapp.ini	2005-10-05 11:58:41 UTC (rev 137)
+++ trunk/maay/configuration/webapp.ini	2005-10-05 12:02:10 UTC (rev 138)
@@ -0,0 +1,5 @@
+[SERVER]
+db-name: maay
+db-host: localhost
+user: maay
+password: maay

Modified: trunk/maay/configuration.py
===================================================================
--- trunk/maay/configuration.py	2005-10-05 11:58:41 UTC (rev 137)
+++ trunk/maay/configuration.py	2005-10-05 12:02:10 UTC (rev 138)
@@ -52,16 +52,16 @@
     options = []
     config_file = None
 
-    def __init__(self):
+    def __init__(self, name=None):
         BaseConfiguration.__init__(self, options=self.options,
-                                   config_file=self.config_file)
+                                   config_file=self.config_file,
+                                   name=name)
 
     def load(self):
         if self.config_file:
             for directory in self.get_config_dirs():
                 path = os.path.join(directory, self.config_file)
-                if os.path.exists(path):
-                    self.load_file_configuration(path)
+                self.load_file_configuration(path)
         # then override with command-line options
         self.load_command_line_configuration()
     

Modified: trunk/maay/indexer.py
===================================================================
--- trunk/maay/indexer.py	2005-10-05 11:58:41 UTC (rev 137)
+++ trunk/maay/indexer.py	2005-10-05 12:02:10 UTC (rev 138)
@@ -155,9 +155,9 @@
 class FileIterator:
     """provide a simple way to walk through indexed dirs"""
     def __init__(self, indexed, skipped=None):
-        self.indexed = [os.path.abspath(p) for p in indexed]
+        self.indexed = [os.path.abspath(os.path.expanduser(p)) for p in indexed]
         skipped = skipped or []
-        self.skipped = [os.path.abspath(p) for p in skipped]
+        self.skipped = [os.path.abspath(os.path.expanduser(p)) for p in skipped]
 
     def __iter__(self):
         for path in self.indexed:
@@ -236,6 +236,8 @@
 
     config_file = 'indexer.ini'
 
+    def __init__(self):
+        Configuration.__init__(self, name="Indexer")
 
 def run():
     indexerConfig = IndexerConfiguration()

Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-05 11:58:41 UTC (rev 137)
+++ trunk/maay/server.py	2005-10-05 12:02:10 UTC (rev 138)
@@ -313,7 +313,7 @@
     config_file = 'webapp.ini'
 
     def __init__(self):
-        Configuration.__init__(self)
+        Configuration.__init__(self, name="Server")
         self.node_id = None
 
     def get_node_id(self):

Modified: trunk/maay/test/data/webapp1.ini
===================================================================
--- trunk/maay/test/data/webapp1.ini	2005-10-05 11:58:41 UTC (rev 137)
+++ trunk/maay/test/data/webapp1.ini	2005-10-05 12:02:10 UTC (rev 138)
@@ -1,2 +1,2 @@
-[DEFAULT]
+[SERVER]
 db-host=eusebius

Modified: trunk/maay/test/data/webapp2.ini
===================================================================
--- trunk/maay/test/data/webapp2.ini	2005-10-05 11:58:41 UTC (rev 137)
+++ trunk/maay/test/data/webapp2.ini	2005-10-05 12:02:10 UTC (rev 138)
@@ -1,2 +1,2 @@
-[DEFAULT]
+[SERVER]
 db-name=muche

Modified: trunk/maay/test/test_configuration.py
===================================================================
--- trunk/maay/test/test_configuration.py	2005-10-05 11:58:41 UTC (rev 137)
+++ trunk/maay/test/test_configuration.py	2005-10-05 12:02:10 UTC (rev 138)
@@ -52,7 +52,7 @@
         try:
             configuration._update_env_path("tmp")
             envpath = os.environ['PATH']
-            regexp = r'.*;tmp[/\\]antiword;tmp[/\\]pdftohtml;tmp[/\\]mysql[/\\]bin$'
+            regexp = r'.*[:;]tmp[/\\]antiword[:;]tmp[/\\]pdftohtml[:;]tmp[/\\]mysql[/\\]bin$'
             self.failUnless(re.match(regexp, envpath)), envpath
         finally:
             sys.platform = platform



From afayolle at berlios.de  Wed Oct  5 14:09:03 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Wed, 5 Oct 2005 14:09:03 +0200
Subject: [Maay-svncheckins] r139 - trunk/maay
Message-ID: <200510051209.j95C93Uw014601@sheep.berlios.de>

Author: afayolle
Date: 2005-10-05 14:09:01 +0200 (Wed, 05 Oct 2005)
New Revision: 139

Modified:
   trunk/maay/converter.py
Log:
EOF fix

Modified: trunk/maay/converter.py
===================================================================
--- trunk/maay/converter.py	2005-10-05 12:02:10 UTC (rev 138)
+++ trunk/maay/converter.py	2005-10-05 12:09:01 UTC (rev 139)
@@ -94,9 +94,9 @@
         if filename.endswith('.gz'):
             opener = gzip.open
         elif filename.endswith('.bz2'):
-                opener = bz2.BZ2File
-        else:
-            opener = file
+                opener = bz2.BZ2File
+        else:
+            opener = file
             
         compressed = opener(filename, 'rb')
         uncompressedFile = os.path.join(outputDir, 'uncompressed')



From afayolle at berlios.de  Wed Oct  5 14:54:53 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Wed, 5 Oct 2005 14:54:53 +0200
Subject: [Maay-svncheckins] r140 - trunk
Message-ID: <200510051254.j95CsrF1016093@sheep.berlios.de>

Author: afayolle
Date: 2005-10-05 14:54:53 +0200 (Wed, 05 Oct 2005)
New Revision: 140

Modified:
   trunk/README.txt
Log:
updated mailing list information

Modified: trunk/README.txt
===================================================================
--- trunk/README.txt	2005-10-05 12:09:01 UTC (rev 139)
+++ trunk/README.txt	2005-10-05 12:54:53 UTC (rev 140)
@@ -94,7 +94,7 @@
 For now the best place to ask for help is on the development mailing
 list of Maay. You can subscribe from
 
-https://lists.berlios.de/mailman/listinfo/maay-svncheckins
+http://lists.berlios.de/mailman/listinfo/maay-dev
 
 You may also use the bug tracker on the Berlios project page at 
 http://developer.berlios.de/projects/maay/



From afayolle at berlios.de  Wed Oct  5 14:55:13 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Wed, 5 Oct 2005 14:55:13 +0200
Subject: [Maay-svncheckins] r141 - trunk
Message-ID: <200510051255.j95CtDYL016131@sheep.berlios.de>

Author: afayolle
Date: 2005-10-05 14:55:12 +0200 (Wed, 05 Oct 2005)
New Revision: 141

Modified:
   trunk/setup.py
Log:
updated mailing list information

Modified: trunk/setup.py
===================================================================
--- trunk/setup.py	2005-10-05 12:54:53 UTC (rev 140)
+++ trunk/setup.py	2005-10-05 12:55:12 UTC (rev 141)
@@ -6,7 +6,7 @@
 
 version = '0.1.0'
 author = "France Telecom R&D and Logilab"
-author_email = "maay-svncheckins at lists.berlios.de"
+author_email = "maay-dev at lists.berlios.de"
 copyright = "Copyright (c)2005 France Telecom R&D and Logilab"
 description = "a network of peers for document search"
 name = "Maay"



From adimasci at berlios.de  Wed Oct  5 15:03:40 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Wed, 5 Oct 2005 15:03:40 +0200
Subject: [Maay-svncheckins] r142 - trunk/maay
Message-ID: <200510051303.j95D3eao017000@sheep.berlios.de>

Author: adimasci
Date: 2005-10-05 15:03:39 +0200 (Wed, 05 Oct 2005)
New Revision: 142

Modified:
   trunk/maay/server.py
Log:
no more FourOhFour when reloading an existing page on a new session

Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-05 12:55:12 UTC (rev 141)
+++ trunk/maay/server.py	2005-10-05 13:03:39 UTC (rev 142)
@@ -40,12 +40,12 @@
 from maay.configuration import get_path_of, Configuration
 from maay.texttool import makeAbstract, WORDS_RGX, normalizeText
 
+
 class MaayPage(rend.Page):
     child_maaycss = static.File(get_path_of('maay.css'))
     child_images = static.File(get_path_of('images/'))
 
 
-
 class LoginForm(MaayPage):
     """a basic login form. This page is rendered until the user
     is logged.
@@ -72,7 +72,13 @@
                 ]
             ]
         )
-    
+
+    def locateChild(self, context, segments):
+        """prevent 404 by consuming all segments"""
+        return self, ()
+
+        
+
 def normalizeMimetype(fileExtension):
     import mimetypes
     return mimetypes.types_map.get('.%s' % fileExtension)



From afayolle at berlios.de  Thu Oct  6 09:44:40 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Thu, 6 Oct 2005 09:44:40 +0200
Subject: [Maay-svncheckins] r143 - trunk/maay/test
Message-ID: <200510060744.j967ieH1002205@sheep.berlios.de>

Author: afayolle
Date: 2005-10-06 09:44:39 +0200 (Thu, 06 Oct 2005)
New Revision: 143

Modified:
   trunk/maay/test/test_dbentity.py
   trunk/maay/test/test_fileiteration.py
   trunk/maay/test/test_querier.py
Log:
brought test up to date with codebase

Modified: trunk/maay/test/test_dbentity.py
===================================================================
--- trunk/maay/test/test_dbentity.py	2005-10-05 13:03:39 UTC (rev 142)
+++ trunk/maay/test/test_dbentity.py	2005-10-06 07:44:39 UTC (rev 143)
@@ -13,7 +13,9 @@
         for p in params[:-1]:
             self.assertEquals(type(p), unicode)
         self.assertEquals(len(params), params[-1] + 1)
-        expected = "SELECT D.db_document_id, D.document_id, D.title, D.size, D.text, D.url, D.mime_type FROM documents D, document_scores DS WHERE DS.db_document_id=D.db_document_id AND DS.word IN (%s, %s, %s, %s) GROUP BY DS.db_document_id HAVING count(DS.db_document_id) = %s"
+        expected = "SELECT D.db_document_id, D.document_id, D.title, D.size, D.text, D.url, D.mime_type, D.publication_time FROM documents D, document_scores DS WHERE DS.db_document_id=D.db_document_id AND DS.word IN (%s, %s, %s, %s)   GROUP BY DS.db_document_id HAVING count(DS.db_document_id) = %s LIMIT 15 OFFSET 0"
+        print query
+        print expected
         self.assertEquals(query, expected)
         q = query%tuple(params) # sanity check for argument count
         

Modified: trunk/maay/test/test_fileiteration.py
===================================================================
--- trunk/maay/test/test_fileiteration.py	2005-10-05 13:03:39 UTC (rev 142)
+++ trunk/maay/test/test_fileiteration.py	2005-10-06 07:44:39 UTC (rev 143)
@@ -5,6 +5,7 @@
 import unittest
 import os
 from os.path import join, abspath, dirname, exists
+from sets import Set
 
 from maay.indexer import FileIterator
 
@@ -48,14 +49,14 @@
         it = FileIterator(['a', 'b', 'c'])
         self.assertEquals(list(it), [])
         it = FileIterator(['data/a', 'data/b', 'data/c'])
-        expected = [abspath(join('data', 'a', 'b', 'c', 'bar')),
-                    abspath(join('data', 'a', 'b', 'c', 'foo')),
-                    abspath(join('data', 'b', 'c', 'd', 'baz')),
-                    abspath(join('data', 'b', 'c', 'd', 'spam')),
-                    abspath(join('data', 'b', 'c', 'e', 'bazbar')),
-                    abspath(join('data', 'b', 'c', 'e', 'foobar')),
-                    ]
-        self.assertEquals(list(it), expected)
+        expected = Set([abspath(join(u'data', 'a', 'b', 'c', 'bar')),
+                        abspath(join(u'data', 'a', 'b', 'c', 'foo')),
+                        abspath(join(u'data', 'b', 'c', 'd', 'baz')),
+                        abspath(join(u'data', 'b', 'c', 'd', 'spam')),
+                        abspath(join(u'data', 'b', 'c', 'e', 'bazbar')),
+                        abspath(join(u'data', 'b', 'c', 'e', 'foobar')),
+                        ])
+        self.assertEquals(Set(it), expected)
 
     def testEverythingSkipped(self):
         everything = ['data/a', 'data/b', 'data/c']
@@ -67,10 +68,10 @@
         everything = ['data/a', 'data/b', 'data/c']
         skipped = ['data/a', 'data/b/c/e']
         it = FileIterator(everything, skipped)
-        expected = [abspath(join('data', 'b', 'c', 'd', 'baz')),
-                    abspath(join('data', 'b', 'c', 'd', 'spam')),
-                    ]
-        self.assertEquals(list(it), expected)
+        expected = Set([abspath(join(u'data', 'b', 'c', 'd', 'baz')),
+                    abspath(join(u'data', 'b', 'c', 'd', 'spam')),
+                    ])
+        self.assertEquals(expected, Set(it))
 
     def testRelativePathConversion(self):
         """FileIterator should automatically convert relative paths"""

Modified: trunk/maay/test/test_querier.py
===================================================================
--- trunk/maay/test/test_querier.py	2005-10-05 13:03:39 UTC (rev 142)
+++ trunk/maay/test/test_querier.py	2005-10-06 07:44:39 UTC (rev 143)
@@ -16,6 +16,8 @@
                                   database='maay_test', user='adim',
                                   password='adim')
         self.querier = MaayQuerier(connection=self.cnx)
+        self.nodeId = '0'*40
+        self.querier.registerNode(self.nodeId, "127.0.0.1", 6789, 10)
 
     def tearDown(self):
         cursor = self.cnx.cursor()
@@ -41,7 +43,8 @@
         # should match <digest>
         matchingDocs = Document.selectWhere(cursor, document_id=digest)
         self.assertEquals(len(matchingDocs), 0)
-        self.querier.indexDocument('/tmp/Tartuffe.txt',
+        self.querier.indexDocument('0'*40,
+                                   '/tmp/Tartuffe.txt',
                                    'Le Tartuffe',
                                    text,
                                    len(text),



From afayolle at berlios.de  Thu Oct  6 09:47:06 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Thu, 6 Oct 2005 09:47:06 +0200
Subject: [Maay-svncheckins] r144 - in trunk/maay: . test
Message-ID: <200510060747.j967l65h002426@sheep.berlios.de>

Author: afayolle
Date: 2005-10-06 09:47:06 +0200 (Thu, 06 Oct 2005)
New Revision: 144

Modified:
   trunk/maay/test/test_texttool.py
   trunk/maay/texttool.py
Log:
Parsers no longer return normalized text
Fixed translation table of normalizeText()


Modified: trunk/maay/test/test_texttool.py
===================================================================
--- trunk/maay/test/test_texttool.py	2005-10-06 07:44:39 UTC (rev 143)
+++ trunk/maay/test/test_texttool.py	2005-10-06 07:47:06 UTC (rev 144)
@@ -4,9 +4,9 @@
 import unittest
 from os.path import join, dirname
 
-from maay.texttool import MaayHTMLParser, guessEncoding, open, untagText
+from maay.texttool import MaayHTMLParser, guessEncoding, open, untagText, normalizeText
 
-ROW_TEXT = u"foo ?t? bar baz top bim bam boum"
+RAW_TEXT = u"foo ?t? bar baz top bim bam boum"
 
 SIMPLE_HTML = u"""<html>
 <head><title>maille Maay</title></head>
@@ -19,22 +19,26 @@
 
 DATADIR = join(dirname(__file__), 'data')
 
+    
+
 class HTMLParserTC(unittest.TestCase):
 
     def setUp(self):
         self.parser = MaayHTMLParser()
 
     def testParseRaw(self):
-        html = '<body>%s</body>' % ROW_TEXT
+        html = '<body>%s</body>' % RAW_TEXT
         title, text, links, offset = self.parser.parseString(html)
-        self.assertEquals(title, '')
-        self.assertEquals(text, ROW_TEXT.replace(u'?', 'e'))
+        self.assertEquals(title, RAW_TEXT)
+        self.assertEquals(normalizeText(text),
+                          RAW_TEXT.replace(u'?', 'e'))
         self.assertEquals(links, [])
 
     def testParseSimpleHtml(self):
         title, text, links, offset = self.parser.parseString(SIMPLE_HTML)
         self.assertEquals(title, 'maille Maay')
-        self.assertEquals(text, 'hello ete world this is a link and this is another link')
+        self.assertEquals(normalizeText(text),
+                          'hello ete world this is a link and this is another link')
         self.assertEquals(links, ['something.com', 'somethingelse.com'])
     
 
@@ -42,14 +46,16 @@
         filename = join(DATADIR, 'encoded.html')
         title, text, links, offset = self.parser.parseFile(filename, 'iso-8859-1')
         self.assertEquals(title, 'maille Maay')
-        self.assertEquals(text, 'hello ete world this is a link and this is another link')
+        self.assertEquals(normalizeText(text),
+                          'hello ete world this is a link and this is another link')
         self.assertEquals(links, ['something.com', 'somethingelse.com'])
         
     def testParseHtmlFileAndGuessEncoding(self):
         filename = join(DATADIR, 'encoded.html')
         title, text, links, offset = self.parser.parseFile(filename)
         self.assertEquals(title, 'maille Maay')
-        self.assertEquals(text, 'hello ete world this is a link and this is another link')
+        self.assertEquals(normalizeText(text),
+                          'hello ete world this is a link and this is another link')
         self.assertEquals(links, ['something.com', 'somethingelse.com'])
         
     def test_normalizeHTMLEncoding(self):
@@ -60,6 +66,7 @@
             ]
 
     def test_parseDifficultFile(self):
+        """test_parseDifficultFile: This test fails for now"""
         # This file has got some weird, non HTML compliant content
         # and is not handled properly by HTMLParser 
         stream = file(join(DATADIR, 'node22.html'))

Modified: trunk/maay/texttool.py
===================================================================
--- trunk/maay/texttool.py	2005-10-06 07:44:39 UTC (rev 143)
+++ trunk/maay/texttool.py	2005-10-06 07:47:06 UTC (rev 144)
@@ -12,9 +12,7 @@
 
 WORD_MIN_LEN = 2
 WORD_MAX_LEN = 50
-MAX_STORED_SIZE = 65535 # not actually used in the code for now,
-                        # because the db engine does the truncation
-                        # for us
+MAX_STORED_SIZE = 65535
 
 WORDS_RGX = re.compile(r'\w{%s,%s}' % (WORD_MIN_LEN, WORD_MAX_LEN)) 
 
@@ -123,8 +121,9 @@
 class TextParser(AbstractParser):
 
     def parseString(self, source):
-        result = normalizeText(source)
-        title = result[:60]
+        result = source
+        first_line = min(80, result.find('\n'))
+        title = result[:first_line]
         return title, result, [], 0
         
 
@@ -151,6 +150,7 @@
     def handle_endtag(self, tag):
         if tag == 'title':
             self.parsingTitle = False
+        self.textbuf.append(u' ') # handle cases such as <b>titi</b><i>tutu</i>
 
     def handle_data(self, data):
         if self.parsingTitle:
@@ -163,15 +163,21 @@
             self.feed(source)
         except HTMLParseError, exc:
             print "Error parsing document: %s" % exc
-        result = normalizeText(u''.join(self.textbuf))
+        result = u'\n'.join(self.textbuf)
+        if not self.title:
+            first_line = min(80, result.find('\n'))
+            self.title = result[:first_line]
         return self.title, result, self.links, 0
 
 
         
-from string import maketrans
-_table = maketrans(
-    ''.join([chr(i) for i in xrange(32)]) + 
-    '\xc0\xc1\xc2\xc3\xc4\xc5'
+_table = {}
+for i in xrange(32):
+    _table[i] = ord(' ')
+
+
+
+for s, d in zip(    list('\xc0\xc1\xc2\xc3\xc4\xc5'
     '\xc7'
     '\xc8\xc9\xca\xcb'
     '\xcc\xcd\xce\xcf'
@@ -188,10 +194,9 @@
     '\xf1'
     '\xf2\xf3\xf4\xf5\xf6\xf8'
     '\xf9\xfa\xfb\xfc'
-    '\xff'
+    '\xff')
     ,
-    ' ' * 32 +
-    'aaaaaa'
+    list('aaaaaa'
     'c'
     'eeee'
     'iiii'
@@ -209,9 +214,8 @@
     'oooooo'
     'uuuu'
     'y'
-    )
-_table = [ord(c) for c in _table]
-del maketrans
+    )):
+    _table[ord(s)] = ord(d)
 
 def normalizeText(text, table=_table):
     """turns everything to lowercase, and converts accentuated
@@ -220,7 +224,7 @@
     :param text: **unicode** string to normalize
     """
     assert type(text) is unicode, "got %s instead of unicode !" % type(text)
-    text = text.lower().translate(table)
+    text = text.translate(table).lower()
     return ' '.join(text.split())
 
 del _table
@@ -255,5 +259,5 @@
             break
     else:
         # case where we have less than 200 characters to display
-        print "should do something sensible here"
-    return ' <b>[...]</b> '.join(buf)
+        return text[:200]
+    return u' <b>[...]</b> '.join(buf)



From afayolle at berlios.de  Thu Oct  6 10:27:46 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Thu, 6 Oct 2005 10:27:46 +0200
Subject: [Maay-svncheckins] r145 - in trunk/maay: . test
Message-ID: <200510060827.j968Rkhk005907@sheep.berlios.de>

Author: afayolle
Date: 2005-10-06 10:27:45 +0200 (Thu, 06 Oct 2005)
New Revision: 145

Modified:
   trunk/maay/indexer.py
   trunk/maay/querier.py
   trunk/maay/rpc.py
   trunk/maay/test/test_texttool.py
Log:
use utf-8 to encode xmlrpc streams
better handling of errors in xmlrpc communication


Modified: trunk/maay/indexer.py
===================================================================
--- trunk/maay/indexer.py	2005-10-06 07:47:06 UTC (rev 144)
+++ trunk/maay/indexer.py	2005-10-06 08:27:45 UTC (rev 145)
@@ -12,7 +12,7 @@
 import sys
 import sha
 from sets import Set
-from xmlrpclib import ServerProxy, Binary, Fault
+from xmlrpclib import ServerProxy, Binary, Fault, ProtocolError
 import mimetypes
 
 from maay import converter
@@ -75,7 +75,9 @@
         password = self.indexerConfig.password
         host = self.indexerConfig.host
         port = self.indexerConfig.port
-        self.serverProxy = ServerProxy('http://%s:%s' % (host, port), allow_none=True)
+        self.serverProxy = ServerProxy('http://%s:%s' % (host, port),
+                                       allow_none=True,
+                                       encoding='utf-8')
         self.cnxId, errmsg = self.serverProxy.authenticate(username, password)
         self.verbose = indexerConfig.verbose
         if not self.cnxId:
@@ -137,12 +139,12 @@
                       lastModTime, content_hash, mime_type, state,
                       file_state=FileInfo.CREATED_FILE_STATE):
         if self.verbose:
-            print "Requesting indexation of %s" % filename
+            print "Requesting indexation of %s" % filename, type(text)
         try:
             self.serverProxy.indexDocument(self.cnxId, filename, title, text,
                                            fileSize, lastModTime, content_hash,
                                            mime_type, state, file_state)
-        except Fault, exc:
+        except (Fault, ProtocolError), exc:
             if self.verbose:
                 print "An error occured on the server while indexing %s" % filename.encode('iso-8859-1')
                 print exc

Modified: trunk/maay/querier.py
===================================================================
--- trunk/maay/querier.py	2005-10-06 07:47:06 UTC (rev 144)
+++ trunk/maay/querier.py	2005-10-06 08:27:45 UTC (rev 145)
@@ -17,7 +17,7 @@
 
 from maay.dbentity import Document, FileInfo, DocumentProvider, DocumentScore, \
      Word, Node
-from maay.texttool import normalizeText, WORDS_RGX
+from maay.texttool import normalizeText, WORDS_RGX, MAX_STORED_SIZE
 
 class MaayAuthenticationError(Exception):
     """raised on db authentication failure"""
@@ -58,7 +58,7 @@
         Return document url if the document is downloadable and and
         empty string otherwise"""
         
-    def registerNode(nodeId):
+    def registerNode(nodeId, ip, port, bandwidth):
         """register the current running node in the database"""
         
     def close():
@@ -75,7 +75,6 @@
     implements(IQuerier)
     
     def __init__(self, host='', database='', user='', password='', connection=None):
-        print "hello ?"
         if connection is None:
             dbapiMod = get_dbapi_compliant_module('mysql')
             try:
@@ -248,7 +247,7 @@
                         lastModifiedOn, filename, mime_type, state):
         doc = Document(document_id=content_hash,
                        title=title,
-                       text=text,
+                       text=text[:MAX_STORED_SIZE],
                        size=fileSize,
                        publication_time=lastModifiedOn,
                        download_count=0.,

Modified: trunk/maay/rpc.py
===================================================================
--- trunk/maay/rpc.py	2005-10-06 07:47:06 UTC (rev 144)
+++ trunk/maay/rpc.py	2005-10-06 08:27:45 UTC (rev 145)
@@ -1,5 +1,6 @@
 from time import time
 from random import randint
+import sys
 
 from twisted.web.xmlrpc import XMLRPC
 from twisted.cred.credentials import UsernamePassword
@@ -84,7 +85,12 @@
         """
         filename = unicode(filename)
         title = unicode(title)
-        text = unicode(text)
+        try:
+            text = unicode(text)
+        except UnicodeError, exc:
+            print exc
+            print `text`
+            return 1
         if self.cnxIsValid(cnxId):
             querier = self._sessions[cnxId]
             querier.indexDocument(self.node_id, filename, title, text, fileSize,

Modified: trunk/maay/test/test_texttool.py
===================================================================
--- trunk/maay/test/test_texttool.py	2005-10-06 07:47:06 UTC (rev 144)
+++ trunk/maay/test/test_texttool.py	2005-10-06 08:27:45 UTC (rev 145)
@@ -115,5 +115,12 @@
         text = 'Hello <a href="foo.bar.com">world <b>!</b></a><img alt="" />'
         self.assertEquals(untagText(text), 'Hello world !')
 
+    def testNormalizeText(self):
+        text = u"? Paris,\t\x02l'?t? \nsera   chaud"
+        norm = normalizeText(text)
+        self.assertEquals(u"a paris, l'ete sera chaud", norm)
+        self.assertEquals(unicode, type(norm))
+        
+
 if __name__ == '__main__':
     unittest.main()



From afayolle at berlios.de  Thu Oct  6 11:11:34 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Thu, 6 Oct 2005 11:11:34 +0200
Subject: [Maay-svncheckins] r146 - in trunk/maay: . data
Message-ID: <200510060911.j969BYWp009904@sheep.berlios.de>

Author: afayolle
Date: 2005-10-06 11:11:34 +0200 (Thu, 06 Oct 2005)
New Revision: 146

Modified:
   trunk/maay/data/resultpage.html
   trunk/maay/data/searchform.html
   trunk/maay/indexer.py
   trunk/maay/server.py
Log:
added favicon

Modified: trunk/maay/data/resultpage.html
===================================================================
--- trunk/maay/data/resultpage.html	2005-10-06 08:27:45 UTC (rev 145)
+++ trunk/maay/data/resultpage.html	2005-10-06 09:11:34 UTC (rev 146)
@@ -4,7 +4,8 @@
   <head>
     <title>Results</title>
     <link rel="stylesheet" type="text/css" href="maaycss"/>
-  </head>
+    <link rel="shortcut icon" href="images/maay.ico" />
+ </head>
  
   <body>
     <div class="reSearch">

Modified: trunk/maay/data/searchform.html
===================================================================
--- trunk/maay/data/searchform.html	2005-10-06 08:27:45 UTC (rev 145)
+++ trunk/maay/data/searchform.html	2005-10-06 09:11:34 UTC (rev 146)
@@ -4,6 +4,7 @@
   <head>
     <title>Search Form</title>
     <link rel="stylesheet" type="text/css" href="maaycss"/>
+    <link rel="shortcut icon" href="images/maay.ico" />
   </head>
  
   <body>

Modified: trunk/maay/indexer.py
===================================================================
--- trunk/maay/indexer.py	2005-10-06 08:27:45 UTC (rev 145)
+++ trunk/maay/indexer.py	2005-10-06 09:11:34 UTC (rev 146)
@@ -139,7 +139,7 @@
                       lastModTime, content_hash, mime_type, state,
                       file_state=FileInfo.CREATED_FILE_STATE):
         if self.verbose:
-            print "Requesting indexation of %s" % filename, type(text)
+            print "Requesting indexation of %s" % filename
         try:
             self.serverProxy.indexDocument(self.cnxId, filename, title, text,
                                            fileSize, lastModTime, content_hash,

Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-06 08:27:45 UTC (rev 145)
+++ trunk/maay/server.py	2005-10-06 09:11:34 UTC (rev 146)
@@ -53,7 +53,11 @@
     addSlash = True
     docFactory = loaders.stan(
         tags.html[
-            tags.head[tags.title["Maay Login Page"]],
+            tags.head[tags.title["Maay Login Page",],
+                      tags.link(rel='stylesheet', type='text/css', href='maaycss'),
+                      tags.link(rel='shortcut icon', href='images/maay.ico'),
+                      ],
+            
             tags.body[
                 tags.form(action=guard.LOGIN_AVATAR, method='post')[
                     tags.table(_class="loginTable")[



From afayolle at berlios.de  Thu Oct  6 11:17:10 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Thu, 6 Oct 2005 11:17:10 +0200
Subject: [Maay-svncheckins] r147 - trunk/maay/data
Message-ID: <200510060917.j969HApU010392@sheep.berlios.de>

Author: afayolle
Date: 2005-10-06 11:17:09 +0200 (Thu, 06 Oct 2005)
New Revision: 147

Modified:
   trunk/maay/data/resultpage.html
   trunk/maay/data/searchform.html
Log:
added link to maay home page and berlios project page


Modified: trunk/maay/data/resultpage.html
===================================================================
--- trunk/maay/data/resultpage.html	2005-10-06 09:11:34 UTC (rev 146)
+++ trunk/maay/data/resultpage.html	2005-10-06 09:17:09 UTC (rev 147)
@@ -27,6 +27,12 @@
 	</td>
       </tr>
     </table>
-    <div class="prevnext"><a><nevow:attr name="href" nevow:render="prevset_url"/>Previous</a> - <a><nevow:attr name="href" nevow:render="nextset_url"/>Next</a></div>
+    <div class="prevnext"><a><nevow:attr name="href"
+    nevow:render="prevset_url"/>Previous</a> - <a><nevow:attr
+    name="href" nevow:render="nextset_url"/>Next</a></div>
+    <hr />
+    <a href="http://maay.netofpeers.net/">Maay Home page</a> <a href="http://developer.berlios.de/projects/maay/">
+<img src="http://developer.berlios.de/bslogo.php?group_id=0"
+    width="124" height="32" border="0" alt="BerliOS Logo" /></a>
   </body>  
 </html>

Modified: trunk/maay/data/searchform.html
===================================================================
--- trunk/maay/data/searchform.html	2005-10-06 09:11:34 UTC (rev 146)
+++ trunk/maay/data/searchform.html	2005-10-06 09:17:09 UTC (rev 147)
@@ -21,5 +21,10 @@
 	</td>
       </tr>
     </table>
-  </body>  
+    <hr />
+    <a href="http://maay.netofpeers.net/">Maay Home page</a> <a href="http://developer.berlios.de/projects/maay/">
+<img src="http://developer.berlios.de/bslogo.php?group_id=0"
+    width="124" height="32" border="0" alt="BerliOS Logo" /></a>
+
+    </body>  
 </html>



From afayolle at berlios.de  Thu Oct  6 11:23:36 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Thu, 6 Oct 2005 11:23:36 +0200
Subject: [Maay-svncheckins] r148 - trunk/maay
Message-ID: <200510060923.j969NaPh010733@sheep.berlios.de>

Author: afayolle
Date: 2005-10-06 11:23:36 +0200 (Thu, 06 Oct 2005)
New Revision: 148

Modified:
   trunk/maay/server.py
Log:
auto relogin  when server restarded

Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-06 09:17:09 UTC (rev 147)
+++ trunk/maay/server.py	2005-10-06 09:23:36 UTC (rev 148)
@@ -59,7 +59,7 @@
                       ],
             
             tags.body[
-                tags.form(action=guard.LOGIN_AVATAR, method='post')[
+                tags.form(action='/'+guard.LOGIN_AVATAR, method='post')[
                     tags.table(_class="loginTable")[
                         tags.tr[
                             tags.td[ "Username:" ],



From afayolle at berlios.de  Thu Oct  6 12:11:10 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Thu, 6 Oct 2005 12:11:10 +0200
Subject: [Maay-svncheckins] r149 - in trunk/maay: . test
Message-ID: <200510061011.j96ABAFl015658@sheep.berlios.de>

Author: afayolle
Date: 2005-10-06 12:11:10 +0200 (Thu, 06 Oct 2005)
New Revision: 149

Modified:
   trunk/maay/indexer.py
   trunk/maay/test/test_texttool.py
   trunk/maay/texttool.py
Log:
fixed xmlrpm ProtocolError caused by illegal chars in XML payload

Modified: trunk/maay/indexer.py
===================================================================
--- trunk/maay/indexer.py	2005-10-06 09:23:36 UTC (rev 148)
+++ trunk/maay/indexer.py	2005-10-06 10:11:10 UTC (rev 149)
@@ -19,6 +19,7 @@
 from maay.configuration import Configuration
 from maay.dbentity import Document, FileInfo
 from maay.querier import MaayAuthenticationError
+from maay.texttool import removeControlChar
 
 # grabbed from nevow
 mimetypes.types_map.update(
@@ -141,6 +142,8 @@
         if self.verbose:
             print "Requesting indexation of %s" % filename
         try:
+            title = removeControlChar(title)
+            text = removeControlChar(text)
             self.serverProxy.indexDocument(self.cnxId, filename, title, text,
                                            fileSize, lastModTime, content_hash,
                                            mime_type, state, file_state)

Modified: trunk/maay/test/test_texttool.py
===================================================================
--- trunk/maay/test/test_texttool.py	2005-10-06 09:23:36 UTC (rev 148)
+++ trunk/maay/test/test_texttool.py	2005-10-06 10:11:10 UTC (rev 149)
@@ -4,7 +4,7 @@
 import unittest
 from os.path import join, dirname
 
-from maay.texttool import MaayHTMLParser, guessEncoding, open, untagText, normalizeText
+from maay.texttool import MaayHTMLParser, guessEncoding, open, untagText, normalizeText, removeControlChar
 
 RAW_TEXT = u"foo ?t? bar baz top bim bam boum"
 
@@ -121,6 +121,13 @@
         self.assertEquals(u"a paris, l'ete sera chaud", norm)
         self.assertEquals(unicode, type(norm))
         
+    def testRemoveControlChar(self):
+        text = u''.join([chr(i) for i in range(32)])
+        text += u'\uFFEF\uFFFE\uFFFF'
+        text += u'\uDA00toto\U00011234'
+        norm = removeControlChar(text)
+        self.assertEquals(u"\t\n\r\uFFEFtoto\U00011234", norm)
+        self.assertEquals(unicode, type(norm))
 
 if __name__ == '__main__':
     unittest.main()

Modified: trunk/maay/texttool.py
===================================================================
--- trunk/maay/texttool.py	2005-10-06 09:23:36 UTC (rev 148)
+++ trunk/maay/texttool.py	2005-10-06 10:11:10 UTC (rev 149)
@@ -174,6 +174,7 @@
 _table = {}
 for i in xrange(32):
     _table[i] = ord(' ')
+del i
 
 
 
@@ -238,7 +239,23 @@
     """
     rgx = re.compile('<.*?>')
     return rgx.sub('', text)
+
+_table2 = {}
+for i in range(0x20) + range(0xD800,0xE000) + [0xFFFE, 0xFFFF]:
+    _table2[i] = None
+for i in (0x9, 0xA, 0xD):
+    del _table2[i]
+del i
+
     
+def removeControlChar(text, table= _table2):
+    """remove control characters which are not allowed in XML 1.0"""
+    # This is required to prevent internal errors in the xmlrpc server
+    assert type(text) is unicode, "got %s instead of unicode !" % type(text)
+    return text.translate(table)
+del _table2
+    
+
 def makeAbstract(text, words):
     """return the original text with HTML emphasis tags
     around <words> occurences



From adimasci at berlios.de  Thu Oct  6 13:42:56 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Thu, 6 Oct 2005 13:42:56 +0200
Subject: [Maay-svncheckins] r150 - in trunk/maay: . data sql test
Message-ID: <200510061142.j96Bgui1024523@sheep.berlios.de>

Author: adimasci
Date: 2005-10-06 13:42:34 +0200 (Thu, 06 Oct 2005)
New Revision: 150

Modified:
   trunk/maay/data/resultpage.html
   trunk/maay/data/searchform.html
   trunk/maay/dbentity.py
   trunk/maay/querier.py
   trunk/maay/rpc.py
   trunk/maay/server.py
   trunk/maay/sql/mysql.sql
   trunk/maay/test/test_rpc.py
Log:
There is now no need to be authentified to use webserver and rpc server.

This is still quite experimental. In particular, cases wher anonymous
querier can't be built at init time are probably not handled correctly.



Modified: trunk/maay/data/resultpage.html
===================================================================
--- trunk/maay/data/resultpage.html	2005-10-06 10:11:10 UTC (rev 149)
+++ trunk/maay/data/resultpage.html	2005-10-06 11:42:34 UTC (rev 150)
@@ -8,6 +8,7 @@
  </head>
  
   <body>
+    <a nevow:render="loginurl"><nevow:attr name="href"><nevow:slot name="loginurl" /></nevow:attr><nevow:slot name="actionlabel" /></a>
     <div class="reSearch">
       <img src="images/smallmaay.png" />
       <form action="search">

Modified: trunk/maay/data/searchform.html
===================================================================
--- trunk/maay/data/searchform.html	2005-10-06 10:11:10 UTC (rev 149)
+++ trunk/maay/data/searchform.html	2005-10-06 11:42:34 UTC (rev 150)
@@ -8,6 +8,7 @@
   </head>
  
   <body>
+    <a href="login">Login</a>    
     <table class="searchHome">
       <tr>
 	<td><img src="images/maay.png" /></td>

Modified: trunk/maay/dbentity.py
===================================================================
--- trunk/maay/dbentity.py	2005-10-06 10:11:10 UTC (rev 149)
+++ trunk/maay/dbentity.py	2005-10-06 11:42:34 UTC (rev 150)
@@ -193,7 +193,7 @@
     abstract = property(get_abstract)
 
 
-    def _selectContainingQuery(cls, words, mimetype=None, offset=0):
+    def _selectContainingQuery(cls, words, mimetype=None, offset=0, allowPrivate=False):
         words = [normalizeText(unicode(w))
                  for w in words
                  if WORD_MIN_LEN <= len(w) <= WORD_MAX_LEN]
@@ -207,6 +207,9 @@
         else:
             restriction = ""
             restrictionParams = []
+        if not allowPrivate:
+            restriction += " AND D.state=%s "
+            restrictionParams.append(cls.PUBLISHED_STATE)
         # Question: what is the HAVING clause supposed to do ?
         # Answer: we select all documents containing one of the words
         # that we are looking for, group them by their identifier, and
@@ -234,10 +237,11 @@
 
     _selectContainingQuery = classmethod(_selectContainingQuery)
 
-    def selectContaining(cls, cursor, words, mimetype=None, offset=0):
-        query, params= cls._selectContainingQuery(words, mimetype, offset=offset)
+    def selectContaining(cls, cursor, words, mimetype=None, offset=0, allowPrivate=False):
+        query, params= cls._selectContainingQuery(words, mimetype,
+                                                  offset=offset,
+                                                  allowPrivate=allowPrivate)
         if query:
-            print "QUERY =", query, "params =", params
             cursor.execute(query, params)
             results = cursor.fetchall()
             return [cls(**dict(zip(['db_document_id', 'document_id', 'title', 'size', 'text', 'url', 'mime_type', 'publication_time'],
@@ -247,10 +251,8 @@
             return []
     selectContaining = classmethod(selectContaining)
     
-    
 
 
-
 class FileInfo(DBEntity):
     """
     Attributes:

Modified: trunk/maay/querier.py
===================================================================
--- trunk/maay/querier.py	2005-10-06 10:11:10 UTC (rev 149)
+++ trunk/maay/querier.py	2005-10-06 11:42:34 UTC (rev 150)
@@ -22,6 +22,8 @@
 class MaayAuthenticationError(Exception):
     """raised on db authentication failure"""
 
+ANONYMOUS_AVATARID = '__anonymous__'
+
     
 class IQuerier(Interface):
     """defines the High-Level interface to Maay SQL database"""
@@ -64,15 +66,14 @@
     def close():
         """closes the DB connection"""
 
-        
-class MaayQuerier:
-    """High-Level interface to Maay SQL database.
 
-    The Querier receives requests from other components to insert or
-    read data in the SQL database and dutifully executes these
-    requests"""
-    
+class AnonymousQuerier:
+    """High-Level interface to Maay SQL database for anonymous
+    (typically peers) users
+    """
     implements(IQuerier)
+
+    searchInPrivate = False
     
     def __init__(self, host='', database='', user='', password='', connection=None):
         if connection is None:
@@ -113,17 +114,142 @@
 
     def close(self):
         self._cnx.close()
-    
+
     def findDocuments(self, query):
         """Find all indexed documents matching the query"""
         words = WORDS_RGX.findall(normalizeText(query.words))
         self._updateQueryStatistics(words)
         try:
             cursor = self._cnx.cursor()
-            return Document.selectContaining(cursor, words, query.filetype)
+            return Document.selectContaining(cursor, words, query.filetype, query.offset,
+                                             self.searchInPrivate)
         finally:
             cursor.close()
 
+    def _updateScores(self, cursor, db_document_id, text):
+        # insert or update in table document_score
+        db_scores = self._getScoresDict(cursor, db_document_id)
+        doc_scores = {}
+        # We update the document_score table only for the first
+        # occurence of the word in the document
+        for match in WORDS_RGX.finditer(normalizeText(text)):
+            word = match.group(0)
+            if word in doc_scores:
+                continue
+            doc_scores[word] = 0
+            position = match.start()
+            if word in db_scores :
+                if db_scores[word].position != position:
+                    db_scores[word].position = position
+                    db_scores[word].commit(cursor, update=True)
+            else:
+                # insert a row in the Word table if required
+                self._ensureWordInDatabase(cursor, word)
+                db_score = DocumentScore(db_document_id=db_document_id,
+                                         word=word,
+                                         position=position,
+                                         download_count=0.,
+                                         relevance=0.,
+                                         popularity=0.)
+                db_score.commit(cursor, update = False)
+                    
+
+    def _ensureWordInDatabase(self, cursor, word):
+        db_words = Word.selectWhere(cursor, word=word)
+        if not db_words:
+            db_word = Word(word=word,
+                           claim_count=0.,
+                           download_count=0.)
+            db_word.commit(cursor, update=False)
+        
+    def _getScoresDict(self, cursor, db_document_id):
+        _scores = DocumentScore.selectWhere(cursor, db_document_id=db_document_id)
+        db_scores = {}
+        while _scores:
+            score = _scores.pop()
+            db_scores[score.word] = score
+        return db_scores
+
+
+    def _updateQueryStatistics(self, words):
+        # FIXME: update node_interests too
+        cursor = self._cnx.cursor()
+        for word in words:
+            winfo = Word.selectOrInsertWhere(cursor, word=word)[0]
+            winfo.claim_count += 1 / len(words)
+            winfo.commit(cursor, update=True)
+        cursor.close
+        self._cnx.commit()
+
+
+    def notifyDownload(self, db_document_id, query):
+        words = WORDS_RGX.findall(normalizeText(query))
+        try:
+            try:
+                cursor = self._cnx.cursor()
+                doc = Document.selectWhere(cursor, db_document_id=db_document_id)[0]
+            finally:
+                cursor.close()
+            self._updateDownloadStatistics(doc, words)
+            return doc.url
+        except IndexError:
+            return ''
+
+    def _updateDownloadStatistics(self, document, words):
+        cursor = self._cnx.cursor()
+        document.download_count = max(0, document.download_count) + 1
+        document.commit(cursor, update=True)
+        db_document_id = document.db_document_id
+        scores = {}
+        wordInfo = {}
+        for word in words:
+            scores[word] = DocumentScore.selectOrInsertWhere(cursor,
+                                      db_document_id=db_document_id,
+                                      word=word)[0]
+            wordInfo[word] = Word.selectOrInsertWhere(cursor,
+                                                      word=word)[0]
+
+        for winfo in wordInfo.itervalues():
+            winfo.download_count += 1/len(words)
+            winfo.commit(cursor, update=True)
+
+        for word,score in scores.iteritems():
+            score.download_count = max(0, score.download_count) + 1/len(words)
+            winfo_downloads = wordInfo[word].download_count
+            
+            score.popularity = score.download_count / winfo_downloads
+            score.popularity -= hoeffding_deviation(winfo_downloads)
+            
+            score.relevance = score.download_count / document.download_count
+            score.relevance -= hoeffding_deviation(document.download_count)
+            
+            score.commit(cursor, update=True)
+        cursor.close()
+        self._cnx.commit()
+
+
+    def registerNode(self, nodeId, ip, port, bandwidth):
+        cursor = self._cnx.cursor()
+        node = Node.selectOrInsertWhere(cursor, node_id=nodeId)[0]
+        node.ip = ip
+        node.port = port
+        node.bandwidth = bandwidth
+        node.last_seen_time = int(time.time())
+        node.commit(cursor, update=True)
+
+
+    
+class MaayQuerier(AnonymousQuerier):
+    """High-Level interface to Maay SQL database.
+
+    The Querier receives requests from other components to insert or
+    read data in the SQL database and dutifully executes these
+    requests"""
+    
+    implements(IQuerier)
+
+    searchInPrivate = True
+
     def getFileInformations(self, filename):
         cursor = self._cnx.cursor()
         results = FileInfo.selectWhere(cursor, file_name=filename)
@@ -260,115 +386,5 @@
         doc = Document.selectWhere(cursor, document_id=content_hash)[0]
         return doc
 
-    def _updateScores(self, cursor, db_document_id, text):
-        # insert or update in table document_score
-        db_scores = self._getScoresDict(cursor, db_document_id)
-        doc_scores = {}
-        # We update the document_score table only for the first
-        # occurence of the word in the document
-        for match in WORDS_RGX.finditer(normalizeText(text)):
-            word = match.group(0)
-            if word in doc_scores:
-                continue
-            doc_scores[word] = 0
-            position = match.start()
-            if word in db_scores :
-                if db_scores[word].position != position:
-                    db_scores[word].position = position
-                    db_scores[word].commit(cursor, update=True)
-            else:
-                # insert a row in the Word table if required
-                self._ensureWordInDatabase(cursor, word)
-                db_score = DocumentScore(db_document_id=db_document_id,
-                                         word=word,
-                                         position=position,
-                                         download_count=0.,
-                                         relevance=0.,
-                                         popularity=0.)
-                db_score.commit(cursor, update = False)
-                    
-
-    def _ensureWordInDatabase(self, cursor, word):
-        db_words = Word.selectWhere(cursor, word=word)
-        if not db_words:
-            db_word = Word(word=word,
-                           claim_count=0.,
-                           download_count=0.)
-            db_word.commit(cursor, update=False)
-        
-    def _getScoresDict(self, cursor, db_document_id):
-        _scores = DocumentScore.selectWhere(cursor, db_document_id=db_document_id)
-        db_scores = {}
-        while _scores:
-            score = _scores.pop()
-            db_scores[score.word] = score
-        return db_scores
-
-    def notifyDownload(self, db_document_id, query):
-        words = WORDS_RGX.findall(normalizeText(query))
-        try:
-            try:
-                cursor = self._cnx.cursor()
-                doc = Document.selectWhere(cursor, db_document_id=db_document_id)[0]
-            finally:
-                cursor.close()
-            self._updateDownloadStatistics(doc, words)
-            return doc.url
-        except IndexError:
-            return ''
-
-    def _updateQueryStatistics(self, words):
-        # FIXME: update node_interests too
-        cursor = self._cnx.cursor()
-        for word in words:
-            winfo = Word.selectOrInsertWhere(cursor, word=word)[0]
-            winfo.claim_count += 1 / len(words)
-            winfo.commit(cursor, update=True)
-        cursor.close
-        self._cnx.commit()
-
-    def _updateDownloadStatistics(self, document, words):
-        cursor = self._cnx.cursor()
-        document.download_count = max(0, document.download_count) + 1
-        document.commit(cursor, update=True)
-        db_document_id = document.db_document_id
-        scores = {}
-        wordInfo = {}
-        for word in words:
-            scores[word] = DocumentScore.selectOrInsertWhere(cursor,
-                                      db_document_id=db_document_id,
-                                      word=word)[0]
-            wordInfo[word] = Word.selectOrInsertWhere(cursor,
-                                                      word=word)[0]
-
-        for winfo in wordInfo.itervalues():
-            winfo.download_count += 1/len(words)
-            winfo.commit(cursor, update=True)
-
-        for word,score in scores.iteritems():
-            score.download_count = max(0, score.download_count) + 1/len(words)
-            winfo_downloads = wordInfo[word].download_count
-            
-            score.popularity = score.download_count / winfo_downloads
-            score.popularity -= hoeffding_deviation(winfo_downloads)
-            
-            score.relevance = score.download_count / document.download_count
-            score.relevance -= hoeffding_deviation(document.download_count)
-            
-            score.commit(cursor, update=True)
-        cursor.close()
-        self._cnx.commit()
-
-
-    def registerNode(self, nodeId, ip, port, bandwidth):
-        cursor = self._cnx.cursor()
-        node = Node.selectOrInsertWhere(cursor, node_id=nodeId)[0]
-        node.ip = ip
-        node.port = port
-        node.bandwidth = bandwidth
-        node.last_seen_time = int(time.time())
-        node.commit(cursor, update=True)
-
-
 def hoeffding_deviation(occurence, confidence=0.9):
      return sqrt(-log(confidence / 2) / (2 * occurence))

Modified: trunk/maay/rpc.py
===================================================================
--- trunk/maay/rpc.py	2005-10-06 10:11:10 UTC (rev 149)
+++ trunk/maay/rpc.py	2005-10-06 11:42:34 UTC (rev 150)
@@ -3,12 +3,12 @@
 import sys
 
 from twisted.web.xmlrpc import XMLRPC
-from twisted.cred.credentials import UsernamePassword
+from twisted.cred.credentials import UsernamePassword, Anonymous
 from twisted.cred.error import UnauthorizedLogin
 from twisted.internet import defer
 ## from twisted.python.failure import Failure
 
-from maay.querier import MaayQuerier, IQuerier
+from maay.querier import MaayQuerier, IQuerier, ANONYMOUS_AVATARID
 
 def make_uid(username, password):
     """forge a unique identifier"""
@@ -23,6 +23,7 @@
         self._sessions = {}
         self.portal = portal
         self.node_id = portal.config.get_node_id()
+        self._sessions[ANONYMOUS_AVATARID] = portal.anonymousQuerier
         
     def _attachUser(self, (interface, querier, logout), username, password):
         if interface is not IQuerier or querier is None:
@@ -36,9 +37,15 @@
 
     def xmlrpc_authenticate(self, username, password):
         """server authentication method"""
-        creds = UsernamePassword(username, password)
+        # anonymous login
+        if (username, password) == ('', ''):
+            creds = Anonymous()
+            onSuccess = lambda d,u,p: (ANONYMOUS_AVATARID, '')
+        else:
+            creds = UsernamePassword(username, password)
+            onSuccess = self._attachUser
         d = self.portal.login(creds, None, IQuerier)
-        d.addCallback(self._attachUser, username, password)
+        d.addCallback(onSuccess, username, password) # self._attachUser, username, password)
         d.addErrback(lambda failure: ('', str(failure)))
         return d
 

Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-06 10:11:10 UTC (rev 149)
+++ trunk/maay/server.py	2005-10-06 11:42:34 UTC (rev 150)
@@ -27,6 +27,7 @@
 from twisted.python import failure
 
 from nevow import inevow, rend, tags, guard, loaders, appserver
+from nevow.url import URL
 # this is to help py2exe
 import nevow.flat.flatstan
 import nevow.query
@@ -35,7 +36,8 @@
 
 from logilab.common.textutils import normalize_text
 
-from maay.querier import MaayQuerier, IQuerier, MaayAuthenticationError
+from maay.querier import MaayQuerier, IQuerier, AnonymousQuerier, \
+     MaayAuthenticationError, ANONYMOUS_AVATARID
 from maay.rpc import MaayRPCServer
 from maay.configuration import get_path_of, Configuration
 from maay.texttool import makeAbstract, WORDS_RGX, normalizeText
@@ -45,7 +47,29 @@
     child_maaycss = static.File(get_path_of('maay.css'))
     child_images = static.File(get_path_of('images/'))
 
+    def __init__(self, maayId):
+        rend.Page.__init__(self)
+        self.maayId = maayId
 
+    def render_loginurl(self, context, data):
+        if self.maayId != ANONYMOUS_AVATARID:
+            context.fillSlots('actionlabel', 'Logout')
+            context.fillSlots('loginurl', '/logout')
+        else:
+            context.fillSlots('actionlabel', 'Login')            
+            context.fillSlots('loginurl', '/login')
+        return context.tag
+
+    def child_login(self, context):
+        return LoginForm(self.maayId)
+
+    def child_logout(self, context):
+        print "sure we're not here ?"
+        req = inevow.IRequest(context)
+        req.getSession().expire()
+        req.redirect('/' + guard.LOGOUT_AVATAR)
+
+
 class LoginForm(MaayPage):
     """a basic login form. This page is rendered until the user
     is logged.
@@ -77,12 +101,7 @@
             ]
         )
 
-    def locateChild(self, context, segments):
-        """prevent 404 by consuming all segments"""
-        return self, ()
 
-        
-
 def normalizeMimetype(fileExtension):
     import mimetypes
     return mimetypes.types_map.get('.%s' % fileExtension)
@@ -125,12 +144,11 @@
     addSlash = True
 
     def __init__(self, maayId, querier):
-        MaayPage.__init__(self)
-        self.maayId = maayId
+        MaayPage.__init__(self, maayId)
         self.querier = querier
 
     def logout(self):
-        print "Bye"
+        print "Bye %s !" % (self.maayId,)
         # XXX: logout message should be forwarded to registration server
         return None
 
@@ -139,7 +157,7 @@
         offset = int(context.arg('offset', 0))
         query = Query.fromRawQuery(unicode(context.arg('words')), offset)
         results = self.querier.findDocuments(query)
-        return ResultsPage(results, query)
+        return ResultsPage(self.maayId, results, query)
 
     # XXX make sure that the requested document is really in the database
     # XXX don't forget to update the download statistics of the document
@@ -153,13 +171,14 @@
         else:
             return PageNotFound()
 
+
 class ResultsPage(MaayPage):
     """default results page"""
     docFactory = loaders.xmlfile(get_path_of('resultpage.html'))
     addSlash = False
     
-    def __init__(self, results, query):
-        MaayPage.__init__(self)
+    def __init__(self, maayId, results, query):
+        MaayPage.__init__(self, maayId)
         self.results = results
         self.query = query.words # unicode(query)
 
@@ -203,6 +222,13 @@
         return context.tag
 
 ## nevow app/server setup ############################################
+
+# MaayMindFactory might be helpful to access request informations
+# in portal. (not sure it's really aimed to be used this way :-)
+class MaayMindFactory:
+    def __init__(self, request, credentials):
+        pass
+
 class MaayRealm:
     """simple realm for Maay application"""
     implements(portal.IRealm)
@@ -217,25 +243,30 @@
 
 
     def requestAvatar(self, avatarId, mind, *interfaces):
+        """Our realm provides 2 different kinds of avatars :
+          - HTML resources (for web applications)
+          - queriers (for XMLRPC queries)
+
+        Both kind of avatars rely on a querier instance
+        """
         for iface in interfaces:
+            # if we were asked for a web resource
             if iface is inevow.IResource:
-                if avatarId is ANONYMOUS:
-                    resc = LoginForm()
-                    return inevow.IResource, resc, lambda: None
+                querier = self._getQuerier(avatarId)
+                if querier is None:
+                    return inevow.IResource, LoginForm(), lambda: None
                 else:
-                    querier = self._getQuerier(avatarId)
-                    if querier is None:
-                        return inevow.IResource, LoginForm(), lambda: None
-                    else:
-                        resc = SearchForm(avatarId, querier)
-                        return inevow.IResource, resc, resc.logout
+                    print "Building search form with", avatarId
+                    resc = SearchForm(avatarId, querier)
+                return inevow.IResource, resc, resc.logout
+            # if we wera asked for a querier
             elif iface is IQuerier:
                 querier = self._getQuerier(avatarId)
                 if querier is None:
                     return IQuerier, None, lambda: None
                 else:
                     return IQuerier, querier, querier.close
-
+                
     def _getQuerier(self, avatarId):
         try:
             querier = self._sessions[avatarId]
@@ -245,6 +276,7 @@
             querier = None
         return querier
 
+
 class MaayPortal(portal.Portal):
     """Portal for Maay authentication system"""
     def __init__(self, webappConfig):
@@ -252,21 +284,36 @@
         checker = DBAuthChecker(realm, webappConfig.db_host,
                                 webappConfig.db_name)
         portal.Portal.__init__(self, realm, (checker,))
-        self.registerChecker(AllowAnonymousAccess(), IAnonymous)
+        self.registerChecker(MaayAnonymousChecker(), IAnonymous)
         self.config = webappConfig
-        realm.createUserSession(None,
-                                MaayQuerier(host=webappConfig.db_host,
-                                            database=webappConfig.db_name,
-                                            user=webappConfig.user,
-                                            password=webappConfig.password))
-        querier = realm._getQuerier(None)
-        # FIXME: put these values in a configuration file somewhere
-        querier.registerNode(webappConfig.get_node_id(),
-                             ip=socket.gethostbyname(socket.gethostname()),
-                             port=6789,
-                             bandwidth=10)
-        
-        
+        # Create default anonymous querier, based on local configuration
+        try:
+            anonymousQuerier = AnonymousQuerier(host=webappConfig.db_host,
+                                                database=webappConfig.db_name,
+                                                user=webappConfig.user,
+                                                password=webappConfig.password)
+        except Exception, exc:
+            # unable to create an anonymous querier
+            print "***"
+            print "*** Could not create anonymous querier"
+            print "*** Got exception", exc
+            print "*** This will disable the P2P functionalities"
+            print "*** and force the user to login for local search"
+            print "***"
+            anonymousQuerier = None
+        else:
+            realm.createUserSession(ANONYMOUS_AVATARID, anonymousQuerier)
+            anonymousQuerier.registerNode(self.config.get_node_id(),
+                                          ip=socket.gethostbyname(socket.gethostname()),
+                                          port=6789, bandwidth=10)
+        self.anonymousQuerier = anonymousQuerier
+
+class MaayAnonymousChecker(AllowAnonymousAccess):
+    """don't use default twisted.cred anonymous avatarId"""
+    def requestAvatarId(self, credentials):
+        return ANONYMOUS_AVATARID
+
+
 class DBAuthChecker:
     """user authentication checker
     cf. twisted's CRED system for more details
@@ -308,14 +355,14 @@
         ('user',
          {'type': 'string',
           'metavar': '<userid>', 'short': 'u',
-          'help': 'identifier to use to connect to the database',
+          'help': 'login of anonymous user to use to connect to the database',
           'default' : "maay",
           }),
 
         ('password',
          {'type': 'string',
           'metavar': '<password>', 'short' : "p",
-          'help': 'password to use to connect to the database',
+          'help': 'password of anonymous user to use to connect to the database',
           'default' : "maay",
           }),
         ]
@@ -343,7 +390,7 @@
                     node_id = line.strip()
                     assert re.match('^[0-9a-fA-F]{40}$', node_id)
                     f.close()
-                    return node_id    
+                    return node_id
             except IOError:
                 continue
         self._write_node_id()
@@ -382,7 +429,8 @@
     webappConfig = WebappConfiguration()
     webappConfig.load()
     maayPortal = MaayPortal(webappConfig)
-    website = appserver.NevowSite(guard.SessionWrapper(maayPortal))
+    website = appserver.NevowSite(guard.SessionWrapper(maayPortal,
+                                                       mindFactory=MaayMindFactory))
     rpcserver = server.Site(MaayRPCServer(maayPortal))
     reactor.listenTCP(8080, website)
     reactor.listenTCP(6789, rpcserver)

Modified: trunk/maay/sql/mysql.sql
===================================================================
--- trunk/maay/sql/mysql.sql	2005-10-06 10:11:10 UTC (rev 149)
+++ trunk/maay/sql/mysql.sql	2005-10-06 11:42:34 UTC (rev 150)
@@ -148,7 +148,13 @@
 
 
 -- ---------------------------------------------------------
--- maay user
+-- maay user (anonymous user, used to create connections
+-- for peers)
 -- ---------------------------------------------------------
 
 grant all on maay.* to "maay"@"localhost" identified by "maay";
+-- grant udpate on maay.documents to "maay"@"localhost" identified by "maay";
+-- grant update on maay.words to "maay"@"localhost" identified by "maay";
+-- grant update on maay.nodes to "maay"@"localhost" identified by "maay";
+-- grant update on maay.nodes_interests to "maay"@"localhost" identified by "maay";
+-- grant update on document_scores to "maay"@"localhost" identified by "maay";

Modified: trunk/maay/test/test_rpc.py
===================================================================
--- trunk/maay/test/test_rpc.py	2005-10-06 10:11:10 UTC (rev 149)
+++ trunk/maay/test/test_rpc.py	2005-10-06 11:42:34 UTC (rev 150)
@@ -16,7 +16,7 @@
 from twisted.cred.credentials import IUsernamePassword
 
 from maay import rpc
-from maay.querier import MaayQuerier
+from maay.querier import MaayQuerier, AnonymousQuerier, ANONYMOUS_AVATARID
 from maay.server import MaayPortal, WebappConfiguration
 
 class FakeConnection:
@@ -69,13 +69,20 @@
         proxy = xmlrpc.Proxy('http://localhost:%s' % self.port)
         return proxy.callRemote(methName, *args)        
     
+    def testAnonymousAuthentication(self):
+        digest = self._callRemote('authenticate', '', '')
+        got, _ = unittest.deferredResult(digest)
+        self.assertEquals(_, '')
+        self.assertEquals(got, ANONYMOUS_AVATARID)
+
     def testRawAuthentication(self):
         for user, passwd in [('adim', 'adim'), ('foo', 'bar')]:
             digest = self._callRemote('authenticate', user, passwd)
             expected = rpc.make_uid(user, passwd)
             got, _ = unittest.deferredResult(digest)
-            self.assertEquals(got, expected)
-
+            self.assertEquals(got, expected, ('%s != %s (%s)' % (got, expected, _)))
+            self.assertEquals(_, '')
+    
     def testUncertifiedRemoteCall(self):
         """only authentified people should be able to call remote methods"""
         retValue = self._callRemote('lastIndexationTime', 'evil', 'foo.pdf')



From afayolle at berlios.de  Thu Oct  6 14:34:45 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Thu, 6 Oct 2005 14:34:45 +0200
Subject: [Maay-svncheckins] r151 - trunk/maay
Message-ID: <200510061234.j96CYjG1017713@sheep.berlios.de>

Author: afayolle
Date: 2005-10-06 14:34:45 +0200 (Thu, 06 Oct 2005)
New Revision: 151

Modified:
   trunk/maay/registration.py
   trunk/maay/registration.tac
Log:
changed a bit the protocol

Modified: trunk/maay/registration.py
===================================================================
--- trunk/maay/registration.py	2005-10-06 11:42:34 UTC (rev 150)
+++ trunk/maay/registration.py	2005-10-06 12:34:45 UTC (rev 151)
@@ -6,13 +6,14 @@
 
 __revision__ = '$Id$'
 
-import time
+from datetime import datetime
 
 from twisted.protocols.basic import LineReceiver
 
 class RegistrationServer(LineReceiver):
 
     def __init__(self):
+        # TODO: auto logout after a given time to save memory
         self._registeredUsers = {}
         
     def lineReceived(self, line):
@@ -22,19 +23,29 @@
         try:
             action, param = line.split(':', 1)
         except ValueError:
-            result = "unable to decode action: <%s>" % action
+            result = "unable to decode action: <%s>" % line
         else:
             callback = getattr(self, 'do_%s' % action, None)
             if callback:
-                result = callback(param)
+                param = param.strip()
+                if param:
+                    args = param.split(':')
+                    result = callback(*args)
+                else:
+                    result = callback()
             else:
                 result = "received invalid action: <%s>" % action
         
-    def do_login(self, nodeId):
+    def do_login(self, nodeId, ip, port, bandwidth):
         print "%s accepts %s" % (id(self), nodeId)
         if nodeId in self._registeredUsers:
             print "%s was already registered" % (nodeId,)
-        self._registeredUsers[nodeId] = time.time()
+        lastseen = datetime.now().isoformat()
+        self._registeredUsers[nodeId] = (lastseen,
+                                         nodeId,
+                                         ip,
+                                         port,
+                                         bandwidth)
 
     def do_logout(self, nodeId):
         try:
@@ -44,6 +55,9 @@
 
     def do_who(self):
         """returns the list of logged in nodes"""
-        for nodeId in self._registeredUsers:
-            self.sendLine(nodeId)
+        nodes = self._registeredUsers.values()
+        nodes.sort()
+        nodes.reverse()
+        for nodeinfo in nodes:
+            self.sendLine("\t".join(nodeinfo))
     

Modified: trunk/maay/registration.tac
===================================================================
--- trunk/maay/registration.tac	2005-10-06 11:42:34 UTC (rev 150)
+++ trunk/maay/registration.tac	2005-10-06 12:34:45 UTC (rev 151)
@@ -1,3 +1,5 @@
+#!/usr/bin/twistd2.3 -noy 
+
 from twisted.application import service, internet
 from twisted.internet.protocol import ServerFactory
 



From adimasci at berlios.de  Thu Oct  6 15:11:26 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Thu, 6 Oct 2005 15:11:26 +0200
Subject: [Maay-svncheckins] r152 - trunk/maay/test
Message-ID: <200510061311.j96DBQ1l021476@sheep.berlios.de>

Author: adimasci
Date: 2005-10-06 15:11:25 +0200 (Thu, 06 Oct 2005)
New Revision: 152

Modified:
   trunk/maay/test/test_dbentity.py
Log:
fix and updated test cases for Document.selectContaining



Modified: trunk/maay/test/test_dbentity.py
===================================================================
--- trunk/maay/test/test_dbentity.py	2005-10-06 12:34:45 UTC (rev 151)
+++ trunk/maay/test/test_dbentity.py	2005-10-06 13:11:25 UTC (rev 152)
@@ -8,19 +8,55 @@
 
 class Document_TC(unittest.TestCase):
     def testContainingQuery(self):
-        query, params = Document._selectContainingQuery(['un', u'?t?', u'?', 'la', 'mer'])
+        query, params = Document._selectContainingQuery(['un', u'?t?', u'?', 'la', 'mer'],
+                                                        allowPrivate=True)
         self.assertEquals(params, [u'un', u'ete', u'la', u'mer', 4])
         for p in params[:-1]:
             self.assertEquals(type(p), unicode)
         self.assertEquals(len(params), params[-1] + 1)
-        expected = "SELECT D.db_document_id, D.document_id, D.title, D.size, D.text, D.url, D.mime_type, D.publication_time FROM documents D, document_scores DS WHERE DS.db_document_id=D.db_document_id AND DS.word IN (%s, %s, %s, %s)   GROUP BY DS.db_document_id HAVING count(DS.db_document_id) = %s LIMIT 15 OFFSET 0"
-        print query
-        print expected
-        self.assertEquals(query, expected)
+        expected = "SELECT D.db_document_id, D.document_id, D.title, D.size, D.text, D.url, D.mime_type, D.publication_time FROM documents D, document_scores DS WHERE DS.db_document_id=D.db_document_id AND DS.word IN (%s, %s, %s, %s) GROUP BY DS.db_document_id HAVING count(DS.db_document_id) = %s LIMIT 15 OFFSET 0"
+        self.assertEquals(query.split(), expected.split())
         q = query%tuple(params) # sanity check for argument count
         
+    def testContainingQueryWithOffset(self):
+        query, params = Document._selectContainingQuery(['un', u'?t?', u'?', 'la', 'mer'],
+                                                        offset=15, allowPrivate=True)
+        self.assertEquals(params, [u'un', u'ete', u'la', u'mer', 4])
+        for p in params[:-1]:
+            self.assertEquals(type(p), unicode)
+        self.assertEquals(len(params), params[-1] + 1)
+        expected = "SELECT D.db_document_id, D.document_id, D.title, D.size, D.text, D.url, D.mime_type, D.publication_time FROM documents D, document_scores DS WHERE DS.db_document_id=D.db_document_id AND DS.word IN (%s, %s, %s, %s) GROUP BY DS.db_document_id HAVING count(DS.db_document_id) = %s LIMIT 15 OFFSET 15"
+        self.assertEquals(query.split(), expected.split())
+        q = query%tuple(params) # sanity check for argument count
         
 
+    def testContainingQueryWithOffsetOnlyPublic(self):
+        query, params = Document._selectContainingQuery(['un', u'?t?', u'?', 'la', 'mer'],
+                                                        offset=15)
+        self.assertEquals(params, [u'un', u'ete', u'la', u'mer', Document.PUBLISHED_STATE, 4])
+        for p in params[:-2]:
+            self.assertEquals(type(p), unicode)
+        self.assertEquals(len(params), params[-1] + 2)
+        expected = "SELECT D.db_document_id, D.document_id, D.title, D.size, D.text, D.url, D.mime_type, D.publication_time FROM documents D, document_scores DS WHERE DS.db_document_id=D.db_document_id AND DS.word IN (%s, %s, %s, %s) AND D.state=%s GROUP BY DS.db_document_id HAVING count(DS.db_document_id) = %s LIMIT 15 OFFSET 15"
+        self.assertEquals(query.split(), expected.split())
+        q = query%tuple(params) # sanity check for argument count
+        
+    
+
+    def testContainingQueryWithMimetype(self):
+        query, params = Document._selectContainingQuery(['un', u'?t?', u'?', 'la', 'mer'],
+                                                        mimetype='text/plain',
+                                                        allowPrivate=True)
+        self.assertEquals(params, [u'un', u'ete', u'la', u'mer', 'text/plain', 4])
+        for p in params[:-1]:
+            self.assertEquals(type(p), unicode)
+        self.assertEquals(len(params), params[-1] + 2)
+        expected = "SELECT D.db_document_id, D.document_id, D.title, D.size, D.text, D.url, D.mime_type, D.publication_time FROM documents D, document_scores DS WHERE DS.db_document_id=D.db_document_id AND DS.word IN (%s, %s, %s, %s)   AND D.mime_type=%s  GROUP BY DS.db_document_id HAVING count(DS.db_document_id) = %s LIMIT 15 OFFSET 0"
+        self.assertEquals(query.split(), expected.split())
+        q = query%tuple(params) # sanity check for argument count
+        
+    
+
 class NodeInterest_TC(unittest.TestCase):
     def setUp(self):
         self.entity = NodeInterest(node_id="0"*40, word="espadon",



From adimasci at berlios.de  Thu Oct  6 15:12:35 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Thu, 6 Oct 2005 15:12:35 +0200
Subject: [Maay-svncheckins] r153 - trunk/maay
Message-ID: <200510061312.j96DCZob021575@sheep.berlios.de>

Author: adimasci
Date: 2005-10-06 15:12:35 +0200 (Thu, 06 Oct 2005)
New Revision: 153

Modified:
   trunk/maay/dbentity.py
Log:
force parameter to be unicode. This particuliar case if just for consistency
and homogeneity


Modified: trunk/maay/dbentity.py
===================================================================
--- trunk/maay/dbentity.py	2005-10-06 13:11:25 UTC (rev 152)
+++ trunk/maay/dbentity.py	2005-10-06 13:12:35 UTC (rev 153)
@@ -203,7 +203,7 @@
         #     nicely in order to handle any kind of restrictions easily
         if mimetype is not None:
             restriction = " AND D.mime_type=%s "
-            restrictionParams = [mimetype]
+            restrictionParams = [unicode(mimetype)]
         else:
             restriction = ""
             restrictionParams = []



From adimasci at berlios.de  Thu Oct  6 15:13:01 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Thu, 6 Oct 2005 15:13:01 +0200
Subject: [Maay-svncheckins] r154 - in trunk/maay: . data
Message-ID: <200510061313.j96DD1W6021620@sheep.berlios.de>

Author: adimasci
Date: 2005-10-06 15:13:01 +0200 (Thu, 06 Oct 2005)
New Revision: 154

Added:
   trunk/maay/data/notfound.html
Modified:
   trunk/maay/server.py
Log:
Maay must have its own FourOhFour page !


Added: trunk/maay/data/notfound.html
===================================================================
--- trunk/maay/data/notfound.html	2005-10-06 13:12:35 UTC (rev 153)
+++ trunk/maay/data/notfound.html	2005-10-06 13:13:01 UTC (rev 154)
@@ -0,0 +1,18 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
+    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xmlns:nevow="http://nevow.com/ns/nevow/0.1">
+  <head>
+    <title>Page not found !</title>
+    <link rel="stylesheet" type="text/css" href="/maaycss"/>
+    <link rel="shortcut icon" href="/images/maay.ico" />
+  </head>
+  <body>
+    <h3 class="error">Sorry, I could not find the request resource.</h3>
+    <a href="/">Maay's main search page</a>
+    <hr />
+    <a href="http://maay.netofpeers.net/">Maay Home page</a> <a href="http://developer.berlios.de/projects/maay/">
+<img src="http://developer.berlios.de/bslogo.php?group_id=0"
+    width="124" height="32" border="0" alt="BerliOS Logo" /></a>
+
+    </body>  
+</html>

Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-06 13:12:35 UTC (rev 153)
+++ trunk/maay/server.py	2005-10-06 13:13:01 UTC (rev 154)
@@ -169,7 +169,7 @@
         if docurl:
             return static.File(docurl)
         else:
-            return PageNotFound()
+            return Maay404()
 
 
 class ResultsPage(MaayPage):
@@ -337,9 +337,16 @@
         return defer.succeed(creds.username)
 
 
-class PageNotFound(rend.FourOhFour):
-    pass
+class Maay404(rend.FourOhFour):
+    """Maay specific resource for 404 errors"""
+    loader = loaders.xmlfile(get_path_of('notfound.html'))
 
+    def renderHTTP_notFound(self, context):
+        """Render a not found message to the given request.
+        """
+        return self.loader.load(context)[0]
+
+
 class WebappConfiguration(Configuration):
     options = [
         ('db-name',
@@ -431,6 +438,7 @@
     maayPortal = MaayPortal(webappConfig)
     website = appserver.NevowSite(guard.SessionWrapper(maayPortal,
                                                        mindFactory=MaayMindFactory))
+    website.remember(Maay404(), inevow.ICanHandleNotFound)
     rpcserver = server.Site(MaayRPCServer(maayPortal))
     reactor.listenTCP(8080, website)
     reactor.listenTCP(6789, rpcserver)



From afayolle at berlios.de  Thu Oct  6 15:28:50 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Thu, 6 Oct 2005 15:28:50 +0200
Subject: [Maay-svncheckins] r155 - trunk/maay
Message-ID: <200510061328.j96DSonN023254@sheep.berlios.de>

Author: afayolle
Date: 2005-10-06 15:28:50 +0200 (Thu, 06 Oct 2005)
New Revision: 155

Added:
   trunk/maay/registrationclient.py
Modified:
   trunk/maay/registration.py
Log:
registration client (not tested and not plugged into main application)

Modified: trunk/maay/registration.py
===================================================================
--- trunk/maay/registration.py	2005-10-06 13:13:01 UTC (rev 154)
+++ trunk/maay/registration.py	2005-10-06 13:28:50 UTC (rev 155)
@@ -40,7 +40,7 @@
         print "%s accepts %s" % (id(self), nodeId)
         if nodeId in self._registeredUsers:
             print "%s was already registered" % (nodeId,)
-        lastseen = datetime.now().isoformat()
+        lastseen = datetime.utcnow().isoformat()
         self._registeredUsers[nodeId] = (lastseen,
                                          nodeId,
                                          ip,
@@ -60,4 +60,4 @@
         nodes.reverse()
         for nodeinfo in nodes:
             self.sendLine("\t".join(nodeinfo))
-    
+        self.sendLine('EOT')

Added: trunk/maay/registrationclient.py
===================================================================
--- trunk/maay/registrationclient.py	2005-10-06 13:13:01 UTC (rev 154)
+++ trunk/maay/registrationclient.py	2005-10-06 13:28:50 UTC (rev 155)
@@ -0,0 +1,35 @@
+from twisted.internet.protocol import Protocol
+from time import mktime
+
+class RegistrationClient(Protocol):
+    def __init__(self, nodeRegisterCallback):
+        self._callback = nodeRegisterCallback
+    def login(self, nodeId, ip, port, bandwidth):
+        self.transport.write('login:%s:%d:%d\r\n' % (nodeId, ip, port, bandwidth))
+        self.disconnect()
+
+    def disconnect(self):
+        self.transport.looseConnection()
+
+    def logout(self, nodeId):
+        self.transport.write('logout:%s\r\n' % nodeId)
+        self.diconnect()
+
+    def who(self):
+        self.transport.write('who:\r\n')
+
+    def lineReceived(self, data):
+        data = data.strip()
+        if data.startswith('EOT'):
+            self.disconnect()
+            return
+        time, nodeId, nodeIP, nodePort, nodeBandwidth = data.split('\t')
+        lastSeenTime = parseTime(time)
+        self._callback(nodeId, nodeIP, nodePort, nodeBandwidth, lastSeenTime)
+        
+
+def parseTime(isodatetime):
+    date, time = isodatetime.split('T')
+    date = [int(s) for s in date.split('-')]
+    time = [int(float(s)) for s in time.split(':')]
+    return mktime(tuple(date+time+[0,0,0]))


Property changes on: trunk/maay/registrationclient.py
___________________________________________________________________
Name: svn:keywords
   + "Id"
Name: svn:eol-style
   + native



From afayolle at berlios.de  Thu Oct  6 16:48:17 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Thu, 6 Oct 2005 16:48:17 +0200
Subject: [Maay-svncheckins] r156 - in trunk: . maay maay/configuration maay/sql
Message-ID: <200510061448.j96EmHFq000032@sheep.berlios.de>

Author: afayolle
Date: 2005-10-06 16:48:16 +0200 (Thu, 06 Oct 2005)
New Revision: 156

Modified:
   trunk/README.txt
   trunk/ReleaseNotes
   trunk/maay.iss
   trunk/maay/configuration.py
   trunk/maay/configuration/indexer.ini
   trunk/maay/configuration/webapp.ini
   trunk/maay/indexer.py
   trunk/maay/sql/mysql.sql
   trunk/setup.py
Log:
various update to release snapshot 2005-10-06
Should actually work on windows, but Word document indexation is not functioning.

Modified: trunk/README.txt
===================================================================
--- trunk/README.txt	2005-10-06 13:28:50 UTC (rev 155)
+++ trunk/README.txt	2005-10-06 14:48:16 UTC (rev 156)
@@ -1,3 +1,10 @@
+Warning
+======
+
+This is alpha quality software. Before launching anything be sure to read 
+this document and the release notes for the program. On Windows systems, 
+the release notes are available through the start menu shortcut of Maay.
+
 What is Maay?
 =============
 
@@ -18,7 +25,7 @@
  * a web interface which can be used to issue queries (currently
    queries are ontly dispatched on the current node, i.e. the P2P
    functionnality is not available for now, though we are working on
-   it. 
+   it). 
 
 How do I install Maay from source?
 ==================================
@@ -74,7 +81,13 @@
 How do I start using Maay?
 ==========================
 
-First, start the Maay service. On Windows, use the start menu to
+First, edit the configuration files. On Windows, they are in 
+C:\Program Files\Maay\webapp.ini and C:\Program Files\Maay\indexer.ini.
+On Unix systems, they are in /etc/maay, and you can copy them to 
+~/.maay/ if you want to have some personnalized settings. Pay attention 
+to the index-dir and skip-dir settings in indexer.ini.
+
+Then, start the Maay service. On Windows, use the start menu to
 launch "Maay Server". On unix systems, use /usr/bin/maay-server
 
 You can now visit http://localhost:8080/ which will display the Maay
@@ -100,4 +113,4 @@
 http://developer.berlios.de/projects/maay/
 
 
- Alexandre Fayolle <alexandre.fayolle>, Mon,  3 Oct 2005 10:09:28 +0200
+ Alexandre Fayolle <alexandre.fayolle at logilab.fr>, Thu,  6 Oct 2005 15:50:15 +0200

Modified: trunk/ReleaseNotes
===================================================================
--- trunk/ReleaseNotes	2005-10-06 13:28:50 UTC (rev 155)
+++ trunk/ReleaseNotes	2005-10-06 14:48:16 UTC (rev 156)
@@ -1,3 +1,14 @@
+Release Notes for snapshot 2005-10-06
+
+This release is a development snapshot, it is not as tested as an 
+official release, and is only provided as a convenience to our users. 
+Expect the application to crash.
+
+Refer to previous release notes below.
+
+-----------------------------------------------------------
+Release Notes for version 0.1.0
+
 See README.txt for installation and quick start instructions. 
 
 This release is alpha-level software. We support local indexation and

Modified: trunk/maay/configuration/indexer.ini
===================================================================
--- trunk/maay/configuration/indexer.ini	2005-10-06 13:28:50 UTC (rev 155)
+++ trunk/maay/configuration/indexer.ini	2005-10-06 14:48:16 UTC (rev 156)
@@ -1,8 +1,8 @@
-[INDEXER]
-host: localhost
-port: 6789
-user: maay
-password: maay
-index-dir:~/
-#skip-dir:~/.firefox,~/.mozilla
-verbose: yes
+[INDEXER]
+host=localhost
+port=6789
+user=maay
+password=maay
+index-dir=c:\
+skip-dir=c:\windows
+verbose=yes
\ No newline at end of file

Modified: trunk/maay/configuration/webapp.ini
===================================================================
--- trunk/maay/configuration/webapp.ini	2005-10-06 13:28:50 UTC (rev 155)
+++ trunk/maay/configuration/webapp.ini	2005-10-06 14:48:16 UTC (rev 156)
@@ -1,5 +1,5 @@
-[SERVER]
-db-name: maay
-db-host: localhost
-user: maay
-password: maay
+[SERVER]
+db-name=maay
+db-host=localhost
+user=maay
+password=maay

Modified: trunk/maay/configuration.py
===================================================================
--- trunk/maay/configuration.py	2005-10-06 13:28:50 UTC (rev 155)
+++ trunk/maay/configuration.py	2005-10-06 14:48:16 UTC (rev 156)
@@ -34,8 +34,9 @@
     path = []
     if os.environ.get('PATH'):
         path.append(os.environ.get('PATH'))
-    for directory in (u'antiword', u'pdftohtml', os.path.join(u'mysql', u'bin')):
-        path.append(os.path.join(maay_dir, directory))
+    for directory in (u'pdftohtml', os.path.join(u'mysql', u'bin')):
+        path.append(os.path.join(maay_dir, directory))
+    path.append(u'c:\antiword')
     os.environ['PATH'] =  os.pathsep.join(path)
 
         

Modified: trunk/maay/indexer.py
===================================================================
--- trunk/maay/indexer.py	2005-10-06 13:28:50 UTC (rev 155)
+++ trunk/maay/indexer.py	2005-10-06 14:48:16 UTC (rev 156)
@@ -162,8 +162,16 @@
     def __init__(self, indexed, skipped=None):
         self.indexed = [os.path.abspath(os.path.expanduser(p)) for p in indexed]
         skipped = skipped or []
-        self.skipped = [os.path.abspath(os.path.expanduser(p)) for p in skipped]
-
+        self.skipped = [os.path.abspath(os.path.expanduser(p)) for p in skipped]
+        self.skipped = [self.normalizeCase(p) for p in self.skipped]
+        
+    if sys.platform == 'win32':
+        def normalizeCase(self, path):
+            return path.lower()
+    else:    
+        def normalizeCase(self, path):
+            return path
+        
     def __iter__(self):
         for path in self.indexed:
             # test path not in self.skipped (dummy config files)
@@ -184,7 +192,7 @@
     def _removeSkippedDirnames(self, dirpath, dirnames):
         """removed skipped directories from dirnames (inplace !)"""
         for dirname in dirnames[:]:
-            abspath = os.path.join(dirpath, dirname)
+            abspath = self.normalizeCase(os.path.join(dirpath, dirname))
             if abspath in self.skipped:
                 dirnames.remove(dirname)
 

Modified: trunk/maay/sql/mysql.sql
===================================================================
--- trunk/maay/sql/mysql.sql	2005-10-06 13:28:50 UTC (rev 155)
+++ trunk/maay/sql/mysql.sql	2005-10-06 14:48:16 UTC (rev 156)
@@ -1,7 +1,7 @@
 -- ---------------------------------------------------------
 -- maay database
 -- ---------------------------------------------------------
-
+DROP DATABASE maay;
 CREATE DATABASE maay DEFAULT CHARACTER SET utf8;
 
 use maay;

Modified: trunk/maay.iss
===================================================================
--- trunk/maay.iss	2005-10-06 13:28:50 UTC (rev 155)
+++ trunk/maay.iss	2005-10-06 14:48:16 UTC (rev 156)
@@ -4,17 +4,19 @@
 
 [Setup]
 AppName=Maay
-AppVerName=Maay version 0.1
+AppVerName=Maay snapshot 2005-10-06
 DefaultDirName={pf}\Maay
 DefaultGroupName=Maay
 UninstallDisplayIcon={app}\maay_server.exe
 Compression=bzip
 SolidCompression=yes
 LicenseFile=thirdparty\mysql\COPYING.txt
-; Require 20 MB for the database files. We can tune this later.
+; Require 50 MB for the database files. We can tune this later.
 ExtraDiskSpaceRequired=20000000
 ; Win9x is not supported
 MinVersion=0,4.0
+InfoBeforeFile=ReleaseNotes
+InfoAfterFile=README.txt
 
 [Files]
 Source: "dist\*"; DestDir: "{app}"
@@ -25,13 +27,22 @@
 Source: "maay\data\images\*.ico"; DestDir: "{app}\data\images"
 Source: "maay\sql\mysql.sql"; DestDir: "{app}"
 Source: "thirdparty\mysql\*"; DestDir: "{app}\mysql" ; Flags: recursesubdirs
-Source: "thirdparty\antiword\*"; DestDir: "{app}\antiword" ; Flags: recursesubdirs
+Source: "thirdparty\antiword\*"; DestDir: "c:\antiword" ; Flags: recursesubdirs
 Source: "thirdparty\pdftohtml-0.36\*"; DestDir: "{app}\pdftohtml" ; Flags: recursesubdirs
+Source: "maay\configuration\*.ini"; DestDir: "{app}"
+Source: "README.txt"; DestDir: "{app}"
+Source: "ChangeLog"; DestDir: "{app}"
+Source: "ReleaseNotes"; DestDir: "{app}"
 
 [Icons]
+Name: "{group}\README.txt"; Filename: "{app}\README.txt"; Comment: "Required reading before launching Maay"
+Name: "{group}\ReleaseNotes.txt"; Filename: "{app}\ReleaseNotes"; Comment: "Required reading before launching Maay"
 Name: "{group}\Maay Server"; Filename: "{app}\maay_server.exe"; WorkingDir: "{app}"; Comment: "The Maay server component"
 Name: "{group}\Maay Indexer"; Filename: "{app}\maay_indexer.exe"; WorkingDir: "{app}"; Comment: "The Maay indexer component"
+Name: "{group}\webapp.ini"; Filename: "{app}\webapp.ini"; Comment: "Maay server configuration"
+Name: "{group}\indexer.ini"; Filename: "{app}\indexer.ini"; Comment: "Maay indexer configuration"
 
+
 [Run]
 Filename: "{app}\mysql\bin\mysqld-max-nt.exe"; Parameters:"--install MySQL --defaults-file=""{app}\mysql\my-maay.ini"""; StatusMsg: "Registering MySQL as a service"; WorkingDir:"{app}\mysql"; Flags:runhidden
 Filename: "NET"; Parameters:"start MySQL"; StatusMsg: "Starting MySQL server"; WorkingDir:"{app}\mysql"; Flags:runhidden

Modified: trunk/setup.py
===================================================================
--- trunk/setup.py	2005-10-06 13:28:50 UTC (rev 155)
+++ trunk/setup.py	2005-10-06 14:48:16 UTC (rev 156)
@@ -7,7 +7,7 @@
 version = '0.1.0'
 author = "France Telecom R&D and Logilab"
 author_email = "maay-dev at lists.berlios.de"
-copyright = "Copyright (c)2005 France Telecom R&D and Logilab"
+copyright = "Copyright (c)2004-2005 France Telecom R&D"
 description = "a network of peers for document search"
 name = "Maay"
 url = "http://maay.netofpeers.net/"



From afayolle at berlios.de  Thu Oct  6 17:17:50 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Thu, 6 Oct 2005 17:17:50 +0200
Subject: [Maay-svncheckins] r157 - trunk
Message-ID: <200510061517.j96FHoYx004076@sheep.berlios.de>

Author: afayolle
Date: 2005-10-06 17:17:50 +0200 (Thu, 06 Oct 2005)
New Revision: 157

Modified:
   trunk/ChangeLog
   trunk/ReleaseNotes
Log:
updated for snapshot 20051006

Modified: trunk/ChangeLog
===================================================================
--- trunk/ChangeLog	2005-10-06 14:48:16 UTC (rev 156)
+++ trunk/ChangeLog	2005-10-06 15:17:50 UTC (rev 157)
@@ -1,3 +1,10 @@
+Maay-snapshot20051006 2005-10-06
+	* Some bug fixes on Windows
+	* Anonymous login supported
+	* Nicer web interface (several pages of 15 results)
+	* Node management in the indexer
+	* Fixed some communication issues between indexer and server
+	
 Maay-0.1.0 2005-10-03
 	* First release of the new code base
 

Modified: trunk/ReleaseNotes
===================================================================
--- trunk/ReleaseNotes	2005-10-06 14:48:16 UTC (rev 156)
+++ trunk/ReleaseNotes	2005-10-06 15:17:50 UTC (rev 157)
@@ -1,14 +1,16 @@
-Release Notes for snapshot 2005-10-06
-
-This release is a development snapshot, it is not as tested as an 
-official release, and is only provided as a convenience to our users. 
-Expect the application to crash.
-
-Refer to previous release notes below.
-
------------------------------------------------------------
-Release Notes for version 0.1.0
-
+Release Notes for snapshot 2005-10-06
+
+This release is a development snapshot, it is not as tested as an 
+official release, and is only provided as a convenience to our users. 
+Expect the application to crash.
+
+Known problems: the Microsoft Word document converter does not work on Windows.
+
+Refer to previous release notes below.
+
+-----------------------------------------------------------
+Release Notes for version 0.1.0
+
 See README.txt for installation and quick start instructions. 
 
 This release is alpha-level software. We support local indexation and



From afayolle at berlios.de  Thu Oct  6 18:23:14 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Thu, 6 Oct 2005 18:23:14 +0200
Subject: [Maay-svncheckins] r158 - in trunk: . maay maay/bin maay/configuration maay/data maay/sql maay/test maay/test/data
Message-ID: <200510061623.j96GNEv0015989@sheep.berlios.de>

Author: afayolle
Date: 2005-10-06 18:23:13 +0200 (Thu, 06 Oct 2005)
New Revision: 158

Modified:
   trunk/ChangeLog
   trunk/ReleaseNotes
   trunk/maay/__init__.py
   trunk/maay/bin/maay-indexer
   trunk/maay/bin/maay-server
   trunk/maay/cleandb.py
   trunk/maay/configuration.py
   trunk/maay/configuration/indexer.ini
   trunk/maay/configuration/webapp.ini
   trunk/maay/converter.py
   trunk/maay/createdb.py
   trunk/maay/data/maay.css
   trunk/maay/data/notfound.html
   trunk/maay/data/resultpage.html
   trunk/maay/data/searchform.html
   trunk/maay/dbentity.py
   trunk/maay/dbstats.py
   trunk/maay/graphical_indexer.py
   trunk/maay/indexer.py
   trunk/maay/querier.py
   trunk/maay/registration.py
   trunk/maay/registration.tac
   trunk/maay/registrationclient.py
   trunk/maay/rpc.py
   trunk/maay/server.py
   trunk/maay/sql/mysql.sql
   trunk/maay/sql/postgres.sql
   trunk/maay/test/data/encoded.html
   trunk/maay/test/data/guess_encoding.txt
   trunk/maay/test/data/latin1.txt
   trunk/maay/test/data/latin1.xml
   trunk/maay/test/data/node22.html
   trunk/maay/test/data/utf16.txt
   trunk/maay/test/data/utf32.txt
   trunk/maay/test/data/utf8.txt
   trunk/maay/test/data/utf8.xml
   trunk/maay/test/data/utf8noencoding.xml
   trunk/maay/test/data/webapp1.ini
   trunk/maay/test/data/webapp2.ini
   trunk/maay/test/runtests.py
   trunk/maay/test/test_codecs.py
   trunk/maay/test/test_configuration.py
   trunk/maay/test/test_converter.py
   trunk/maay/test/test_dbentity.py
   trunk/maay/test/test_fileiteration.py
   trunk/maay/test/test_indexer.py
   trunk/maay/test/test_querier.py
   trunk/maay/test/test_rpc.py
   trunk/maay/test/test_server.py
   trunk/maay/test/test_texttool.py
   trunk/maay/texttool.py
Log:
set various properties to ease cross platform development


Property changes on: trunk/ChangeLog
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/ReleaseNotes
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/maay/__init__.py
___________________________________________________________________
Name: svn:eol-style
   + native


Property changes on: trunk/maay/bin/maay-indexer
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/maay/bin/maay-server
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/maay/cleandb.py
___________________________________________________________________
Name: svn:keywords
   - "Id"
   + Id

Modified: trunk/maay/configuration/indexer.ini
===================================================================
--- trunk/maay/configuration/indexer.ini	2005-10-06 15:17:50 UTC (rev 157)
+++ trunk/maay/configuration/indexer.ini	2005-10-06 16:23:13 UTC (rev 158)
@@ -1,8 +1,8 @@
-[INDEXER]
-host=localhost
-port=6789
-user=maay
-password=maay
-index-dir=c:\
-skip-dir=c:\windows
+[INDEXER]
+host=localhost
+port=6789
+user=maay
+password=maay
+index-dir=c:\
+skip-dir=c:\windows
 verbose=yes
\ No newline at end of file


Property changes on: trunk/maay/configuration/indexer.ini
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Modified: trunk/maay/configuration/webapp.ini
===================================================================
--- trunk/maay/configuration/webapp.ini	2005-10-06 15:17:50 UTC (rev 157)
+++ trunk/maay/configuration/webapp.ini	2005-10-06 16:23:13 UTC (rev 158)
@@ -1,5 +1,5 @@
-[SERVER]
-db-name=maay
-db-host=localhost
-user=maay
-password=maay
+[SERVER]
+db-name=maay
+db-host=localhost
+user=maay
+password=maay


Property changes on: trunk/maay/configuration/webapp.ini
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Modified: trunk/maay/configuration.py
===================================================================
--- trunk/maay/configuration.py	2005-10-06 15:17:50 UTC (rev 157)
+++ trunk/maay/configuration.py	2005-10-06 16:23:13 UTC (rev 158)
@@ -35,7 +35,7 @@
     if os.environ.get('PATH'):
         path.append(os.environ.get('PATH'))
     for directory in (u'pdftohtml', os.path.join(u'mysql', u'bin')):
-        path.append(os.path.join(maay_dir, directory))
+        path.append(os.path.join(maay_dir, directory))
     path.append(u'c:\antiword')
     os.environ['PATH'] =  os.pathsep.join(path)
 


Property changes on: trunk/maay/configuration.py
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/maay/converter.py
===================================================================
--- trunk/maay/converter.py	2005-10-06 15:17:50 UTC (rev 157)
+++ trunk/maay/converter.py	2005-10-06 16:23:13 UTC (rev 158)
@@ -103,7 +103,7 @@
         uncompressed = file(uncompressedFile, 'wb')
         uncompressed.write(compressed.read())
         compressed.close()
-        uncompressed.close()
+        uncompressed.close()
 
             
         outputFile = os.path.join(outputDir, 'outfile')


Property changes on: trunk/maay/converter.py
___________________________________________________________________
Name: svn:eol-style
   + native


Property changes on: trunk/maay/createdb.py
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/maay/data/maay.css
___________________________________________________________________
Name: svn:keyword
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/maay/data/notfound.html
___________________________________________________________________
Name: svn:keyword
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/maay/data/resultpage.html
___________________________________________________________________
Name: svn:keyword
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/maay/data/searchform.html
___________________________________________________________________
Name: svn:keyword
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/maay/dbentity.py
___________________________________________________________________
Name: svn:eol-style
   + native


Property changes on: trunk/maay/dbstats.py
___________________________________________________________________
Name: svn:keywords
   - "Id"
   + Id


Property changes on: trunk/maay/graphical_indexer.py
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/maay/indexer.py
===================================================================
--- trunk/maay/indexer.py	2005-10-06 15:17:50 UTC (rev 157)
+++ trunk/maay/indexer.py	2005-10-06 16:23:13 UTC (rev 158)
@@ -162,16 +162,16 @@
     def __init__(self, indexed, skipped=None):
         self.indexed = [os.path.abspath(os.path.expanduser(p)) for p in indexed]
         skipped = skipped or []
-        self.skipped = [os.path.abspath(os.path.expanduser(p)) for p in skipped]
+        self.skipped = [os.path.abspath(os.path.expanduser(p)) for p in skipped]
         self.skipped = [self.normalizeCase(p) for p in self.skipped]
-        
-    if sys.platform == 'win32':
-        def normalizeCase(self, path):
-            return path.lower()
-    else:    
-        def normalizeCase(self, path):
-            return path
         
+    if sys.platform == 'win32':
+        def normalizeCase(self, path):
+            return path.lower()
+    else:    
+        def normalizeCase(self, path):
+            return path
+        
     def __iter__(self):
         for path in self.indexed:
             # test path not in self.skipped (dummy config files)


Property changes on: trunk/maay/indexer.py
___________________________________________________________________
Name: svn:eol-style
   + native


Property changes on: trunk/maay/querier.py
___________________________________________________________________
Name: svn:eol-style
   + native


Property changes on: trunk/maay/registration.py
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/maay/registration.tac
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/maay/registrationclient.py
___________________________________________________________________
Name: svn:keywords
   - "Id"
   + Id


Property changes on: trunk/maay/rpc.py
___________________________________________________________________
Name: svn:eol-style
   + native


Property changes on: trunk/maay/server.py
___________________________________________________________________
Name: svn:eol-style
   + native


Property changes on: trunk/maay/sql/mysql.sql
___________________________________________________________________
Name: svn:eol-style
   + native


Property changes on: trunk/maay/sql/postgres.sql
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/maay/test/data/encoded.html
___________________________________________________________________
Name: svn:keyword
   + Id
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/maay/test/data/guess_encoding.txt
___________________________________________________________________
Name: svn:keywords
   - "Id"
   + Id


Property changes on: trunk/maay/test/data/latin1.txt
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/maay/test/data/latin1.xml
___________________________________________________________________
Name: svn:keyword
   + Id
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/maay/test/data/node22.html
___________________________________________________________________
Name: svn:keyword
   + Id
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/maay/test/data/utf16.txt
___________________________________________________________________
Name: svn:keywords
   + Id


Property changes on: trunk/maay/test/data/utf32.txt
___________________________________________________________________
Name: svn:keywords
   + Id


Property changes on: trunk/maay/test/data/utf8.txt
___________________________________________________________________
Name: svn:keywords
   + Id


Property changes on: trunk/maay/test/data/utf8.xml
___________________________________________________________________
Name: svn:keyword
   + Id
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/maay/test/data/utf8noencoding.xml
___________________________________________________________________
Name: svn:keyword
   + Id
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/maay/test/data/webapp1.ini
___________________________________________________________________
Name: svn:keyword
   + Id
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/maay/test/data/webapp2.ini
___________________________________________________________________
Name: svn:keyword
   + Id
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/maay/test/runtests.py
___________________________________________________________________
Name: svn:keyword
   + Id
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/maay/test/test_codecs.py
___________________________________________________________________
Name: svn:keywords
   - "Id"
   + Id
Name: svn:keyword
   + Id


Property changes on: trunk/maay/test/test_configuration.py
___________________________________________________________________
Name: svn:keyword
   + Id
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/maay/test/test_converter.py
___________________________________________________________________
Name: svn:keyword
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/maay/test/test_dbentity.py
___________________________________________________________________
Name: svn:keywords
   - "Id"
   + Id
Name: svn:keyword
   + Id


Property changes on: trunk/maay/test/test_fileiteration.py
___________________________________________________________________
Name: svn:keyword
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/maay/test/test_indexer.py
___________________________________________________________________
Name: svn:keywords
   - "Id"
   + Id
Name: svn:keyword
   + Id


Property changes on: trunk/maay/test/test_querier.py
___________________________________________________________________
Name: svn:keywords
   - "Id"
   + Id
Name: svn:keyword
   + Id


Property changes on: trunk/maay/test/test_rpc.py
___________________________________________________________________
Name: svn:keyword
   + Id
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/maay/test/test_server.py
___________________________________________________________________
Name: svn:keyword
   + Id
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/maay/test/test_texttool.py
___________________________________________________________________
Name: svn:keyword
   + Id
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native


Property changes on: trunk/maay/texttool.py
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native



From afayolle at berlios.de  Thu Oct  6 18:34:32 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Thu, 6 Oct 2005 18:34:32 +0200
Subject: [Maay-svncheckins] r159 - in trunk: . maay maay/bin maay/test
Message-ID: <200510061634.j96GYWTY024916@sheep.berlios.de>

Author: afayolle
Date: 2005-10-06 18:34:27 +0200 (Thu, 06 Oct 2005)
New Revision: 159

Modified:
   trunk/maay/__init__.py
   trunk/maay/bin/maay-indexer
   trunk/maay/bin/maay-server
   trunk/maay/cleandb.py
   trunk/maay/configuration.py
   trunk/maay/converter.py
   trunk/maay/createdb.py
   trunk/maay/dbentity.py
   trunk/maay/dbstats.py
   trunk/maay/graphical_indexer.py
   trunk/maay/indexer.py
   trunk/maay/querier.py
   trunk/maay/registration.py
   trunk/maay/registration.tac
   trunk/maay/registrationclient.py
   trunk/maay/rpc.py
   trunk/maay/server.py
   trunk/maay/test/runtests.py
   trunk/maay/test/test_codecs.py
   trunk/maay/test/test_configuration.py
   trunk/maay/test/test_converter.py
   trunk/maay/test/test_dbentity.py
   trunk/maay/test/test_fileiteration.py
   trunk/maay/test/test_indexer.py
   trunk/maay/test/test_querier.py
   trunk/maay/test/test_rpc.py
   trunk/maay/test/test_server.py
   trunk/maay/test/test_texttool.py
   trunk/maay/texttool.py
   trunk/setup.py
Log:
added GPL boilerplate and copyright statement

Modified: trunk/maay/__init__.py
===================================================================
--- trunk/maay/__init__.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/__init__.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,6 +1,21 @@
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 """MAAY project
 """
 
-# FIXME: add a copyright and license statement 
 
 __revision__ = '$Id$'

Modified: trunk/maay/bin/maay-indexer
===================================================================
--- trunk/maay/bin/maay-indexer	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/bin/maay-indexer	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,4 +1,20 @@
 #!/usr/bin/python
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 __revision__ = '$Id$'
 from maay.indexer import run
 run()

Modified: trunk/maay/bin/maay-server
===================================================================
--- trunk/maay/bin/maay-server	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/bin/maay-server	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,4 +1,20 @@
 #!/usr/bin/python
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 __revision__ = '$Id$'
 from maay.server import run
 run()

Modified: trunk/maay/cleandb.py
===================================================================
--- trunk/maay/cleandb.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/cleandb.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,4 +1,20 @@
 #!/usr/bin/python
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 """Utility script to clean the database. This forces full reindexation
 on the following indexer run
 """

Modified: trunk/maay/configuration.py
===================================================================
--- trunk/maay/configuration.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/configuration.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,3 +1,19 @@
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 """provides configuration (command line / config file) helpers for Maay"""
 
 __revision__ = '$Id$'

Modified: trunk/maay/converter.py
===================================================================
--- trunk/maay/converter.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/converter.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,3 +1,19 @@
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 """this module handles Converter Registry
 
 Typical use ::

Modified: trunk/maay/createdb.py
===================================================================
--- trunk/maay/createdb.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/createdb.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,3 +1,19 @@
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 """ helper to create the maay mysql instance on windows platform"""
 import os
 

Modified: trunk/maay/dbentity.py
===================================================================
--- trunk/maay/dbentity.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/dbentity.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,3 +1,19 @@
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 """this module provides a simple document abstraction"""
 
 __revision__ = '$Id$'

Modified: trunk/maay/dbstats.py
===================================================================
--- trunk/maay/dbstats.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/dbstats.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,4 +1,20 @@
 #!/usr/bin/python
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 """Helper script to display how many rows are stored in the various maay tables on localhost"""
 
 from MySQLdb import connect

Modified: trunk/maay/graphical_indexer.py
===================================================================
--- trunk/maay/graphical_indexer.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/graphical_indexer.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,3 +1,19 @@
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 """This module contains a Tk wrapper around the indexer, for easier
 operation on Windows boxes
 """

Modified: trunk/maay/indexer.py
===================================================================
--- trunk/maay/indexer.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/indexer.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,3 +1,19 @@
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 """This module contains the indexer code.
 The indexer crawl files on disk, analyse the textual content
 of a file and update the indexes.

Modified: trunk/maay/querier.py
===================================================================
--- trunk/maay/querier.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/querier.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,4 +1,20 @@
 # -*- coding: iso-8859-1 -*- 
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 """provides the MaayQuerier class"""
 
 from __future__ import division

Modified: trunk/maay/registration.py
===================================================================
--- trunk/maay/registration.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/registration.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,3 +1,19 @@
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 """this module defines the central registration server.
 
 The Registration server keeps track of every connected

Modified: trunk/maay/registration.tac
===================================================================
--- trunk/maay/registration.tac	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/registration.tac	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,5 +1,21 @@
 #!/usr/bin/twistd2.3 -noy 
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
 
+
 from twisted.application import service, internet
 from twisted.internet.protocol import ServerFactory
 

Modified: trunk/maay/registrationclient.py
===================================================================
--- trunk/maay/registrationclient.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/registrationclient.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,3 +1,19 @@
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 from twisted.internet.protocol import Protocol
 from time import mktime
 

Modified: trunk/maay/rpc.py
===================================================================
--- trunk/maay/rpc.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/rpc.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,3 +1,19 @@
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 from time import time
 from random import randint
 import sys

Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/server.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,3 +1,19 @@
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 """maay local web UI script"""
 
 __revision__ = '$Id$'
@@ -28,11 +44,15 @@
 
 from nevow import inevow, rend, tags, guard, loaders, appserver
 from nevow.url import URL
-# this is to help py2exe
+
+# These imports are not used, but they help py2exe tremendously.
+# Do not remove them (that is, unless we change the database backend
+# or drop twisted)
 import nevow.flat.flatstan
 import nevow.query
 import twisted.web.woven.guard
 import MySQLdb
+# end of py2exe helping imports
 
 from logilab.common.textutils import normalize_text
 

Modified: trunk/maay/test/runtests.py
===================================================================
--- trunk/maay/test/runtests.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/test/runtests.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,3 +1,19 @@
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 from logilab.common.testlib import main
 
 if __name__ == '__main__':

Modified: trunk/maay/test/test_codecs.py
===================================================================
--- trunk/maay/test/test_codecs.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/test/test_codecs.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,4 +1,20 @@
 # -*- coding: iso-8859-1 -*-
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 import unittest
 import codecs
 import gzip

Modified: trunk/maay/test/test_configuration.py
===================================================================
--- trunk/maay/test/test_configuration.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/test/test_configuration.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,3 +1,19 @@
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 """small unit tests for Configuration class"""
 
 import unittest

Modified: trunk/maay/test/test_converter.py
===================================================================
--- trunk/maay/test/test_converter.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/test/test_converter.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,3 +1,19 @@
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 """tests converters registry management"""
 
 import unittest

Modified: trunk/maay/test/test_dbentity.py
===================================================================
--- trunk/maay/test/test_dbentity.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/test/test_dbentity.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,4 +1,20 @@
 # -*- encoding: iso-8859-1 -*-
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 """querier test cases"""
 
 import unittest

Modified: trunk/maay/test/test_fileiteration.py
===================================================================
--- trunk/maay/test/test_fileiteration.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/test/test_fileiteration.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,3 +1,19 @@
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 """tests file iteration"""
 
 __revision__ = '$Id$'

Modified: trunk/maay/test/test_indexer.py
===================================================================
--- trunk/maay/test/test_indexer.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/test/test_indexer.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,3 +1,19 @@
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 import unittest
 from  tempfile import mkstemp
 import os

Modified: trunk/maay/test/test_querier.py
===================================================================
--- trunk/maay/test/test_querier.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/test/test_querier.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,4 +1,20 @@
 # -*- coding: iso-8859-1 -*-
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 "querier test cases"""
 
 import unittest

Modified: trunk/maay/test/test_rpc.py
===================================================================
--- trunk/maay/test/test_rpc.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/test/test_rpc.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,3 +1,19 @@
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 """unit tests for Maay's XMLRPC server
 
 These test cases should be tested with the twisted's `trial` utility

Modified: trunk/maay/test/test_server.py
===================================================================
--- trunk/maay/test/test_server.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/test/test_server.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,3 +1,19 @@
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 import unittest
 
 from maay.server import Query

Modified: trunk/maay/test/test_texttool.py
===================================================================
--- trunk/maay/test/test_texttool.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/test/test_texttool.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,6 +1,24 @@
 # -*- coding: iso-8859-1 -*-
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 """unit tests for Text and HTML parsers"""
 
+
+
 import unittest
 from os.path import join, dirname
 

Modified: trunk/maay/texttool.py
===================================================================
--- trunk/maay/texttool.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/maay/texttool.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,4 +1,20 @@
 # -*- coding: iso-8859-1 -*-
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
 """this module provide text / parsing tools"""
 
 __revision__ = '$Id$'

Modified: trunk/setup.py
===================================================================
--- trunk/setup.py	2005-10-06 16:23:13 UTC (rev 158)
+++ trunk/setup.py	2005-10-06 16:34:27 UTC (rev 159)
@@ -1,4 +1,20 @@
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
 
+
 __revision__ = "$Id$"
 from distutils.core import setup
 import sys



From afayolle at berlios.de  Thu Oct  6 19:55:50 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Thu, 6 Oct 2005 19:55:50 +0200
Subject: [Maay-svncheckins] r160 - trunk/maay
Message-ID: <200510061755.j96Hto5i010488@sheep.berlios.de>

Author: afayolle
Date: 2005-10-06 19:55:48 +0200 (Thu, 06 Oct 2005)
New Revision: 160

Modified:
   trunk/maay/querier.py
   trunk/maay/registration.py
   trunk/maay/registration.tac
   trunk/maay/registrationclient.py
   trunk/maay/server.py
Log:
registrations are sent and memorized, but we can't receive them back :-(

Modified: trunk/maay/querier.py
===================================================================
--- trunk/maay/querier.py	2005-10-06 16:34:27 UTC (rev 159)
+++ trunk/maay/querier.py	2005-10-06 17:55:48 UTC (rev 160)
@@ -77,7 +77,7 @@
         empty string otherwise"""
         
     def registerNode(nodeId, ip, port, bandwidth):
-        """register the current running node in the database"""
+        """register a node in the database"""
         
     def close():
         """closes the DB connection"""

Modified: trunk/maay/registration.py
===================================================================
--- trunk/maay/registration.py	2005-10-06 16:34:27 UTC (rev 159)
+++ trunk/maay/registration.py	2005-10-06 17:55:48 UTC (rev 160)
@@ -27,11 +27,10 @@
 from twisted.protocols.basic import LineReceiver
 
 class RegistrationServer(LineReceiver):
-
-    def __init__(self):
-        # TODO: auto logout after a given time to save memory
-        self._registeredUsers = {}
+    _registeredUsers = {}
+    # TODO: auto logout after a given time to save memory
         
+        
     def lineReceived(self, line):
         """received lines should match the following format :
         action:parm1:param2:...:paramn
@@ -76,4 +75,6 @@
         nodes.reverse()
         for nodeinfo in nodes:
             self.sendLine("\t".join(nodeinfo))
+            print nodeinfo
         self.sendLine('EOT')
+        print 'EOT'

Modified: trunk/maay/registration.tac
===================================================================
--- trunk/maay/registration.tac	2005-10-06 16:34:27 UTC (rev 159)
+++ trunk/maay/registration.tac	2005-10-06 17:55:48 UTC (rev 160)
@@ -24,4 +24,4 @@
 application = service.Application("registrationServer")
 factory = ServerFactory()
 factory.protocol = RegistrationServer
-internet.TCPServer(2345, factory, interface='127.0.0.1').setServiceParent(application)
+internet.TCPServer(2345, factory, interface='').setServiceParent(application)

Modified: trunk/maay/registrationclient.py
===================================================================
--- trunk/maay/registrationclient.py	2005-10-06 16:34:27 UTC (rev 159)
+++ trunk/maay/registrationclient.py	2005-10-06 17:55:48 UTC (rev 160)
@@ -14,34 +14,36 @@
 #     along with this program; if not, write to the Free Software
 #     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
 
-from twisted.internet.protocol import Protocol
+from twisted.internet.protocol import Protocol, ClientCreator
 from time import mktime
 
 class RegistrationClient(Protocol):
-    def __init__(self, nodeRegisterCallback):
-        self._callback = nodeRegisterCallback
-    def login(self, nodeId, ip, port, bandwidth):
-        self.transport.write('login:%s:%d:%d\r\n' % (nodeId, ip, port, bandwidth))
-        self.disconnect()
+    def __init__(self, nodeRegistrationCallback):
+        self.__callback = nodeRegistrationCallback
+        
+    def login(self, nodeId, ip, port, bandwidth) :
+        print "login to registration server"
+        self.transport.write('login:%s:%s:%s:%s\r\n' % (nodeId, ip,
+                                                     port, bandwidth))
+        return self
 
-    def disconnect(self):
-        self.transport.looseConnection()
-
     def logout(self, nodeId):
         self.transport.write('logout:%s\r\n' % nodeId)
-        self.diconnect()
+        self.transport.looseConnection()
 
     def who(self):
+        print "querying registration server"
         self.transport.write('who:\r\n')
 
     def lineReceived(self, data):
         data = data.strip()
+        print "registration server said", data
         if data.startswith('EOT'):
-            self.disconnect()
+            self.transport.looseConnection()
             return
         time, nodeId, nodeIP, nodePort, nodeBandwidth = data.split('\t')
         lastSeenTime = parseTime(time)
-        self._callback(nodeId, nodeIP, nodePort, nodeBandwidth, lastSeenTime)
+        self.__callback(nodeId, nodeIP, nodePort, nodeBandwidth, lastSeenTime)
         
 
 def parseTime(isodatetime):
@@ -49,3 +51,16 @@
     date = [int(s) for s in date.split('-')]
     time = [int(float(s)) for s in time.split(':')]
     return mktime(tuple(date+time+[0,0,0]))
+
+
+def login(reactor, regIP, regPort, querier, nodeId, nodeIP, xmlrpcPort, bandwidth):
+    c = ClientCreator(reactor, RegistrationClient, querier.registerNode)
+    d = c.connectTCP(regIP, regPort)
+    d.addCallback(RegistrationClient.login, nodeId, nodeIP, xmlrpcPort, bandwidth)
+    d.addCallback(RegistrationClient.who)
+
+def logout(reactor, nodeId):
+    c = ClientCreator(reactor, RegistrationClient, None)
+    d = c.connectTCP(regIP, regPort)
+    d.addCallback(RegistrationClient.logout)
+    

Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-06 16:34:27 UTC (rev 159)
+++ trunk/maay/server.py	2005-10-06 17:55:48 UTC (rev 160)
@@ -61,8 +61,8 @@
 from maay.rpc import MaayRPCServer
 from maay.configuration import get_path_of, Configuration
 from maay.texttool import makeAbstract, WORDS_RGX, normalizeText
+from maay import registrationclient 
 
-
 class MaayPage(rend.Page):
     child_maaycss = static.File(get_path_of('maay.css'))
     child_images = static.File(get_path_of('images/'))
@@ -392,6 +392,17 @@
           'help': 'password of anonymous user to use to connect to the database',
           'default' : "maay",
           }),
+        ('registration-host',
+         {'type' : "string", 'metavar' : "<registration_host>", 
+          'help' : "Host name or IP address of the registration server",
+          'default' : "localhost",
+          }),
+        ('registration-port',
+         {'type' : "int", 'metavar' : "<registration_port>", 
+          'help' : "Internet port on which the registration server is listening",
+          'default' : "2345",
+          }),
+        
         ]
 
     config_file = 'webapp.ini'
@@ -450,8 +461,8 @@
         raise ValueError('Unable to find a writable directory to store the node id')
                 
     
-
     
+    
 def run():
     webappConfig = WebappConfiguration()
     webappConfig.load()
@@ -459,6 +470,15 @@
     website = appserver.NevowSite(guard.SessionWrapper(maayPortal,
                                                        mindFactory=MaayMindFactory))
     website.remember(Maay404(), inevow.ICanHandleNotFound)
+    registrationclient.login(reactor,
+                             webappConfig.registration_host, webappConfig.registration_port,
+                             maayPortal.anonymousQuerier,
+                             webappConfig.get_node_id(),
+                             socket.gethostbyname(socket.gethostname()),
+                             6789,
+                             10)
+                                                  
+                             
     rpcserver = server.Site(MaayRPCServer(maayPortal))
     reactor.listenTCP(8080, website)
     reactor.listenTCP(6789, rpcserver)



From afayolle at berlios.de  Fri Oct  7 08:45:29 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Fri, 7 Oct 2005 08:45:29 +0200
Subject: [Maay-svncheckins] r161 - trunk/maay/configuration
Message-ID: <200510070645.j976jTLF029132@sheep.berlios.de>

Author: afayolle
Date: 2005-10-07 08:45:22 +0200 (Fri, 07 Oct 2005)
New Revision: 161

Modified:
   trunk/maay/configuration/webapp.ini
Log:
added new params to handle registration server

Modified: trunk/maay/configuration/webapp.ini
===================================================================
--- trunk/maay/configuration/webapp.ini	2005-10-06 17:55:48 UTC (rev 160)
+++ trunk/maay/configuration/webapp.ini	2005-10-07 06:45:22 UTC (rev 161)
@@ -3,3 +3,5 @@
 db-host=localhost
 user=maay
 password=maay
+registration-host=localhost
+registration-port=2345



From afayolle at berlios.de  Fri Oct  7 08:46:18 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Fri, 7 Oct 2005 08:46:18 +0200
Subject: [Maay-svncheckins] r162 - in trunk/maay: . sql
Message-ID: <200510070646.j976kIvO029939@sheep.berlios.de>

Author: afayolle
Date: 2005-10-07 08:46:07 +0200 (Fri, 07 Oct 2005)
New Revision: 162

Modified:
   trunk/maay/createdb.py
   trunk/maay/sql/mysql.sql
Log:
cleanly handle database removal in createdb

Modified: trunk/maay/createdb.py
===================================================================
--- trunk/maay/createdb.py	2005-10-07 06:45:22 UTC (rev 161)
+++ trunk/maay/createdb.py	2005-10-07 06:46:07 UTC (rev 162)
@@ -17,16 +17,20 @@
 """ helper to create the maay mysql instance on windows platform"""
 import os
 
+def do_delete():
+    pipe = os.popen(r'mysql\bin\mysql.exe -u root mysql', 'w')
+    pipe.write('DROP DATABASE maay;\n')
+    pipe.close()
+    
+
 def do_create():
-	pipe = os.popen(r'mysql\bin\mysql.exe -u root mysql', 'w')
-	print pipe
-	data = file('mysql.sql','rb').read()
-	print data
-	pipe.write(data)
-	pipe.close()
-	print 'done'
-	
+    pipe = os.popen(r'mysql\bin\mysql.exe -u root mysql', 'w')
+    data = file('mysql.sql','rb').read()
+    pipe.write(data)
+    pipe.close()
+    
 if __name__ == '__main__':
-	do_create()
+    do_deleted()
+    do_create()
 	
 	

Modified: trunk/maay/sql/mysql.sql
===================================================================
--- trunk/maay/sql/mysql.sql	2005-10-07 06:45:22 UTC (rev 161)
+++ trunk/maay/sql/mysql.sql	2005-10-07 06:46:07 UTC (rev 162)
@@ -1,7 +1,6 @@
 -- ---------------------------------------------------------
 -- maay database
 -- ---------------------------------------------------------
-DROP DATABASE maay;
 CREATE DATABASE maay DEFAULT CHARACTER SET utf8;
 
 use maay;



From adimasci at berlios.de  Fri Oct  7 08:48:01 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Fri, 7 Oct 2005 08:48:01 +0200
Subject: [Maay-svncheckins] r163 - trunk/maay
Message-ID: <200510070648.j976m1EK031379@sheep.berlios.de>

Author: adimasci
Date: 2005-10-07 08:47:57 +0200 (Fri, 07 Oct 2005)
New Revision: 163

Modified:
   trunk/maay/querier.py
   trunk/maay/registrationclient.py
Log:
- use LineReceiver Protocol for registration client
- fixed typos


Modified: trunk/maay/querier.py
===================================================================
--- trunk/maay/querier.py	2005-10-07 06:46:07 UTC (rev 162)
+++ trunk/maay/querier.py	2005-10-07 06:47:57 UTC (rev 163)
@@ -76,7 +76,7 @@
         Return document url if the document is downloadable and and
         empty string otherwise"""
         
-    def registerNode(nodeId, ip, port, bandwidth):
+    def registerNode(nodeId, ip, port, bandwidth, lastSeenTime=None):
         """register a node in the database"""
         
     def close():
@@ -244,13 +244,14 @@
         self._cnx.commit()
 
 
-    def registerNode(self, nodeId, ip, port, bandwidth):
+    def registerNode(self, nodeId, ip, port, bandwidth, lastSeenTime=None):
+        lastSeenTime = lastSeenTime or int(time.time())
         cursor = self._cnx.cursor()
         node = Node.selectOrInsertWhere(cursor, node_id=nodeId)[0]
         node.ip = ip
         node.port = port
         node.bandwidth = bandwidth
-        node.last_seen_time = int(time.time())
+        node.last_seen_time = lastSeenTime
         node.commit(cursor, update=True)
 
 

Modified: trunk/maay/registrationclient.py
===================================================================
--- trunk/maay/registrationclient.py	2005-10-07 06:46:07 UTC (rev 162)
+++ trunk/maay/registrationclient.py	2005-10-07 06:47:57 UTC (rev 163)
@@ -14,10 +14,11 @@
 #     along with this program; if not, write to the Free Software
 #     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
 
-from twisted.internet.protocol import Protocol, ClientCreator
+from twisted.internet.protocol import ClientCreator
+from twisted.protocols.basic import LineReceiver
 from time import mktime
 
-class RegistrationClient(Protocol):
+class RegistrationClient(LineReceiver):
     def __init__(self, nodeRegistrationCallback):
         self.__callback = nodeRegistrationCallback
         
@@ -29,7 +30,7 @@
 
     def logout(self, nodeId):
         self.transport.write('logout:%s\r\n' % nodeId)
-        self.transport.looseConnection()
+        self.transport.loseConnection()
 
     def who(self):
         print "querying registration server"
@@ -39,7 +40,7 @@
         data = data.strip()
         print "registration server said", data
         if data.startswith('EOT'):
-            self.transport.looseConnection()
+            self.transport.loseConnection()
             return
         time, nodeId, nodeIP, nodePort, nodeBandwidth = data.split('\t')
         lastSeenTime = parseTime(time)



From afayolle at berlios.de  Fri Oct  7 09:02:01 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Fri, 7 Oct 2005 09:02:01 +0200
Subject: [Maay-svncheckins] r164 - trunk
Message-ID: <200510070702.j97721aN006223@sheep.berlios.de>

Author: afayolle
Date: 2005-10-07 09:01:54 +0200 (Fri, 07 Oct 2005)
New Revision: 164

Added:
   trunk/TODO.txt
Log:
extracted from the code and did some manual reformating

Added: trunk/TODO.txt
===================================================================
--- trunk/TODO.txt	2005-10-07 06:47:57 UTC (rev 163)
+++ trunk/TODO.txt	2005-10-07 07:01:54 UTC (rev 164)
@@ -0,0 +1,82 @@
+==============
+Maay TODO List
+==============
+
+converter.py:
+-------------
+
+TODO: add support for xls, ppt,  openoffice, mp3, ogg
+
+XXX: need to handle file encodings
+
+
+dbentity.py:   
+------------
+
+FIXME : UNKNOWN_STATE gets stored in the
+          database as a char in table Document or
+          as a tinyint(4) in table files. Check
+
+XXX mimetype handling is a HACK. It needs to be integrated
+     nicely in order to handle any kind of restrictions easily
+
+XXX: LIMIT clause should be optional
+
+indexer.py:
+-----------
+
+TODO: analyse the God class into something understandable
+
+TODO: manage published/private documents
+
+TODO: manage periodical runs
+
+TODO: memorize state of indexed document to avoid db lookup at each run
+
+TODO: do an initial db query to initialize the indexation state (?)
+
+querier.py:                
+-----------
+FIXME: find a better way to perform this operation
+       the autodetection of the charset guesses latin-1 and
+       this obviously does not work with unicode
+
+FIXME: update node_interests too
+
+XXX Decide if we can compute the content_hash and mime_type ourselves
+    or if the indexer should do it and pass the values as an argument
+
+
+registration.py:
+----------------
+
+TODO: auto logout after a given time to save memory
+
+rpc.py:    
+-------
+
+FIXME: need a better implementation
+
+XXX : could we return twisted.python.failure.Failure instance here ?
+
+XXX: need to differenciate bad cnxId and no last mod time
+
+server.py:        
+----------
+
+XXX: logout message should be forwarded to registration server
+
+XXX make sure that the requested document is really in the database
+
+XXX don't forget to update the download statistics of the document
+
+XXX abstract attribute should be a unicode string
+
+texttool.py:
+------------
+
+XXX FIXME: this function probably already exists somewhere ...
+
+TODO: port original code from htmltotext
+
+XXX: this is a quick and dirty implementation


Property changes on: trunk/TODO.txt
___________________________________________________________________
Name: svn:keywords
   + "Id"
Name: svn:eol-style
   + native



From afayolle at berlios.de  Fri Oct  7 10:21:04 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Fri, 7 Oct 2005 10:21:04 +0200
Subject: [Maay-svncheckins] r165 - trunk/maay
Message-ID: <200510070821.j978L41G024478@sheep.berlios.de>

Author: afayolle
Date: 2005-10-07 10:21:03 +0200 (Fri, 07 Oct 2005)
New Revision: 165

Modified:
   trunk/maay/createdb.py
Log:
stupid typo

Modified: trunk/maay/createdb.py
===================================================================
--- trunk/maay/createdb.py	2005-10-07 07:01:54 UTC (rev 164)
+++ trunk/maay/createdb.py	2005-10-07 08:21:03 UTC (rev 165)
@@ -30,7 +30,7 @@
     pipe.close()
     
 if __name__ == '__main__':
-    do_deleted()
+    do_delete()
     do_create()
 	
 	



From adimasci at berlios.de  Fri Oct  7 10:50:05 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Fri, 7 Oct 2005 10:50:05 +0200
Subject: [Maay-svncheckins] r166 - in trunk/maay: . test
Message-ID: <200510070850.j978o59F031676@sheep.berlios.de>

Author: adimasci
Date: 2005-10-07 10:49:58 +0200 (Fri, 07 Oct 2005)
New Revision: 166

Modified:
   trunk/maay/querier.py
   trunk/maay/registrationclient.py
   trunk/maay/server.py
   trunk/maay/test/test_rpc.py
Log:
Better handling of case where anonymous querier could not be created :
  - force login for web application
  - rpc server refuses anonymous connections in this case
  - do not register
 


Modified: trunk/maay/querier.py
===================================================================
--- trunk/maay/querier.py	2005-10-07 08:21:03 UTC (rev 165)
+++ trunk/maay/querier.py	2005-10-07 08:49:58 UTC (rev 166)
@@ -39,7 +39,6 @@
     """raised on db authentication failure"""
 
 ANONYMOUS_AVATARID = '__anonymous__'
-
     
 class IQuerier(Interface):
     """defines the High-Level interface to Maay SQL database"""

Modified: trunk/maay/registrationclient.py
===================================================================
--- trunk/maay/registrationclient.py	2005-10-07 08:21:03 UTC (rev 165)
+++ trunk/maay/registrationclient.py	2005-10-07 08:49:58 UTC (rev 166)
@@ -55,11 +55,15 @@
 
 
 def login(reactor, regIP, regPort, querier, nodeId, nodeIP, xmlrpcPort, bandwidth):
-    c = ClientCreator(reactor, RegistrationClient, querier.registerNode)
-    d = c.connectTCP(regIP, regPort)
-    d.addCallback(RegistrationClient.login, nodeId, nodeIP, xmlrpcPort, bandwidth)
-    d.addCallback(RegistrationClient.who)
+    if querier is not None:
+        c = ClientCreator(reactor, RegistrationClient, querier.registerNode)
+        d = c.connectTCP(regIP, regPort)
+        d.addCallback(RegistrationClient.login, nodeId, nodeIP, xmlrpcPort, bandwidth)
+        d.addCallback(RegistrationClient.who)
+    else:
+        print "No querier found => no registration / no P2P"
 
+
 def logout(reactor, nodeId):
     c = ClientCreator(reactor, RegistrationClient, None)
     d = c.connectTCP(regIP, regPort)

Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-07 08:21:03 UTC (rev 165)
+++ trunk/maay/server.py	2005-10-07 08:49:58 UTC (rev 166)
@@ -67,7 +67,7 @@
     child_maaycss = static.File(get_path_of('maay.css'))
     child_images = static.File(get_path_of('images/'))
 
-    def __init__(self, maayId):
+    def __init__(self, maayId=ANONYMOUS_AVATARID):
         rend.Page.__init__(self)
         self.maayId = maayId
 
@@ -297,14 +297,15 @@
         return querier
 
 
-class MaayPortal(portal.Portal):
+class MaayPortal(object, portal.Portal):
     """Portal for Maay authentication system"""
     def __init__(self, webappConfig):
         realm = MaayRealm()
         checker = DBAuthChecker(realm, webappConfig.db_host,
                                 webappConfig.db_name)
         portal.Portal.__init__(self, realm, (checker,))
-        self.registerChecker(MaayAnonymousChecker(), IAnonymous)
+        self.anonymousChecker = MaayAnonymousChecker()
+        self.registerChecker(self.anonymousChecker, IAnonymous)
         self.config = webappConfig
         # Create default anonymous querier, based on local configuration
         try:
@@ -328,10 +329,30 @@
                                           port=6789, bandwidth=10)
         self.anonymousQuerier = anonymousQuerier
 
+    def getAnonymousQuerier(self):
+        return getattr(self, '_anonymousQuerier', None)
+
+    def setAnonymousQuerier(self, value):
+        """used to set 'anonymousAllowed' flag in anonymous checker"""
+        if value is not None:
+            self.anonymousChecker.anonymousAllowed = True
+        self._anonymousQuerier = value
+
+    anonymousQuerier = property(getAnonymousQuerier, setAnonymousQuerier,
+                                doc="anonymous querier")
+
+
 class MaayAnonymousChecker(AllowAnonymousAccess):
     """don't use default twisted.cred anonymous avatarId"""
+    def __init__(self):
+        self.anonymousAllowed = False
+        
     def requestAvatarId(self, credentials):
-        return ANONYMOUS_AVATARID
+        if self.anonymousAllowed:
+            return ANONYMOUS_AVATARID
+        else:
+            return failure.Failure(error.UnauthorizedLogin(
+                "No anonymous querier available !"))
 
 
 class DBAuthChecker:
@@ -459,16 +480,32 @@
             except IOError:
                 continue
         raise ValueError('Unable to find a writable directory to store the node id')
-                
+
+
+class MaaySessionWrapper(guard.SessionWrapper):
+    """override guard.SessionWrapper to add an explicit errBack on
+    portal.login()
+
+    XXX: TODO check if we could not use SessionWrapper.incorrectLoginError()
+    """
+    def login(self, request, session, credentials, segments):
+        mind = self.mindFactory(request, credentials)
+        session.mind = mind
+        d = self.portal.login(credentials, mind, self.credInterface)
+        d.addCallback(self._cbLoginSuccess, session, segments)
+        d.addErrback(self._forceLoginPage)
+        return d
+
+    def _forceLoginPage(self, *args):
+        return LoginForm(), ''
     
     
-    
 def run():
     webappConfig = WebappConfiguration()
     webappConfig.load()
     maayPortal = MaayPortal(webappConfig)
-    website = appserver.NevowSite(guard.SessionWrapper(maayPortal,
-                                                       mindFactory=MaayMindFactory))
+    website = appserver.NevowSite(MaaySessionWrapper(maayPortal,
+                                                     mindFactory=MaayMindFactory))
     website.remember(Maay404(), inevow.ICanHandleNotFound)
     registrationclient.login(reactor,
                              webappConfig.registration_host, webappConfig.registration_port,

Modified: trunk/maay/test/test_rpc.py
===================================================================
--- trunk/maay/test/test_rpc.py	2005-10-07 08:21:03 UTC (rev 165)
+++ trunk/maay/test/test_rpc.py	2005-10-07 08:49:58 UTC (rev 166)
@@ -30,6 +30,7 @@
 from twisted.trial import unittest
 from twisted.cred.checkers import ICredentialsChecker
 from twisted.cred.credentials import IUsernamePassword
+from twisted.python.failure import Failure
 
 from maay import rpc
 from maay.querier import MaayQuerier, AnonymousQuerier, ANONYMOUS_AVATARID
@@ -72,6 +73,7 @@
     def setUp(self):
         portal = MaayPortal(WebappConfiguration())
         portal.registerChecker(FakeChecker(portal.realm))
+        self.portal = portal
         rpcserver = server.Site(rpc.MaayRPCServer(portal))
         self.p = reactor.listenTCP(0, rpcserver, interface="127.0.0.1")
         self.port = self.p.getHost().port
@@ -86,11 +88,22 @@
         return proxy.callRemote(methName, *args)        
     
     def testAnonymousAuthentication(self):
+        self.portal.anonymousQuerier = object() # could be anything but None
         digest = self._callRemote('authenticate', '', '')
         got, _ = unittest.deferredResult(digest)
         self.assertEquals(_, '')
         self.assertEquals(got, ANONYMOUS_AVATARID)
 
+    def testAnonymousAuthenticationFailure(self):
+        """when portal.anonymousQuerier is None, anonymous login is not allowed"""
+        self.portal.anonymousQuerier = None
+        digest = self._callRemote('authenticate', '', '')
+        got, err = unittest.deferredResult(digest)
+        self.assertEquals(got, '')
+        # XXX: need a better check
+        self.assertNotEquals(err, '')
+        
+
     def testRawAuthentication(self):
         for user, passwd in [('adim', 'adim'), ('foo', 'bar')]:
             digest = self._callRemote('authenticate', user, passwd)



From afayolle at berlios.de  Fri Oct  7 10:56:13 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Fri, 7 Oct 2005 10:56:13 +0200
Subject: [Maay-svncheckins] r167 - trunk
Message-ID: <200510070856.j978uDA1000708@sheep.berlios.de>

Author: afayolle
Date: 2005-10-07 10:56:08 +0200 (Fri, 07 Oct 2005)
New Revision: 167

Modified:
   trunk/maay.iss
Log:
nicer windows installer (launches maay-server at the end of installation)

Modified: trunk/maay.iss
===================================================================
--- trunk/maay.iss	2005-10-07 08:49:58 UTC (rev 166)
+++ trunk/maay.iss	2005-10-07 08:56:08 UTC (rev 167)
@@ -2,9 +2,11 @@
 
 ; Revision: $Id: maay.iss 40 2005-09-16 14:42:33Z afayolle $
 
+; TODO: Optionnally install sources to comply with the GPL requirements
+
 [Setup]
 AppName=Maay
-AppVerName=Maay snapshot 2005-10-06
+AppVerName=Maay snapshot 2005-10-07
 DefaultDirName={pf}\Maay
 DefaultGroupName=Maay
 UninstallDisplayIcon={app}\maay_server.exe
@@ -12,7 +14,7 @@
 SolidCompression=yes
 LicenseFile=thirdparty\mysql\COPYING.txt
 ; Require 50 MB for the database files. We can tune this later.
-ExtraDiskSpaceRequired=20000000
+ExtraDiskSpaceRequired=50000000
 ; Win9x is not supported
 MinVersion=0,4.0
 InfoBeforeFile=ReleaseNotes
@@ -42,14 +44,20 @@
 Name: "{group}\webapp.ini"; Filename: "{app}\webapp.ini"; Comment: "Maay server configuration"
 Name: "{group}\indexer.ini"; Filename: "{app}\indexer.ini"; Comment: "Maay indexer configuration"
 
+[Tasks]
+;Name: removedatabase; Description: "Erase indexation data"
+;Name: launchmaayserver; Description: "Launch maay server after installation"
 
 [Run]
 Filename: "{app}\mysql\bin\mysqld-max-nt.exe"; Parameters:"--install MySQL --defaults-file=""{app}\mysql\my-maay.ini"""; StatusMsg: "Registering MySQL as a service"; WorkingDir:"{app}\mysql"; Flags:runhidden
 Filename: "NET"; Parameters:"start MySQL"; StatusMsg: "Starting MySQL server"; WorkingDir:"{app}\mysql"; Flags:runhidden
-Filename: "{app}\createdb.exe"; StatusMsg: "Installing database"; WorkingDir:"{app}";
+Filename: "{app}\createdb.exe"; StatusMsg: "Installing database"; WorkingDir:"{app}"; Flags:runhidden
+Filename: "{app}\maay_server.exe"; StatusMsg: "Launching maay server"; WorkingDir:"{app}"; Flags:postinstall nowait
 
 
 [UninstallRun]
 Filename: "NET"; Parameters: "stop MySQL"; StatusMsg: "Stopping MySQL database"; Flags:runhidden
 Filename: "{app}\mysql\bin\mysqld-max-nt.exe"; Parameters:"--remove MySQL"; StatusMsg: "Unregistering MySQL as a service"; WorkingDir:"{app}\mysql"; Flags:runhidden
 
+;[UninstallDelete]
+;Type: filesandordirs; Name: {app}\mysql\data; Tasks: removedatabase



From adimasci at berlios.de  Fri Oct  7 11:02:47 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Fri, 7 Oct 2005 11:02:47 +0200
Subject: [Maay-svncheckins] r168 - trunk/maay/data
Message-ID: <200510070902.j9792lWp002758@sheep.berlios.de>

Author: adimasci
Date: 2005-10-07 11:02:40 +0200 (Fri, 07 Oct 2005)
New Revision: 168

Modified:
   trunk/maay/data/searchform.html
Log:
fixed the "login" link bug on search form
(Impressive how certain I was to have checked for that ....)

The fix makes me think that we should use kind of ZPT macors
for our Pages. Need to investigate on how to do that with Nevow



Modified: trunk/maay/data/searchform.html
===================================================================
--- trunk/maay/data/searchform.html	2005-10-07 08:56:08 UTC (rev 167)
+++ trunk/maay/data/searchform.html	2005-10-07 09:02:40 UTC (rev 168)
@@ -7,8 +7,8 @@
     <link rel="shortcut icon" href="images/maay.ico" />
   </head>
  
-  <body>
-    <a href="login">Login</a>    
+  <body> 
+    <a nevow:render="loginurl"><nevow:attr name="href"><nevow:slot name="loginurl" /></nevow:attr><nevow:slot name="actionlabel" /></a>
     <table class="searchHome">
       <tr>
 	<td><img src="images/maay.png" /></td>



From afayolle at berlios.de  Fri Oct  7 11:09:48 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Fri, 7 Oct 2005 11:09:48 +0200
Subject: [Maay-svncheckins] r169 - trunk/maay
Message-ID: <200510070909.j9799mk5004219@sheep.berlios.de>

Author: afayolle
Date: 2005-10-07 11:09:45 +0200 (Fri, 07 Oct 2005)
New Revision: 169

Modified:
   trunk/maay/configuration.py
Log:
fixed escape char problem in windows path for antiword
prevent paths from being added multiple times by checking if they are already there


Modified: trunk/maay/configuration.py
===================================================================
--- trunk/maay/configuration.py	2005-10-07 09:02:40 UTC (rev 168)
+++ trunk/maay/configuration.py	2005-10-07 09:09:45 UTC (rev 169)
@@ -50,9 +50,9 @@
     path = []
     if os.environ.get('PATH'):
         path.append(os.environ.get('PATH'))
-    for directory in (u'pdftohtml', os.path.join(u'mysql', u'bin')):
-        path.append(os.path.join(maay_dir, directory))
-    path.append(u'c:\antiword')
+    for directory in (u'pdftohtml', os.path.join(u'mysql', u'bin'), ur'c:\antiword'):
+        if path and directory not in path[0]:
+            path.append(os.path.join(maay_dir, directory))
     os.environ['PATH'] =  os.pathsep.join(path)
 
         



From afayolle at berlios.de  Fri Oct  7 11:38:21 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Fri, 7 Oct 2005 11:38:21 +0200
Subject: [Maay-svncheckins] r170 - trunk
Message-ID: <200510070938.j979cLb5009636@sheep.berlios.de>

Author: afayolle
Date: 2005-10-07 11:38:18 +0200 (Fri, 07 Oct 2005)
New Revision: 170

Modified:
   trunk/ChangeLog
Log:
updated for snapshot 20051007

Modified: trunk/ChangeLog
===================================================================
--- trunk/ChangeLog	2005-10-07 09:09:45 UTC (rev 169)
+++ trunk/ChangeLog	2005-10-07 09:38:18 UTC (rev 170)
@@ -1,3 +1,8 @@
+Maay-snapshot20051007 2005-10-07
+        * fixed a problem with db creation on windows
+        * fixed word converter PATH issue
+        * installer now offers to launche maay-server after installation
+
 Maay-snapshot20051006 2005-10-06
 	* Some bug fixes on Windows
 	* Anonymous login supported



From afayolle at berlios.de  Fri Oct  7 13:47:39 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Fri, 7 Oct 2005 13:47:39 +0200
Subject: [Maay-svncheckins] r171 - trunk/maay
Message-ID: <200510071147.j97BldGw026934@sheep.berlios.de>

Author: afayolle
Date: 2005-10-07 13:47:34 +0200 (Fri, 07 Oct 2005)
New Revision: 171

Modified:
   trunk/maay/dbentity.py
   trunk/maay/indexer.py
   trunk/maay/querier.py
   trunk/maay/rpc.py
Log:
Indexation of private and public documents
Querying on private or public documents


Modified: trunk/maay/dbentity.py
===================================================================
--- trunk/maay/dbentity.py	2005-10-07 09:38:18 UTC (rev 170)
+++ trunk/maay/dbentity.py	2005-10-07 11:47:34 UTC (rev 171)
@@ -223,9 +223,10 @@
         else:
             restriction = ""
             restrictionParams = []
+        print "select containing", allowPrivate
         if not allowPrivate:
-            restriction += " AND D.state=%s "
-            restrictionParams.append(cls.PUBLISHED_STATE)
+            restriction += " AND D.state!=%s "
+            restrictionParams.append(cls.PRIVATE_STATE)
         # Question: what is the HAVING clause supposed to do ?
         # Answer: we select all documents containing one of the words
         # that we are looking for, group them by their identifier, and
@@ -248,7 +249,7 @@
                  "HAVING count(DS.db_document_id) = %%s "
                  "LIMIT 15 OFFSET %s" % \
                  (', '.join(['%s'] * len(words)), restriction, offset))
-
+        print query, words + restrictionParams + [len(words)]
         return query, words + restrictionParams + [len(words)]
 
     _selectContainingQuery = classmethod(_selectContainingQuery)

Modified: trunk/maay/indexer.py
===================================================================
--- trunk/maay/indexer.py	2005-10-07 09:38:18 UTC (rev 170)
+++ trunk/maay/indexer.py	2005-10-07 11:47:34 UTC (rev 171)
@@ -30,6 +30,7 @@
 from sets import Set
 from xmlrpclib import ServerProxy, Binary, Fault, ProtocolError
 import mimetypes
+import socket
 
 from maay import converter
 from maay.configuration import Configuration
@@ -102,25 +103,52 @@
                 print "Got failure from server:", errmsg
             raise MaayAuthenticationError("Failed to connect as '%s'" % username)
         
-    def getFileIterator(self):
-        indexed = self.indexerConfig.index_dir
-        skipped = self.indexerConfig.skip_dir
+    def getFileIterator(self, isPrivate=True):
+        if isPrivate:
+            indexed = self.indexerConfig.private_index_dir
+            skipped = self.indexerConfig.private_skip_dir
+            print "private indexation of", indexed, "omitting", skipped
+        else:
+            indexed = self.indexerConfig.public_index_dir
+            skipped = self.indexerConfig.public_skip_dir
+            print "public indexation of", indexed, "omitting", skipped
         return FileIterator(indexed, skipped)
 
     def isIndexable(self, filename):
         return converter.isKnownType(filename)
 
     def start(self):
+        # we index private dirs first because public overrides private
+        existingFiles = self.runIndexer(isPrivate=True)
+        existingFiles += self.runIndexer(isPrivate=False)
+        indexedFiles = Set(self.serverProxy.getIndexedFiles(self.cnxId))
+        oldFiles = indexedFiles - existingFiles
+        for filename in oldFiles:
+            if self.verbose:
+                print "Requesting unindexation of %s" % filename
+            self.serverProxy.removeFileInfo(self.cnxId, filename)
+        if self.verbose:
+            print "Requesting cleanup of unreferenced documents"
+        self.serverProxy.removeUnreferencedDocuments(self.cnxId)
+
+    def runIndexer(self, isPrivate=True):
         existingFiles = Set()
-        for filename in self.getFileIterator():
+        
+        if isPrivate:
+            state = Document.PRIVATE_STATE
+        else:
+            state = Document.PUBLISHED_STATE
+            
+        for filename in self.getFileIterator(isPrivate):
             existingFiles.add(filename)
             if not self.isIndexable(filename):
                 continue
             lastModificationTime = os.path.getmtime(filename)
-            lastIndexationTime = self.getLastIndexationTime(filename)
-            if lastIndexationTime >= lastModificationTime:
+            lastIdxTime, lastIdxState = self.getLastIndexationTimeAndState(filename)
+            if lastIdxState == state and lastIdxTime >= lastModificationTime:
                 if self.verbose:
                     print "%s didn't change since last indexation" % filename
+                continue
             else:
                 fileSize = os.path.getsize(filename)
                 try:
@@ -134,23 +162,15 @@
 
                 self.indexDocument(filename, title, text, fileSize,
                                    lastModificationTime,
-                                   docId, mime_type, Document.PUBLISHED_STATE)
-
-        indexedFiles = Set(self.serverProxy.getIndexedFiles(self.cnxId))
-        oldFiles = indexedFiles - existingFiles
-        for filename in oldFiles:
-            if self.verbose:
-                print "Requesting unindexation of %s" % filename
-            self.serverProxy.removeFileInfo(self.cnxId, filename)
-        if self.verbose:
-            print "Requesting cleanup of unreferenced documents"
-        self.serverProxy.removeUnreferencedDocuments(self.cnxId)
+                                   docId, mime_type, state)
+        return existingFiles
         
-    def getLastIndexationTime(self, filename):
-        lastIndexationTime = self.serverProxy.lastIndexationTime(self.cnxId, filename)
-        if lastIndexationTime is None:
+    def getLastIndexationTimeAndState(self, filename):
+        answer = self.serverProxy.lastIndexationTimeAndState(self.cnxId, filename)
+        if answer is None:
             raise MaayAuthenticationError("Bad cnxId sent to the server")
-        return lastIndexationTime
+        lastTime, lastState = answer
+        return lastTime, lastState
 
     def indexDocument(self, filename, title, text, fileSize,
                       lastModTime, content_hash, mime_type, state,
@@ -193,6 +213,7 @@
             # test path not in self.skipped (dummy config files)
             if path not in self.skipped:
                 for dirpath, dirnames, filenames in os.walk(path):
+                    print "looking in", dirpath
                     self._removeSkippedDirnames(dirpath, dirnames)
                     try:
                         dirpath = unicode(dirpath, 'utf-8')
@@ -210,6 +231,7 @@
         for dirname in dirnames[:]:
             abspath = self.normalizeCase(os.path.join(dirpath, dirname))
             if abspath in self.skipped:
+                print "skipping", dirname
                 dirnames.remove(dirname)
 
 
@@ -244,17 +266,29 @@
           'default' : "maay",
           }),
 
-        ('index-dir',
+        ('private-index-dir',
          {'type': 'csv',
           'metavar': '<csv>', 'short': 'i',
-          'help': 'index this directory'
+          'help': 'index this directory with the private indexer'
           }),
          
-        ('skip-dir',
+        ('private-skip-dir',
          {'type': 'csv',
           'metavar': '<csv>', 'short': 's',
-          'help': 'skip this directory'
+          'help': 'the private indexer will skip this directory'
           }),
+        ('public-index-dir',
+         {'type': 'csv',
+          'metavar': '<csv>', 'short': 'I',
+          'help': 'index this directory with the public indexer'
+          }),
+         
+        ('public-skip-dir',
+         {'type': 'csv',
+          'metavar': '<csv>', 'short': 'S',
+          'help': 'the public indexer will skip this directory'
+          }),
+
         ('verbose',
          {'type': 'yn',
           'metavar': '<y or n>', 'short': 'v',
@@ -272,11 +306,17 @@
     indexerConfig = IndexerConfiguration()
     indexerConfig.load()
     try:
-        indexer = Indexer(indexerConfig)
-    except MaayAuthenticationError, exc:
-        print "AuthenticationError:", exc
+        try:
+            indexer = Indexer(indexerConfig)
+        except MaayAuthenticationError, exc:
+            print "AuthenticationError:", exc
+            sys.exit(1)
+        indexer.start()
+    except socket.error, exc:
+        print "Cannot contact server:", exc
+        print "Check that the server is running on %s:%s" % \
+              (indexerConfig.host, indexerConfig.port)
         sys.exit(1)
-    indexer.start()
 
 if __name__ == '__main__':
     run()

Modified: trunk/maay/querier.py
===================================================================
--- trunk/maay/querier.py	2005-10-07 09:38:18 UTC (rev 170)
+++ trunk/maay/querier.py	2005-10-07 11:47:34 UTC (rev 171)
@@ -132,6 +132,7 @@
 
     def findDocuments(self, query):
         """Find all indexed documents matching the query"""
+        print "Find Documents", self.searchInPrivate
         words = WORDS_RGX.findall(normalizeText(query.words))
         self._updateQueryStatistics(words)
         try:
@@ -342,6 +343,9 @@
             else:
                 # document has not changed
                 doc = doc[0]
+                if doc.state != state:
+                    doc.state = state
+                    doc.commit(cursor, update=True)
                 
             fileinfo.commit(cursor, update=True)
                 

Modified: trunk/maay/rpc.py
===================================================================
--- trunk/maay/rpc.py	2005-10-07 09:38:18 UTC (rev 170)
+++ trunk/maay/rpc.py	2005-10-07 11:47:34 UTC (rev 171)
@@ -25,6 +25,7 @@
 ## from twisted.python.failure import Failure
 
 from maay.querier import MaayQuerier, IQuerier, ANONYMOUS_AVATARID
+from maay.dbentity import Document
 
 def make_uid(username, password):
     """forge a unique identifier"""
@@ -65,20 +66,23 @@
         d.addErrback(lambda failure: ('', str(failure)))
         return d
 
-    def xmlrpc_lastIndexationTime(self, cnxId, filename):
+    def xmlrpc_lastIndexationTimeAndState(self, cnxId, filename):
         if self.cnxIsValid(cnxId):
             filename = unicode(filename)
             querier = self._sessions[cnxId]
             fileInfos = querier.getFileInformations(filename)
             if len(fileInfos):
                 time = fileInfos[0].file_time
+                state = fileInfos[0].state
             else:
                 time = 0
+                state = Document.UNKNOWN_STATE
         else:
             # XXX : could we return twisted.python.failure.Failure instance here ?
             ## return Failure(ValueError("invalid connexion")
             time = -1 # XXX: need to differenciate bad cnxId and no last mod time
-        return time
+            state = Document.UNKNOWN_STATE
+        return time, state
 
     def xmlrpc_getIndexedFiles(self, cnxId):
         if self.cnxIsValid(cnxId):



From afayolle at berlios.de  Fri Oct  7 14:34:32 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Fri, 7 Oct 2005 14:34:32 +0200
Subject: [Maay-svncheckins] r172 - trunk/maay/configuration
Message-ID: <200510071234.j97CYWm0001081@sheep.berlios.de>

Author: afayolle
Date: 2005-10-07 14:34:22 +0200 (Fri, 07 Oct 2005)
New Revision: 172

Modified:
   trunk/maay/configuration/indexer.ini
Log:
added comments and updated to new format

Modified: trunk/maay/configuration/indexer.ini
===================================================================
--- trunk/maay/configuration/indexer.ini	2005-10-07 11:47:34 UTC (rev 171)
+++ trunk/maay/configuration/indexer.ini	2005-10-07 12:34:22 UTC (rev 172)
@@ -1,8 +1,28 @@
 [INDEXER]
+# Host on which the maay server is running
 host=localhost
+#Port on which the maay server is listening
 port=6789
+
+# User login on the maay server 
 user=maay
+# User password on the maay server
 password=maay
-index-dir=c:\
-skip-dir=c:\windows
-verbose=yes
\ No newline at end of file
+
+# Which directories are to be indexed
+#  - private indexed directories are not available to  queries from other nodes
+#  - public indexed directories are available to these queries
+#  - skip dirs are not indexed
+#
+# If a document is available through both a public and a private directory, 
+# the public version prevails
+#
+# You can use a comma separated list of values to specify several
+# directories in each configuration variable. 
+private-index-dirs=c:\
+private-skip-dirs=c:\windows
+public-index-dirs=
+private-index-dirs=
+
+# print messages in the console
+verbose=yes



From afayolle at berlios.de  Fri Oct  7 16:54:43 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Fri, 7 Oct 2005 16:54:43 +0200
Subject: [Maay-svncheckins] r173 - in trunk: . maay
Message-ID: <200510071454.j97EshVo000618@sheep.berlios.de>

Author: afayolle
Date: 2005-10-07 16:54:43 +0200 (Fri, 07 Oct 2005)
New Revision: 173

Modified:
   trunk/TODO.txt
   trunk/maay/querier.py
Log:
TODO: trier les r?\195?\169sultats par pertinence

Modified: trunk/TODO.txt
===================================================================
--- trunk/TODO.txt	2005-10-07 12:34:22 UTC (rev 172)
+++ trunk/TODO.txt	2005-10-07 14:54:43 UTC (rev 173)
@@ -46,6 +46,7 @@
 XXX Decide if we can compute the content_hash and mime_type ourselves
     or if the indexer should do it and pass the values as an argument
 
+TODO: order results using document_scores information
 
 registration.py:
 ----------------

Modified: trunk/maay/querier.py
===================================================================
--- trunk/maay/querier.py	2005-10-07 12:34:22 UTC (rev 172)
+++ trunk/maay/querier.py	2005-10-07 14:54:43 UTC (rev 173)
@@ -132,7 +132,7 @@
 
     def findDocuments(self, query):
         """Find all indexed documents matching the query"""
-        print "Find Documents", self.searchInPrivate
+        # TODO: order results using document_scores information
         words = WORDS_RGX.findall(normalizeText(query.words))
         self._updateQueryStatistics(words)
         try:



From afayolle at berlios.de  Fri Oct  7 16:55:13 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Fri, 7 Oct 2005 16:55:13 +0200
Subject: [Maay-svncheckins] r174 - trunk/maay
Message-ID: <200510071455.j97EtDwN000700@sheep.berlios.de>

Author: afayolle
Date: 2005-10-07 16:55:13 +0200 (Fri, 07 Oct 2005)
New Revision: 174

Modified:
   trunk/maay/dbentity.py
Log:
removed spurious prints

Modified: trunk/maay/dbentity.py
===================================================================
--- trunk/maay/dbentity.py	2005-10-07 14:54:43 UTC (rev 173)
+++ trunk/maay/dbentity.py	2005-10-07 14:55:13 UTC (rev 174)
@@ -223,7 +223,6 @@
         else:
             restriction = ""
             restrictionParams = []
-        print "select containing", allowPrivate
         if not allowPrivate:
             restriction += " AND D.state!=%s "
             restrictionParams.append(cls.PRIVATE_STATE)
@@ -249,7 +248,6 @@
                  "HAVING count(DS.db_document_id) = %%s "
                  "LIMIT 15 OFFSET %s" % \
                  (', '.join(['%s'] * len(words)), restriction, offset))
-        print query, words + restrictionParams + [len(words)]
         return query, words + restrictionParams + [len(words)]
 
     _selectContainingQuery = classmethod(_selectContainingQuery)



From afayolle at berlios.de  Fri Oct  7 16:56:36 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Fri, 7 Oct 2005 16:56:36 +0200
Subject: [Maay-svncheckins] r175 - in trunk/maay: . data
Message-ID: <200510071456.j97EuaT2000860@sheep.berlios.de>

Author: afayolle
Date: 2005-10-07 16:56:35 +0200 (Fri, 07 Oct 2005)
New Revision: 175

Modified:
   trunk/maay/data/resultpage.html
   trunk/maay/data/searchform.html
   trunk/maay/server.py
Log:
handle non ascii queries
write query in text field on result page


Modified: trunk/maay/data/resultpage.html
===================================================================
--- trunk/maay/data/resultpage.html	2005-10-07 14:55:13 UTC (rev 174)
+++ trunk/maay/data/resultpage.html	2005-10-07 14:56:35 UTC (rev 175)
@@ -11,8 +11,8 @@
     <a nevow:render="loginurl"><nevow:attr name="href"><nevow:slot name="loginurl" /></nevow:attr><nevow:slot name="actionlabel" /></a>
     <div class="reSearch">
       <img src="images/smallmaay.png" />
-      <form action="search">
-	<input type="text" name="words" value="" />
+      <form action="search" accept-charset="utf-8">
+	<input type="text" name="words" nevow:render="searchfield"><nevow:attr name="value" ><nevow:slot name="words" /></nevow:attr></input>
 	<input type="submit" class="searchButton" value="search" />
       </form>      
     </div>

Modified: trunk/maay/data/searchform.html
===================================================================
--- trunk/maay/data/searchform.html	2005-10-07 14:55:13 UTC (rev 174)
+++ trunk/maay/data/searchform.html	2005-10-07 14:56:35 UTC (rev 175)
@@ -15,7 +15,7 @@
       </tr>
       <tr>
 	<td>
-	  <form action="search">
+	  <form action="search" accept-charset="utf-8">
 	    <input type="text" name="words" value="" />
 	    <input type="submit" class="searchButton" value="search" />
 	  </form>

Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-07 14:55:13 UTC (rev 174)
+++ trunk/maay/server.py	2005-10-07 14:56:35 UTC (rev 175)
@@ -127,14 +127,19 @@
     return mimetypes.types_map.get('.%s' % fileExtension)
 
 class Query(object):
-    restrictions = ('filetype', 'filename')
-
-    def __init__(self, words, offset=0, filetype=None, filename=None):
+    restrictions = ('filetype', 'filename', 'searchtype')
+    def __init__(self, words, offset=0, filetype=None, filename=None, searchtype='local'):
         self.words = words # unicode string 
         self.offset = offset
         self.filetype = normalizeMimetype(filetype)
         self.filename = filename
+        if searchtype.lower() not in ('local', 'p2p'):
+            searchtype = 'local'
+        self.searchtype = searchtype.lower()
 
+    def isDistributed(self):
+        return self.searchtype == 'p2p'
+
     def fromRawQuery(rawQuery, offset=0):
         rawWords = rawQuery.split()
         words = []
@@ -173,9 +178,9 @@
         return None
 
     def child_search(self, context):
-        # query = unicode(context.arg('words'))
+        # query = unicode(context.arg('words'))        
         offset = int(context.arg('offset', 0))
-        query = Query.fromRawQuery(unicode(context.arg('words')), offset)
+        query = Query.fromRawQuery(unicode(context.arg('words'), 'utf-8'), offset)
         results = self.querier.findDocuments(query)
         return ResultsPage(self.maayId, results, query)
 
@@ -184,7 +189,7 @@
     def child_download(self, context):
         docid = context.arg('docid')
         # query = unicode(context.arg('words'))
-        query = Query.fromRawQuery(unicode(context.arg('words')))
+        query = Query.fromRawQuery(unicode(context.arg('words'), 'utf-8'))
         docurl = self.querier.notifyDownload(docid, query.words)
         if docurl:
             return static.File(docurl)
@@ -209,15 +214,19 @@
         context.fillSlots('words', self.query)
         return context.tag
 
+    def render_searchfield(self, context, data):
+        context.fillSlots('words', self.query)
+        return context.tag
+
     def render_prevset_url(self, context, data):
-        words = WORDS_RGX.findall(normalizeText(unicode(context.arg('words'))))
+        words = WORDS_RGX.findall(normalizeText(unicode(context.arg('words'), 'utf-8')))
         offset = int(context.arg('offset', 0))
         if offset:
             offset -= 15
         return 'search?words=%s&offset=%s' % ('+'.join(words), offset)
 
     def render_nextset_url(self, context, data):
-        words = WORDS_RGX.findall(normalizeText(unicode(context.arg('words'))))
+        words = WORDS_RGX.findall(normalizeText(unicode(context.arg('words'), 'utf-8')))
         offset = int(context.arg('offset', 0)) + 15
         return 'search?words=%s&offset=%s' % ('+'.join(words), offset)
 



From afayolle at berlios.de  Tue Oct 11 16:14:19 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Tue, 11 Oct 2005 16:14:19 +0200
Subject: [Maay-svncheckins] r177 - in trunk/maay: . test
Message-ID: <200510111414.j9BEEJAu023350@sheep.berlios.de>

Author: afayolle
Date: 2005-10-11 16:14:18 +0200 (Tue, 11 Oct 2005)
New Revision: 177

Added:
   trunk/maay/query.py
   trunk/maay/test/test_query.py
Modified:
   trunk/maay/server.py
   trunk/maay/test/test_server.py
Log:
moved the Query class to a separate module to avoid circular dependency

Added: trunk/maay/query.py
===================================================================
--- trunk/maay/query.py	2005-10-07 17:48:09 UTC (rev 176)
+++ trunk/maay/query.py	2005-10-11 14:14:18 UTC (rev 177)
@@ -0,0 +1,56 @@
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
+__revision__ = '$Id$'
+
+
+class Query(object):
+    restrictions = ('filetype', 'filename', 'searchtype')
+    def __init__(self, words, offset=0, filetype=None, filename=None, searchtype='local'):
+        self.words = words # unicode string 
+        self.offset = offset
+        self.filetype = normalizeMimetype(filetype)
+        self.filename = filename
+        if searchtype.lower() not in ('local', 'p2p'):
+            searchtype = 'local'
+        self.searchtype = searchtype.lower()
+
+    def isDistributed(self):
+        return self.searchtype == 'p2p'
+
+    def fromRawQuery(rawQuery, offset=0):
+        rawWords = rawQuery.split()
+        words = []
+        restrictions = {}
+        for word in rawWords:
+            try:
+                restType, restValue = [s.strip() for s in word.split(':')]
+            except ValueError:
+                words.append(word)
+            else:
+                if restType in Query.restrictions:
+                    # Python does not support unicode keywords !
+                    # (note: restType is pure ASCII, so no pb with str())
+                    restrictions[str(restType)] = restValue
+                else:
+                    words.append(word)
+        return Query(u' '.join(words), offset, **restrictions)
+    fromRawQuery = staticmethod(fromRawQuery)
+
+    def __repr__(self):
+        return 'Query Object (%s, %s, %s)' % (self.words, self.filetype,
+                                              self.filename)
+


Property changes on: trunk/maay/query.py
___________________________________________________________________
Name: svn:keywords
   + "Id"
Name: svn:eol-style
   + native

Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-07 17:48:09 UTC (rev 176)
+++ trunk/maay/server.py	2005-10-11 14:14:18 UTC (rev 177)
@@ -61,7 +61,8 @@
 from maay.rpc import MaayRPCServer
 from maay.configuration import get_path_of, Configuration
 from maay.texttool import makeAbstract, WORDS_RGX, normalizeText
-from maay import registrationclient 
+from maay import registrationclient
+from maay.query import Query
 
 class MaayPage(rend.Page):
     child_maaycss = static.File(get_path_of('maay.css'))
@@ -126,43 +127,6 @@
     import mimetypes
     return mimetypes.types_map.get('.%s' % fileExtension)
 
-class Query(object):
-    restrictions = ('filetype', 'filename', 'searchtype')
-    def __init__(self, words, offset=0, filetype=None, filename=None, searchtype='local'):
-        self.words = words # unicode string 
-        self.offset = offset
-        self.filetype = normalizeMimetype(filetype)
-        self.filename = filename
-        if searchtype.lower() not in ('local', 'p2p'):
-            searchtype = 'local'
-        self.searchtype = searchtype.lower()
-
-    def isDistributed(self):
-        return self.searchtype == 'p2p'
-
-    def fromRawQuery(rawQuery, offset=0):
-        rawWords = rawQuery.split()
-        words = []
-        restrictions = {}
-        for word in rawWords:
-            try:
-                restType, restValue = [s.strip() for s in word.split(':')]
-            except ValueError:
-                words.append(word)
-            else:
-                if restType in Query.restrictions:
-                    # Python does not support unicode keywords !
-                    # (note: restType is pure ASCII, so no pb with str())
-                    restrictions[str(restType)] = restValue
-                else:
-                    words.append(word)
-        return Query(u' '.join(words), offset, **restrictions)
-    fromRawQuery = staticmethod(fromRawQuery)
-
-    def __repr__(self):
-        return 'Query Object (%s, %s, %s)' % (self.words, self.filetype,
-                                              self.filename)
-
 class SearchForm(MaayPage):
     """default search form"""
     docFactory = loaders.xmlfile(get_path_of('searchform.html'))
@@ -525,7 +489,8 @@
                              10)
                                                   
                              
-    rpcserver = server.Site(MaayRPCServer(maayPortal))
+    rpcserver = server.Site(MaayRPCServer(webappConfig.get_node_id(),
+                                          maayPortal))
     reactor.listenTCP(8080, website)
     reactor.listenTCP(6789, rpcserver)
     print "Go !"

Added: trunk/maay/test/test_query.py
===================================================================
--- trunk/maay/test/test_query.py	2005-10-07 17:48:09 UTC (rev 176)
+++ trunk/maay/test/test_query.py	2005-10-11 14:14:18 UTC (rev 177)
@@ -0,0 +1,80 @@
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
+import unittest
+
+from maay.query import Query
+
+class QueryTC(unittest.TestCase):
+
+    def testBasicQuery(self):
+        query = Query.fromRawQuery(u"hello")
+        self.assertEquals(query.words, u"hello")
+        # excplitly check for unicode-ness ('hello' == u'hello')
+        self.assertEquals(type(query.words), unicode)
+        self.assertEquals(query.filename, None)
+        self.assertEquals(query.filetype, None)
+        self.assertEquals(query.offset, 0)
+        
+    def testBasicQueryWithSeveralWords(self):
+        query = Query.fromRawQuery(u"hello world")
+        self.assertEquals(query.words, u"hello world")
+        # excplitly check for unicode-ness ('hello' == u'hello')
+        self.assertEquals(type(query.words), unicode)
+        self.assertEquals(query.filename, None)
+        self.assertEquals(query.filetype, None)
+        self.assertEquals(query.offset, 0)
+        
+    def testOneWordRestrictedQuery(self):
+        query = Query.fromRawQuery(u"hello filetype:pdf")
+        self.assertEquals(query.words, u"hello")
+        # excplitly check for unicode-ness ('hello' == u'hello')
+        self.assertEquals(type(query.words), unicode)
+        self.assertEquals(query.filename, None)
+        self.assertEquals(query.filetype, 'application/pdf')
+        self.assertEquals(query.offset, 0)
+
+    def testTwoWordsRestrictedQuery(self):
+        query = Query.fromRawQuery(u"hello filetype:pdf world")
+        self.assertEquals(query.words, u"hello world")
+        # excplitly check for unicode-ness ('hello' == u'hello')
+        self.assertEquals(type(query.words), unicode)
+        self.assertEquals(query.filename, None)
+        self.assertEquals(query.filetype, 'application/pdf')
+        self.assertEquals(query.offset, 0)
+
+    def testTwoWordsRestrictedQueryAndOffset(self):
+        query = Query.fromRawQuery(u"hello filetype:pdf world", 12)
+        self.assertEquals(query.words, u"hello world")
+        # excplitly check for unicode-ness ('hello' == u'hello')
+        self.assertEquals(type(query.words), unicode)
+        self.assertEquals(query.filename, None)
+        self.assertEquals(query.filetype, 'application/pdf')
+        self.assertEquals(query.offset, 12)
+
+    # Commented because not sure how filename should be handled  :
+    # (regexps ? LIKE %...% ?, etc.)
+##     def testSeveralWordsAndSeveralRestrictions(self):
+##         query = Query.fromRawQuery(u"hello filetype:pdf world filename:foo")
+##         self.assertEquals(query.words, u"hello world")
+##         self.assertEquals(query.filename, u"foo")
+##         self.assertEquals(query.filetype, 'text/pdf')
+
+
+if __name__ == '__main__':
+    unittest.main()
+
+


Property changes on: trunk/maay/test/test_query.py
___________________________________________________________________
Name: svn:keywords
   + "Id"
Name: svn:eol-style
   + native

Modified: trunk/maay/test/test_server.py
===================================================================
--- trunk/maay/test/test_server.py	2005-10-07 17:48:09 UTC (rev 176)
+++ trunk/maay/test/test_server.py	2005-10-11 14:14:18 UTC (rev 177)
@@ -15,65 +15,8 @@
 #     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
 
 import unittest
+import maay.server
 
-from maay.server import Query
-
-class UtilsTC(unittest.TestCase):
-
-    def testBasicQuery(self):
-        query = Query.fromRawQuery(u"hello")
-        self.assertEquals(query.words, u"hello")
-        # excplitly check for unicode-ness ('hello' == u'hello')
-        self.assertEquals(type(query.words), unicode)
-        self.assertEquals(query.filename, None)
-        self.assertEquals(query.filetype, None)
-        self.assertEquals(query.offset, 0)
-        
-    def testBasicQueryWithSeveralWords(self):
-        query = Query.fromRawQuery(u"hello world")
-        self.assertEquals(query.words, u"hello world")
-        # excplitly check for unicode-ness ('hello' == u'hello')
-        self.assertEquals(type(query.words), unicode)
-        self.assertEquals(query.filename, None)
-        self.assertEquals(query.filetype, None)
-        self.assertEquals(query.offset, 0)
-        
-    def testOneWordRestrictedQuery(self):
-        query = Query.fromRawQuery(u"hello filetype:pdf")
-        self.assertEquals(query.words, u"hello")
-        # excplitly check for unicode-ness ('hello' == u'hello')
-        self.assertEquals(type(query.words), unicode)
-        self.assertEquals(query.filename, None)
-        self.assertEquals(query.filetype, 'application/pdf')
-        self.assertEquals(query.offset, 0)
-
-    def testTwoWordsRestrictedQuery(self):
-        query = Query.fromRawQuery(u"hello filetype:pdf world")
-        self.assertEquals(query.words, u"hello world")
-        # excplitly check for unicode-ness ('hello' == u'hello')
-        self.assertEquals(type(query.words), unicode)
-        self.assertEquals(query.filename, None)
-        self.assertEquals(query.filetype, 'application/pdf')
-        self.assertEquals(query.offset, 0)
-
-    def testTwoWordsRestrictedQueryAndOffset(self):
-        query = Query.fromRawQuery(u"hello filetype:pdf world", 12)
-        self.assertEquals(query.words, u"hello world")
-        # excplitly check for unicode-ness ('hello' == u'hello')
-        self.assertEquals(type(query.words), unicode)
-        self.assertEquals(query.filename, None)
-        self.assertEquals(query.filetype, 'application/pdf')
-        self.assertEquals(query.offset, 12)
-
-    # Commented because not sure how filename should be handled  :
-    # (regexps ? LIKE %...% ?, etc.)
-##     def testSeveralWordsAndSeveralRestrictions(self):
-##         query = Query.fromRawQuery(u"hello filetype:pdf world filename:foo")
-##         self.assertEquals(query.words, u"hello world")
-##         self.assertEquals(query.filename, u"foo")
-##         self.assertEquals(query.filetype, 'text/pdf')
-
-
 if __name__ == '__main__':
     unittest.main()
 



From afayolle at berlios.de  Tue Oct 11 17:50:26 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Tue, 11 Oct 2005 17:50:26 +0200
Subject: [Maay-svncheckins] r178 - trunk
Message-ID: <200510111550.j9BFoQU3001153@sheep.berlios.de>

Author: afayolle
Date: 2005-10-11 17:50:26 +0200 (Tue, 11 Oct 2005)
New Revision: 178

Modified:
   trunk/TODO.txt
Log:
updated


Modified: trunk/TODO.txt
===================================================================
--- trunk/TODO.txt	2005-10-11 14:14:18 UTC (rev 177)
+++ trunk/TODO.txt	2005-10-11 15:50:26 UTC (rev 178)
@@ -27,8 +27,6 @@
 
 TODO: analyse the God class into something understandable
 
-TODO: manage published/private documents
-
 TODO: manage periodical runs
 
 TODO: memorize state of indexed document to avoid db lookup at each run



From afayolle at berlios.de  Tue Oct 11 18:02:11 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Tue, 11 Oct 2005 18:02:11 +0200
Subject: [Maay-svncheckins] r179 - trunk/maay
Message-ID: <200510111602.j9BG2Bx1002228@sheep.berlios.de>

Author: afayolle
Date: 2005-10-11 18:02:11 +0200 (Tue, 11 Oct 2005)
New Revision: 179

Modified:
   trunk/maay/query.py
Log:
added missing function

Modified: trunk/maay/query.py
===================================================================
--- trunk/maay/query.py	2005-10-11 15:50:26 UTC (rev 178)
+++ trunk/maay/query.py	2005-10-11 16:02:11 UTC (rev 179)
@@ -16,7 +16,11 @@
 
 __revision__ = '$Id$'
 
+def normalizeMimetype(fileExtension):
+    import mimetypes
+    return mimetypes.types_map.get('.%s' % fileExtension)
 
+
 class Query(object):
     restrictions = ('filetype', 'filename', 'searchtype')
     def __init__(self, words, offset=0, filetype=None, filename=None, searchtype='local'):



From afayolle at berlios.de  Thu Oct 13 12:45:29 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Thu, 13 Oct 2005 12:45:29 +0200
Subject: [Maay-svncheckins] r180 - trunk
Message-ID: <200510131045.j9DAjTTT019392@sheep.berlios.de>

Author: afayolle
Date: 2005-10-13 12:45:27 +0200 (Thu, 13 Oct 2005)
New Revision: 180

Modified:
   trunk/README.txt
Log:
fixed warning title

Modified: trunk/README.txt
===================================================================
--- trunk/README.txt	2005-10-11 16:02:11 UTC (rev 179)
+++ trunk/README.txt	2005-10-13 10:45:27 UTC (rev 180)
@@ -1,5 +1,5 @@
 Warning
-======
+=======
 
 This is alpha quality software. Before launching anything be sure to read 
 this document and the release notes for the program. On Windows systems, 



From afayolle at berlios.de  Thu Oct 13 16:02:09 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Thu, 13 Oct 2005 16:02:09 +0200
Subject: [Maay-svncheckins] r181 - trunk/maay/test
Message-ID: <200510131402.j9DE29HM009505@sheep.berlios.de>

Author: afayolle
Date: 2005-10-13 16:02:09 +0200 (Thu, 13 Oct 2005)
New Revision: 181

Added:
   trunk/maay/test/test_boilerplate.py
Log:
starting point for new test files

Added: trunk/maay/test/test_boilerplate.py
===================================================================
--- trunk/maay/test/test_boilerplate.py	2005-10-13 10:45:27 UTC (rev 180)
+++ trunk/maay/test/test_boilerplate.py	2005-10-13 14:02:09 UTC (rev 181)
@@ -0,0 +1,37 @@
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
+"""unit tests for WRITEME
+
+This file is a template for new test files.
+Copy it and rename everything to match your needs
+"""
+__revision__ = '$Id$'
+
+import unittest
+
+class SomeTestTC(unittest.TestCase):
+    def setUp(self):
+        pass
+
+    def tearDown(self):
+        pass
+
+    def testSomething(self):
+        pass
+
+if __name__ == '__main__':
+    unittest.main()


Property changes on: trunk/maay/test/test_boilerplate.py
___________________________________________________________________
Name: svn:keywords
   + "Id"
Name: svn:eol-style
   + native



From afayolle at berlios.de  Thu Oct 13 16:03:29 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Thu, 13 Oct 2005 16:03:29 +0200
Subject: [Maay-svncheckins] r182 - trunk/maay
Message-ID: <200510131403.j9DE3Tss009594@sheep.berlios.de>

Author: afayolle
Date: 2005-10-13 16:03:29 +0200 (Thu, 13 Oct 2005)
New Revision: 182

Modified:
   trunk/maay/indexer.py
Log:
handle private/public configuration

Modified: trunk/maay/indexer.py
===================================================================
--- trunk/maay/indexer.py	2005-10-13 14:02:09 UTC (rev 181)
+++ trunk/maay/indexer.py	2005-10-13 14:03:29 UTC (rev 182)
@@ -75,7 +75,6 @@
     stream.close()
     return hasher.hexdigest()
     
-# TODO: manage published/private documents
 # TODO: manage periodical runs
 # TODO: memorize state of indexed document to avoid db lookup at each run
 # TODO: do an initial db query to initialize the indexation state (?)
@@ -118,7 +117,6 @@
         return converter.isKnownType(filename)
 
     def start(self):
-        raise "FIXME Error. See comment below"
         # we index private dirs first because public overrides private
         existingFiles = self.runIndexer(isPrivate=True)
         # XXX FIXME: last run gave
@@ -130,7 +128,7 @@
         #     existingFiles += self.runIndexer(isPrivate=False)
         # TypeError: unsupported operand type(s) for +=: 'Set' and 'Set'
 
-        existingFiles += self.runIndexer(isPrivate=False)
+        existingFiles.union(self.runIndexer(isPrivate=False))
         indexedFiles = Set(self.serverProxy.getIndexedFiles(self.cnxId))
         oldFiles = indexedFiles - existingFiles
         for filename in oldFiles:



From afayolle at berlios.de  Thu Oct 13 16:03:56 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Thu, 13 Oct 2005 16:03:56 +0200
Subject: [Maay-svncheckins] r183 - trunk/maay
Message-ID: <200510131403.j9DE3ufF009657@sheep.berlios.de>

Author: afayolle
Date: 2005-10-13 16:03:56 +0200 (Thu, 13 Oct 2005)
New Revision: 183

Modified:
   trunk/maay/dbstats.py
Log:
more information on db words

Modified: trunk/maay/dbstats.py
===================================================================
--- trunk/maay/dbstats.py	2005-10-13 14:03:29 UTC (rev 182)
+++ trunk/maay/dbstats.py	2005-10-13 14:03:56 UTC (rev 183)
@@ -18,15 +18,28 @@
 """Helper script to display how many rows are stored in the various maay tables on localhost"""
 
 from MySQLdb import connect
+from Scientific.Statistics.Histogram import Histogram
 
 cnx = connect(user='maay', passwd='maay', use_unicode=True, db='maay')
 cursor = cnx.cursor()
 tables = ['document_providers', 'document_scores', 'documents',
           'files', 'node_interests', 'nodes', 'words']
+
+size = {}
 for table  in tables:
     cursor.execute('select count(*) from %s'%table)
     nbRows = cursor.fetchone()[0]
+    size[table] = nbRows
     print "Table %s: %d rows" % (table, nbRows)
 
+r = """SELECT count(word) from document_scores group by word"""
+cursor.execute(r)
+h = Histogram(cursor.fetchall(), 10)
+
+for i in range(10):
+    print h[i]
+
+
+
 cnx.close()
     



From afayolle at berlios.de  Thu Oct 13 16:05:05 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Thu, 13 Oct 2005 16:05:05 +0200
Subject: [Maay-svncheckins] r184 - in trunk/maay: . test
Message-ID: <200510131405.j9DE55tf009755@sheep.berlios.de>

Author: afayolle
Date: 2005-10-13 16:05:03 +0200 (Thu, 13 Oct 2005)
New Revision: 184

Added:
   trunk/maay/test/test_p2p.py
Modified:
   trunk/maay/dbentity.py
   trunk/maay/querier.py
   trunk/maay/rpc.py
   trunk/maay/server.py
   trunk/maay/test/test_rpc.py
Log:
first attempt at P2P queries

Modified: trunk/maay/dbentity.py
===================================================================
--- trunk/maay/dbentity.py	2005-10-13 14:03:56 UTC (rev 183)
+++ trunk/maay/dbentity.py	2005-10-13 14:05:03 UTC (rev 184)
@@ -382,13 +382,29 @@
      * double affinity: caracterisation of interests similar to the
        running node (values close to 1 ar better)
      
-     * int bandwidth: constant for now (value = 10)
+     * int bandwidth: bandwidth of the node
     """
     tableName = 'nodes'
     attributes = ('node_id', 'ip', 'port', 'last_seen_time', 'counter',
                   'claim_count', 'affinity', 'bandwidth')
     key = ('node_id',)
 
+    def _selectActiveQuery(cls):
+        query = cls._selectQuery()
+        query += " WHERE node_id != %s ORDER BY last_seen_time DESC LIMIT %s"
+        return query
+    
+    _selectActiveQuery = classmethod(_selectActiveQuery)
+
+    def selectActive(cls, cursor, currentNodeId, maxResults):
+        query = cls._selectActiveQuery()
+        cursor.execute(query, currentNodeId, maxResults)
+        results = cursor.fetchall()
+        return [cls(**dict(zip(cls.attributes, row))) for row in results]
+    selectActive = classmethod(selectActive)
+        
+
+
 class NodeInterest(DBEntity):
     """
     Attributes:

Modified: trunk/maay/querier.py
===================================================================
--- trunk/maay/querier.py	2005-10-13 14:03:56 UTC (rev 183)
+++ trunk/maay/querier.py	2005-10-13 14:05:03 UTC (rev 184)
@@ -78,6 +78,9 @@
     def registerNode(nodeId, ip, port, bandwidth, lastSeenTime=None):
         """register a node in the database"""
         
+    def registerNodeActivity(nodeId):
+        """update lastSeenTime for node"""
+        
     def close():
         """closes the DB connection"""
 
@@ -188,7 +191,7 @@
 
 
     def _updateQueryStatistics(self, words):
-        # FIXME: update node_interests too
+        # FIXME: update node_interests too, but we need the nodeId to do this
         cursor = self._cnx.cursor()
         for word in words:
             winfo = Word.selectOrInsertWhere(cursor, word=word)[0]
@@ -253,8 +256,20 @@
         node.bandwidth = bandwidth
         node.last_seen_time = lastSeenTime
         node.commit(cursor, update=True)
+        cursor.close()
 
+    def registerNodeActivity(self, nodeId):
+        cursor = self._cnx.cursor()
+        node = Node.selectWhere(cursor, node_id=nodeId)[0]
+        node.last_seen_time = int(time.time())
+        node.commit(cursor, update=True)
+        cursor.close()
 
+    def getActiveNeighbors(self, nodeId, nbNodes):
+        cursor = self._cnx.cursor()
+        nodes = Node.selectActive(nodeId, nbNodes)
+        cursor.close()
+        return nodes
     
 class MaayQuerier(AnonymousQuerier):
     """High-Level interface to Maay SQL database.

Modified: trunk/maay/rpc.py
===================================================================
--- trunk/maay/rpc.py	2005-10-13 14:03:56 UTC (rev 183)
+++ trunk/maay/rpc.py	2005-10-13 14:05:03 UTC (rev 184)
@@ -21,11 +21,13 @@
 from twisted.web.xmlrpc import XMLRPC
 from twisted.cred.credentials import UsernamePassword, Anonymous
 from twisted.cred.error import UnauthorizedLogin
-from twisted.internet import defer
+from twisted.internet import defer, reactor
 ## from twisted.python.failure import Failure
 
 from maay.querier import MaayQuerier, IQuerier, ANONYMOUS_AVATARID
 from maay.dbentity import Document
+from maay.p2pquerier import P2pQuerier, P2pQuery
+from maay.query import Query
 
 def make_uid(username, password):
     """forge a unique identifier"""
@@ -35,12 +37,13 @@
 
 class MaayRPCServer(XMLRPC):
 
-    def __init__(self, portal):
+    def __init__(self, nodeId, portal):
         XMLRPC.__init__(self)
         self._sessions = {}
         self.portal = portal
         self.node_id = portal.config.get_node_id()
         self._sessions[ANONYMOUS_AVATARID] = portal.anonymousQuerier
+        self._p2pQuerier = P2pQuerier(nodeId, portal.anonymousQuerier)
         
     def _attachUser(self, (interface, querier, logout), username, password):
         if interface is not IQuerier or querier is None:
@@ -124,6 +127,22 @@
                                   lastModifiedOn, content_hash, mime_type, state,
                                   file_state)
         return 0
+
+    def xmlrpc_distributedQuery(self, queryId, sender, ttl, words, mime_type):
+        query = P2pQuery(queryId,
+                         sender,
+                         ttl,
+                         Query(words, filetype=mime_type))
+        # schedule the query for later processing and return immediately
+        # this enables the sender to query several nodes in a row
+        d = reactor.callLater(.01, self._p2pQuerier.receiveQuery, query)
+        return self.nodeId
+
+    def xmlrpc_distributedQueryAnswer(self, queryId, senderId, documents):
+        answer = P2pAnswer()
+        d = reactor.callLater(.01, self._p2pQuerier.receiveAnswer,answer)
+        return self.nodeId
+                         
     
     def cnxIsValid(self, cnxId):
         if cnxId in self._sessions:

Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-13 14:03:56 UTC (rev 183)
+++ trunk/maay/server.py	2005-10-13 14:05:03 UTC (rev 184)
@@ -123,10 +123,6 @@
         )
 
 
-def normalizeMimetype(fileExtension):
-    import mimetypes
-    return mimetypes.types_map.get('.%s' % fileExtension)
-
 class SearchForm(MaayPage):
     """default search form"""
     docFactory = loaders.xmlfile(get_path_of('searchform.html'))
@@ -299,7 +295,8 @@
             realm.createUserSession(ANONYMOUS_AVATARID, anonymousQuerier)
             anonymousQuerier.registerNode(self.config.get_node_id(),
                                           ip=socket.gethostbyname(socket.gethostname()),
-                                          port=6789, bandwidth=10)
+                                          port=webappConfig.rpcserver_port,
+                                          bandwidth=webappConfig.bandwidth)
         self.anonymousQuerier = anonymousQuerier
 
     def getAnonymousQuerier(self):
@@ -394,9 +391,28 @@
         ('registration-port',
          {'type' : "int", 'metavar' : "<registration_port>", 
           'help' : "Internet port on which the registration server is listening",
-          'default' : "2345",
+          'default' : 2345,
           }),
+        ('webserver-port',
+         {'type' : "int", 'metavar' : "<webserver_port>", 
+          'help' : "Internet port on which the web interface is listening",
+          'default' : 8080,
+          }),
+        ('rpcserver-port',
+         {'type' : "int", 'metavar' : "<rpcserver_port>", 
+          'help' : "Internet port on which the xmlrpc server is listening",
+          'default' : 6789,
+          }),
         
+        ('bandwidth',
+         {'type' : "int", 'metavar' : "<bandwidth>", 
+          'help' : "Internet port on which the xmlrpc server is listening",
+          'default' : 10,
+          }),
+        
+        
+        
+        
         ]
 
     config_file = 'webapp.ini'
@@ -485,14 +501,14 @@
                              maayPortal.anonymousQuerier,
                              webappConfig.get_node_id(),
                              socket.gethostbyname(socket.gethostname()),
-                             6789,
-                             10)
+                             webappConfig.rpcserver_port,
+                             webappConfig.bandwidth)
                                                   
                              
     rpcserver = server.Site(MaayRPCServer(webappConfig.get_node_id(),
                                           maayPortal))
-    reactor.listenTCP(8080, website)
-    reactor.listenTCP(6789, rpcserver)
+    reactor.listenTCP(webappConfig.webserver_port, website)
+    reactor.listenTCP(webappConfig.rpcserver_port, rpcserver)
     print "Go !"
     reactor.run()
 

Added: trunk/maay/test/test_p2p.py
===================================================================
--- trunk/maay/test/test_p2p.py	2005-10-13 14:03:56 UTC (rev 183)
+++ trunk/maay/test/test_p2p.py	2005-10-13 14:05:03 UTC (rev 184)
@@ -0,0 +1,64 @@
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
+"""unit tests for P2P queries"""
+
+__revision__ = '$Id$'
+
+import unittest
+from maay.server import Query
+from maay.p2pquerier import *
+from maay.dbentity import Document
+
+class P2pQueryTC(unittest.TestCase):
+    def setUp(self):
+        self.query = P2pQuery(queryId='1'*40,
+                              sender='http://localhost:3423',
+                              ttl=2,
+                              query=None)
+
+    def testHop(self):
+        ttl = self.query.ttl
+        self.query.hop()
+        self.assertEquals(self.query.ttl, ttl-1)
+
+    def testAddMatch(self):
+        doc = Document(document_id = '0'*40)
+        self.query.addMatch(doc)
+        self.failUnless('0'*40 in self.query.documents)
+
+    def testIsKnown(self):
+        doc = Document(document_id = '0'*40)
+        self.query.addMatch(doc)
+        self.failUnless(self.query.isKnown(doc))
+        self.failIf(self.query.isKnown(Document(document_id = '1'*40)))
+
+class P2pQuerierTC(unittest.TestCase):
+    def setUp(self):
+        self.querier = P2pQuerier('0'*40)
+        self.query = P2pQuery(queryId='1'*40,
+                              sender='http://localhost:3423',
+                              ttl=2,
+                              query=None)
+
+    def tearDown(self):
+        self.querier._queries = {}
+
+    def test_selectTargetNeighbors(self):
+        pass
+        
+if __name__ == '__main__':
+    unittest.main()


Property changes on: trunk/maay/test/test_p2p.py
___________________________________________________________________
Name: svn:keywords
   + "Id"
Name: svn:eol-style
   + native

Modified: trunk/maay/test/test_rpc.py
===================================================================
--- trunk/maay/test/test_rpc.py	2005-10-13 14:03:56 UTC (rev 183)
+++ trunk/maay/test/test_rpc.py	2005-10-13 14:05:03 UTC (rev 184)
@@ -74,7 +74,7 @@
         portal = MaayPortal(WebappConfiguration())
         portal.registerChecker(FakeChecker(portal.realm))
         self.portal = portal
-        rpcserver = server.Site(rpc.MaayRPCServer(portal))
+        rpcserver = server.Site(rpc.MaayRPCServer(None, portal))
         self.p = reactor.listenTCP(0, rpcserver, interface="127.0.0.1")
         self.port = self.p.getHost().port
         
@@ -120,7 +120,7 @@
     def testCertifiedRemoteCall(self):
         d = self._callRemote('authenticate', 'adim', 'adim')
         cnxId, _ = unittest.deferredResult(d)
-        retValue = self._callRemote('lastIndexationTime', cnxId, 'foo.pdf')
+        retValue = self._callRemote('lastIndexationTimeAndState', cnxId, 'foo.pdf')
         self.assertEquals(unittest.deferredResult(retValue), 0)
 
 if __name__ == '__main__':



From adimasci at berlios.de  Thu Oct 13 22:14:55 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Thu, 13 Oct 2005 22:14:55 +0200
Subject: [Maay-svncheckins] r185 - trunk/maay
Message-ID: <200510132014.j9DKEtQJ000211@sheep.berlios.de>

Author: adimasci
Date: 2005-10-13 22:14:55 +0200 (Thu, 13 Oct 2005)
New Revision: 185

Modified:
   trunk/maay/server.py
Log:
memorize current url before login to be able to return there
in case of successful login


Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-13 14:05:03 UTC (rev 184)
+++ trunk/maay/server.py	2005-10-13 20:14:55 UTC (rev 185)
@@ -73,12 +73,20 @@
         self.maayId = maayId
 
     def render_loginurl(self, context, data):
+        url = URL.fromContext(context)
+        # store current URL into  'goThereAfter' to be able to return here
+        # after login
         if self.maayId != ANONYMOUS_AVATARID:
+            goThereAfter = URL(url.scheme, url.netloc,
+                               ['logout'] + url.pathList())
             context.fillSlots('actionlabel', 'Logout')
-            context.fillSlots('loginurl', '/logout')
         else:
+            goThereAfter = URL(url.scheme, url.netloc,
+                               ['login'] + url.pathList())
             context.fillSlots('actionlabel', 'Login')            
-            context.fillSlots('loginurl', '/login')
+        for param, value in url.queryList():
+            goThereAfter = goThereAfter.add(param, value)
+        context.fillSlots('loginurl', str(goThereAfter))
         return context.tag
 
     def child_login(self, context):
@@ -95,7 +103,17 @@
     """a basic login form. This page is rendered until the user
     is logged.
     """
-    addSlash = True
+    # addSlash = True
+
+    def path(self, context, data):
+        here = URL.fromContext(context)
+        # transform /login/somePathAndQuery into /__login__/somePathAndQuery
+        # to benefit from nevow.guard redirection magic
+        pathList = ['__login__'] + here.pathList()[1:]
+        goThereAfter = URL(here.scheme, here.netloc,
+                           pathList, here.queryList())
+        return str(goThereAfter)
+
     docFactory = loaders.stan(
         tags.html[
             tags.head[tags.title["Maay Login Page",],
@@ -104,7 +122,8 @@
                       ],
             
             tags.body[
-                tags.form(action='/'+guard.LOGIN_AVATAR, method='post')[
+                # tags.form(action='/'+guard.LOGIN_AVATAR, render=path, method='post')[
+                tags.form(action=path, method='post')[
                     tags.table(_class="loginTable")[
                         tags.tr[
                             tags.td[ "Username:" ],
@@ -122,7 +141,9 @@
             ]
         )
 
-
+    def childFactory(self, context, segments):
+        return LoginForm()
+    
 class SearchForm(MaayPage):
     """default search form"""
     docFactory = loaders.xmlfile(get_path_of('searchform.html'))
@@ -478,6 +499,8 @@
     XXX: TODO check if we could not use SessionWrapper.incorrectLoginError()
     """
     def login(self, request, session, credentials, segments):
+        # d = SessionWrapper.login()
+        # d.addErrback(..)
         mind = self.mindFactory(request, credentials)
         session.mind = mind
         d = self.portal.login(credentials, mind, self.credInterface)



From afayolle at berlios.de  Fri Oct 14 09:53:15 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Fri, 14 Oct 2005 09:53:15 +0200
Subject: [Maay-svncheckins] r186 - trunk/maay
Message-ID: <200510140753.j9E7rFIp024673@sheep.berlios.de>

Author: afayolle
Date: 2005-10-14 09:53:14 +0200 (Fri, 14 Oct 2005)
New Revision: 186

Added:
   trunk/maay/p2pquerier.py
Log:
begin p2p implementation

Added: trunk/maay/p2pquerier.py
===================================================================
--- trunk/maay/p2pquerier.py	2005-10-13 20:14:55 UTC (rev 185)
+++ trunk/maay/p2pquerier.py	2005-10-14 07:53:14 UTC (rev 186)
@@ -0,0 +1,135 @@
+#     Copyright (C) 2005 France Telecom R&D
+#
+#     This program is free software; you can redistribute it and/or modify
+#     it under the terms of the GNU General Public License as published by
+#     the Free Software Foundation; either version 2 of the License, or
+#     (at your option) any later version.
+#
+#     This program is distributed in the hope that it will be useful,
+#     but WITHOUT ANY WARRANTY; without even the implied warranty of
+#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#     GNU General Public License for more details.
+#
+#     You should have received a copy of the GNU General Public License
+#     along with this program; if not, write to the Free Software
+#     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
+"""Management of distributed queries
+
+"""
+__revision__ = '$Id$'
+
+from sets import Set
+
+from twisted.web.xmlrpc import Proxy
+
+# XXX should P2pQuery derive from query.Query?
+class P2pQuery:
+    def __init__(self, queryId, sender, ttl, query):
+        self.id = queryId
+        self.sender = sender
+        self.ttl = ttl
+        self.query = query
+        self.query.searchtype = 'p2p'
+        self.documents = Set
+
+    def hop(self):
+        self.ttl -= 1
+
+    def addMatch(self, document):
+        self.documents.add(document.document_id)
+
+    def isKnown(self, document):
+        return document.document_id in self.documents
+ 
+    def asKwargs(self):
+        """return a dictionnary of arguments suitable for use as a
+        **kwargs parameters to a call to distributedQuery"""
+
+        return {'id':self.query_id,
+                'sender':sender,
+                'ttl':ttl,
+                'words': self.query.words,
+                'mime_type': self.query.mime_type,
+                }
+
+class P2pAnswer:
+    def __init__(self, queryId, documents):
+        self.queryId = queryId
+        self.documents = documents
+
+class P2pQuerier:
+    """The P2pQuerier class is responsible for managing P2P queries.
+
+    The sendQuery method is called by the web interface to send a
+    distributed query to other Maay nodes, and by the P2pQuerier
+    itself to broadcast a query to other known nodes.
+
+    Distributed queries answers are sent back to the requester, and
+    the rpc server calls receiveQuery. This method will forward the
+    query to other nodes if it has not exceeded its TTL, and query the
+    and the answers are stored in the local database as well to update
+    the statistical information available about the neighbors'
+    documents.
+    """
+    _queries = {}
+    
+    def __init__(self, nodeId, querier):
+        self.nodeId = nodeId
+        self.querier = querier
+
+    def sendQuery(self, query):
+        for neighbor in self._selectTargetNeighbors(query):
+            proxy = Proxy(neighbor)
+            d = proxy.callRemote('distributedQuery', query.asKwargs())
+            d.addCallback(self.querier.registerNodeActivity)
+            print "sent %s to %s" % (query, neighbor)
+
+    def receiveQuery(self, query):
+        if query.id in self._queries:
+            return
+        
+        self._queries[query.id] = query
+
+        query.hop()        
+        if query.ttl > 0:
+            self.sendQuery(query)
+
+        documents = self.querier.findDocuments(query.query)
+        self.receiveAnswer(P2pAnswer(query.id, documents))
+
+    def receiveAnswer(self, answer, local=False):
+        """record and forward answers to a query.
+        If local is True, then the answers come from a local query,
+        and thus must not be recorded in the database"""
+        query = self._queries.get(answer.queryId)
+        if query is None:
+            return
+        
+        toSend = []
+        
+        for document in answer.documents:
+            # TODO: record answer in database if local is False
+            if query.isKnown(document):
+                self.query.addMatch(document)
+                toSend.append(document.asDictionnary())
+        
+        if query.sender != self.nodeId:
+            try:
+                senderUrl = self.querier.getNodeUrl(query.sender)
+                proxy = Proxy(senderUrl)
+                d = proxy.callRemote('distributedQueryAnswer',
+                                     query.id,
+                                     self.nodeId,
+                                     toSend)
+                d.addCallback(self.querier.registerNodeActivity)
+            except ValueError:
+                print "unknown node %s" % query.sender
+    
+    def _selectTargetNeighbors(self, query):
+        """return a list of nodes to which the query will be sent.
+        """
+        nbNodes = 2**(max(0, 5-query.ttl))
+        # TODO: use the neighbors' profiles to route requests
+        return self.querier.getActiveNeighbors(self.nodeId, nbNodes)
+        


Property changes on: trunk/maay/p2pquerier.py
___________________________________________________________________
Name: svn:keywords
   + "Id"
Name: svn:eol-style
   + native



From afayolle at berlios.de  Fri Oct 14 10:15:25 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Fri, 14 Oct 2005 10:15:25 +0200
Subject: [Maay-svncheckins] r187 - trunk/maay
Message-ID: <200510140815.j9E8FPue027663@sheep.berlios.de>

Author: afayolle
Date: 2005-10-14 10:15:24 +0200 (Fri, 14 Oct 2005)
New Revision: 187

Modified:
   trunk/maay/indexer.py
Log:
error fixed, removed comment

Modified: trunk/maay/indexer.py
===================================================================
--- trunk/maay/indexer.py	2005-10-14 07:53:14 UTC (rev 186)
+++ trunk/maay/indexer.py	2005-10-14 08:15:24 UTC (rev 187)
@@ -119,15 +119,6 @@
     def start(self):
         # we index private dirs first because public overrides private
         existingFiles = self.runIndexer(isPrivate=True)
-        # XXX FIXME: last run gave
-        #   File "bin/maay-indexer", line 20, in ?
-        #     run()
-        #   File "/home/alf/lib/python/maay/indexer.py", line 314, in run
-        #     indexer.start()
-        #   File "/home/alf/lib/python/maay/indexer.py", line 123, in start
-        #     existingFiles += self.runIndexer(isPrivate=False)
-        # TypeError: unsupported operand type(s) for +=: 'Set' and 'Set'
-
         existingFiles.union(self.runIndexer(isPrivate=False))
         indexedFiles = Set(self.serverProxy.getIndexedFiles(self.cnxId))
         oldFiles = indexedFiles - existingFiles



From aurelienc at berlios.de  Mon Oct 17 15:02:38 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Mon, 17 Oct 2005 15:02:38 +0200
Subject: [Maay-svncheckins] r189 - trunk/maay
Message-ID: <200510171302.j9HD2cp1001585@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-17 15:02:38 +0200 (Mon, 17 Oct 2005)
New Revision: 189

Modified:
   trunk/maay/indexer.py
   trunk/maay/p2pquerier.py
   trunk/maay/texttool.py
Log:
Added a file permission check into FileIterator class (indexer) (we may not have read permission)


Modified: trunk/maay/indexer.py
===================================================================
--- trunk/maay/indexer.py	2005-10-14 14:20:26 UTC (rev 188)
+++ trunk/maay/indexer.py	2005-10-17 13:02:38 UTC (rev 189)
@@ -122,6 +122,7 @@
         existingFiles.union(self.runIndexer(isPrivate=False))
         indexedFiles = Set(self.serverProxy.getIndexedFiles(self.cnxId))
         oldFiles = indexedFiles - existingFiles
+        oldfiles = []
         for filename in oldFiles:
             if self.verbose:
                 print "Requesting unindexation of %s" % filename
@@ -219,11 +220,12 @@
                     except UnicodeError:
                         dirpath = unicode(dirpath, 'iso-8859-1')
                     for filename in filenames:
-                        try:
-                            filename = unicode(filename, 'utf-8')
-                        except UnicodeError:
-                            filename = unicode(filename, 'iso-8859-1')
-                        yield os.path.join(dirpath, filename)
+                        if os.access(dirpath+filename, os.R_OK): # Can we open it ?
+                            try:
+                                filename = unicode(filename, 'utf-8')
+                            except UnicodeError:
+                                filename = unicode(filename, 'iso-8859-1')
+                            yield os.path.join(dirpath, filename)
                     
     def _removeSkippedDirnames(self, dirpath, dirnames):
         """removed skipped directories from dirnames (inplace !)"""
@@ -235,6 +237,7 @@
 
 
 
+
 ## main() ##################################################
 
 class IndexerConfiguration(Configuration):

Modified: trunk/maay/p2pquerier.py
===================================================================
--- trunk/maay/p2pquerier.py	2005-10-14 14:20:26 UTC (rev 188)
+++ trunk/maay/p2pquerier.py	2005-10-17 13:02:38 UTC (rev 189)
@@ -72,10 +72,10 @@
     the statistical information available about the neighbors'
     documents.
     """
-    _queries = {}
+    _queries = {} # AUC : needs to be shared amongst instances, why not, but then, what ...
     
-    def __init__(self, nodeId, querier):
-        self.nodeId = nodeId
+    def __init__(self, nodeId, querier):  # about those ? 
+        self.nodeId = nodeId  
         self.querier = querier
 
     def sendQuery(self, query):
@@ -86,10 +86,10 @@
             print "sent %s to %s" % (query, neighbor)
 
     def receiveQuery(self, query):
-        if query.id in self._queries:
+        if query.id in self._queries: 
             return
         
-        self._queries[query.id] = query
+        self._queries[query.id] = query 
 
         query.hop()        
         if query.ttl > 0:

Modified: trunk/maay/texttool.py
===================================================================
--- trunk/maay/texttool.py	2005-10-14 14:20:26 UTC (rev 188)
+++ trunk/maay/texttool.py	2005-10-17 13:02:38 UTC (rev 189)
@@ -49,8 +49,7 @@
     # default, return original one
     return htmlEncoding
 
-
-def guessEncoding(filename):
+def guessEncoding(filename): #may throw IOError
     """try to guess encoding from a buffer
         Bytes  	Encoding Form
         00 00 FE FF 	UTF-32, big-endian
@@ -65,6 +64,7 @@
         stream = bz2.BZ2File(filename, 'rb')
     else:
         stream = file(filename, 'rb')
+        
     try:
         buffer = stream.read(4)
         # try to guess from BOM



From aurelienc at berlios.de  Mon Oct 17 15:07:19 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Mon, 17 Oct 2005 15:07:19 +0200
Subject: [Maay-svncheckins] r190 - trunk/maay
Message-ID: <200510171307.j9HD7Jfs002322@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-17 15:07:19 +0200 (Mon, 17 Oct 2005)
New Revision: 190

Modified:
   trunk/maay/indexer.py
Log:
Fix spurious edit from previous commit


Modified: trunk/maay/indexer.py
===================================================================
--- trunk/maay/indexer.py	2005-10-17 13:02:38 UTC (rev 189)
+++ trunk/maay/indexer.py	2005-10-17 13:07:19 UTC (rev 190)
@@ -122,7 +122,6 @@
         existingFiles.union(self.runIndexer(isPrivate=False))
         indexedFiles = Set(self.serverProxy.getIndexedFiles(self.cnxId))
         oldFiles = indexedFiles - existingFiles
-        oldfiles = []
         for filename in oldFiles:
             if self.verbose:
                 print "Requesting unindexation of %s" % filename



From aurelienc at berlios.de  Mon Oct 17 17:28:44 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Mon, 17 Oct 2005 17:28:44 +0200
Subject: [Maay-svncheckins] r191 - trunk/maay
Message-ID: <200510171528.j9HFSiY8014289@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-17 17:28:41 +0200 (Mon, 17 Oct 2005)
New Revision: 191

Modified:
   trunk/maay/converter.py
   trunk/maay/indexer.py
   trunk/maay/texttool.py
Log:
Fix union bug in Indexer.start, fix previous fix in FileIterator, add ImageBaseConverter and JpegConverter class to converters

Modified: trunk/maay/converter.py
===================================================================
--- trunk/maay/converter.py	2005-10-17 13:07:19 UTC (rev 190)
+++ trunk/maay/converter.py	2005-10-17 15:28:41 UTC (rev 191)
@@ -48,7 +48,7 @@
 import gzip
 import bz2
 
-from maay.texttool import TextParser, MaayHTMLParser as HTMLParser, ParsingError
+from maay.texttool import TextParser, ExifParser, MaayHTMLParser as HTMLParser, ParsingError
 
 # REGISTRY is a mimetype / converterList map
 REGISTRY = {}
@@ -102,6 +102,18 @@
     OUTPUT_TYPE = 'html'
     MIME_TYPE = 'text/html'
 
+class ImageBasedConverter(BaseConverter):
+    """provides base Image converter
+       In the future, it may hold EXIF information retrieval methods"""
+    OUTPUT_TYPE = 'image'
+
+    def getParser(self):
+        return ExifParser ()
+
+class JpegConverter(ImageBasedConverter):
+    OUTPUT_TYPE = 'jpg'
+    MIME_TYPE = 'image/jpeg'
+
 class CommandBasedConverter(BaseConverter):
     COMMAND = None
 
@@ -160,7 +172,6 @@
     COMMAND = 'antiword "%(input)s" > "%(output)s"'
     MIME_TYPE = 'application/msword'
 
-
 def extractWordsFromFile(filename):
     mimetype = guess_type(filename)[0]
     converters = REGISTRY.get(mimetype, [])

Modified: trunk/maay/indexer.py
===================================================================
--- trunk/maay/indexer.py	2005-10-17 13:07:19 UTC (rev 190)
+++ trunk/maay/indexer.py	2005-10-17 15:28:41 UTC (rev 191)
@@ -39,7 +39,7 @@
 from maay.texttool import removeControlChar
 
 # grabbed from nevow
-mimetypes.types_map.update(
+mimetypes.types_map.update( # is it really taken into account ? (python files seem not to appear)
     {
             '.conf':  'text/plain',
             '.diff':  'text/plain',
@@ -119,7 +119,7 @@
     def start(self):
         # we index private dirs first because public overrides private
         existingFiles = self.runIndexer(isPrivate=True)
-        existingFiles.union(self.runIndexer(isPrivate=False))
+        existingFiles |= self.runIndexer(isPrivate=False)
         indexedFiles = Set(self.serverProxy.getIndexedFiles(self.cnxId))
         oldFiles = indexedFiles - existingFiles
         for filename in oldFiles:
@@ -219,7 +219,7 @@
                     except UnicodeError:
                         dirpath = unicode(dirpath, 'iso-8859-1')
                     for filename in filenames:
-                        if os.access(dirpath+filename, os.R_OK): # Can we open it ?
+                        if os.access(dirpath+'/'+filename, os.R_OK): # Can we open it ?
                             try:
                                 filename = unicode(filename, 'utf-8')
                             except UnicodeError:

Modified: trunk/maay/texttool.py
===================================================================
--- trunk/maay/texttool.py	2005-10-17 13:07:19 UTC (rev 190)
+++ trunk/maay/texttool.py	2005-10-17 15:28:41 UTC (rev 191)
@@ -186,6 +186,12 @@
         return self.title, result, self.links, 0
 
 
+class ExifParser(AbstractParser):
+    """A parser for Exif information found in image files"""
+
+    def parseString(self, source):
+        return u'An image', u'The image', [], 0
+
         
 _table = {}
 for i in xrange(32):



From aurelienc at berlios.de  Tue Oct 18 10:24:35 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Tue, 18 Oct 2005 10:24:35 +0200
Subject: [Maay-svncheckins] r192 - trunk/maay
Message-ID: <200510180824.j9I8OZxQ020651@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-18 10:24:25 +0200 (Tue, 18 Oct 2005)
New Revision: 192

Modified:
   trunk/maay/converter.py
   trunk/maay/indexer.py
Log:
indexer : cosmetics, new purge bootstrap function, converter : removed non oo dispatch in BaseConverter class, added multiple inheritance for Text/Html derived converters


Modified: trunk/maay/converter.py
===================================================================
--- trunk/maay/converter.py	2005-10-17 15:28:41 UTC (rev 191)
+++ trunk/maay/converter.py	2005-10-18 08:24:25 UTC (rev 192)
@@ -43,7 +43,7 @@
 # XXX: need to handle file encodings
 
 import os
-from mimetypes import guess_type
+from mimetypes import guess_type, types_map
 from tempfile import mkdtemp
 import gzip
 import bz2
@@ -75,10 +75,7 @@
     OUTPUT_ENCODING = None
 
     def getParser(self):
-        if self.OUTPUT_TYPE == 'html':
-            return HTMLParser()
-        else:
-            return TextParser()
+        raise NotImplementedException()
 
     def extractWordsFromFile(self, filename):
         """entry point of each converter class
@@ -96,12 +93,18 @@
     """provides simple text parser"""
     OUTPUT_TYPE = 'text'
     MIME_TYPE = 'text/plain'
+
+    def getParser(self):
+        return TextParser()
         
 class HTMLConverter(BaseConverter):
     """provides a simple HTML parser"""
     OUTPUT_TYPE = 'html'
     MIME_TYPE = 'text/html'
 
+    def getParser(self):
+        return HTMLParser()
+
 class ImageBasedConverter(BaseConverter):
     """provides base Image converter
        In the future, it may hold EXIF information retrieval methods"""
@@ -111,7 +114,7 @@
         return ExifParser ()
 
 class JpegConverter(ImageBasedConverter):
-    OUTPUT_TYPE = 'jpg'
+    OUTPUT_TYPE = 'jpeg'
     MIME_TYPE = 'image/jpeg'
 
 class CommandBasedConverter(BaseConverter):
@@ -153,17 +156,17 @@
             os.rmdir(outputDir)
 
 
-class PDFConverter(CommandBasedConverter):
+class PDFConverter(CommandBasedConverter, HTMLConverter):
     COMMAND = 'pdftohtml -i -q -noframes -stdout -enc UTF-8 "%(input)s" > "%(output)s"'
     OUTPUT_TYPE = 'html'
     MIME_TYPE = 'application/pdf'
     OUTPUT_ENCODING = 'UTF-8'
 
-class PSConverter(CommandBasedConverter):
+class PSConverter(CommandBasedConverter, RawTextConverter):
     COMMAND = 'ps2ascii "%(input)s" "%(output)s"'
     MIME_TYPE = 'application/postscript'
 
-class RTFConverter(CommandBasedConverter):
+class RTFConverter(CommandBasedConverter, RawTextConverter):
     COMMAND = 'unrtf --html "%(input)s" > "%(output)s"'
     OUTPUT_TYPE = 'html'
     MIME_TYPE = 'text/rtf'

Modified: trunk/maay/indexer.py
===================================================================
--- trunk/maay/indexer.py	2005-10-17 15:28:41 UTC (rev 191)
+++ trunk/maay/indexer.py	2005-10-18 08:24:25 UTC (rev 192)
@@ -38,8 +38,8 @@
 from maay.querier import MaayAuthenticationError
 from maay.texttool import removeControlChar
 
-# grabbed from nevow
-mimetypes.types_map.update( # is it really taken into account ? (python files seem not to appear)
+# grabbed from nevow, but it doesn't work until you test it interactively ;-)
+mimetypes.types_map.update( 
     {
             '.conf':  'text/plain',
             '.diff':  'text/plain',
@@ -54,12 +54,12 @@
             '.xul':   'application/vnd.mozilla.xul+xml',
             '.py':    'text/plain',
             '.patch': 'text/plain',
-            '.c' : 'text/plain',
-            '.h': 'text/plain',
-            '.C': 'text/plain',
-            '.cpp': 'text/plain',
-            '.cc': 'text/plain',
-            '.c++': 'text/plain',
+            '.c' :    'text/plain',
+            '.h':     'text/plain',
+            '.C':     'text/plain',
+            '.cpp':   'text/plain',
+            '.cc':    'text/plain',
+            '.c++':   'text/plain',
         }
     )
 
@@ -116,13 +116,8 @@
     def isIndexable(self, filename):
         return converter.isKnownType(filename)
 
-    def start(self):
-        # we index private dirs first because public overrides private
-        existingFiles = self.runIndexer(isPrivate=True)
-        existingFiles |= self.runIndexer(isPrivate=False)
-        indexedFiles = Set(self.serverProxy.getIndexedFiles(self.cnxId))
-        oldFiles = indexedFiles - existingFiles
-        for filename in oldFiles:
+    def purgeFiles(self,fileset):
+        for filename in fileset:
             if self.verbose:
                 print "Requesting unindexation of %s" % filename
             self.serverProxy.removeFileInfo(self.cnxId, filename)
@@ -130,6 +125,18 @@
             print "Requesting cleanup of unreferenced documents"
         self.serverProxy.removeUnreferencedDocuments(self.cnxId)
 
+    def _purgeEverything(self):
+        indexedFiles = Set(self.serverProxy.getIndexedFiles(self.cnxId))
+        self.purgeFiles(indexedFiles)
+
+    def start(self):
+        # we index private dirs first because public overrides private
+        existingFiles = self.runIndexer(isPrivate=True)
+        existingFiles |= self.runIndexer(isPrivate=False)
+        indexedFiles = Set(self.serverProxy.getIndexedFiles(self.cnxId))
+        oldFiles = indexedFiles - existingFiles
+        self.purgeFiles(oldFiles)
+
     def runIndexer(self, isPrivate=True):
         existingFiles = Set()
         
@@ -179,6 +186,11 @@
         try:
             title = removeControlChar(title)
             text = removeControlChar(text)
+            if self.verbose:
+                try:
+                    print " ... indexed as", title
+                except UnicodeEncodeError, e:
+                    print " ... (BUG : invalid unicode elements in Title) ..."
             self.serverProxy.indexDocument(self.cnxId, filename, title, text,
                                            fileSize, lastModTime, content_hash,
                                            mime_type, state, file_state)
@@ -303,6 +315,26 @@
     def __init__(self):
         Configuration.__init__(self, name="Indexer")
 
+
+# XXX the purge starter should be factored back into a slightly
+#     more parametrable run. For now it's just a convenience thing.
+
+def purge():
+    indexerConfig = IndexerConfiguration()
+    indexerConfig.load()
+    try:
+        try:
+            indexer = Indexer(indexerConfig)
+        except MaayAuthenticationError, exc:
+            print "AuthenticationError:", exc
+            sys.exit(1)
+        indexer._purgeEverything()
+    except socket.error, exc:
+        print "Cannot contact server:", exc
+        print "Check that the server is running on %s:%s" % \
+              (indexerConfig.host, indexerConfig.port)
+        sys.exit(1)
+
 def run():
     indexerConfig = IndexerConfiguration()
     indexerConfig.load()



From adimasci at berlios.de  Tue Oct 18 20:32:21 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Tue, 18 Oct 2005 20:32:21 +0200
Subject: [Maay-svncheckins] r193 - trunk/maay
Message-ID: <200510181832.j9IIWLl1025817@sheep.berlios.de>

Author: adimasci
Date: 2005-10-18 20:32:20 +0200 (Tue, 18 Oct 2005)
New Revision: 193

Modified:
   trunk/maay/converter.py
Log:
fixed typo

Modified: trunk/maay/converter.py
===================================================================
--- trunk/maay/converter.py	2005-10-18 08:24:25 UTC (rev 192)
+++ trunk/maay/converter.py	2005-10-18 18:32:20 UTC (rev 193)
@@ -75,7 +75,7 @@
     OUTPUT_ENCODING = None
 
     def getParser(self):
-        raise NotImplementedException()
+        raise NotImplementedError()
 
     def extractWordsFromFile(self, filename):
         """entry point of each converter class



From adimasci at berlios.de  Tue Oct 18 20:45:31 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Tue, 18 Oct 2005 20:45:31 +0200
Subject: [Maay-svncheckins] r194 - in trunk/maay: . test
Message-ID: <200510181845.j9IIjV92002286@sheep.berlios.de>

Author: adimasci
Date: 2005-10-18 20:45:30 +0200 (Tue, 18 Oct 2005)
New Revision: 194

Modified:
   trunk/maay/indexer.py
   trunk/maay/test/test_fileiteration.py
Log:
added a unittest that checks that files with unsufficient privileges
are skipped


Modified: trunk/maay/indexer.py
===================================================================
--- trunk/maay/indexer.py	2005-10-18 18:32:20 UTC (rev 193)
+++ trunk/maay/indexer.py	2005-10-18 18:45:30 UTC (rev 194)
@@ -224,7 +224,7 @@
             # test path not in self.skipped (dummy config files)
             if path not in self.skipped:
                 for dirpath, dirnames, filenames in os.walk(path):
-                    print "looking in", dirpath
+                    # print "looking in", dirpath
                     self._removeSkippedDirnames(dirpath, dirnames)
                     try:
                         dirpath = unicode(dirpath, 'utf-8')
@@ -243,7 +243,7 @@
         for dirname in dirnames[:]:
             abspath = self.normalizeCase(os.path.join(dirpath, dirname))
             if abspath in self.skipped:
-                print "skipping", dirname
+                # print "skipping", dirname
                 dirnames.remove(dirname)
 
 

Modified: trunk/maay/test/test_fileiteration.py
===================================================================
--- trunk/maay/test/test_fileiteration.py	2005-10-18 18:32:20 UTC (rev 193)
+++ trunk/maay/test/test_fileiteration.py	2005-10-18 18:45:30 UTC (rev 194)
@@ -100,5 +100,19 @@
             onAbspaths = list(FileIterator(absIndexed, absSkipped))
             self.assertEquals(onRelatives, onAbspaths)
 
+    def testSkipNonAllowed(self):
+        """tests that files that don't have 'read' permission are skipped"""
+        # these two files should be skipped
+        os.chmod('data/a/b/c/foo', 0)
+        os.chmod('data/b/c/d/spam', 0)
+        it = FileIterator(['data/a', 'data/b', 'data/c'])
+        expected = Set([abspath(join(u'data', 'a', 'b', 'c', 'bar')),
+                        abspath(join(u'data', 'b', 'c', 'd', 'baz')),
+                        abspath(join(u'data', 'b', 'c', 'e', 'bazbar')),
+                        abspath(join(u'data', 'b', 'c', 'e', 'foobar')),
+                        ])
+        self.assertEquals(Set(it), expected)
+        
+        
 if __name__ == '__main__':
     unittest.main()



From adimasci at berlios.de  Tue Oct 18 22:07:42 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Tue, 18 Oct 2005 22:07:42 +0200
Subject: [Maay-svncheckins] r195 - trunk/maay
Message-ID: <200510182007.j9IK7gAR011809@sheep.berlios.de>

Author: adimasci
Date: 2005-10-18 22:07:42 +0200 (Tue, 18 Oct 2005)
New Revision: 195

Modified:
   trunk/maay/registrationclient.py
Log:
The logout() function was unused and buggy. It's still unsued for now,
but a bit less buggy :)-)



Modified: trunk/maay/registrationclient.py
===================================================================
--- trunk/maay/registrationclient.py	2005-10-18 18:45:30 UTC (rev 194)
+++ trunk/maay/registrationclient.py	2005-10-18 20:07:42 UTC (rev 195)
@@ -14,6 +14,7 @@
 #     along with this program; if not, write to the Free Software
 #     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
 
+from twisted.internet import reactor
 from twisted.internet.protocol import ClientCreator
 from twisted.protocols.basic import LineReceiver
 from time import mktime
@@ -64,8 +65,8 @@
         print "No querier found => no registration / no P2P"
 
 
-def logout(reactor, nodeId):
+def logout(reactor, regIp, regPort, nodeId):
     c = ClientCreator(reactor, RegistrationClient, None)
     d = c.connectTCP(regIP, regPort)
     d.addCallback(RegistrationClient.logout)
-    
+



From adimasci at berlios.de  Tue Oct 18 22:12:39 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Tue, 18 Oct 2005 22:12:39 +0200
Subject: [Maay-svncheckins] r196 - in trunk/maay: . data
Message-ID: <200510182012.j9IKCdZk012189@sheep.berlios.de>

Author: adimasci
Date: 2005-10-18 22:12:39 +0200 (Tue, 18 Oct 2005)
New Revision: 196

Added:
   trunk/maay/data/peers.html
Modified:
   trunk/maay/TODO.txt
   trunk/maay/data/maay.css
   trunk/maay/dbentity.py
   trunk/maay/server.py
Log:
- fixed bug (TypeError) in Node.selectActive
- added a simple peers web page that lists all registered peers
- added ability to choose which file will be used to store the
  peer id (mainly for test purpose)



Modified: trunk/maay/TODO.txt
===================================================================
--- trunk/maay/TODO.txt	2005-10-18 20:07:42 UTC (rev 195)
+++ trunk/maay/TODO.txt	2005-10-18 20:12:39 UTC (rev 196)
@@ -9,6 +9,8 @@
 #B   X v?rifier qu'on utiliser de l'UTF-8 partout (2005.09.27)
 #B   X g?rer les documents compress?s (2005.09.28)
 #B   X Regarder la conversion pdf->html (2005.09.28)
+#B   _ utiliser des macros pour g?rer l'aspect commun de toutes les pages (2005.10.18)
+#B   _ s'assurer qu'on g?re correctement les child_* des diff?rentes ressources (2005.10.18)
 
 * Notes
 

Modified: trunk/maay/data/maay.css
===================================================================
--- trunk/maay/data/maay.css	2005-10-18 20:07:42 UTC (rev 195)
+++ trunk/maay/data/maay.css	2005-10-18 20:12:39 UTC (rev 196)
@@ -50,3 +50,19 @@
   font-weight: bold;
   color: blue;
 }
+
+table.peersTable {
+  margin-top: 20px;
+  width: 100%;
+  border: 1px solid black;
+}
+
+table.peersTable th {
+  border-bottom: 1px dotted grey;
+  text-align: left;
+  margin: 0px;
+}
+
+table.peersTable td.nodeId {
+  background: lightgrey;
+}
\ No newline at end of file

Added: trunk/maay/data/peers.html
===================================================================
--- trunk/maay/data/peers.html	2005-10-18 20:07:42 UTC (rev 195)
+++ trunk/maay/data/peers.html	2005-10-18 20:12:39 UTC (rev 196)
@@ -0,0 +1,38 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
+    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xmlns:nevow="http://nevow.com/ns/nevow/0.1">
+  <head>
+    <title>List of peers</title>
+    <link rel="stylesheet" type="text/css" href="maaycss"/>
+    <link rel="shortcut icon" href="images/maay.ico" />
+  </head>
+ 
+  <body> 
+    <a nevow:render="loginurl"><nevow:attr name="href"><nevow:slot name="loginurl" /></nevow:attr><nevow:slot name="actionlabel" /></a>
+    <table class="peersTable" nevow:render="sequence" nevow:data="peers">
+      <tr nevow:pattern="header">
+	<th>Node id</th>
+	<th>IP</th>
+	<th>Port</th>
+	<th>Last Seen on</th>
+	<th>Number of Messages received</th>
+	<th>Affinity</th>
+	<th>Bandwidth</th>
+      </tr>
+      <tr nevow:pattern="item" nevow:render="peer">
+	<td class="nodeId"><nevow:slot name="node_id" /></td>
+	<td><nevow:slot name="ip" /></td>
+	<td><nevow:slot name="port" /></td>
+	<td><nevow:slot name="last_seen_time" /></td>
+	<td><nevow:slot name="claim_count" /></td>
+	<td><nevow:slot name="affinity" /></td>
+	<td><nevow:slot name="bandwidth" /></td>
+      </tr>
+    </table>
+    <hr />
+    <a href="http://maay.netofpeers.net/">Maay Home page</a> <a href="http://developer.berlios.de/projects/maay/">
+<img src="http://developer.berlios.de/bslogo.php?group_id=0"
+    width="124" height="32" border="0" alt="BerliOS Logo" /></a>
+
+    </body>  
+</html>

Modified: trunk/maay/dbentity.py
===================================================================
--- trunk/maay/dbentity.py	2005-10-18 20:07:42 UTC (rev 195)
+++ trunk/maay/dbentity.py	2005-10-18 20:12:39 UTC (rev 196)
@@ -398,7 +398,7 @@
 
     def selectActive(cls, cursor, currentNodeId, maxResults):
         query = cls._selectActiveQuery()
-        cursor.execute(query, currentNodeId, maxResults)
+        cursor.execute(query, (currentNodeId, maxResults))
         results = cursor.fetchall()
         return [cls(**dict(zip(cls.attributes, row))) for row in results]
     selectActive = classmethod(selectActive)

Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-18 20:07:42 UTC (rev 195)
+++ trunk/maay/server.py	2005-10-18 20:12:39 UTC (rev 196)
@@ -31,7 +31,7 @@
 import re
 import socket
 
-from zope.interface import implements
+from zope.interface import implements, Interface
 
 from twisted.cred import portal, checkers, error
 from twisted.cred.checkers import ANONYMOUS, AllowAnonymousAccess, \
@@ -98,7 +98,6 @@
         req.getSession().expire()
         req.redirect('/' + guard.LOGOUT_AVATAR)
 
-
 class LoginForm(MaayPage):
     """a basic login form. This page is rendered until the user
     is logged.
@@ -143,7 +142,29 @@
 
     def childFactory(self, context, segments):
         return LoginForm()
+
+class PeersList(MaayPage):
+    """display list of registered peers"""
+    docFactory = loaders.xmlfile(get_path_of('peers.html'))
+    addSlash = True
+
+    def __init__(self, maayId, querier):
+        MaayPage.__init__(self, maayId)
+        self.querier = querier
+
+    def data_peers(self, context, data):
+        webappConfig = IWebappConfiguration(context)
+        peers = self.querier.getActiveNeighbors(webappConfig.get_node_id(), 10)
+        return peers
     
+    def render_peer(self, context, peerNode):
+        # Note: might be convenient to register a special flattener for
+        #       Node objects
+        for attrname in ('node_id', 'ip', 'port', 'last_seen_time',
+                         'claim_count', 'affinity', 'bandwidth'):
+            context.fillSlots(attrname, getattr(peerNode, attrname, 'N/A'))
+        return context.tag
+                    
 class SearchForm(MaayPage):
     """default search form"""
     docFactory = loaders.xmlfile(get_path_of('searchform.html'))
@@ -158,6 +179,9 @@
         # XXX: logout message should be forwarded to registration server
         return None
 
+    def child_peers(self, context):
+        return PeersList(self.maayId, self.querier)
+
     def child_search(self, context):
         # query = unicode(context.arg('words'))        
         offset = int(context.arg('offset', 0))
@@ -378,6 +402,8 @@
         """
         return self.loader.load(context)[0]
 
+class IWebappConfiguration(Interface):
+    """provide an interface in order to be able to remember webappconfig"""
 
 class WebappConfiguration(Configuration):
     options = [
@@ -424,16 +450,16 @@
           'help' : "Internet port on which the xmlrpc server is listening",
           'default' : 6789,
           }),
-        
         ('bandwidth',
          {'type' : "int", 'metavar' : "<bandwidth>", 
           'help' : "Internet port on which the xmlrpc server is listening",
           'default' : 10,
           }),
-        
-        
-        
-        
+        ('nodeid-file',
+         {'type' : "string", 'metavar' : "<node_id_file>",
+          'help' : "Maay will store the generated node id in this file",
+          'default' : "node_id",
+          }),
         ]
 
     config_file = 'webapp.ini'
@@ -450,7 +476,7 @@
     def _read_node_id(self):
         for directory in self.get_config_dirs():
             try:
-                filename = os.path.join(directory,'node_id')
+                filename = os.path.join(directory, self.nodeid_file)
                 f = open(filename,'r')
                 for line in f:
                     line = line.strip()
@@ -476,7 +502,7 @@
         node_id = self._generate_node_id()
         for directory in self.get_config_dirs():
             try:
-                filename = os.path.join(directory, 'node_id')
+                filename = os.path.join(directory, self.nodeid_file)
                 f = open(filename, 'w')
                 lines = ['# This file contains the Node Identifier for your computer\n',
                          '# Do not edit it or erase it, or this will corrupt the database\n',
@@ -519,6 +545,7 @@
     website = appserver.NevowSite(MaaySessionWrapper(maayPortal,
                                                      mindFactory=MaayMindFactory))
     website.remember(Maay404(), inevow.ICanHandleNotFound)
+    website.remember(webappConfig, IWebappConfiguration)
     registrationclient.login(reactor,
                              webappConfig.registration_host, webappConfig.registration_port,
                              maayPortal.anonymousQuerier,



From aurelienc at berlios.de  Wed Oct 19 17:26:50 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Wed, 19 Oct 2005 17:26:50 +0200
Subject: [Maay-svncheckins] r197 - in trunk/maay: . test
Message-ID: <200510191526.j9JFQocf027166@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-19 17:26:50 +0200 (Wed, 19 Oct 2005)
New Revision: 197

Modified:
   trunk/maay/p2pquerier.py
   trunk/maay/test/test_p2p.py
Log:
- test fixed to match API
- cosmetic and docstrings in p2pquerier


Modified: trunk/maay/p2pquerier.py
===================================================================
--- trunk/maay/p2pquerier.py	2005-10-18 20:12:39 UTC (rev 196)
+++ trunk/maay/p2pquerier.py	2005-10-19 15:26:50 UTC (rev 197)
@@ -19,19 +19,23 @@
 """
 __revision__ = '$Id$'
 
-from sets import Set
+from logilab.common.compat import set
 
 from twisted.web.xmlrpc import Proxy
 
 # XXX should P2pQuery derive from query.Query?
 class P2pQuery:
     def __init__(self, queryId, sender, ttl, query):
+        """
+        :param query: the query to wrap
+        :type query: `maay.query.Query`
+        """
         self.id = queryId
         self.sender = sender
         self.ttl = ttl
         self.query = query
         self.query.searchtype = 'p2p'
-        self.documents = Set
+        self.documents = set()
 
     def hop(self):
         self.ttl -= 1
@@ -72,7 +76,7 @@
     the statistical information available about the neighbors'
     documents.
     """
-    _queries = {} # AUC : needs to be shared amongst instances, why not, but then, what ...
+    _queries = {} 
     
     def __init__(self, nodeId, querier):  # about those ? 
         self.nodeId = nodeId  

Modified: trunk/maay/test/test_p2p.py
===================================================================
--- trunk/maay/test/test_p2p.py	2005-10-18 20:12:39 UTC (rev 196)
+++ trunk/maay/test/test_p2p.py	2005-10-19 15:26:50 UTC (rev 197)
@@ -19,7 +19,7 @@
 __revision__ = '$Id$'
 
 import unittest
-from maay.server import Query
+from maay.query import Query
 from maay.p2pquerier import *
 from maay.dbentity import Document
 
@@ -28,7 +28,7 @@
         self.query = P2pQuery(queryId='1'*40,
                               sender='http://localhost:3423',
                               ttl=2,
-                              query=None)
+                              query=Query.fromRawQuery("foo"))
 
     def testHop(self):
         ttl = self.query.ttl
@@ -48,11 +48,11 @@
 
 class P2pQuerierTC(unittest.TestCase):
     def setUp(self):
-        self.querier = P2pQuerier('0'*40)
+        self.querier = P2pQuerier('0'*40, None)  #XXX: How can we get a querier ?
         self.query = P2pQuery(queryId='1'*40,
                               sender='http://localhost:3423',
                               ttl=2,
-                              query=None)
+                              query=Query.fromRawQuery("foo"))
 
     def tearDown(self):
         self.querier._queries = {}



From aurelienc at berlios.de  Wed Oct 19 17:29:35 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Wed, 19 Oct 2005 17:29:35 +0200
Subject: [Maay-svncheckins] r198 - in trunk/maay: . test
Message-ID: <200510191529.j9JFTZhQ027331@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-19 17:29:34 +0200 (Wed, 19 Oct 2005)
New Revision: 198

Modified:
   trunk/maay/configuration.py
   trunk/maay/test/test_configuration.py
Log:
- test updateEnvPath only on Win32 (inconsistent behaviour on non-win32 platform)


Modified: trunk/maay/configuration.py
===================================================================
--- trunk/maay/configuration.py	2005-10-19 15:26:50 UTC (rev 197)
+++ trunk/maay/configuration.py	2005-10-19 15:29:34 UTC (rev 198)
@@ -46,6 +46,9 @@
     raise AssertionError("Unknown platform setup")
 
 def _update_env_path(maay_dir):
+    """Updates PATH to explicitly add antiword, mysql, etc.
+       default installation paths
+    """
     assert sys.platform == 'win32', 'This method must not be called on non windows platforms'
     path = []
     if os.environ.get('PATH'):
@@ -55,7 +58,17 @@
             path.append(os.path.join(maay_dir, directory))
     os.environ['PATH'] =  os.pathsep.join(path)
 
-        
+## XXX: proposed replacement for the above function (need to be
+##      accepted and tested on windows)
+## def XXX_update_env_path(maay_dir):
+##     assert sys.platform == 'win32', 'This method must not be called on non windows platforms'
+##     path = os.environ.get('PATH', '').split(os.pathsep)
+##     for otherPath in (u'pdftohtml', os.path.join(u'mysql', u'bin'), ur'c:\antiword'):
+##         if otherPath not in path:
+##             path.append(os.path.join(maay_dir, otherPath))
+##     os.environ['PATH'] = os.pathsep.join(path)
+
+
 def get_path_of(datafile):
     """return the path of a data file, depending on the platform
     Handles development paths for testing as well as deployed paths"""

Modified: trunk/maay/test/test_configuration.py
===================================================================
--- trunk/maay/test/test_configuration.py	2005-10-19 15:26:50 UTC (rev 197)
+++ trunk/maay/test/test_configuration.py	2005-10-19 15:29:34 UTC (rev 198)
@@ -59,20 +59,25 @@
         self.assertEquals(config.db_name, 'muche')
 
 
-class Win32ConfigTC(unittest.TestCase):
+if sys.platform == 'win32':
+    class Win32ConfigTC(unittest.TestCase):
+        def testUpdateEnvPath(self):
+            platform = sys.platform
+            oldpath = os.environ['PATH']
+            sys.platform = 'win32'
+            try:
+                configuration._update_env_path("tmp")
+                envpath = os.environ['PATH']
+                regexp = r'tmp[/\\]pdftohtml[:;]tmp[/\\]mysql[/\\]bin[:;]tmp[/\\]c:\antiword$'
+                self.failUnless(re.search(regexp, envpath)), envpath
+            finally:
+                sys.platform = platform
+                os.environ['PATH'] = oldpath
+else:
+    print "****  Skipping Win32 tests on non-windows platforms"
+    print "****  (os.path.join(some_dir, 'c:\antiword') does not make"
+    print "****  sense on non-windows platform, and makes tests a lot "
+    print "****  more obfuscated and hard to read/maintain"
 
-    def test_update_env_path(self):
-        platform = sys.platform
-        oldpath = os.environ['PATH']
-        sys.platform = 'win32'
-        try:
-            configuration._update_env_path("tmp")
-            envpath = os.environ['PATH']
-            regexp = r'.*[:;]tmp[/\\]antiword[:;]tmp[/\\]pdftohtml[:;]tmp[/\\]mysql[/\\]bin$'
-            self.failUnless(re.match(regexp, envpath)), envpath
-        finally:
-            sys.platform = platform
-            os.environ['PATH'] = oldpath 
-            
 if __name__ == '__main__':
     unittest.main()



From aurelienc at berlios.de  Wed Oct 19 17:30:57 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Wed, 19 Oct 2005 17:30:57 +0200
Subject: [Maay-svncheckins] r199 - trunk/maay/test
Message-ID: <200510191530.j9JFUvLG027529@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-19 17:30:56 +0200 (Wed, 19 Oct 2005)
New Revision: 199

Modified:
   trunk/maay/test/test_dbentity.py
   trunk/maay/test/test_rpc.py
Log:
- update test to match API changes


Modified: trunk/maay/test/test_dbentity.py
===================================================================
--- trunk/maay/test/test_dbentity.py	2005-10-19 15:29:34 UTC (rev 198)
+++ trunk/maay/test/test_dbentity.py	2005-10-19 15:30:56 UTC (rev 199)
@@ -49,11 +49,11 @@
     def testContainingQueryWithOffsetOnlyPublic(self):
         query, params = Document._selectContainingQuery(['un', u'?t?', u'?', 'la', 'mer'],
                                                         offset=15)
-        self.assertEquals(params, [u'un', u'ete', u'la', u'mer', Document.PUBLISHED_STATE, 4])
+        self.assertEquals(params, [u'un', u'ete', u'la', u'mer', Document.PRIVATE_STATE, 4])
         for p in params[:-2]:
             self.assertEquals(type(p), unicode)
         self.assertEquals(len(params), params[-1] + 2)
-        expected = "SELECT D.db_document_id, D.document_id, D.title, D.size, D.text, D.url, D.mime_type, D.publication_time FROM documents D, document_scores DS WHERE DS.db_document_id=D.db_document_id AND DS.word IN (%s, %s, %s, %s) AND D.state=%s GROUP BY DS.db_document_id HAVING count(DS.db_document_id) = %s LIMIT 15 OFFSET 15"
+        expected = "SELECT D.db_document_id, D.document_id, D.title, D.size, D.text, D.url, D.mime_type, D.publication_time FROM documents D, document_scores DS WHERE DS.db_document_id=D.db_document_id AND DS.word IN (%s, %s, %s, %s) AND D.state!=%s GROUP BY DS.db_document_id HAVING count(DS.db_document_id) = %s LIMIT 15 OFFSET 15"
         self.assertEquals(query.split(), expected.split())
         q = query%tuple(params) # sanity check for argument count
         

Modified: trunk/maay/test/test_rpc.py
===================================================================
--- trunk/maay/test/test_rpc.py	2005-10-19 15:29:34 UTC (rev 198)
+++ trunk/maay/test/test_rpc.py	2005-10-19 15:30:56 UTC (rev 199)
@@ -33,6 +33,7 @@
 from twisted.python.failure import Failure
 
 from maay import rpc
+from maay.dbentity import Document
 from maay.querier import MaayQuerier, AnonymousQuerier, ANONYMOUS_AVATARID
 from maay.server import MaayPortal, WebappConfiguration
 
@@ -114,14 +115,14 @@
     
     def testUncertifiedRemoteCall(self):
         """only authentified people should be able to call remote methods"""
-        retValue = self._callRemote('lastIndexationTime', 'evil', 'foo.pdf')
-        self.assertEquals(unittest.deferredResult(retValue), -1)
+        retValue = self._callRemote('lastIndexationTimeAndState', 'evil', 'foo.pdf')
+        self.assertEquals(unittest.deferredResult(retValue), [-1, Document.UNKNOWN_STATE])
 
     def testCertifiedRemoteCall(self):
         d = self._callRemote('authenticate', 'adim', 'adim')
         cnxId, _ = unittest.deferredResult(d)
         retValue = self._callRemote('lastIndexationTimeAndState', cnxId, 'foo.pdf')
-        self.assertEquals(unittest.deferredResult(retValue), 0)
+        self.assertEquals(unittest.deferredResult(retValue), [0, Document.UNKNOWN_STATE])
 
 if __name__ == '__main__':
     # FIXME: the following is nicer but triggers an assertion



From aurelienc at berlios.de  Wed Oct 19 17:32:26 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Wed, 19 Oct 2005 17:32:26 +0200
Subject: [Maay-svncheckins] r200 - trunk/maay/test
Message-ID: <200510191532.j9JFWQhu027721@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-19 17:32:26 +0200 (Wed, 19 Oct 2005)
New Revision: 200

Modified:
   trunk/maay/test/test_fileiteration.py
Log:
- test made independant of invocation path


Modified: trunk/maay/test/test_fileiteration.py
===================================================================
--- trunk/maay/test/test_fileiteration.py	2005-10-19 15:30:56 UTC (rev 199)
+++ trunk/maay/test/test_fileiteration.py	2005-10-19 15:32:26 UTC (rev 200)
@@ -64,13 +64,14 @@
     def testNothingSkipped(self):
         it = FileIterator(['a', 'b', 'c'])
         self.assertEquals(list(it), [])
-        it = FileIterator(['data/a', 'data/b', 'data/c'])
-        expected = Set([abspath(join(u'data', 'a', 'b', 'c', 'bar')),
-                        abspath(join(u'data', 'a', 'b', 'c', 'foo')),
-                        abspath(join(u'data', 'b', 'c', 'd', 'baz')),
-                        abspath(join(u'data', 'b', 'c', 'd', 'spam')),
-                        abspath(join(u'data', 'b', 'c', 'e', 'bazbar')),
-                        abspath(join(u'data', 'b', 'c', 'e', 'foobar')),
+        it = FileIterator([join(DATADIR, 'a'), join(DATADIR, 'b'),
+                           join(DATADIR, 'c')])
+        expected = Set([abspath(join(DATADIR, 'a', 'b', 'c', 'bar')),
+                        abspath(join(DATADIR, 'a', 'b', 'c', 'foo')),
+                        abspath(join(DATADIR, 'b', 'c', 'd', 'baz')),
+                        abspath(join(DATADIR, 'b', 'c', 'd', 'spam')),
+                        abspath(join(DATADIR, 'b', 'c', 'e', 'bazbar')),
+                        abspath(join(DATADIR, 'b', 'c', 'e', 'foobar')),
                         ])
         self.assertEquals(Set(it), expected)
 
@@ -81,12 +82,13 @@
 
 
     def testSkippingSomething(self):
-        everything = ['data/a', 'data/b', 'data/c']
-        skipped = ['data/a', 'data/b/c/e']
+        everything = [join(DATADIR, 'a'), join(DATADIR, 'b'),
+                      join(DATADIR, 'c')]
+        skipped = [join(DATADIR, 'a'), join(DATADIR, 'b', 'c', 'e')]
         it = FileIterator(everything, skipped)
-        expected = Set([abspath(join(u'data', 'b', 'c', 'd', 'baz')),
-                    abspath(join(u'data', 'b', 'c', 'd', 'spam')),
-                    ])
+        expected = Set([abspath(join(DATADIR, 'b', 'c', 'd', 'baz')),
+                        abspath(join(DATADIR, 'b', 'c', 'd', 'spam')),
+                        ])
         self.assertEquals(expected, Set(it))
 
     def testRelativePathConversion(self):
@@ -103,13 +105,14 @@
     def testSkipNonAllowed(self):
         """tests that files that don't have 'read' permission are skipped"""
         # these two files should be skipped
-        os.chmod('data/a/b/c/foo', 0)
-        os.chmod('data/b/c/d/spam', 0)
-        it = FileIterator(['data/a', 'data/b', 'data/c'])
-        expected = Set([abspath(join(u'data', 'a', 'b', 'c', 'bar')),
-                        abspath(join(u'data', 'b', 'c', 'd', 'baz')),
-                        abspath(join(u'data', 'b', 'c', 'e', 'bazbar')),
-                        abspath(join(u'data', 'b', 'c', 'e', 'foobar')),
+        os.chmod(join(DATADIR, 'a/b/c/foo'), 0)
+        os.chmod(join(DATADIR, 'b/c/d/spam'), 0)
+        it = FileIterator([join(DATADIR, 'a'), join(DATADIR, 'b'),
+                           join(DATADIR, 'c')])
+        expected = Set([abspath(join(DATADIR, 'a', 'b', 'c', 'bar')),
+                        abspath(join(DATADIR, 'b', 'c', 'd', 'baz')),
+                        abspath(join(DATADIR, 'b', 'c', 'e', 'bazbar')),
+                        abspath(join(DATADIR, 'b', 'c', 'e', 'foobar')),
                         ])
         self.assertEquals(Set(it), expected)
         



From aurelienc at berlios.de  Wed Oct 19 17:36:53 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Wed, 19 Oct 2005 17:36:53 +0200
Subject: [Maay-svncheckins] r201 - in trunk/maay: . test
Message-ID: <200510191536.j9JFarV4028107@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-19 17:36:49 +0200 (Wed, 19 Oct 2005)
New Revision: 201

Modified:
   trunk/maay/test/test_texttool.py
   trunk/maay/texttool.py
Log:
- when no title is available in the doc, we use the filename as title and
  don't do wild guesses
- rename open to universalOpen
- add test for the title changes


Modified: trunk/maay/test/test_texttool.py
===================================================================
--- trunk/maay/test/test_texttool.py	2005-10-19 15:32:26 UTC (rev 200)
+++ trunk/maay/test/test_texttool.py	2005-10-19 15:36:49 UTC (rev 201)
@@ -22,7 +22,8 @@
 import unittest
 from os.path import join, dirname
 
-from maay.texttool import MaayHTMLParser, guessEncoding, open, untagText, normalizeText, removeControlChar
+from maay.texttool import MaayHTMLParser, TextParser, guessEncoding, \
+     universalOpen, untagText, normalizeText, removeControlChar
 
 RAW_TEXT = u"foo ?t? bar baz top bim bam boum"
 
@@ -37,8 +38,21 @@
 
 DATADIR = join(dirname(__file__), 'data')
 
-    
 
+class TextParserTC(unittest.TestCase):
+
+    def setUp(self):
+        self.parser = TextParser()
+
+    def testTitleGuess(self):
+        """Make sure the title is the filename when we treat a text file
+           or no title could be found
+        """
+        title, text, links, offset = self.parser.parseFile(join(DATADIR, 'latin1.txt'), 'ISO-8859-1')
+        self.assertEquals(title, 'latin1.txt')
+        self.assertEquals(normalizeText(text), "c'est l'ete")
+        self.assertEquals(links, [])
+
 class HTMLParserTC(unittest.TestCase):
 
     def setUp(self):
@@ -47,11 +61,22 @@
     def testParseRaw(self):
         html = '<body>%s</body>' % RAW_TEXT
         title, text, links, offset = self.parser.parseString(html)
-        self.assertEquals(title, RAW_TEXT)
+        # parseString() should return empty title when non available in the HTML
+        self.assertEquals(title, '')
         self.assertEquals(normalizeText(text),
                           RAW_TEXT.replace(u'?', 'e'))
         self.assertEquals(links, [])
 
+    def testTitleGuess(self):
+        """Make sure the title is the filename when we treat a text file
+           or no title could be found
+        """
+        title, text, links, offset = self.parser.parseFile(join(DATADIR, "notitle.html"))
+        self.assertEquals(title, 'notitle.html')
+        self.assertEquals(normalizeText(text), "maille maay")
+        self.assertEquals(links, [])
+
+
     def testParseSimpleHtml(self):
         title, text, links, offset = self.parser.parseString(SIMPLE_HTML)
         self.assertEquals(title, 'maille Maay')
@@ -115,14 +140,14 @@
 
 class OpenTC(unittest.TestCase):
     def testGzip(self):
-        f = open(join(DATADIR, 'compressed_gzip.txt.gz'), 'rb', 'utf-8')
+        f = universalOpen(join(DATADIR, 'compressed_gzip.txt.gz'), 'rb', 'utf-8')
         data = f.read()
         f.close()
         self.assertEquals(type(data), unicode)
         self.failUnless(u'ent?te' in data)
         
     def testBz2(self):
-        f = open(join(DATADIR, 'compressed_bzip2.txt.bz2'), 'rb', 'utf-8')
+        f = universalOpen(join(DATADIR, 'compressed_bzip2.txt.bz2'), 'rb', 'utf-8')
         data = f.read()
         f.close()
         self.assertEquals(type(data), unicode)

Modified: trunk/maay/texttool.py
===================================================================
--- trunk/maay/texttool.py	2005-10-19 15:32:26 UTC (rev 200)
+++ trunk/maay/texttool.py	2005-10-19 15:36:49 UTC (rev 201)
@@ -18,6 +18,7 @@
 """this module provide text / parsing tools"""
 
 __revision__ = '$Id$'
+__metaclass__ = type
 
 from HTMLParser import HTMLParser, HTMLParseError
 import codecs
@@ -95,7 +96,7 @@
         stream.close()
 
 
-def open(filename, mode='rb', encoding='ascii', errors='strict'):
+def universalOpen(filename, mode='rb', encoding='ascii', errors='strict'):
     """open potentially compressed files using a codec converter"""
     if 'r' in mode:
         converter = codecs.getreader(encoding)
@@ -115,32 +116,40 @@
 
 class AbstractParser:
     """base-class for file parsers"""
-    def parseFile(self, filename, encoding=None):
+    def parseFile(self, filepath, encoding=None):
         """returns a 4-uple (title, normalized_text, links, offset)
         TODO: port original code from htmltotext
         :param encoding: if None, then need to be guessed
+
+        When a title cannot be computed from file content,
+        the last component of the filepath is used instead
         """
-        encoding = encoding or guessEncoding(filename)
+        encoding = encoding or guessEncoding(filepath)
         try:
-            stream = open(filename, 'rb', encoding, errors='ignore')
+            stream = universalOpen(filepath, 'rb', encoding, errors='ignore')
         except LookupError:
             raise ParsingError('Unsupported document encoding %s' % encoding)
         try:
-            return self.parseString(stream.read())
+            title, result, links, offset = self.parseString(stream.read())
+            if not title:
+                title = filepath.split('/')[-1]
+            return title, result, links, offset 
         finally:
             stream.close()
 
     def parseString(self, source):
+        """returns a 4-uple (title, normalized_text, links, offset)
+           to parseFile
+           When a title cannot be computed from file content parseFile
+           expects an empty string
+        """
         raise NotImplementedError()
 
 
 class TextParser(AbstractParser):
 
     def parseString(self, source):
-        result = source
-        first_line = min(80, result.find('\n'))
-        title = result[:first_line]
-        return title, result, [], 0
+        return '', source, [], 0
         
 
 class MaayHTMLParser(AbstractParser, HTMLParser):
@@ -180,9 +189,6 @@
         except HTMLParseError, exc:
             print "Error parsing document: %s" % exc
         result = u'\n'.join(self.textbuf)
-        if not self.title:
-            first_line = min(80, result.find('\n'))
-            self.title = result[:first_line]
         return self.title, result, self.links, 0
 
 
@@ -190,7 +196,7 @@
     """A parser for Exif information found in image files"""
 
     def parseString(self, source):
-        return u'An image', u'The image', [], 0
+        return '', u'The image', [], 0
 
         
 _table = {}



From aurelienc at berlios.de  Wed Oct 19 17:41:41 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Wed, 19 Oct 2005 17:41:41 +0200
Subject: [Maay-svncheckins] r202 - in trunk/maay: . test/data
Message-ID: <200510191541.j9JFffeF028451@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-19 17:41:40 +0200 (Wed, 19 Oct 2005)
New Revision: 202

Added:
   trunk/maay/test/data/notitle.html
Modified:
   trunk/maay/indexer.py
   trunk/maay/querier.py
   trunk/maay/query.py
Log:
- title added to the words to be indexed
- follow-up on the last checkin (title processing)


Modified: trunk/maay/indexer.py
===================================================================
--- trunk/maay/indexer.py	2005-10-19 15:36:49 UTC (rev 201)
+++ trunk/maay/indexer.py	2005-10-19 15:41:40 UTC (rev 202)
@@ -184,13 +184,10 @@
         if self.verbose:
             print "Requesting indexation of %s" % filename
         try:
-            title = removeControlChar(title)
+            title = removeControlChar(title) 
             text = removeControlChar(text)
             if self.verbose:
-                try:
-                    print " ... indexed as", title
-                except UnicodeEncodeError, e:
-                    print " ... (BUG : invalid unicode elements in Title) ..."
+                print " ... indexed as", title.encode('utf-8')
             self.serverProxy.indexDocument(self.cnxId, filename, title, text,
                                            fileSize, lastModTime, content_hash,
                                            mime_type, state, file_state)
@@ -231,7 +228,7 @@
                     except UnicodeError:
                         dirpath = unicode(dirpath, 'iso-8859-1')
                     for filename in filenames:
-                        if os.access(dirpath+'/'+filename, os.R_OK): # Can we open it ?
+                        if os.access(os.path.join(dirpath, filename), os.R_OK): # Can we open it ?
                             try:
                                 filename = unicode(filename, 'utf-8')
                             except UnicodeError:

Modified: trunk/maay/querier.py
===================================================================
--- trunk/maay/querier.py	2005-10-19 15:36:49 UTC (rev 201)
+++ trunk/maay/querier.py	2005-10-19 15:41:40 UTC (rev 202)
@@ -140,8 +140,8 @@
         self._updateQueryStatistics(words)
         try:
             cursor = self._cnx.cursor()
-            return Document.selectContaining(cursor, words, query.filetype, query.offset,
-                                             self.searchInPrivate)
+            return Document.selectContaining(cursor, words, query.filetype,
+                                             query.offset, self.searchInPrivate)
         finally:
             cursor.close()
 
@@ -333,6 +333,9 @@
         # insert or update in table file_info
         fileinfo = FileInfo.selectWhere(cursor,
                                         file_name=filename)
+        # insert title into text to be able to find documents according
+        # to their title (e.g: searching 'foo' should find 'foo.pdf')
+        text = '%s %s' % (title, text)
         if fileinfo:
             fileinfo = fileinfo[0]
             fileinfo.file_time = lastModifiedOn

Modified: trunk/maay/query.py
===================================================================
--- trunk/maay/query.py	2005-10-19 15:36:49 UTC (rev 201)
+++ trunk/maay/query.py	2005-10-19 15:41:40 UTC (rev 202)
@@ -36,6 +36,7 @@
         return self.searchtype == 'p2p'
 
     def fromRawQuery(rawQuery, offset=0):
+        """:type rawQuery: str"""
         rawWords = rawQuery.split()
         words = []
         restrictions = {}

Added: trunk/maay/test/data/notitle.html
===================================================================
--- trunk/maay/test/data/notitle.html	2005-10-19 15:36:49 UTC (rev 201)
+++ trunk/maay/test/data/notitle.html	2005-10-19 15:41:40 UTC (rev 202)
@@ -0,0 +1,6 @@
+<!-- This document has no title -->
+<html>
+  <body>
+    <h1>maille Maay</h1>
+  </body>
+</html>



From aurelienc at berlios.de  Wed Oct 19 17:43:22 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Wed, 19 Oct 2005 17:43:22 +0200
Subject: [Maay-svncheckins] r203 - trunk/maay
Message-ID: <200510191543.j9JFhM7g028525@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-19 17:43:21 +0200 (Wed, 19 Oct 2005)
New Revision: 203

Modified:
   trunk/maay/dbentity.py
Log:
- revert first try at including title in the list of words (cf. lasts checkins)


Modified: trunk/maay/dbentity.py
===================================================================
--- trunk/maay/dbentity.py	2005-10-19 15:41:40 UTC (rev 202)
+++ trunk/maay/dbentity.py	2005-10-19 15:43:21 UTC (rev 203)
@@ -21,6 +21,7 @@
            'Word', 'Node', 'NodeInterest']
 
 import re
+from sets import Set
 
 from maay.texttool import normalizeText, WORD_MIN_LEN, WORD_MAX_LEN
 
@@ -177,14 +178,16 @@
     # Caution : in the maay.orig branch, this parameter gets stored as
     # a string containing a single integer, so values of state above 9
     # are lost
-    PUBLISHED_STATE = 1 << 0
+    # XXX: only PUBLISHED and PRIVATE states are correctly handled
+    PRIVATE_STATE = 0 
+    PUBLISHED_STATE = 1 # << 0
+
     CACHED_STATE = 1 << 1
     KNOWN_STATE = 1 << 2
-    PRIVATE_STATE = 1 << 3
     UNKNOWN_STATE = 1 << 9 ### FIXME : this gets stored in the
-                           ### database as a char in table Document or
-                           ### as a tinyint(4) in table files. Check
-                           ### to see if you get 0 or something else.
+                            ### database as a char in table Document or
+                            ### as a tinyint(4) in table files. Check
+                            ### to see if you get 0 or something else.
 
 
     attributes = ('db_document_id', 'document_id', 'mime_type', 'title',
@@ -208,13 +211,12 @@
         return self.text[:200]
     abstract = property(get_abstract)
 
-
     def _selectContainingQuery(cls, words, mimetype=None, offset=0, allowPrivate=False):
+        if not words:
+            return ''
         words = [normalizeText(unicode(w))
                  for w in words
-                 if WORD_MIN_LEN <= len(w) <= WORD_MAX_LEN]
-        if not words:
-            return ''
+                 if WORD_MIN_LEN <= len(w) <= WORD_MAX_LEN]        
         # XXX mimetype handling is a HACK. It needs to be integrated
         #     nicely in order to handle any kind of restrictions easily
         if mimetype is not None:
@@ -229,7 +231,7 @@
         # Question: what is the HAVING clause supposed to do ?
         # Answer: we select all documents containing one of the words
         # that we are looking for, group them by their identifier, and
-        # only keep those identifier which appeared once for each word
+        # only keep those identifiers which appeared once for each word
         # we were looking for.
         # XXX: LIMIT clause should be optional
         query = ("SELECT D.db_document_id, "
@@ -253,17 +255,20 @@
     _selectContainingQuery = classmethod(_selectContainingQuery)
 
     def selectContaining(cls, cursor, words, mimetype=None, offset=0, allowPrivate=False):
-        query, params= cls._selectContainingQuery(words, mimetype,
-                                                  offset=offset,
-                                                  allowPrivate=allowPrivate)
+        query, params = cls._selectContainingQuery(words, mimetype,
+                                                   offset=offset,
+                                                   allowPrivate=allowPrivate)
         if query:
             cursor.execute(query, params)
             results = cursor.fetchall()
-            return [cls(**dict(zip(['db_document_id', 'document_id', 'title', 'size', 'text', 'url', 'mime_type', 'publication_time'],
+            return [cls(**dict(zip(['db_document_id', 'document_id', 'title',
+                                    'size', 'text', 'url', 'mime_type',
+                                    'publication_time'],
                                    row)))
                     for row in results]
         else:
-            return []
+            return [] 
+        
     selectContaining = classmethod(selectContaining)
     
 
@@ -428,3 +433,4 @@
     key = ('node_id', 'word')
 
     
+



From aurelienc at berlios.de  Wed Oct 19 17:44:11 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Wed, 19 Oct 2005 17:44:11 +0200
Subject: [Maay-svncheckins] r204 - trunk/maay/test
Message-ID: <200510191544.j9JFiBM1028575@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-19 17:44:11 +0200 (Wed, 19 Oct 2005)
New Revision: 204

Modified:
   trunk/maay/test/test_querier.py
Log:
- completes the title-related tests


Modified: trunk/maay/test/test_querier.py
===================================================================
--- trunk/maay/test/test_querier.py	2005-10-19 15:43:21 UTC (rev 203)
+++ trunk/maay/test/test_querier.py	2005-10-19 15:44:11 UTC (rev 204)
@@ -57,11 +57,12 @@
         cursor = self.cnx.cursor()
         # At this point, database should be emtpy, so no document
         # should match <digest>
+        title = 'Le Tartuffe'
         matchingDocs = Document.selectWhere(cursor, document_id=digest)
         self.assertEquals(len(matchingDocs), 0)
         self.querier.indexDocument('0'*40,
                                    '/tmp/Tartuffe.txt',
-                                   'Le Tartuffe',
+                                   title,
                                    text,
                                    len(text),
                                    30000,
@@ -71,7 +72,7 @@
                                    FileInfo.CREATED_FILE_STATE)
         matchingDocs = Document.selectWhere(cursor, document_id=digest)
         self.assertEquals(len(matchingDocs), 1)
-        self.assertEquals(matchingDocs[0].text, text)
+        self.assertEquals(matchingDocs[0].text, '%s %s' % (title, text))
         
 
     def test_normalizeText(self):



From aurelienc at berlios.de  Wed Oct 19 18:07:36 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Wed, 19 Oct 2005 18:07:36 +0200
Subject: [Maay-svncheckins] r205 - in trunk/maay: . test
Message-ID: <200510191607.j9JG7aPI031333@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-19 18:07:35 +0200 (Wed, 19 Oct 2005)
New Revision: 205

Modified:
   trunk/maay/converter.py
   trunk/maay/test/test_converter.py
Log:
- add converter for python files
- add test for python converter


Modified: trunk/maay/converter.py
===================================================================
--- trunk/maay/converter.py	2005-10-19 15:44:11 UTC (rev 204)
+++ trunk/maay/converter.py	2005-10-19 16:07:35 UTC (rev 205)
@@ -96,6 +96,10 @@
 
     def getParser(self):
         return TextParser()
+
+class PythonSourceConverter(RawTextConverter):
+    """provides support for various kinds of languages"""
+    MIME_TYPE = 'text/x-python'
         
 class HTMLConverter(BaseConverter):
     """provides a simple HTML parser"""
@@ -111,7 +115,7 @@
     OUTPUT_TYPE = 'image'
 
     def getParser(self):
-        return ExifParser ()
+        return ExifParser()
 
 class JpegConverter(ImageBasedConverter):
     OUTPUT_TYPE = 'jpeg'

Modified: trunk/maay/test/test_converter.py
===================================================================
--- trunk/maay/test/test_converter.py	2005-10-19 15:44:11 UTC (rev 204)
+++ trunk/maay/test/test_converter.py	2005-10-19 16:07:35 UTC (rev 205)
@@ -26,7 +26,7 @@
     def testRegistry(self):
         """tests that converters we get match filenames's mimetype"""
         filenames = ['foo.pdf', 'foo.ps', 'foo.html', 'foo.txt',
-                     'foo.doc', 'foo.rtf']
+                     'foo.doc', 'foo.rtf', 'foo.py']
         for filename in filenames:
             mimetype = guess_type(filename)[0]
             if mimetype is None:



From adimasci at berlios.de  Thu Oct 20 09:39:30 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Thu, 20 Oct 2005 09:39:30 +0200
Subject: [Maay-svncheckins] r206 - trunk/maay
Message-ID: <200510200739.j9K7dU2o018651@sheep.berlios.de>

Author: adimasci
Date: 2005-10-20 09:39:22 +0200 (Thu, 20 Oct 2005)
New Revision: 206

Modified:
   trunk/maay/TODO.txt
Log:
updated TODO list according to last meeting decisions

Modified: trunk/maay/TODO.txt
===================================================================
--- trunk/maay/TODO.txt	2005-10-19 16:07:35 UTC (rev 205)
+++ trunk/maay/TODO.txt	2005-10-20 07:39:22 UTC (rev 206)
@@ -14,4 +14,23 @@
 
 * Notes
 
+* What's Next
 
+ - "le serveur d'enregistrement" est un serveur de pr?sence (vocabulaire)
+ - autologin (<=> ne travailler qu'en mode logg?)
+ - GC des noeuds morts (ping ? heartbeats ? etc.)
+ - serveur de pr?sence ne doit ?tre utilis? qu'? l'amor?age. Chaque
+   noeud maintient ensuite ? jour sa liste de voisins
+ - D?sinstalleur windows
+ - Ne pas mettre dans le wizzard d'installation de question du genre
+   "o? souhaitez vous installer Maay ?"
+ - Par d?faut : private-index-dir : $HOME, public-index-dir : $HOME/Desktop/MaayPublic
+ - Dans le cadre de la recherche P2P, on cherche partout (local et distribu?), mais sur
+   la page de r?sultats, on doit voir appara?tre les informations suivantes :
+
+     * Deux liens : "X r?sultats locaux", "Y r?sultats distants" qui am?nent respectivement
+       sur une liste de r?sutlat exclusivement locaux et distants.
+     * Un indicateur visuel pour chaque r?sultat qui permet de savoir que c'est un
+       r?sultat distant, et de qui ?a vient.
+
+



From aurelienc at berlios.de  Thu Oct 20 10:38:25 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Thu, 20 Oct 2005 10:38:25 +0200
Subject: [Maay-svncheckins] r207 - in trunk/maay: . test
Message-ID: <200510200838.j9K8cPaM014370@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-20 10:38:21 +0200 (Thu, 20 Oct 2005)
New Revision: 207

Modified:
   trunk/maay/converter.py
   trunk/maay/test/test_converter.py
Log:
- add 3 new converters (for c, c++ and java source files)
- inform the test to check it


Modified: trunk/maay/converter.py
===================================================================
--- trunk/maay/converter.py	2005-10-20 07:39:22 UTC (rev 206)
+++ trunk/maay/converter.py	2005-10-20 08:38:21 UTC (rev 207)
@@ -98,8 +98,20 @@
         return TextParser()
 
 class PythonSourceConverter(RawTextConverter):
-    """provides support for various kinds of languages"""
+    """provides support for python source files"""
     MIME_TYPE = 'text/x-python'
+
+class CSourceConverter(RawTextConverter):
+    """provides support for C source files"""
+    MIME_TYPE = 'text/x-csrc'
+    
+class CPlusPlusSourceConverter(RawTextConverter):
+    """provides support for C++ source files"""
+    MIME_TYPE = 'text/x-c++src'
+
+class JavaSourceConverter(RawTextConverter):
+    """provides support for Java source files"""
+    MIME_TYPE = 'text/x-java'
         
 class HTMLConverter(BaseConverter):
     """provides a simple HTML parser"""

Modified: trunk/maay/test/test_converter.py
===================================================================
--- trunk/maay/test/test_converter.py	2005-10-20 07:39:22 UTC (rev 206)
+++ trunk/maay/test/test_converter.py	2005-10-20 08:38:21 UTC (rev 207)
@@ -26,7 +26,8 @@
     def testRegistry(self):
         """tests that converters we get match filenames's mimetype"""
         filenames = ['foo.pdf', 'foo.ps', 'foo.html', 'foo.txt',
-                     'foo.doc', 'foo.rtf', 'foo.py']
+                     'foo.doc', 'foo.rtf', 'foo.py', 'foo.c', 'foo.cpp',
+                     'foo.c++', 'foo.java']
         for filename in filenames:
             mimetype = guess_type(filename)[0]
             if mimetype is None:
@@ -44,7 +45,11 @@
         self.assert_(converter.PSConverter in converter.REGISTRY['application/postscript'])
         self.assert_(converter.PDFConverter in converter.REGISTRY['application/pdf'])
         self.assert_(converter.MSWordConverter in converter.REGISTRY['application/msword'])
-
+        self.assert_(converter.PythonSourceConverter in converter.REGISTRY['text/x-python'])
+        self.assert_(converter.CSourceConverter in converter.REGISTRY['text/x-csrc'])
+        self.assert_(converter.CPlusPlusSourceConverter in converter.REGISTRY['text/x-c++src'])
+        self.assert_(converter.JavaSourceConverter in converter.REGISTRY['text/x-java'])
+        
     def testCustomizedConverter(self):
         """make sure a user can define its own converter"""
         original_converters = list(converter.REGISTRY.get('application/pdf', []))



From adimasci at berlios.de  Thu Oct 20 10:52:58 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Thu, 20 Oct 2005 10:52:58 +0200
Subject: [Maay-svncheckins] r208 - in trunk/maay: . test
Message-ID: <200510200852.j9K8qwPO017091@sheep.berlios.de>

Author: adimasci
Date: 2005-10-20 10:52:57 +0200 (Thu, 20 Oct 2005)
New Revision: 208

Modified:
   trunk/maay/converter.py
   trunk/maay/test/test_converter.py
Log:
added ability to handle several mimetypes with the same converter
class.

We might also want to allow regular exrepssions or glob in mimetypes 
definitions. For instance :
class RawTextConverter(BaseConverter):
    MIMETYPES = ('text/*')

would automatically handle 'text/plain', 'text/x-python', etc.



Modified: trunk/maay/converter.py
===================================================================
--- trunk/maay/converter.py	2005-10-20 08:38:21 UTC (rev 207)
+++ trunk/maay/converter.py	2005-10-20 08:52:57 UTC (rev 208)
@@ -23,12 +23,12 @@
     >>> title, text, links, offset = extractWordsFromFile('foo.doc')
 
 To define a new command-based converter, just extend the
-CommandBasedConverter class and define MIME_TYPE and
+CommandBasedConverter class and define MIME_TYPES and
 optionally OUTPUT_TYPE variables ::
 
     from maay import converter
     class MyPDFConverter(converter.CommandBasedConverter):
-        MIME_TYPE = 'application/pdf'
+        MIME_TYPES = ('application/pdf',)
         OUTPUT_TYPE = 'text'
         COMMAND = 'mypdfconverter %(input)s -o %(output)s'
 
@@ -60,8 +60,8 @@
     """a simple metaclass for automatic converter registration"""
     def __new__(cls, classname, bases, classdict):
         klass = type.__new__(cls, classname, bases, classdict)
-        mimetype = classdict.get('MIME_TYPE')
-        if mimetype:
+        mimetypes = classdict.get('MIME_TYPES', [])
+        for mimetype in mimetypes:
             # insert user-defined converter first
             REGISTRY.setdefault(mimetype, []).insert(0, klass)
         return klass
@@ -92,31 +92,16 @@
 class RawTextConverter(BaseConverter):
     """provides simple text parser"""
     OUTPUT_TYPE = 'text'
-    MIME_TYPE = 'text/plain'
+    MIME_TYPES = ('text/plain', 'text/x-python', 'text/x-csrc', 'text/x-c++src',
+                  'text/x-java')
 
     def getParser(self):
         return TextParser()
-
-class PythonSourceConverter(RawTextConverter):
-    """provides support for python source files"""
-    MIME_TYPE = 'text/x-python'
-
-class CSourceConverter(RawTextConverter):
-    """provides support for C source files"""
-    MIME_TYPE = 'text/x-csrc'
-    
-class CPlusPlusSourceConverter(RawTextConverter):
-    """provides support for C++ source files"""
-    MIME_TYPE = 'text/x-c++src'
-
-class JavaSourceConverter(RawTextConverter):
-    """provides support for Java source files"""
-    MIME_TYPE = 'text/x-java'
         
 class HTMLConverter(BaseConverter):
     """provides a simple HTML parser"""
     OUTPUT_TYPE = 'html'
-    MIME_TYPE = 'text/html'
+    MIME_TYPES = ('text/html',)
 
     def getParser(self):
         return HTMLParser()
@@ -131,7 +116,7 @@
 
 class JpegConverter(ImageBasedConverter):
     OUTPUT_TYPE = 'jpeg'
-    MIME_TYPE = 'image/jpeg'
+    MIME_TYPES = ('image/jpeg',)
 
 class CommandBasedConverter(BaseConverter):
     COMMAND = None
@@ -175,21 +160,21 @@
 class PDFConverter(CommandBasedConverter, HTMLConverter):
     COMMAND = 'pdftohtml -i -q -noframes -stdout -enc UTF-8 "%(input)s" > "%(output)s"'
     OUTPUT_TYPE = 'html'
-    MIME_TYPE = 'application/pdf'
+    MIME_TYPES = ('application/pdf',)
     OUTPUT_ENCODING = 'UTF-8'
 
 class PSConverter(CommandBasedConverter, RawTextConverter):
     COMMAND = 'ps2ascii "%(input)s" "%(output)s"'
-    MIME_TYPE = 'application/postscript'
+    MIME_TYPES = ('application/postscript',)
 
 class RTFConverter(CommandBasedConverter, RawTextConverter):
     COMMAND = 'unrtf --html "%(input)s" > "%(output)s"'
     OUTPUT_TYPE = 'html'
-    MIME_TYPE = 'text/rtf'
+    MIME_TYPES = ('text/rtf',)
 
 class MSWordConverter(CommandBasedConverter):
     COMMAND = 'antiword "%(input)s" > "%(output)s"'
-    MIME_TYPE = 'application/msword'
+    MIME_TYPES = ('application/msword',)
 
 def extractWordsFromFile(filename):
     mimetype = guess_type(filename)[0]

Modified: trunk/maay/test/test_converter.py
===================================================================
--- trunk/maay/test/test_converter.py	2005-10-20 08:38:21 UTC (rev 207)
+++ trunk/maay/test/test_converter.py	2005-10-20 08:52:57 UTC (rev 208)
@@ -1,3 +1,10 @@
+# Copyright (c) 2000-2003 LOGILAB S.A. (Paris, FRANCE).
+# http://www.logilab.fr/ -- mailto:contact at logilab.fr
+"""
+
+"""
+
+__revision__ = "$Id$"
 #     Copyright (C) 2005 France Telecom R&D
 #
 #     This program is free software; you can redistribute it and/or modify
@@ -35,7 +42,7 @@
                 continue
             converters = converter.REGISTRY[mimetype]
             for klass in converters:
-                self.assertEquals(klass.MIME_TYPE, mimetype)
+                self.assert_(mimetype in klass.MIME_TYPES)
 
     def testLowLevelRegistry(self):
         """tests predefined converters registration"""
@@ -45,17 +52,17 @@
         self.assert_(converter.PSConverter in converter.REGISTRY['application/postscript'])
         self.assert_(converter.PDFConverter in converter.REGISTRY['application/pdf'])
         self.assert_(converter.MSWordConverter in converter.REGISTRY['application/msword'])
-        self.assert_(converter.PythonSourceConverter in converter.REGISTRY['text/x-python'])
-        self.assert_(converter.CSourceConverter in converter.REGISTRY['text/x-csrc'])
-        self.assert_(converter.CPlusPlusSourceConverter in converter.REGISTRY['text/x-c++src'])
-        self.assert_(converter.JavaSourceConverter in converter.REGISTRY['text/x-java'])
+        self.assert_(converter.RawTextConverter in converter.REGISTRY['text/x-python'])
+        self.assert_(converter.RawTextConverter in converter.REGISTRY['text/x-csrc'])
+        self.assert_(converter.RawTextConverter in converter.REGISTRY['text/x-c++src'])
+        self.assert_(converter.RawTextConverter in converter.REGISTRY['text/x-java'])
         
     def testCustomizedConverter(self):
         """make sure a user can define its own converter"""
         original_converters = list(converter.REGISTRY.get('application/pdf', []))
         class MyConverter(converter.CommandBasedConverter):
             COMMAND = "mypdfindexer %(input)s %(output)s"
-            MIME_TYPE = 'application/pdf'
+            MIME_TYPES = ('application/pdf',)
         new_converters = converter.REGISTRY.get('application/pdf', [])
         self.assertEquals(new_converters, [MyConverter] + original_converters)
 



From adimasci at berlios.de  Thu Oct 20 11:51:19 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Thu, 20 Oct 2005 11:51:19 +0200
Subject: [Maay-svncheckins] r209 - in trunk/maay: . test
Message-ID: <200510200951.j9K9pJi8029924@sheep.berlios.de>

Author: adimasci
Date: 2005-10-20 11:51:18 +0200 (Thu, 20 Oct 2005)
New Revision: 209

Modified:
   trunk/maay/p2pquerier.py
   trunk/maay/test/test_p2p.py
Log:
fixed dummy bugs, and added related tests


Modified: trunk/maay/p2pquerier.py
===================================================================
--- trunk/maay/p2pquerier.py	2005-10-20 08:52:57 UTC (rev 208)
+++ trunk/maay/p2pquerier.py	2005-10-20 09:51:18 UTC (rev 209)
@@ -50,11 +50,11 @@
         """return a dictionnary of arguments suitable for use as a
         **kwargs parameters to a call to distributedQuery"""
 
-        return {'id':self.query_id,
-                'sender':sender,
-                'ttl':ttl,
+        return {'id':self.id,
+                'sender':self.sender,
+                'ttl':self.ttl,
                 'words': self.query.words,
-                'mime_type': self.query.mime_type,
+                'mime_type': self.query.filetype,
                 }
 
 class P2pAnswer:

Modified: trunk/maay/test/test_p2p.py
===================================================================
--- trunk/maay/test/test_p2p.py	2005-10-20 08:52:57 UTC (rev 208)
+++ trunk/maay/test/test_p2p.py	2005-10-20 09:51:18 UTC (rev 209)
@@ -46,6 +46,28 @@
         self.failUnless(self.query.isKnown(doc))
         self.failIf(self.query.isKnown(Document(document_id = '1'*40)))
 
+    def testSimpleQueryAsKwargs(self):
+        self.assertEquals(self.query.asKwargs(),
+                          {'id' : '1'*40,
+                           'sender' : 'http://localhost:3423',
+                           'ttl' : 2,
+                           'words' : 'foo',
+                           'mime_type' : None})
+
+    def testComplexQueryAsKwargs(self):
+        query = P2pQuery(queryId='1'*40,
+                         sender='http://localhost:3423',
+                         ttl=2,
+                         query=Query.fromRawQuery("foo bar filetype:pdf"))
+        self.assertEquals(query.asKwargs(),
+                          {'id' : '1'*40,
+                           'sender' : 'http://localhost:3423',
+                           'ttl' : 2,
+                           'words' : 'foo bar',
+                           'mime_type' : 'application/pdf'})
+        
+    
+
 class P2pQuerierTC(unittest.TestCase):
     def setUp(self):
         self.querier = P2pQuerier('0'*40, None)  #XXX: How can we get a querier ?



From adimasci at berlios.de  Thu Oct 20 16:33:09 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Thu, 20 Oct 2005 16:33:09 +0200
Subject: [Maay-svncheckins] r210 - in trunk/maay: . test
Message-ID: <200510201433.j9KEX9FG016619@sheep.berlios.de>

Author: adimasci
Date: 2005-10-20 16:33:09 +0200 (Thu, 20 Oct 2005)
New Revision: 210

Modified:
   trunk/maay/dbentity.py
   trunk/maay/p2pquerier.py
   trunk/maay/test/test_p2p.py
Log:
- changed None to '' for because None cannot be sent through XMLRPC
- small bug fixes (Proxy expects a URL, not a Node instance)


Modified: trunk/maay/dbentity.py
===================================================================
--- trunk/maay/dbentity.py	2005-10-20 09:51:18 UTC (rev 209)
+++ trunk/maay/dbentity.py	2005-10-20 14:33:09 UTC (rev 210)
@@ -369,6 +369,7 @@
     attributes = ('word', 'claim_count', 'download_count')
     key = ('word',)
 
+
 class Node(DBEntity):
     """
     Attributes:
@@ -409,7 +410,10 @@
     selectActive = classmethod(selectActive)
         
 
+    def getRpcUrl(self):
+        return 'http://%s:%s' % (self.ip, self.port)
 
+
 class NodeInterest(DBEntity):
     """
     Attributes:

Modified: trunk/maay/p2pquerier.py
===================================================================
--- trunk/maay/p2pquerier.py	2005-10-20 09:51:18 UTC (rev 209)
+++ trunk/maay/p2pquerier.py	2005-10-20 14:33:09 UTC (rev 210)
@@ -49,12 +49,15 @@
     def asKwargs(self):
         """return a dictionnary of arguments suitable for use as a
         **kwargs parameters to a call to distributedQuery"""
-
+        # NOTE: We mustn't have None values in this dict because
+        #       None can't be sent via XMLRPC.
+        #       (Well, it can be in Twisted, but then I guess that
+        #       we have to restrict to Twisted and Python world)
         return {'id':self.id,
                 'sender':self.sender,
                 'ttl':self.ttl,
                 'words': self.query.words,
-                'mime_type': self.query.filetype,
+                'mime_type': self.query.filetype or '',
                 }
 
 class P2pAnswer:
@@ -84,7 +87,7 @@
 
     def sendQuery(self, query):
         for neighbor in self._selectTargetNeighbors(query):
-            proxy = Proxy(neighbor)
+            proxy = Proxy(neighbor.getRpcUrl())
             d = proxy.callRemote('distributedQuery', query.asKwargs())
             d.addCallback(self.querier.registerNodeActivity)
             print "sent %s to %s" % (query, neighbor)

Modified: trunk/maay/test/test_p2p.py
===================================================================
--- trunk/maay/test/test_p2p.py	2005-10-20 09:51:18 UTC (rev 209)
+++ trunk/maay/test/test_p2p.py	2005-10-20 14:33:09 UTC (rev 210)
@@ -52,7 +52,7 @@
                            'sender' : 'http://localhost:3423',
                            'ttl' : 2,
                            'words' : 'foo',
-                           'mime_type' : None})
+                           'mime_type' : ''})
 
     def testComplexQueryAsKwargs(self):
         query = P2pQuery(queryId='1'*40,



From adimasci at berlios.de  Thu Oct 20 16:36:54 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Thu, 20 Oct 2005 16:36:54 +0200
Subject: [Maay-svncheckins] r211 - trunk/maay
Message-ID: <200510201436.j9KEasl7016934@sheep.berlios.de>

Author: adimasci
Date: 2005-10-20 16:36:54 +0200 (Thu, 20 Oct 2005)
New Revision: 211

Modified:
   trunk/maay/rpc.py
Log:
yet another NameError/AttributeError fix

Modified: trunk/maay/rpc.py
===================================================================
--- trunk/maay/rpc.py	2005-10-20 14:33:09 UTC (rev 210)
+++ trunk/maay/rpc.py	2005-10-20 14:36:54 UTC (rev 211)
@@ -41,7 +41,7 @@
         XMLRPC.__init__(self)
         self._sessions = {}
         self.portal = portal
-        self.node_id = portal.config.get_node_id()
+        self.nodeId = portal.config.get_node_id()
         self._sessions[ANONYMOUS_AVATARID] = portal.anonymousQuerier
         self._p2pQuerier = P2pQuerier(nodeId, portal.anonymousQuerier)
         
@@ -123,7 +123,7 @@
             return 1
         if self.cnxIsValid(cnxId):
             querier = self._sessions[cnxId]
-            querier.indexDocument(self.node_id, filename, title, text, fileSize,
+            querier.indexDocument(self.nodeId, filename, title, text, fileSize,
                                   lastModifiedOn, content_hash, mime_type, state,
                                   file_state)
         return 0



From adimasci at berlios.de  Thu Oct 20 16:38:02 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Thu, 20 Oct 2005 16:38:02 +0200
Subject: [Maay-svncheckins] r212 - trunk/maay
Message-ID: <200510201438.j9KEc2vb017052@sheep.berlios.de>

Author: adimasci
Date: 2005-10-20 16:38:01 +0200 (Thu, 20 Oct 2005)
New Revision: 212

Modified:
   trunk/maay/converter.py
Log:
just added a small comment to explain why the the method ends with a raise statement

Modified: trunk/maay/converter.py
===================================================================
--- trunk/maay/converter.py	2005-10-20 14:36:54 UTC (rev 211)
+++ trunk/maay/converter.py	2005-10-20 14:38:01 UTC (rev 212)
@@ -186,6 +186,8 @@
         except IndexationFailure, exc:
             print "indexation failed for %s, trying another converter" % filename
             continue
+    # reaching this point means that none of our converters was able
+    # to decode the input file
     raise IndexationFailure("Could not index file %r" % filename)
 
 def isKnownType(filename):



From adimasci at berlios.de  Thu Oct 20 16:43:00 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Thu, 20 Oct 2005 16:43:00 +0200
Subject: [Maay-svncheckins] r213 - in trunk/maay: . data
Message-ID: <200510201443.j9KEh0GU017348@sheep.berlios.de>

Author: adimasci
Date: 2005-10-20 16:43:00 +0200 (Thu, 20 Oct 2005)
New Revision: 213

Added:
   trunk/maay/data/skeleton.html
Modified:
   trunk/maay/data/peers.html
   trunk/maay/data/resultpage.html
   trunk/maay/data/searchform.html
   trunk/maay/server.py
Log:
use nevow macros to define a common LookAndFeel and to factorize
templates HTML code (page footer and css declaration for instance)


Modified: trunk/maay/data/peers.html
===================================================================
--- trunk/maay/data/peers.html	2005-10-20 14:38:01 UTC (rev 212)
+++ trunk/maay/data/peers.html	2005-10-20 14:43:00 UTC (rev 213)
@@ -1,38 +1,26 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
-    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
-<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xmlns:nevow="http://nevow.com/ns/nevow/0.1">
-  <head>
-    <title>List of peers</title>
-    <link rel="stylesheet" type="text/css" href="maaycss"/>
-    <link rel="shortcut icon" href="images/maay.ico" />
-  </head>
- 
-  <body> 
-    <a nevow:render="loginurl"><nevow:attr name="href"><nevow:slot name="loginurl" /></nevow:attr><nevow:slot name="actionlabel" /></a>
-    <table class="peersTable" nevow:render="sequence" nevow:data="peers">
-      <tr nevow:pattern="header">
-	<th>Node id</th>
-	<th>IP</th>
-	<th>Port</th>
-	<th>Last Seen on</th>
-	<th>Number of Messages received</th>
-	<th>Affinity</th>
-	<th>Bandwidth</th>
-      </tr>
-      <tr nevow:pattern="item" nevow:render="peer">
-	<td class="nodeId"><nevow:slot name="node_id" /></td>
-	<td><nevow:slot name="ip" /></td>
-	<td><nevow:slot name="port" /></td>
-	<td><nevow:slot name="last_seen_time" /></td>
-	<td><nevow:slot name="claim_count" /></td>
-	<td><nevow:slot name="affinity" /></td>
-	<td><nevow:slot name="bandwidth" /></td>
-      </tr>
-    </table>
-    <hr />
-    <a href="http://maay.netofpeers.net/">Maay Home page</a> <a href="http://developer.berlios.de/projects/maay/">
-<img src="http://developer.berlios.de/bslogo.php?group_id=0"
-    width="124" height="32" border="0" alt="BerliOS Logo" /></a>
+"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
 
-    </body>  
-</html>
+<nevow:invisible xmlns="http://www.w3.org/1999/xhtml" lang="en" xmlns:nevow="http://nevow.com/ns/nevow/0.1">
+  <a nevow:render="loginurl"><nevow:attr name="href"><nevow:slot name="loginurl" /></nevow:attr><nevow:slot name="actionlabel" /></a>
+  <table class="peersTable" nevow:render="sequence" nevow:data="peers">
+    <tr nevow:pattern="header">
+      <th>Node id</th>
+      <th>IP</th>
+      <th>Port</th>
+      <th>Last Seen on</th>
+      <th>Number of Messages received</th>
+      <th>Affinity</th>
+      <th>Bandwidth</th>
+    </tr>
+    <tr nevow:pattern="item" nevow:render="peer">
+      <td class="nodeId"><nevow:slot name="node_id" /></td>
+      <td><nevow:slot name="ip" /></td>
+      <td><nevow:slot name="port" /></td>
+      <td><nevow:slot name="last_seen_time" /></td>
+      <td><nevow:slot name="claim_count" /></td>
+      <td><nevow:slot name="affinity" /></td>
+      <td><nevow:slot name="bandwidth" /></td>
+    </tr>
+  </table>
+</nevow:invisible>

Modified: trunk/maay/data/resultpage.html
===================================================================
--- trunk/maay/data/resultpage.html	2005-10-20 14:38:01 UTC (rev 212)
+++ trunk/maay/data/resultpage.html	2005-10-20 14:43:00 UTC (rev 213)
@@ -1,39 +1,27 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
-    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
-<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xmlns:nevow="http://nevow.com/ns/nevow/0.1">
-  <head>
-    <title>Results</title>
-    <link rel="stylesheet" type="text/css" href="maaycss"/>
-    <link rel="shortcut icon" href="images/maay.ico" />
- </head>
- 
-  <body>
-    <a nevow:render="loginurl"><nevow:attr name="href"><nevow:slot name="loginurl" /></nevow:attr><nevow:slot name="actionlabel" /></a>
-    <div class="reSearch">
-      <img src="images/smallmaay.png" />
-      <form action="search" accept-charset="utf-8">
-	<input type="text" name="words" nevow:render="searchfield"><nevow:attr name="value" ><nevow:slot name="words" /></nevow:attr></input>
-	<input type="submit" class="searchButton" value="search" />
-      </form>      
-    </div>
-    <div class="message" nevow:render="title">Results for "<nevow:slot name="words" />"</div>
-    <table class="results" nevow:render="sequence" nevow:data="results">
-      <tr nevow:pattern="item" nevow:render="row">
-	<td>
-	  <div class="resultItem">
-	    <a class="docTitle"><nevow:attr name="href">/download?docid=<nevow:slot name="docid" />&amp;words=<nevow:slot name="words" /></nevow:attr><nevow:slot name="doctitle">DOC TITLE</nevow:slot></a>
-	    <div class="resultDesc"><nevow:slot name="abstract" /></div>
-	    <span class="resultUrl"><nevow:attr name="href"><nevow:slot name="docurl" /></nevow:attr><nevow:slot name="docurl" /> - <nevow:slot name="readable_size" /> - <nevow:slot name="publication_date" /></span>
-	  </div>
-	</td>
-      </tr>
-    </table>
-    <div class="prevnext"><a><nevow:attr name="href"
-    nevow:render="prevset_url"/>Previous</a> - <a><nevow:attr
-    name="href" nevow:render="nextset_url"/>Next</a></div>
-    <hr />
-    <a href="http://maay.netofpeers.net/">Maay Home page</a> <a href="http://developer.berlios.de/projects/maay/">
-<img src="http://developer.berlios.de/bslogo.php?group_id=0"
-    width="124" height="32" border="0" alt="BerliOS Logo" /></a>
-  </body>  
-</html>
+"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<nevow:invisible xmlns="http://www.w3.org/1999/xhtml" lang="en" xmlns:nevow="http://nevow.com/ns/nevow/0.1">
+  <a nevow:render="loginurl"><nevow:attr name="href"><nevow:slot name="loginurl" /></nevow:attr><nevow:slot name="actionlabel" /></a>
+  <div class="reSearch">
+    <img src="images/smallmaay.png" />
+    <form action="search" accept-charset="utf-8">
+      <input type="text" name="words" nevow:render="searchfield"><nevow:attr name="value" ><nevow:slot name="words" /></nevow:attr></input>
+      <input type="submit" class="searchButton" value="search" />
+    </form>      
+  </div>
+  <div class="message" nevow:render="title">Results for "<nevow:slot name="words" />"</div>
+  <table class="results" nevow:render="sequence" nevow:data="results">
+    <tr nevow:pattern="item" nevow:render="row">
+      <td>
+	<div class="resultItem">
+	  <a class="docTitle"><nevow:attr name="href">/download?docid=<nevow:slot name="docid" />&amp;words=<nevow:slot name="words" /></nevow:attr><nevow:slot name="doctitle">DOC TITLE</nevow:slot></a>
+	  <div class="resultDesc"><nevow:slot name="abstract" /></div>
+	  <span class="resultUrl"><nevow:attr name="href"><nevow:slot name="docurl" /></nevow:attr><nevow:slot name="docurl" /> - <nevow:slot name="readable_size" /> - <nevow:slot name="publication_date" /></span>
+	</div>
+      </td>
+    </tr>
+  </table>
+  <div class="prevnext"><a><nevow:attr name="href"
+  nevow:render="prevset_url"/>Previous</a> - <a><nevow:attr
+  name="href" nevow:render="nextset_url"/>Next</a></div>
+</nevow:invisible>

Modified: trunk/maay/data/searchform.html
===================================================================
--- trunk/maay/data/searchform.html	2005-10-20 14:38:01 UTC (rev 212)
+++ trunk/maay/data/searchform.html	2005-10-20 14:43:00 UTC (rev 213)
@@ -1,31 +1,19 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
-    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
-<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xmlns:nevow="http://nevow.com/ns/nevow/0.1">
-  <head>
-    <title>Search Form</title>
-    <link rel="stylesheet" type="text/css" href="maaycss"/>
-    <link rel="shortcut icon" href="images/maay.ico" />
-  </head>
- 
-  <body> 
-    <a nevow:render="loginurl"><nevow:attr name="href"><nevow:slot name="loginurl" /></nevow:attr><nevow:slot name="actionlabel" /></a>
-    <table class="searchHome">
-      <tr>
-	<td><img src="images/maay.png" /></td>
-      </tr>
-      <tr>
-	<td>
-	  <form action="search" accept-charset="utf-8">
-	    <input type="text" name="words" value="" />
-	    <input type="submit" class="searchButton" value="search" />
-	  </form>
-	</td>
-      </tr>
-    </table>
-    <hr />
-    <a href="http://maay.netofpeers.net/">Maay Home page</a> <a href="http://developer.berlios.de/projects/maay/">
-<img src="http://developer.berlios.de/bslogo.php?group_id=0"
-    width="124" height="32" border="0" alt="BerliOS Logo" /></a>
+"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
 
-    </body>  
-</html>
+<nevow:invisible xmlns="http://www.w3.org/1999/xhtml" lang="en" xmlns:nevow="http://nevow.com/ns/nevow/0.1">
+  <a nevow:render="loginurl"><nevow:attr name="href"><nevow:slot name="loginurl" /></nevow:attr><nevow:slot name="actionlabel" /></a>
+  <table class="searchHome">
+    <tr>
+      <td><img src="images/maay.png" /></td>
+    </tr>
+    <tr>
+      <td>
+	<form action="search" accept-charset="utf-8">
+	  <input type="text" name="words" value="" />
+	  <input type="submit" class="searchButton" value="search" />
+	</form>
+      </td>
+    </tr>
+  </table>
+</nevow:invisible>

Added: trunk/maay/data/skeleton.html
===================================================================
--- trunk/maay/data/skeleton.html	2005-10-20 14:38:01 UTC (rev 212)
+++ trunk/maay/data/skeleton.html	2005-10-20 14:43:00 UTC (rev 213)
@@ -0,0 +1,18 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
+    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xmlns:nevow="http://nevow.com/ns/nevow/0.1">
+  <head>
+    <title>Search Form</title>
+    <link rel="stylesheet" type="text/css" href="maaycss"/>
+    <link rel="shortcut icon" href="images/maay.ico" />
+  </head>
+ 
+  <body>
+    <nevow:invisible nevow:macro="body" />
+    <hr />
+    <a href="http://maay.netofpeers.net/">Maay Home page</a> <a href="http://developer.berlios.de/projects/maay/">
+<img src="http://developer.berlios.de/bslogo.php?group_id=0"
+    width="124" height="32" border="0" alt="BerliOS Logo" /></a>
+
+    </body>  
+</html>

Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-20 14:38:01 UTC (rev 212)
+++ trunk/maay/server.py	2005-10-20 14:43:00 UTC (rev 213)
@@ -65,6 +65,7 @@
 from maay.query import Query
 
 class MaayPage(rend.Page):
+    docFactory = loaders.xmlfile(get_path_of('skeleton.html'))
     child_maaycss = static.File(get_path_of('maay.css'))
     child_images = static.File(get_path_of('images/'))
 
@@ -89,6 +90,9 @@
         context.fillSlots('loginurl', str(goThereAfter))
         return context.tag
 
+    def macro_body(self, context):
+        return self.bodyFactory
+
     def child_login(self, context):
         return LoginForm(self.maayId)
 
@@ -113,7 +117,7 @@
                            pathList, here.queryList())
         return str(goThereAfter)
 
-    docFactory = loaders.stan(
+    bodyFactory = loaders.stan(
         tags.html[
             tags.head[tags.title["Maay Login Page",],
                       tags.link(rel='stylesheet', type='text/css', href='maaycss'),
@@ -145,7 +149,7 @@
 
 class PeersList(MaayPage):
     """display list of registered peers"""
-    docFactory = loaders.xmlfile(get_path_of('peers.html'))
+    bodyFactory = loaders.xmlfile(get_path_of('peers.html'))
     addSlash = True
 
     def __init__(self, maayId, querier):
@@ -167,7 +171,7 @@
                     
 class SearchForm(MaayPage):
     """default search form"""
-    docFactory = loaders.xmlfile(get_path_of('searchform.html'))
+    bodyFactory = loaders.xmlfile(get_path_of('searchform.html'))
     addSlash = True
 
     def __init__(self, maayId, querier):
@@ -204,7 +208,7 @@
 
 class ResultsPage(MaayPage):
     """default results page"""
-    docFactory = loaders.xmlfile(get_path_of('resultpage.html'))
+    bodyFactory = loaders.xmlfile(get_path_of('resultpage.html'))
     addSlash = False
     
     def __init__(self, maayId, results, query):



From aurelienc at berlios.de  Mon Oct 24 10:23:57 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Mon, 24 Oct 2005 10:23:57 +0200
Subject: [Maay-svncheckins] r214 - trunk/maay/test
Message-ID: <200510240823.j9O8Nv0i009274@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-24 10:23:53 +0200 (Mon, 24 Oct 2005)
New Revision: 214

Modified:
   trunk/maay/test/test_indexer.py
Log:
a test for the mimetype update hack in indexer


Modified: trunk/maay/test/test_indexer.py
===================================================================
--- trunk/maay/test/test_indexer.py	2005-10-20 14:43:00 UTC (rev 213)
+++ trunk/maay/test/test_indexer.py	2005-10-24 08:23:53 UTC (rev 214)
@@ -30,6 +30,12 @@
         f.close()
         self.assertEquals(makeDocumentId(filename), sha.sha(data).hexdigest())
         os.remove(filename)
+
+    def testMimetypeUpdate(self):
+        #XXX: This may need to go away since we provide converters for python
+        # and the type_map update in indexer is not sufficient to catch python files
+        # as text files
+        self.assertEquals('text/plain', mimetypes.types_map['.py'])
         
         
 



From aurelienc at berlios.de  Mon Oct 24 10:24:51 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Mon, 24 Oct 2005 10:24:51 +0200
Subject: [Maay-svncheckins] r215 - trunk/maay
Message-ID: <200510240824.j9O8Opxu009314@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-24 10:24:48 +0200 (Mon, 24 Oct 2005)
New Revision: 215

Modified:
   trunk/maay/server.py
Log:
switch default webserver port to 7777 by request of J. Keller


Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-24 08:23:53 UTC (rev 214)
+++ trunk/maay/server.py	2005-10-24 08:24:48 UTC (rev 215)
@@ -447,7 +447,7 @@
         ('webserver-port',
          {'type' : "int", 'metavar' : "<webserver_port>", 
           'help' : "Internet port on which the web interface is listening",
-          'default' : 8080,
+          'default' : 7777,
           }),
         ('rpcserver-port',
          {'type' : "int", 'metavar' : "<rpcserver_port>", 



From aurelienc at berlios.de  Mon Oct 24 11:47:27 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Mon, 24 Oct 2005 11:47:27 +0200
Subject: [Maay-svncheckins] r216 - trunk/maay
Message-ID: <200510240947.j9O9lRWo031745@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-24 11:47:15 +0200 (Mon, 24 Oct 2005)
New Revision: 216

Modified:
   trunk/maay/texttool.py
Log:
Unicode-ify all initialisations of a title (whose asserted type is unicode, not str)


Modified: trunk/maay/texttool.py
===================================================================
--- trunk/maay/texttool.py	2005-10-24 08:24:48 UTC (rev 215)
+++ trunk/maay/texttool.py	2005-10-24 09:47:15 UTC (rev 216)
@@ -132,7 +132,7 @@
         try:
             title, result, links, offset = self.parseString(stream.read())
             if not title:
-                title = filepath.split('/')[-1]
+                title = unicode(filepath.split('/')[-1])
             return title, result, links, offset 
         finally:
             stream.close()
@@ -141,7 +141,7 @@
         """returns a 4-uple (title, normalized_text, links, offset)
            to parseFile
            When a title cannot be computed from file content parseFile
-           expects an empty string
+           expects an empty unicode string
         """
         raise NotImplementedError()
 
@@ -149,7 +149,7 @@
 class TextParser(AbstractParser):
 
     def parseString(self, source):
-        return '', source, [], 0
+        return u'', source, [], 0
         
 
 class MaayHTMLParser(AbstractParser, HTMLParser):
@@ -157,7 +157,7 @@
         HTMLParser.__init__(self)
         self.links = []
         self.textbuf = []
-        self.title = ''
+        self.title = u''
         self.parsingTitle = False
         self.parsingBody = False
         
@@ -196,7 +196,7 @@
     """A parser for Exif information found in image files"""
 
     def parseString(self, source):
-        return '', u'The image', [], 0
+        return u'', u'The image', [], 0
 
         
 _table = {}



From aurelienc at berlios.de  Mon Oct 24 18:06:38 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Mon, 24 Oct 2005 18:06:38 +0200
Subject: [Maay-svncheckins] r217 - in trunk/maay: . test
Message-ID: <200510241606.j9OG6ckN010033@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-24 18:06:35 +0200 (Mon, 24 Oct 2005)
New Revision: 217

Modified:
   trunk/maay/converter.py
   trunk/maay/test/test_texttool.py
   trunk/maay/texttool.py
Log:
-update to texttool to improve title handling 
-same for converter.py plus a little refactoring of extractWordsFromFile (now with two helpers)
-some tests to check title handling at the level of texttool


Modified: trunk/maay/converter.py
===================================================================
--- trunk/maay/converter.py	2005-10-24 09:47:15 UTC (rev 216)
+++ trunk/maay/converter.py	2005-10-24 16:06:35 UTC (rev 217)
@@ -77,16 +77,17 @@
     def getParser(self):
         raise NotImplementedError()
 
-    def extractWordsFromFile(self, filename):
+    def extractWordsFromFile(self, filepath):
         """entry point of each converter class
 
         :returns: a word-vector
         """
         parser = self.getParser()
         try:
-            return parser.parseFile(filename, self.OUTPUT_ENCODING)
+            return parser.parseFile(filepath, lastComponent(filepath),
+                                    self.OUTPUT_ENCODING)
         except ParsingError, exc:
-            raise IndexationFailure("Cannot index document %s (%s)" % (filename, exc))
+            raise IndexationFailure("Cannot index document %s (%s)" % (filepath, exc))
 
 
 class RawTextConverter(BaseConverter):
@@ -104,7 +105,7 @@
     MIME_TYPES = ('text/html',)
 
     def getParser(self):
-        return HTMLParser()
+        return HTMLParser() # This is really MaayHTMLParser from texttool
 
 class ImageBasedConverter(BaseConverter):
     """provides base Image converter
@@ -118,46 +119,77 @@
     OUTPUT_TYPE = 'jpeg'
     MIME_TYPES = ('image/jpeg',)
 
+
+def lastComponent(filepath):
+    """returns the last component of a file path
+       ex : '/home/data/foo.gz' -> 'foo.gz'
+    """
+    return filepath.split('/')[-1] #XXX: replace '/' by os independant method
+
+
+def uncompressFile(filepath, outputDir):
+    """returns a filepath for the same, uncompressed, file
+       located in the provided output dir
+    """
+    if filepath.endswith('.gz'):
+        opener = gzip.open
+    elif filepath.endswith('.bz2'):
+        opener = bz2.BZ2File
+    else:
+        opener = file
+    compressed = opener(filepath, 'rb')
+    uncompressedFile = os.path.join(outputDir, lastComponent(filepath+"-in"))
+    uncompressed = file(uncompressedFile, 'wb')
+    uncompressed.write(compressed.read())
+    compressed.close()
+    uncompressed.close()
+    return uncompressedFile
+    
+
 class CommandBasedConverter(BaseConverter):
     COMMAND = None
 
-    def extractWordsFromFile(self, filename):
+    def extractWordsFromFile(self, filepath):
+        """XXX: some nasty side-effects lurking here
+           1) for ps2ascii to work, we must have inputFile != outputFile
+              hence the "-in" which is concatenated in uncompressFile above
+           2) pdftohtml will always generate a wrongly titled document named
+              after the input file (ie 'foo.pdf-in')
+           For the title problem, we provide this workaround : provide
+           the correct filename as additional parameter to the parser.
+        """
+
         outputDir = mkdtemp()
-        if filename.endswith('.gz'):
-            opener = gzip.open
-        elif filename.endswith('.bz2'):
-                opener = bz2.BZ2File
-        else:
-            opener = file
-            
-        compressed = opener(filename, 'rb')
-        uncompressedFile = os.path.join(outputDir, 'uncompressed')
-        uncompressed = file(uncompressedFile, 'wb')
-        uncompressed.write(compressed.read())
-        compressed.close()
-        uncompressed.close()
 
-            
-        outputFile = os.path.join(outputDir, 'outfile')
-        command_args = {'input' : uncompressedFile, 'output' : outputFile}
+        inputFile = uncompressFile (filepath, outputDir)
+        outputFile = os.path.join(outputDir, lastComponent(filepath))
+
+        command_args = {'input' : inputFile, 'output' : outputFile}
         cmd = self.COMMAND % command_args
+
         #print "Executing %r" % cmd
         errcode = os.system(cmd)
         try:
             if errcode == 0: # OK
                 parser = self.getParser()
-                return parser.parseFile(outputFile, self.OUTPUT_ENCODING)
+                return parser.parseFile(outputFile, lastComponent(filepath),
+                                        self.OUTPUT_ENCODING)                                        
             else:
-                raise IndexationFailure('Unable to index %r' % filename)
+                raise IndexationFailure('Unable to index %r' % filepath)
         finally:
             if os.path.isfile(outputFile):
                 os.remove(outputFile)
-            if os.path.isfile(uncompressedFile):
-                os.remove(uncompressedFile)
+            if os.path.isfile(inputFile):
+                os.remove(inputFile)
             os.rmdir(outputDir)
 
 
 class PDFConverter(CommandBasedConverter, HTMLConverter):
+    """This PDF converter has a little problem :
+       it uses pdftohtml which systematically builds a html
+       file whose TITLE field is its input file name.
+       This can inpact the title guessing algorithm we want.
+    """
     COMMAND = 'pdftohtml -i -q -noframes -stdout -enc UTF-8 "%(input)s" > "%(output)s"'
     OUTPUT_TYPE = 'html'
     MIME_TYPES = ('application/pdf',)

Modified: trunk/maay/test/test_texttool.py
===================================================================
--- trunk/maay/test/test_texttool.py	2005-10-24 09:47:15 UTC (rev 216)
+++ trunk/maay/test/test_texttool.py	2005-10-24 16:06:35 UTC (rev 217)
@@ -44,15 +44,24 @@
     def setUp(self):
         self.parser = TextParser()
 
-    def testTitleGuess(self):
+    def testTitleGuess(self): #XXX: complete this with PDF/PS files before commit time !!!
         """Make sure the title is the filename when we treat a text file
            or no title could be found
         """
-        title, text, links, offset = self.parser.parseFile(join(DATADIR, 'latin1.txt'), 'ISO-8859-1')
+        title, text, links, offset = self.parser.parseFile(join(DATADIR, 'latin1.txt'), 'latin1.txt', 'ISO-8859-1')
         self.assertEquals(title, 'latin1.txt')
         self.assertEquals(normalizeText(text), "c'est l'ete")
         self.assertEquals(links, [])
+        # Now, PS file
+        title, text, links, offset = self.parser.parseFile(join(DATADIR, 'utf8.ps'), 'utf8.ps', 'UTF-8')
+        self.assertEquals(title, 'utf8.ps')
+        self.assertEquals(links, [])
+        # The PDF (yes, it's important to test this too)
+        title, text, links, offset = self.parser.parseFile(join(DATADIR, 'utf8.pdf'), 'utf8.pdf', 'UTF-8')
+        self.assertEquals(title, 'utf8.pdf')
+        self.assertEquals(links, [])
 
+
 class HTMLParserTC(unittest.TestCase):
 
     def setUp(self):
@@ -71,7 +80,7 @@
         """Make sure the title is the filename when we treat a text file
            or no title could be found
         """
-        title, text, links, offset = self.parser.parseFile(join(DATADIR, "notitle.html"))
+        title, text, links, offset = self.parser.parseFile(join(DATADIR, "notitle.html"), 'notitle.html')
         self.assertEquals(title, 'notitle.html')
         self.assertEquals(normalizeText(text), "maille maay")
         self.assertEquals(links, [])
@@ -87,7 +96,7 @@
 
     def testParseHtmlFileWithEncoding(self):
         filename = join(DATADIR, 'encoded.html')
-        title, text, links, offset = self.parser.parseFile(filename, 'iso-8859-1')
+        title, text, links, offset = self.parser.parseFile(filename, 'encoded.html', 'iso-8859-1')
         self.assertEquals(title, 'maille Maay')
         self.assertEquals(normalizeText(text),
                           'hello ete world this is a link and this is another link')
@@ -95,7 +104,7 @@
         
     def testParseHtmlFileAndGuessEncoding(self):
         filename = join(DATADIR, 'encoded.html')
-        title, text, links, offset = self.parser.parseFile(filename)
+        title, text, links, offset = self.parser.parseFile(filename, 'encoded.html')
         self.assertEquals(title, 'maille Maay')
         self.assertEquals(normalizeText(text),
                           'hello ete world this is a link and this is another link')

Modified: trunk/maay/texttool.py
===================================================================
--- trunk/maay/texttool.py	2005-10-24 09:47:15 UTC (rev 216)
+++ trunk/maay/texttool.py	2005-10-24 16:06:35 UTC (rev 217)
@@ -116,7 +116,7 @@
 
 class AbstractParser:
     """base-class for file parsers"""
-    def parseFile(self, filepath, encoding=None):
+    def parseFile(self, filepath, pristineFilename, encoding=None):
         """returns a 4-uple (title, normalized_text, links, offset)
         TODO: port original code from htmltotext
         :param encoding: if None, then need to be guessed
@@ -132,7 +132,7 @@
         try:
             title, result, links, offset = self.parseString(stream.read())
             if not title:
-                title = unicode(filepath.split('/')[-1])
+                title = unicode(pristineFilename) 
             return title, result, links, offset 
         finally:
             stream.close()
@@ -189,6 +189,10 @@
         except HTMLParseError, exc:
             print "Error parsing document: %s" % exc
         result = u'\n'.join(self.textbuf)
+        #XXX: wacky hack to get a correct title when we just processed
+        #     a file from PDFTOHTML
+        if self.title[-7:len(self.title)] == '.pdf-in':
+            self.title = u''
         return self.title, result, self.links, 0
 
 



From aurelienc at berlios.de  Mon Oct 24 18:17:01 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Mon, 24 Oct 2005 18:17:01 +0200
Subject: [Maay-svncheckins] r218 - in trunk/maay: . test
Message-ID: <200510241617.j9OGH1hP011584@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-24 18:16:55 +0200 (Mon, 24 Oct 2005)
New Revision: 218

Modified:
   trunk/maay/converter.py
   trunk/maay/test/test_converter.py
Log:
Generalize image converter to handle multiple image types, add tests for these.


Modified: trunk/maay/converter.py
===================================================================
--- trunk/maay/converter.py	2005-10-24 16:06:35 UTC (rev 217)
+++ trunk/maay/converter.py	2005-10-24 16:16:55 UTC (rev 218)
@@ -107,19 +107,16 @@
     def getParser(self):
         return HTMLParser() # This is really MaayHTMLParser from texttool
 
-class ImageBasedConverter(BaseConverter):
+class ImageConverter(BaseConverter):
     """provides base Image converter
        In the future, it may hold EXIF information retrieval methods"""
     OUTPUT_TYPE = 'image'
+    MIME_TYPES = ('image/jpeg','image/png', 'image/x-xpixmap')
 
     def getParser(self):
         return ExifParser()
 
-class JpegConverter(ImageBasedConverter):
-    OUTPUT_TYPE = 'jpeg'
-    MIME_TYPES = ('image/jpeg',)
 
-
 def lastComponent(filepath):
     """returns the last component of a file path
        ex : '/home/data/foo.gz' -> 'foo.gz'

Modified: trunk/maay/test/test_converter.py
===================================================================
--- trunk/maay/test/test_converter.py	2005-10-24 16:06:35 UTC (rev 217)
+++ trunk/maay/test/test_converter.py	2005-10-24 16:16:55 UTC (rev 218)
@@ -34,7 +34,7 @@
         """tests that converters we get match filenames's mimetype"""
         filenames = ['foo.pdf', 'foo.ps', 'foo.html', 'foo.txt',
                      'foo.doc', 'foo.rtf', 'foo.py', 'foo.c', 'foo.cpp',
-                     'foo.c++', 'foo.java']
+                     'foo.c++', 'foo.java', 'foo.xpm', 'foo.jpg', 'foo.png']
         for filename in filenames:
             mimetype = guess_type(filename)[0]
             if mimetype is None:
@@ -56,6 +56,9 @@
         self.assert_(converter.RawTextConverter in converter.REGISTRY['text/x-csrc'])
         self.assert_(converter.RawTextConverter in converter.REGISTRY['text/x-c++src'])
         self.assert_(converter.RawTextConverter in converter.REGISTRY['text/x-java'])
+        self.assert_(converter.ImageConverter in converter.REGISTRY['image/jpeg'])
+        self.assert_(converter.ImageConverter in converter.REGISTRY['image/png'])
+        self.assert_(converter.ImageConverter in converter.REGISTRY['image/x-xpixmap'])
         
     def testCustomizedConverter(self):
         """make sure a user can define its own converter"""



From aurelienc at berlios.de  Mon Oct 24 18:23:25 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Mon, 24 Oct 2005 18:23:25 +0200
Subject: [Maay-svncheckins] r219 - trunk/maay
Message-ID: <200510241623.j9OGNPva012526@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-24 18:23:21 +0200 (Mon, 24 Oct 2005)
New Revision: 219

Modified:
   trunk/maay/indexer.py
Log:
Minor cosmetic outpout fix.


Modified: trunk/maay/indexer.py
===================================================================
--- trunk/maay/indexer.py	2005-10-24 16:16:55 UTC (rev 218)
+++ trunk/maay/indexer.py	2005-10-24 16:23:21 UTC (rev 219)
@@ -182,12 +182,12 @@
                       lastModTime, content_hash, mime_type, state,
                       file_state=FileInfo.CREATED_FILE_STATE):
         if self.verbose:
-            print "Requesting indexation of %s" % filename
+            print "Requesting indexation of %s" % filename,
         try:
             title = removeControlChar(title) 
             text = removeControlChar(text)
             if self.verbose:
-                print " ... indexed as", title.encode('utf-8')
+                print u'('+title.encode('utf-8')+u')'
             self.serverProxy.indexDocument(self.cnxId, filename, title, text,
                                            fileSize, lastModTime, content_hash,
                                            mime_type, state, file_state)
@@ -350,3 +350,5 @@
 
 if __name__ == '__main__':
     run()
+
+#print "PYTHON", mimetypes.types_map['.py']



From adimasci at berlios.de  Mon Oct 24 19:14:56 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Mon, 24 Oct 2005 19:14:56 +0200
Subject: [Maay-svncheckins] r220 - trunk/maay
Message-ID: <200510241714.j9OHEulM007396@sheep.berlios.de>

Author: adimasci
Date: 2005-10-24 19:14:55 +0200 (Mon, 24 Oct 2005)
New Revision: 220

Modified:
   trunk/maay/converter.py
Log:
replaced lastComponent() with os.path.basename() which
does exactly what was expected, and correctly handles
platform-specific related problems.


Modified: trunk/maay/converter.py
===================================================================
--- trunk/maay/converter.py	2005-10-24 16:23:21 UTC (rev 219)
+++ trunk/maay/converter.py	2005-10-24 17:14:55 UTC (rev 220)
@@ -42,7 +42,7 @@
 
 # XXX: need to handle file encodings
 
-import os
+import os, os.path as osp
 from mimetypes import guess_type, types_map
 from tempfile import mkdtemp
 import gzip
@@ -84,7 +84,7 @@
         """
         parser = self.getParser()
         try:
-            return parser.parseFile(filepath, lastComponent(filepath),
+            return parser.parseFile(filepath, osp.basename(filepath),
                                     self.OUTPUT_ENCODING)
         except ParsingError, exc:
             raise IndexationFailure("Cannot index document %s (%s)" % (filepath, exc))
@@ -117,13 +117,6 @@
         return ExifParser()
 
 
-def lastComponent(filepath):
-    """returns the last component of a file path
-       ex : '/home/data/foo.gz' -> 'foo.gz'
-    """
-    return filepath.split('/')[-1] #XXX: replace '/' by os independant method
-
-
 def uncompressFile(filepath, outputDir):
     """returns a filepath for the same, uncompressed, file
        located in the provided output dir
@@ -135,7 +128,7 @@
     else:
         opener = file
     compressed = opener(filepath, 'rb')
-    uncompressedFile = os.path.join(outputDir, lastComponent(filepath+"-in"))
+    uncompressedFile = osp.join(outputDir, osp.basename(filepath+"-in"))
     uncompressed = file(uncompressedFile, 'wb')
     uncompressed.write(compressed.read())
     compressed.close()
@@ -159,7 +152,7 @@
         outputDir = mkdtemp()
 
         inputFile = uncompressFile (filepath, outputDir)
-        outputFile = os.path.join(outputDir, lastComponent(filepath))
+        outputFile = osp.join(outputDir, osp.basename(filepath))
 
         command_args = {'input' : inputFile, 'output' : outputFile}
         cmd = self.COMMAND % command_args
@@ -169,14 +162,14 @@
         try:
             if errcode == 0: # OK
                 parser = self.getParser()
-                return parser.parseFile(outputFile, lastComponent(filepath),
-                                        self.OUTPUT_ENCODING)                                        
+                return parser.parseFile(outputFile, osp.basename(filepath),
+                                        self.OUTPUT_ENCODING)
             else:
                 raise IndexationFailure('Unable to index %r' % filepath)
         finally:
-            if os.path.isfile(outputFile):
+            if osp.isfile(outputFile):
                 os.remove(outputFile)
-            if os.path.isfile(inputFile):
+            if osp.isfile(inputFile):
                 os.remove(inputFile)
             os.rmdir(outputDir)
 



From aurelienc at berlios.de  Tue Oct 25 11:27:39 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Tue, 25 Oct 2005 11:27:39 +0200
Subject: [Maay-svncheckins] r221 - trunk/maay/test/data
Message-ID: <200510250927.j9P9RdIF027486@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-25 11:27:33 +0200 (Tue, 25 Oct 2005)
New Revision: 221

Added:
   trunk/maay/test/data/utf8.ps
Log:
This is a helper for tests (a title-less tiny postscript file).


Added: trunk/maay/test/data/utf8.ps
===================================================================
--- trunk/maay/test/data/utf8.ps	2005-10-24 17:14:55 UTC (rev 220)
+++ trunk/maay/test/data/utf8.ps	2005-10-25 09:27:33 UTC (rev 221)
@@ -0,0 +1,774 @@
+%!PS-Adobe-3.0
+%%Title: utf8.txt
+%%For: Aurelien Campeas
+%%Creator: a2ps version 4.13
+%%CreationDate: Mon Oct 24 17:58:04 2005
+%%BoundingBox: 24 24 571 818
+%%DocumentData: Clean7Bit
+%%Orientation: Landscape
+%%Pages: 1
+%%PageOrder: Ascend
+%%DocumentMedia: A4 595 842 0 () ()
+%%DocumentNeededResources: font Courier
+%%+ font Courier-Bold
+%%+ font Courier-BoldOblique
+%%+ font Courier-Oblique
+%%+ font Helvetica
+%%+ font Helvetica-Bold
+%%+ font Symbol
+%%+ font Times-Bold
+%%+ font Times-Roman
+%%DocumentProcessColors: Black 
+%%DocumentSuppliedResources: procset a2ps-a2ps-hdr
+%%+ procset a2ps-black+white-Prolog
+%%+ encoding ISO-8859-1Encoding
+%%EndComments
+/a2psdict 200 dict def
+a2psdict begin
+%%BeginProlog
+%%Copyright: (c) 1988, 89, 90, 91, 92, 93 Miguel Santana
+%%Copyright: (c) 1995, 96, 97, 98 Akim Demaille, Miguel Santana
+% Check PostScript language level.
+/languagelevel where {
+  pop /gs_languagelevel languagelevel def
+} {
+  /gs_languagelevel 1 def
+} ifelse
+
+% EPSF import as in the Red Book
+/BeginInclude {
+  /b4_Inc_state save def    		% Save state for cleanup
+  /dict_count countdictstack def	% Count objects on dict stack
+  /op_count count 1 sub def		% Count objects on operand stack 
+  userdict begin
+    0 setgray 0 setlinecap
+    1 setlinewidth 0 setlinejoin
+    10 setmiterlimit [ ] 0 setdash newpath
+    gs_languagelevel 1 ne {
+      false setstrokeadjust false setoverprint 
+    } if
+} bind def
+
+/EndInclude {
+  count op_count sub { pos } repeat	% Clean up stacks
+  countdictstack dict_count sub { end } repeat
+  b4_Inc_state restore
+} bind def
+
+/BeginEPSF {
+  BeginInclude
+  /showpage { } def
+} bind def
+
+/EndEPSF {
+  EndInclude
+} bind def
+
+% Page prefeed
+/page_prefeed {         % bool -> -
+  statusdict /prefeed known {
+    statusdict exch /prefeed exch put
+  } {
+    pop
+  } ifelse
+} bind def
+
+/deffont {
+  findfont exch scalefont def
+} bind def
+
+/reencode_font {
+  findfont reencode 2 copy definefont pop def
+} bind def
+
+% Function c-show (str => -)
+% centers text only according to x axis.
+/c-show { 
+  dup stringwidth pop
+  2 div neg 0 rmoveto
+  show
+} bind def
+
+% Function l-show (str => -)
+% prints texts so that it ends at currentpoint
+/l-show {
+  dup stringwidth pop neg 
+  0 
+  rmoveto show
+} bind def
+
+% center-fit show (str w => -)
+% show centered, and scale currentfont so that the width is less than w
+/cfshow {
+  exch dup stringwidth pop
+  % If the title is too big, try to make it smaller
+  3 2 roll 2 copy
+  gt
+  { % if, i.e. too big
+    exch div
+    currentfont exch scalefont setfont
+  } { % ifelse
+    pop pop 
+  }
+  ifelse
+  c-show			% center title
+} bind def
+
+% Return the y size of the current font
+% - => fontsize
+/currentfontsize {
+  currentfont /FontType get 0 eq {
+    currentfont /FontMatrix get 3 get
+  }{
+    currentfont /FontMatrix get 3 get 1000 mul
+  } ifelse
+} bind def
+
+% reencode the font
+% <encoding-vector> <fontdict> -> <newfontdict>
+/reencode { %def
+  dup length 5 add dict begin
+    { %forall
+      1 index /FID ne 
+      { def }{ pop pop } ifelse
+    } forall
+    /Encoding exch def
+
+    % Use the font's bounding box to determine the ascent, descent,
+    % and overall height; don't forget that these values have to be
+    % transformed using the font's matrix.
+    % We use `load' because sometimes BBox is executable, sometimes not.
+    % Since we need 4 numbers an not an array avoid BBox from being executed
+    /FontBBox load aload pop
+    FontMatrix transform /Ascent exch def pop
+    FontMatrix transform /Descent exch def pop
+    /FontHeight Ascent Descent sub def
+
+    % Define these in case they're not in the FontInfo (also, here
+    % they're easier to get to.
+    /UnderlinePosition 1 def
+    /UnderlineThickness 1 def
+    
+    % Get the underline position and thickness if they're defined.
+    currentdict /FontInfo known {
+      FontInfo
+      
+      dup /UnderlinePosition known {
+	dup /UnderlinePosition get
+	0 exch FontMatrix transform exch pop
+	/UnderlinePosition exch def
+      } if
+      
+      dup /UnderlineThickness known {
+	/UnderlineThickness get
+	0 exch FontMatrix transform exch pop
+	/UnderlineThickness exch def
+      } if
+      
+    } if
+    currentdict 
+  end 
+} bind def
+
+% composite fonts for ASCII-EUC mixed strings
+% Version 1.2 1/31/1990
+% Original Ken'ichi HANDA (handa at etl.go.jp)
+% Modified Norio Katayama (katayama at rd.nacsis.ac.jp),1998
+% Extend & Fix Koji Nakamaru (maru at on.cs.keio.ac.jp), 1999
+% Anyone can freely copy, modify, distribute this program.
+
+/copyfont {	% font-dic extra-entry-count  copyfont  font-dic
+	1 index maxlength add dict begin
+	{	1 index /FID ne 2 index /UniqueID ne and
+		{def} {pop pop} ifelse
+	} forall
+	currentdict
+	end
+} bind def
+
+/compositefont { % ASCIIFontName EUCFontName RomanScale RomanOffset Rot(T/F) compositefont font
+    /RomanRotation exch def
+    /RomanOffset exch def
+    /RomanScale exch def
+    userdict /fixeucfont_dict known not {
+	userdict begin
+	    /fixeucfont_dict 2 dict begin
+		/UpperByteEncoding [
+		    16#00 1 16#20 { pop 0 } for
+		    16#21 1 16#28 { 16#20 sub } for
+		    16#29 1 16#2F { pop 0 } for
+		    16#30 1 16#74 { 16#27 sub } for
+		    16#75 1 16#FF { pop 0 } for
+		] def
+	        /LowerByteEncoding [
+		    16#00 1 16#A0 { pop /.notdef } for
+		    16#A1 1 16#FE { 16#80 sub 16 2 string cvrs
+				    (cXX) dup 1 4 -1 roll
+				    putinterval cvn } for
+		    /.notdef
+		] def
+		currentdict
+	    end def
+	end
+    } if
+    findfont dup /FontType get 0 eq {
+	14 dict begin
+	    %
+	    % 7+8 bit EUC font
+	    %
+	    12 dict begin
+		/EUCFont exch def
+		/FontInfo (7+8 bit EUC font) readonly def
+		/PaintType 0 def
+		/FontType 0 def
+		/FontMatrix matrix def
+		% /FontName
+		/Encoding fixeucfont_dict /UpperByteEncoding get def
+		/FMapType 2 def
+		EUCFont /WMode known
+		{ EUCFont /WMode get /WMode exch def }
+		{ /WMode 0 def } ifelse
+		/FDepVector [
+		    EUCFont /FDepVector get 0 get
+		    [ 16#21 1 16#28 {} for 16#30 1 16#74 {} for ]
+		    {
+			13 dict begin
+			    /EUCFont EUCFont def
+			    /UpperByte exch 16#80 add def	
+			    % /FontName
+			    /FontInfo (EUC lower byte font) readonly def
+			    /PaintType 0 def
+			    /FontType 3 def
+			    /FontMatrix matrix def
+			    /FontBBox {0 0 0 0} def
+			    /Encoding
+				fixeucfont_dict /LowerByteEncoding get def
+			    % /UniqueID
+			    % /WMode
+			    /BuildChar {
+				gsave
+				exch dup /EUCFont get setfont
+				/UpperByte get
+				2 string
+				dup 0 4 -1 roll put
+				dup 1 4 -1 roll put
+				dup stringwidth setcharwidth
+				0 0 moveto show
+				grestore
+			    } bind def
+			    currentdict
+			end
+			/lowerbytefont exch definefont
+		    } forall
+		] def
+		currentdict
+	    end
+	    /eucfont exch definefont
+	    exch
+	    findfont 1 copyfont dup begin
+		RomanRotation {
+			/FontMatrix FontMatrix
+			[ 0 RomanScale neg RomanScale 0 RomanOffset neg 0 ]
+			matrix concatmatrix def
+		}{
+			/FontMatrix FontMatrix
+			[ RomanScale 0 0 RomanScale 0 RomanOffset ] matrix concatmatrix
+			def
+			/CDevProc
+			    {pop pop pop pop 0 exch -1000 exch 2 div 880} def
+		} ifelse
+	    end
+	    /asciifont exch definefont
+	    exch
+	    /FDepVector [ 4 2 roll ] def
+	    /FontType 0 def
+	    /WMode 0 def
+	    /FMapType 4 def
+	    /FontMatrix matrix def
+	    /Encoding [0 1] def
+	    /FontBBox {0 0 0 0} def
+%	    /FontHeight 1.0 def % XXXX
+	    /FontHeight RomanScale 1.0 ge { RomanScale }{ 1.0 } ifelse def
+	    /Descent -0.3 def   % XXXX
+	    currentdict
+	end
+	/tmpfont exch definefont
+	pop
+	/tmpfont findfont
+    }{
+	pop findfont 0 copyfont
+    } ifelse
+} def	
+
+/slantfont {	% FontName slant-degree  slantfont  font'
+    exch findfont 1 copyfont begin
+    [ 1 0 4 -1 roll 1 0 0 ] FontMatrix exch matrix concatmatrix
+    /FontMatrix exch def
+    currentdict
+    end
+} def
+
+% Function print line number (<string> # -)
+/# {
+  gsave
+    sx cw mul neg 2 div 0 rmoveto
+    f# setfont
+    c-show
+  grestore
+} bind def
+
+% -------- Some routines to enlight plain b/w printings ---------
+
+% Underline
+% width --
+/dounderline {
+  currentpoint
+  gsave
+    moveto
+    0 currentfont /Descent get currentfontsize mul rmoveto
+    0 rlineto
+    stroke
+  grestore
+} bind def
+
+% Underline a string
+% string --
+/dounderlinestring {
+  stringwidth pop
+  dounderline
+} bind def
+
+/UL {
+  /ul exch store
+} bind def
+
+% Draw a box of WIDTH wrt current font
+% width --
+/dobox {
+  currentpoint
+  gsave
+    newpath
+    moveto
+    0 currentfont /Descent get currentfontsize mul rmoveto
+    dup 0 rlineto
+    0 currentfont /FontHeight get currentfontsize mul rlineto
+    neg 0 rlineto
+    closepath
+    stroke
+  grestore
+} bind def
+
+/BX {
+  /bx exch store
+} bind def
+
+% Box a string
+% string --
+/doboxstring {
+  stringwidth pop
+  dobox
+} bind def
+
+%
+% ------------- Color routines ---------------
+%
+/FG /setrgbcolor load def
+
+% Draw the background
+% width --
+/dobackground {
+  currentpoint
+  gsave
+    newpath
+    moveto
+    0 currentfont /Descent get currentfontsize mul rmoveto
+    dup 0 rlineto
+    0 currentfont /FontHeight get currentfontsize mul rlineto
+    neg 0 rlineto
+    closepath
+    bgcolor aload pop setrgbcolor
+    fill
+  grestore
+} bind def
+
+% Draw bg for a string
+% string --
+/dobackgroundstring {
+  stringwidth pop
+  dobackground
+} bind def
+
+
+/BG {
+  dup /bg exch store
+  { mark 4 1 roll ] /bgcolor exch store } if
+} bind def
+
+
+/Show {
+  bg { dup dobackgroundstring } if
+  ul { dup dounderlinestring } if
+  bx { dup doboxstring } if
+  show
+} bind def
+
+% Function T(ab), jumps to the n-th tabulation in the current line
+/T {
+  cw mul x0 add
+  bg { dup currentpoint pop sub dobackground } if
+  ul { dup currentpoint pop sub dounderline } if
+  bx { dup currentpoint pop sub dobox } if
+  y0 moveto
+} bind def
+
+% Function n: move to the next line
+/n {
+  /y0 y0 bfs sub store
+  x0 y0 moveto
+} bind def
+
+% Function N: show and move to the next line
+/N {
+  Show
+  /y0 y0 bfs sub store
+  x0 y0 moveto
+} bind def
+
+/S {
+  Show
+} bind def
+
+%%BeginResource: procset a2ps-a2ps-hdr 2.0 2
+%%Copyright: (c) 1988, 89, 90, 91, 92, 93 Miguel Santana
+%%Copyright: (c) 1995, 96, 97, 98 Akim Demaille, Miguel Santana
+% Function title: prints page header.
+% <ct> <rt> <lt> are passed as argument
+/title { 
+  % 1. Draw the background
+  x v get y v get moveto
+  gsave
+    0 th 2 div neg rmoveto 
+    th setlinewidth
+    0.95 setgray
+    pw 0 rlineto stroke
+  grestore
+  % 2. Border it
+  gsave
+    0.7 setlinewidth
+    pw 0 rlineto
+    0 th neg rlineto
+    pw neg 0 rlineto
+    closepath stroke
+  grestore
+  % stk: ct rt lt
+  x v get y v get th sub 1 add moveto
+%%IncludeResource: font Helvetica
+  fHelvetica fnfs 0.8 mul scalefont setfont
+  % 3. The left title
+  gsave
+    dup stringwidth pop fnfs 0.8 mul add exch % leave space took on stack
+    fnfs 0.8 mul hm rmoveto
+    show			% left title
+  grestore
+  exch
+  % stk: ct ltw rt
+  % 4. the right title
+  gsave
+    dup stringwidth pop fnfs 0.8 mul add exch % leave space took on stack
+    dup
+    pw exch stringwidth pop fnfs 0.8 mul add sub
+    hm
+    rmoveto
+    show			% right title
+  grestore
+  % stk: ct ltw rtw
+  % 5. the center title
+  gsave
+    pw 3 1 roll
+    % stk: ct pw ltw rtw
+    3 copy 
+    % Move to the center of the left room
+    sub add 2 div hm rmoveto
+    % What is the available space in here?
+    add sub fnfs 0.8 mul sub fnfs 0.8 mul sub
+    % stk: ct space_left
+%%IncludeResource: font Helvetica-Bold
+  fHelvetica-Bold fnfs scalefont setfont
+    cfshow
+  grestore
+} bind def
+
+% Function border: prints virtual page border
+/border { %def
+  gsave				% print four sides
+    0 setgray
+    x v get y v get moveto
+    0.7 setlinewidth		% of the square
+    pw 0 rlineto
+    0 ph neg rlineto
+    pw neg 0 rlineto
+    closepath stroke
+  grestore
+} bind def
+
+% Function water: prints a water mark in background
+/water { %def
+  gsave
+    scx scy moveto rotate
+%%IncludeResource: font Times-Bold
+  fTimes-Bold 100 scalefont setfont
+    .97 setgray
+    dup stringwidth pop 2 div neg -50 rmoveto
+    show
+  grestore
+} bind def
+
+% Function rhead: prints the right header
+/rhead {  %def
+  lx ly moveto
+  fHelvetica fnfs 0.8 mul scalefont setfont
+  l-show
+} bind def
+
+% Function footer (cf rf lf -> -)
+/footer {
+  fHelvetica fnfs 0.8 mul scalefont setfont
+  dx dy moveto
+  show
+
+  snx sny moveto
+  l-show
+  
+  fnx fny moveto
+  c-show
+} bind def
+%%EndResource
+%%BeginResource: procset a2ps-black+white-Prolog 2.0 1
+
+% Function T(ab), jumps to the n-th tabulation in the current line
+/T { 
+  cw mul x0 add y0 moveto
+} bind def
+
+% Function n: move to the next line
+/n { %def
+  /y0 y0 bfs sub store
+  x0 y0 moveto
+} bind def
+
+% Function N: show and move to the next line
+/N {
+  Show
+  /y0 y0 bfs sub store
+  x0 y0 moveto
+}  bind def
+
+/S {
+  Show
+} bind def
+
+/p {
+  false UL
+  false BX
+  fCourier bfs scalefont setfont
+  Show
+} bind def
+
+/sy {
+  false UL
+  false BX
+  fSymbol bfs scalefont setfont
+  Show
+} bind def
+
+/k {
+  false UL
+  false BX
+  fCourier-Oblique bfs scalefont setfont
+  Show
+} bind def
+
+/K {
+  false UL
+  false BX
+  fCourier-Bold bfs scalefont setfont
+  Show
+} bind def
+
+/c {
+  false UL
+  false BX
+  fCourier-Oblique bfs scalefont setfont
+  Show
+} bind def
+
+/C {
+  false UL
+  false BX
+  fCourier-BoldOblique bfs scalefont setfont
+  Show 
+} bind def
+
+/l {
+  false UL
+  false BX
+  fHelvetica bfs scalefont setfont
+  Show
+} bind def
+
+/L {
+  false UL
+  false BX
+  fHelvetica-Bold bfs scalefont setfont
+  Show 
+} bind def
+
+/str{
+  false UL
+  false BX
+  fTimes-Roman bfs scalefont setfont
+  Show
+} bind def
+
+/e{
+  false UL
+  true BX
+  fHelvetica-Bold bfs scalefont setfont
+  Show
+} bind def
+
+%%EndResource
+%%EndProlog
+%%BeginSetup
+%%IncludeResource: font Courier
+%%IncludeResource: font Courier-Oblique
+%%IncludeResource: font Courier-Bold
+%%IncludeResource: font Times-Roman
+%%IncludeResource: font Symbol
+%%IncludeResource: font Courier-BoldOblique
+%%BeginResource: encoding ISO-8859-1Encoding
+/ISO-8859-1Encoding [
+/.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef 
+/.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef 
+/.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef 
+/.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef 
+/space /exclam /quotedbl /numbersign /dollar /percent /ampersand /quoteright 
+/parenleft /parenright /asterisk /plus /comma /minus /period /slash 
+/zero /one /two /three /four /five /six /seven 
+/eight /nine /colon /semicolon /less /equal /greater /question 
+/at /A /B /C /D /E /F /G 
+/H /I /J /K /L /M /N /O 
+/P /Q /R /S /T /U /V /W 
+/X /Y /Z /bracketleft /backslash /bracketright /asciicircum /underscore 
+/quoteleft /a /b /c /d /e /f /g 
+/h /i /j /k /l /m /n /o 
+/p /q /r /s /t /u /v /w 
+/x /y /z /braceleft /bar /braceright /asciitilde /.notdef 
+/.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef 
+/.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef 
+/.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef 
+/.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef 
+/space /exclamdown /cent /sterling /currency /yen /brokenbar /section 
+/dieresis /copyright /ordfeminine /guillemotleft /logicalnot /hyphen /registered /macron 
+/degree /plusminus /twosuperior /threesuperior /acute /mu /paragraph /bullet 
+/cedilla /onesuperior /ordmasculine /guillemotright /onequarter /onehalf /threequarters /questiondown 
+/Agrave /Aacute /Acircumflex /Atilde /Adieresis /Aring /AE /Ccedilla 
+/Egrave /Eacute /Ecircumflex /Edieresis /Igrave /Iacute /Icircumflex /Idieresis 
+/Eth /Ntilde /Ograve /Oacute /Ocircumflex /Otilde /Odieresis /multiply 
+/Oslash /Ugrave /Uacute /Ucircumflex /Udieresis /Yacute /Thorn /germandbls 
+/agrave /aacute /acircumflex /atilde /adieresis /aring /ae /ccedilla 
+/egrave /eacute /ecircumflex /edieresis /igrave /iacute /icircumflex /idieresis 
+/eth /ntilde /ograve /oacute /ocircumflex /otilde /odieresis /divide 
+/oslash /ugrave /uacute /ucircumflex /udieresis /yacute /thorn /ydieresis 
+] def
+%%EndResource
+% Initialize page description variables.
+/sh 595 def
+/sw 842 def
+/llx 24 def
+/urx 818 def
+/ury 571 def
+/lly 24 def
+/#copies 1 def
+/th 15.000000 def
+/fnfs 11 def
+/bfs 8.005733 def
+/cw 4.803440 def
+
+% Dictionary for ISO-8859-1 support
+/iso1dict 8 dict begin
+  /fCourier ISO-8859-1Encoding /Courier reencode_font
+  /fCourier-Bold ISO-8859-1Encoding /Courier-Bold reencode_font
+  /fCourier-BoldOblique ISO-8859-1Encoding /Courier-BoldOblique reencode_font
+  /fCourier-Oblique ISO-8859-1Encoding /Courier-Oblique reencode_font
+  /fHelvetica ISO-8859-1Encoding /Helvetica reencode_font
+  /fHelvetica-Bold ISO-8859-1Encoding /Helvetica-Bold reencode_font
+  /fTimes-Bold ISO-8859-1Encoding /Times-Bold reencode_font
+  /fTimes-Roman ISO-8859-1Encoding /Times-Roman reencode_font
+currentdict end def
+/bgcolor [ 0 0 0 ] def
+/bg false def
+/ul false def
+/bx false def
+% The font for line numbering
+/f# /Helvetica findfont bfs .6 mul scalefont def
+/fSymbol /Symbol findfont def
+/hm fnfs 0.25 mul def
+/pw
+   cw 81.400000 mul
+def
+/ph
+   501.959430 th add
+def
+/pmw urx llx sub pw 2 mul sub 1 div def
+/pmh 0 def
+/v 0 def
+/x [
+  0
+  dup pmw add pw add
+] def
+/y [
+  pmh ph add 0 mul ph add
+  dup
+] def
+/scx sw 2 div def
+/scy sh 2 div def
+/snx urx def
+/sny lly 2 add def
+/dx llx def
+/dy sny def
+/fnx scx def
+/fny dy def
+/lx snx def
+/ly ury fnfs 0.8 mul sub def
+/sx 0 def
+/tab 8 def
+/x0 0 def
+/y0 0 def
+%%EndSetup
+
+%%Page: (1) 1
+%%BeginPageSetup
+/pagesave save def
+sh 0 translate 90 rotate
+%%EndPageSetup
+iso1dict begin
+gsave
+llx lly 12 add translate
+/v 0 store
+/x0 x v get 3.362408 add sx cw mul add store
+/y0 y v get bfs th add sub store
+x0 y0 moveto
+(c'est l'\303\251t\303\251) p n
+(utf8.txt) (Page 1/1) (14 oct 05 11:35) title
+border
+grestore
+(Imprim\351 par Aurelien Campeas) rhead
+(utf8.txt) (1/1) (lundi 24 octobre 2005) footer
+end % of iso1dict
+pagesave restore
+showpage
+
+%%Trailer
+end
+%%EOF



From aurelienc at berlios.de  Tue Oct 25 11:29:37 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Tue, 25 Oct 2005 11:29:37 +0200
Subject: [Maay-svncheckins] r222 - trunk/maay/test/data
Message-ID: <200510250929.j9P9Tbnp027773@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-25 11:29:27 +0200 (Tue, 25 Oct 2005)
New Revision: 222

Added:
   trunk/maay/test/data/utf8.pdf
Log:
A tiny title-less pdf file for tests.


Added: trunk/maay/test/data/utf8.pdf
===================================================================
(Binary files differ)


Property changes on: trunk/maay/test/data/utf8.pdf
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream



From aurelienc at berlios.de  Tue Oct 25 11:30:48 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Tue, 25 Oct 2005 11:30:48 +0200
Subject: [Maay-svncheckins] r223 - trunk/maay
Message-ID: <200510250930.j9P9Umew027860@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-25 11:30:45 +0200 (Tue, 25 Oct 2005)
New Revision: 223

Modified:
   trunk/maay/server.py
Log:
Two typos and two prints.


Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-25 09:29:27 UTC (rev 222)
+++ trunk/maay/server.py	2005-10-25 09:30:45 UTC (rev 223)
@@ -120,7 +120,7 @@
     bodyFactory = loaders.stan(
         tags.html[
             tags.head[tags.title["Maay Login Page",],
-                      tags.link(rel='stylesheet', type='text/css', href='maaycss'),
+                      tags.link(rel='stylesheet', type='text/css', href='maay.css'),
                       tags.link(rel='shortcut icon', href='images/maay.ico'),
                       ],
             
@@ -277,6 +277,7 @@
     def createUserSession(self, avatarId, querier):
         """associate a querier to an avatarId.
         Use avatarId=None for the internal private database connection"""
+        print "Maay Realm : creating session for", avatarId
         self._sessions[avatarId] = querier
 
 
@@ -297,7 +298,7 @@
                     print "Building search form with", avatarId
                     resc = SearchForm(avatarId, querier)
                 return inevow.IResource, resc, resc.logout
-            # if we wera asked for a querier
+            # if we wer asked for a querier
             elif iface is IQuerier:
                 querier = self._getQuerier(avatarId)
                 if querier is None:
@@ -308,9 +309,10 @@
     def _getQuerier(self, avatarId):
         try:
             querier = self._sessions[avatarId]
-            print "Hit cache !"
+            print "Querier for", avatarId, "was in the cache. Good."
         except KeyError:
-            print "Ouch ! What am I supposed to do ?!!"
+            print "No querier in cache far", avatarId, \
+                  ". What are we supposed to do ?"
             querier = None
         return querier
 



From aurelienc at berlios.de  Tue Oct 25 17:08:22 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Tue, 25 Oct 2005 17:08:22 +0200
Subject: [Maay-svncheckins] r224 - in trunk/maay: . data data/images
Message-ID: <200510251508.j9PF8MWZ030574@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-25 17:08:18 +0200 (Tue, 25 Oct 2005)
New Revision: 224

Modified:
   trunk/maay/data/images/smallmaay.png
   trunk/maay/data/resultpage.html
   trunk/maay/data/searchform.html
   trunk/maay/data/skeleton.html
   trunk/maay/rpc.py
   trunk/maay/server.py
Log:
This set of fixes tries to provide the "autologin" feature with the less possible modifications.
It is surely not the best way. 
- changes to server.py are 90% commenting out now unused code, adding some print statements and changing slightly the init procedure of the portal
- html templates have parts of them accordingly commented out
- something insignificant (and a question) in rpc.py


Modified: trunk/maay/data/images/smallmaay.png
===================================================================
(Binary files differ)

Modified: trunk/maay/data/resultpage.html
===================================================================
--- trunk/maay/data/resultpage.html	2005-10-25 09:30:45 UTC (rev 223)
+++ trunk/maay/data/resultpage.html	2005-10-25 15:08:18 UTC (rev 224)
@@ -1,7 +1,7 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
 <nevow:invisible xmlns="http://www.w3.org/1999/xhtml" lang="en" xmlns:nevow="http://nevow.com/ns/nevow/0.1">
-  <a nevow:render="loginurl"><nevow:attr name="href"><nevow:slot name="loginurl" /></nevow:attr><nevow:slot name="actionlabel" /></a>
+  <!-- <a nevow:render="loginurl"><nevow:attr name="href"><nevow:slot name="loginurl" /></nevow:attr><nevow:slot name="actionlabel" /></a> -->
   <div class="reSearch">
     <img src="images/smallmaay.png" />
     <form action="search" accept-charset="utf-8">

Modified: trunk/maay/data/searchform.html
===================================================================
--- trunk/maay/data/searchform.html	2005-10-25 09:30:45 UTC (rev 223)
+++ trunk/maay/data/searchform.html	2005-10-25 15:08:18 UTC (rev 224)
@@ -1,19 +1,25 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
 
-<nevow:invisible xmlns="http://www.w3.org/1999/xhtml" lang="en" xmlns:nevow="http://nevow.com/ns/nevow/0.1">
-  <a nevow:render="loginurl"><nevow:attr name="href"><nevow:slot name="loginurl" /></nevow:attr><nevow:slot name="actionlabel" /></a>
-  <table class="searchHome">
-    <tr>
-      <td><img src="images/maay.png" /></td>
-    </tr>
-    <tr>
-      <td>
-	<form action="search" accept-charset="utf-8">
-	  <input type="text" name="words" value="" />
-	  <input type="submit" class="searchButton" value="search" />
-	</form>
-      </td>
-    </tr>
-  </table>
-</nevow:invisible>
+  <nevow:invisible xmlns="http://www.w3.org/1999/xhtml" lang="en" xmlns:nevow="http://nevow.com/ns/nevow/0.1">
+    <!-- <a nevow:render="loginurl"> -->
+<!--       <nevow:attr name="href"> -->
+<!--         <nevow:slot name="loginurl" /> -->
+<!--       </nevow:attr> -->
+<!--       <nevow:slot name="actionlabel" /> -->
+<!--     </a> -->
+    <table class="searchHome">
+      <tr>
+        <td><img src="images/maay.png" /></td>
+      </tr>
+      <tr>
+        <td>
+          <form action="search" accept-charset="utf-8">
+            <input type="text" name="words" value="" />
+              <input type="submit" class="searchButton" value="search" />
+          </form>
+        </td>
+      </tr>
+    </table>
+  </nevow:invisible>
+  
\ No newline at end of file

Modified: trunk/maay/data/skeleton.html
===================================================================
--- trunk/maay/data/skeleton.html	2005-10-25 09:30:45 UTC (rev 223)
+++ trunk/maay/data/skeleton.html	2005-10-25 15:08:18 UTC (rev 224)
@@ -2,17 +2,18 @@
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
 <html xmlns="http://www.w3.org/1999/xhtml" lang="en" xmlns:nevow="http://nevow.com/ns/nevow/0.1">
   <head>
-    <title>Search Form</title>
+    <title>Maay Search Form</title>
     <link rel="stylesheet" type="text/css" href="maaycss"/>
-    <link rel="shortcut icon" href="images/maay.ico" />
+      <link rel="shortcut icon" href="images/maay.ico" />
   </head>
  
   <body>
     <nevow:invisible nevow:macro="body" />
-    <hr />
-    <a href="http://maay.netofpeers.net/">Maay Home page</a> <a href="http://developer.berlios.de/projects/maay/">
-<img src="http://developer.berlios.de/bslogo.php?group_id=0"
-    width="124" height="32" border="0" alt="BerliOS Logo" /></a>
-
-    </body>  
+      <hr />
+        <a href="http://maay.netofpeers.net/">Maay Home page</a> 
+        <a href="http://developer.berlios.de/projects/maay/">
+          <img src="http://developer.berlios.de/images/berliOS_logo.png"
+            width="124" height="32" border="0" alt="BerliOS Logo" />
+        </a>
+  </body>  
 </html>

Modified: trunk/maay/rpc.py
===================================================================
--- trunk/maay/rpc.py	2005-10-25 09:30:45 UTC (rev 223)
+++ trunk/maay/rpc.py	2005-10-25 15:08:18 UTC (rev 224)
@@ -39,9 +39,11 @@
 
     def __init__(self, nodeId, portal):
         XMLRPC.__init__(self)
+        print "init of MaayRPCServer, nodeId = ", nodeId
+        assert nodeId == portal.config.get_node_id ()
         self._sessions = {}
         self.portal = portal
-        self.nodeId = portal.config.get_node_id()
+        self.nodeId = portal.config.get_node_id() # hmmm ...
         self._sessions[ANONYMOUS_AVATARID] = portal.anonymousQuerier
         self._p2pQuerier = P2pQuerier(nodeId, portal.anonymousQuerier)
         

Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-25 09:30:45 UTC (rev 223)
+++ trunk/maay/server.py	2005-10-25 15:08:18 UTC (rev 224)
@@ -64,6 +64,8 @@
 from maay import registrationclient
 from maay.query import Query
 
+ANONYMOUS_AVATARID = 'maay' # it's only a matter of definition after all ...
+
 class MaayPage(rend.Page):
     docFactory = loaders.xmlfile(get_path_of('skeleton.html'))
     child_maaycss = static.File(get_path_of('maay.css'))
@@ -73,22 +75,23 @@
         rend.Page.__init__(self)
         self.maayId = maayId
 
-    def render_loginurl(self, context, data):
-        url = URL.fromContext(context)
-        # store current URL into  'goThereAfter' to be able to return here
-        # after login
-        if self.maayId != ANONYMOUS_AVATARID:
-            goThereAfter = URL(url.scheme, url.netloc,
-                               ['logout'] + url.pathList())
-            context.fillSlots('actionlabel', 'Logout')
-        else:
-            goThereAfter = URL(url.scheme, url.netloc,
-                               ['login'] + url.pathList())
-            context.fillSlots('actionlabel', 'Login')            
-        for param, value in url.queryList():
-            goThereAfter = goThereAfter.add(param, value)
-        context.fillSlots('loginurl', str(goThereAfter))
-        return context.tag
+#     def render_loginurl(self, context, data):
+#         url = URL.fromContext(context)
+#         store current URL into  'goThereAfter' to be able to return here
+#         after login
+#         goThereAfter = URL(url.scheme, url.netloc, url.pathList())
+#         if self.maayId != ANONYMOUS_AVATARID:
+#            goThereAfter = URL(url.scheme, url.netloc,
+#                               ['logout'] + url.pathList())
+#            context.fillSlots('actionlabel', 'Logout')
+#         else:
+#            goThereAfter = URL(url.scheme, url.netloc,
+#                               ['login'] + url.pathList())
+#            context.fillSlots('actionlabel', 'Login')            
+#         for param, value in url.queryList():
+#            goThereAfter = goThereAfter.add(param, value)
+#         context.fillSlots('loginurl', str(goThereAfter))
+#         return context.tag
 
     def macro_body(self, context):
         return self.bodyFactory
@@ -102,50 +105,51 @@
         req.getSession().expire()
         req.redirect('/' + guard.LOGOUT_AVATAR)
 
-class LoginForm(MaayPage):
-    """a basic login form. This page is rendered until the user
-    is logged.
-    """
-    # addSlash = True
+# class LoginForm(MaayPage):
+#     """a basic login form. This page is rendered until the user
+#     is logged.
+#     """
+#     # addSlash = True
 
-    def path(self, context, data):
-        here = URL.fromContext(context)
-        # transform /login/somePathAndQuery into /__login__/somePathAndQuery
-        # to benefit from nevow.guard redirection magic
-        pathList = ['__login__'] + here.pathList()[1:]
-        goThereAfter = URL(here.scheme, here.netloc,
-                           pathList, here.queryList())
-        return str(goThereAfter)
+#     def path(self, context, data):
+#         here = URL.fromContext(context)
+#         # transform /login/somePathAndQuery into /__login__/somePathAndQuery
+#         # to benefit from nevow.guard redirection magic
+#         pathList = ['__login__'] + here.pathList()[1:]
+#         goThereAfter = URL(here.scheme, here.netloc,
+#                            pathList, here.queryList())
+#         return str(goThereAfter)
 
-    bodyFactory = loaders.stan(
-        tags.html[
-            tags.head[tags.title["Maay Login Page",],
-                      tags.link(rel='stylesheet', type='text/css', href='maay.css'),
-                      tags.link(rel='shortcut icon', href='images/maay.ico'),
-                      ],
+#     bodyFactory = loaders.stan(
+#         tags.html[
+#             tags.head[tags.title["Maay Login Page",],
+#                       tags.link(rel='stylesheet', type='text/css', href='maay.css'),
+#                       tags.link(rel='shortcut icon', href='images/maay.ico'),
+#                       ],
             
-            tags.body[
-                # tags.form(action='/'+guard.LOGIN_AVATAR, render=path, method='post')[
-                tags.form(action=path, method='post')[
-                    tags.table(_class="loginTable")[
-                        tags.tr[
-                            tags.td[ "Username:" ],
-                            tags.td[ tags.input(type='text', name='username') ],
-                            ],
-                        tags.tr[
-                            tags.td[ "Password:" ],
-                            tags.td[ tags.input(type='password', name='password') ],
-                            ]
-                        ],
-                    tags.input(type='submit'),
-                    tags.p,
-                    ]
-                ]
-            ]
-        )
+#             tags.body[
+#                 # tags.form(action='/'+guard.LOGIN_AVATAR, render=path, method='post')[
+#                 tags.form(action=path, method='post')[
+#                     tags.table(_class="loginTable")[
+#                         tags.tr[
+#                             tags.td[ "Username :" ],
+#                             tags.td[ tags.input(type='text', name='username') ],
+#                             ],
+#                         tags.tr[
+#                             tags.td[ "Password :" ],
+#                             tags.td[ tags.input(type='password', name='password') ],
+#                             ]
+#                         ],
+#                     tags.input(type='submit'),
+#                     tags.p,
+#                     ]
+#                 ]
+#             ]
+#         )
 
-    def childFactory(self, context, segments):
-        return LoginForm()
+#     def childFactory(self, context, segments):
+#         print " child factory"
+#         return LoginForm()
 
 class PeersList(MaayPage):
     """display list of registered peers"""
@@ -295,7 +299,7 @@
                 if querier is None:
                     return inevow.IResource, LoginForm(), lambda: None
                 else:
-                    print "Building search form with", avatarId
+                    print "Building search form for", avatarId
                     resc = SearchForm(avatarId, querier)
                 return inevow.IResource, resc, resc.logout
             # if we wer asked for a querier
@@ -309,9 +313,9 @@
     def _getQuerier(self, avatarId):
         try:
             querier = self._sessions[avatarId]
-            print "Querier for", avatarId, "was in the cache. Good."
+            print "Querier of type", type(querier), "for", avatarId, "was in the cache. Good."
         except KeyError:
-            print "No querier in cache far", avatarId, \
+            print "No querier in cache for", str(avatarId)+ \
                   ". What are we supposed to do ?"
             querier = None
         return querier
@@ -320,6 +324,7 @@
 class MaayPortal(object, portal.Portal):
     """Portal for Maay authentication system"""
     def __init__(self, webappConfig):
+        print "Portal creation"
         realm = MaayRealm()
         checker = DBAuthChecker(realm, webappConfig.db_host,
                                 webappConfig.db_name)
@@ -329,10 +334,19 @@
         self.config = webappConfig
         # Create default anonymous querier, based on local configuration
         try:
-            anonymousQuerier = AnonymousQuerier(host=webappConfig.db_host,
-                                                database=webappConfig.db_name,
-                                                user=webappConfig.user,
-                                                password=webappConfig.password)
+            print "Credentials : "
+            print "  - host", webappConfig.db_host
+            print "  - db", webappConfig.db_name
+            print "  - user", webappConfig.user
+            print "  - pass", webappConfig.password
+            anonymousQuerier = MaayQuerier(host=webappConfig.db_host,
+                                           database=webappConfig.db_name,
+                                           user=webappConfig.user,
+                                           password=webappConfig.password)
+            #anonymousQuerier = AnonymousQuerier(host=webappConfig.db_host,
+            #                                    database=webappConfig.db_name,
+            #                                    user=webappConfig.user,
+            #                                    password=webappConfig.password)
         except Exception, exc:
             # unable to create an anonymous querier
             print "***"
@@ -389,11 +403,12 @@
         self.dbname = dbname
     
     def requestAvatarId(self, creds):
+        print "Checking credentials for DB access"
         try:
             querier = MaayQuerier(host=self.dbhost, database=self.dbname,
                                   user=creds.username, password=creds.password)
         except MaayAuthenticationError:
-            print "Got Authentication Error !"
+            print "DBAuthChecker : Authentication Error"
             return failure.Failure(error.UnauthorizedLogin())
         self.realm.createUserSession(creds.username, querier)
         return defer.succeed(creds.username)
@@ -565,7 +580,7 @@
                                           maayPortal))
     reactor.listenTCP(webappConfig.webserver_port, website)
     reactor.listenTCP(webappConfig.rpcserver_port, rpcserver)
-    print "Go !"
+    print "In the mainloop ..."
     reactor.run()
 
 if __name__ == '__main__':



From aurelienc at berlios.de  Wed Oct 26 11:55:44 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Wed, 26 Oct 2005 11:55:44 +0200
Subject: [Maay-svncheckins] r225 - trunk/maay
Message-ID: <200510260955.j9Q9tiG6012939@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-26 11:55:43 +0200 (Wed, 26 Oct 2005)
New Revision: 225

Modified:
   trunk/maay/indexer.py
Log:
Minor cleanups.


Modified: trunk/maay/indexer.py
===================================================================
--- trunk/maay/indexer.py	2005-10-25 15:08:18 UTC (rev 224)
+++ trunk/maay/indexer.py	2005-10-26 09:55:43 UTC (rev 225)
@@ -38,30 +38,30 @@
 from maay.querier import MaayAuthenticationError
 from maay.texttool import removeControlChar
 
-# grabbed from nevow, but it doesn't work until you test it interactively ;-)
-mimetypes.types_map.update( 
-    {
-            '.conf':  'text/plain',
-            '.diff':  'text/plain',
-            '.exe':   'application/x-executable',
-            '.flac':  'audio/x-flac',
-            '.java':  'text/plain',
-            '.ogg':   'application/ogg',
-            '.oz':    'text/x-oz',
-            '.swf':   'application/x-shockwave-flash',
-            '.tgz':   'application/x-gtar',
-            '.wml':   'text/vnd.wap.wml',
-            '.xul':   'application/vnd.mozilla.xul+xml',
-            '.py':    'text/plain',
-            '.patch': 'text/plain',
-            '.c' :    'text/plain',
-            '.h':     'text/plain',
-            '.C':     'text/plain',
-            '.cpp':   'text/plain',
-            '.cc':    'text/plain',
-            '.c++':   'text/plain',
-        }
-    )
+# grabbed from nevow, but useless
+# mimetypes.types_map.update( 
+#     {
+#             '.conf':  'text/plain',
+#             '.diff':  'text/plain',
+#             '.exe':   'application/x-executable',
+#             '.flac':  'audio/x-flac',
+#             '.java':  'text/plain',
+#             '.ogg':   'application/ogg',
+#             '.oz':    'text/x-oz',
+#             '.swf':   'application/x-shockwave-flash',
+#             '.tgz':   'application/x-gtar',
+#             '.wml':   'text/vnd.wap.wml',
+#             '.xul':   'application/vnd.mozilla.xul+xml',
+#             '.py':    'text/plain',
+#             '.patch': 'text/plain',
+#             '.c' :    'text/plain',
+#             '.h':     'text/plain',
+#             '.C':     'text/plain',
+#             '.cpp':   'text/plain',
+#             '.cc':    'text/plain',
+#             '.c++':   'text/plain',
+#         }
+#     )
 
 
 def makeDocumentId(filename):
@@ -92,6 +92,7 @@
         password = self.indexerConfig.password
         host = self.indexerConfig.host
         port = self.indexerConfig.port
+        print "Indexer connecting to server %s:%s" % (host, port)
         self.serverProxy = ServerProxy('http://%s:%s' % (host, port),
                                        allow_none=True,
                                        encoding='utf-8')
@@ -317,22 +318,9 @@
 #     more parametrable run. For now it's just a convenience thing.
 
 def purge():
-    indexerConfig = IndexerConfiguration()
-    indexerConfig.load()
-    try:
-        try:
-            indexer = Indexer(indexerConfig)
-        except MaayAuthenticationError, exc:
-            print "AuthenticationError:", exc
-            sys.exit(1)
-        indexer._purgeEverything()
-    except socket.error, exc:
-        print "Cannot contact server:", exc
-        print "Check that the server is running on %s:%s" % \
-              (indexerConfig.host, indexerConfig.port)
-        sys.exit(1)
+    run(purge=True)
 
-def run():
+def run(purge=False):
     indexerConfig = IndexerConfiguration()
     indexerConfig.load()
     try:
@@ -341,7 +329,10 @@
         except MaayAuthenticationError, exc:
             print "AuthenticationError:", exc
             sys.exit(1)
-        indexer.start()
+        if not purge:
+            indexer.start()
+        else:
+            indexer._purgeEverything()
     except socket.error, exc:
         print "Cannot contact server:", exc
         print "Check that the server is running on %s:%s" % \
@@ -351,4 +342,4 @@
 if __name__ == '__main__':
     run()
 
-#print "PYTHON", mimetypes.types_map['.py']
+



From aurelienc at berlios.de  Wed Oct 26 11:56:46 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Wed, 26 Oct 2005 11:56:46 +0200
Subject: [Maay-svncheckins] r226 - trunk/maay/test
Message-ID: <200510260956.j9Q9uk7c013197@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-26 11:56:44 +0200 (Wed, 26 Oct 2005)
New Revision: 226

Modified:
   trunk/maay/test/test_indexer.py
Log:
Cleanup according to last rev of indexer.


Modified: trunk/maay/test/test_indexer.py
===================================================================
--- trunk/maay/test/test_indexer.py	2005-10-26 09:55:43 UTC (rev 225)
+++ trunk/maay/test/test_indexer.py	2005-10-26 09:56:44 UTC (rev 226)
@@ -31,11 +31,11 @@
         self.assertEquals(makeDocumentId(filename), sha.sha(data).hexdigest())
         os.remove(filename)
 
-    def testMimetypeUpdate(self):
-        #XXX: This may need to go away since we provide converters for python
-        # and the type_map update in indexer is not sufficient to catch python files
-        # as text files
-        self.assertEquals('text/plain', mimetypes.types_map['.py'])
+#     def testMimetypeUpdate(self):
+#         #XXX: This may need to go away since we provide converters for python
+#         # and the type_map update in indexer is not sufficient to catch python files
+#         # as text files
+#         self.assertEquals('text/plain', mimetypes.types_map['.py'])
         
         
 



From aurelienc at berlios.de  Wed Oct 26 12:51:18 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Wed, 26 Oct 2005 12:51:18 +0200
Subject: [Maay-svncheckins] r227 - trunk/maay
Message-ID: <200510261051.j9QApI7A002742@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-26 12:51:08 +0200 (Wed, 26 Oct 2005)
New Revision: 227

Modified:
   trunk/maay/indexer.py
Log:
End of cleanups.
--Cett ligne, et les suivantes ci-dessous, seront ignor?\195?\169es--

M    indexer.py


Modified: trunk/maay/indexer.py
===================================================================
--- trunk/maay/indexer.py	2005-10-26 09:56:44 UTC (rev 226)
+++ trunk/maay/indexer.py	2005-10-26 10:51:08 UTC (rev 227)
@@ -314,9 +314,6 @@
         Configuration.__init__(self, name="Indexer")
 
 
-# XXX the purge starter should be factored back into a slightly
-#     more parametrable run. For now it's just a convenience thing.
-
 def purge():
     run(purge=True)
 



From aurelienc at berlios.de  Wed Oct 26 12:56:00 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Wed, 26 Oct 2005 12:56:00 +0200
Subject: [Maay-svncheckins] r228 - trunk/maay
Message-ID: <200510261056.j9QAu0nE005352@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-26 12:55:47 +0200 (Wed, 26 Oct 2005)
New Revision: 228

Modified:
   trunk/maay/querier.py
   trunk/maay/rpc.py
   trunk/maay/server.py
Log:
- fix for the leak leading to mysql threads exhaustion (pb. was DBAuthChecker not recycling queriers)
- fixes to the maay portal (in the future it may prove useful to unfix it :)


Modified: trunk/maay/querier.py
===================================================================
--- trunk/maay/querier.py	2005-10-26 10:51:08 UTC (rev 227)
+++ trunk/maay/querier.py	2005-10-26 10:55:47 UTC (rev 228)
@@ -405,7 +405,7 @@
         node.last_seen_time = int(time.time())
         node.commit(cursor, update=True)
         cursor.close()
-        self._cnx.commit()        
+        self._cnx.commit()
         
     def _createDocument(self, cursor, content_hash, title, text, fileSize,
                         lastModifiedOn, filename, mime_type, state):

Modified: trunk/maay/rpc.py
===================================================================
--- trunk/maay/rpc.py	2005-10-26 10:51:08 UTC (rev 227)
+++ trunk/maay/rpc.py	2005-10-26 10:55:47 UTC (rev 228)
@@ -44,8 +44,8 @@
         self._sessions = {}
         self.portal = portal
         self.nodeId = portal.config.get_node_id() # hmmm ...
-        self._sessions[ANONYMOUS_AVATARID] = portal.anonymousQuerier
-        self._p2pQuerier = P2pQuerier(nodeId, portal.anonymousQuerier)
+        self._sessions[ANONYMOUS_AVATARID] = portal.webQuerier
+        self._p2pQuerier = P2pQuerier(nodeId, portal.webQuerier)
         
     def _attachUser(self, (interface, querier, logout), username, password):
         if interface is not IQuerier or querier is None:

Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-26 10:51:08 UTC (rev 227)
+++ trunk/maay/server.py	2005-10-26 10:55:47 UTC (rev 228)
@@ -56,7 +56,7 @@
 
 from logilab.common.textutils import normalize_text
 
-from maay.querier import MaayQuerier, IQuerier, AnonymousQuerier, \
+from maay.querier import MaayQuerier, IQuerier, \
      MaayAuthenticationError, ANONYMOUS_AVATARID
 from maay.rpc import MaayRPCServer
 from maay.configuration import get_path_of, Configuration
@@ -281,7 +281,8 @@
     def createUserSession(self, avatarId, querier):
         """associate a querier to an avatarId.
         Use avatarId=None for the internal private database connection"""
-        print "Maay Realm : creating session for", avatarId
+        print "Maay Realm : creating session for avatar", avatarId,
+        print "with a", type(querier), "querier."
         self._sessions[avatarId] = querier
 
 
@@ -313,7 +314,8 @@
     def _getQuerier(self, avatarId):
         try:
             querier = self._sessions[avatarId]
-            print "Querier of type", type(querier), "for", avatarId, "was in the cache. Good."
+            print "Querier of type", type(querier), "for avatar",
+            print avatarId, "was in the cache. Good."
         except KeyError:
             print "No querier in cache for", str(avatarId)+ \
                   ". What are we supposed to do ?"
@@ -332,49 +334,45 @@
         self.anonymousChecker = MaayAnonymousChecker()
         self.registerChecker(self.anonymousChecker, IAnonymous)
         self.config = webappConfig
-        # Create default anonymous querier, based on local configuration
+        # Create default web querier, based on local configuration
         try:
             print "Credentials : "
             print "  - host", webappConfig.db_host
             print "  - db", webappConfig.db_name
             print "  - user", webappConfig.user
             print "  - pass", webappConfig.password
-            anonymousQuerier = MaayQuerier(host=webappConfig.db_host,
-                                           database=webappConfig.db_name,
-                                           user=webappConfig.user,
-                                           password=webappConfig.password)
-            #anonymousQuerier = AnonymousQuerier(host=webappConfig.db_host,
-            #                                    database=webappConfig.db_name,
-            #                                    user=webappConfig.user,
-            #                                    password=webappConfig.password)
+            webQuerier = MaayQuerier(host=webappConfig.db_host,
+                                     database=webappConfig.db_name,
+                                     user=webappConfig.user,
+                                     password=webappConfig.password)
         except Exception, exc:
-            # unable to create an anonymous querier
+            # unable to create a web querier
             print "***"
-            print "*** Could not create anonymous querier"
+            print "*** Could not create web querier"
             print "*** Got exception", exc
-            print "*** This will disable the P2P functionalities"
-            print "*** and force the user to login for local search"
+            print "*** This may hurt in unexpected ways"
             print "***"
-            anonymousQuerier = None
+            webQuerier = None
         else:
-            realm.createUserSession(ANONYMOUS_AVATARID, anonymousQuerier)
-            anonymousQuerier.registerNode(self.config.get_node_id(),
-                                          ip=socket.gethostbyname(socket.gethostname()),
-                                          port=webappConfig.rpcserver_port,
-                                          bandwidth=webappConfig.bandwidth)
-        self.anonymousQuerier = anonymousQuerier
+            realm.createUserSession(ANONYMOUS_AVATARID, webQuerier)
+            webQuerier.registerNode(self.config.get_node_id(),
+                                    ip=socket.gethostbyname(socket.gethostname()),
+                                    port=webappConfig.rpcserver_port,
+                                    bandwidth=webappConfig.bandwidth)
+        self.webQuerier = webQuerier
 
-    def getAnonymousQuerier(self):
-        return getattr(self, '_anonymousQuerier', None)
+    def getWebQuerier(self):
+        return getattr(self, '_webQuerier', None)
 
-    def setAnonymousQuerier(self, value):
+    def setWebQuerier(self, value):
         """used to set 'anonymousAllowed' flag in anonymous checker"""
+        #XXX: now, check this seriously
         if value is not None:
             self.anonymousChecker.anonymousAllowed = True
-        self._anonymousQuerier = value
+        self._webQuerier = value
 
-    anonymousQuerier = property(getAnonymousQuerier, setAnonymousQuerier,
-                                doc="anonymous querier")
+    webQuerier = property(getWebQuerier, setWebQuerier,
+                          doc="web querier")
 
 
 class MaayAnonymousChecker(AllowAnonymousAccess):
@@ -398,19 +396,23 @@
     credentialInterfaces = (IUsernamePassword,)
     
     def __init__(self, realm, dbhost, dbname):
+        print "DBAuthChecker inits in realm", realm, "dbhost", dbhost,
+        print "and dbname", str(dbname)+"."
         self.realm = realm
         self.dbhost = dbhost
         self.dbname = dbname
+        self.querier = None # reusing the same querier has some benefits :)
     
     def requestAvatarId(self, creds):
-        print "Checking credentials for DB access"
+        print "DBAuthChecker : checking credentials for DB access"
         try:
-            querier = MaayQuerier(host=self.dbhost, database=self.dbname,
-                                  user=creds.username, password=creds.password)
+            if not self.querier:
+                self.querier = MaayQuerier(host=self.dbhost, database=self.dbname,
+                                        user=creds.username, password=creds.password)
         except MaayAuthenticationError:
             print "DBAuthChecker : Authentication Error"
             return failure.Failure(error.UnauthorizedLogin())
-        self.realm.createUserSession(creds.username, querier)
+        self.realm.createUserSession(creds.username, self.querier)
         return defer.succeed(creds.username)
 
 
@@ -569,7 +571,7 @@
     website.remember(webappConfig, IWebappConfiguration)
     registrationclient.login(reactor,
                              webappConfig.registration_host, webappConfig.registration_port,
-                             maayPortal.anonymousQuerier,
+                             maayPortal.webQuerier,
                              webappConfig.get_node_id(),
                              socket.gethostbyname(socket.gethostname()),
                              webappConfig.rpcserver_port,



From adimasci at berlios.de  Wed Oct 26 14:21:42 2005
From: adimasci at berlios.de (Adrien Di Mascio at BerliOS)
Date: Wed, 26 Oct 2005 14:21:42 +0200
Subject: [Maay-svncheckins] r229 - trunk/maay
Message-ID: <200510261221.j9QCLguo013160@sheep.berlios.de>

Author: adimasci
Date: 2005-10-26 14:21:23 +0200 (Wed, 26 Oct 2005)
New Revision: 229

Modified:
   trunk/maay/server.py
Log:
keep a cache of creds/queriers instead of keeping a single
querier in cache, because we don't want to provide the same
querier to 2 different users ! (Even if, for our current
use cases, it can't happen)



Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-26 10:55:47 UTC (rev 228)
+++ trunk/maay/server.py	2005-10-26 12:21:23 UTC (rev 229)
@@ -401,18 +401,23 @@
         self.realm = realm
         self.dbhost = dbhost
         self.dbname = dbname
-        self.querier = None # reusing the same querier has some benefits :)
+	# Keeping a cache of queriers reusing the same has some benefits :)
+        self.querierCache = {}
     
     def requestAvatarId(self, creds):
         print "DBAuthChecker : checking credentials for DB access"
         try:
-            if not self.querier:
-                self.querier = MaayQuerier(host=self.dbhost, database=self.dbname,
-                                        user=creds.username, password=creds.password)
+	    try:
+		querier = self.querierCache[creds]
+	    except KeyError:
+		querier = MaayQuerier(host=self.dbhost, database=self.dbname,
+				      user=creds.username,
+				      password=creds.password)
+		self.querierCache[creds] = querier
         except MaayAuthenticationError:
             print "DBAuthChecker : Authentication Error"
             return failure.Failure(error.UnauthorizedLogin())
-        self.realm.createUserSession(creds.username, self.querier)
+        self.realm.createUserSession(creds.username, querier)
         return defer.succeed(creds.username)
 
 



From aurelien.campeas at logilab.fr  Wed Oct 26 19:17:12 2005
From: aurelien.campeas at logilab.fr (=?iso-8859-1?Q?Aur=E9lien_Camp=E9as?=)
Date: Wed, 26 Oct 2005 19:17:12 +0200
Subject: [Maay-svncheckins] r229 - trunk/maay
In-Reply-To: <200510261221.j9QCLguo013160@sheep.berlios.de>
References: <200510261221.j9QCLguo013160@sheep.berlios.de>
Message-ID: <20051026171712.GA6814@logilab.fr>

Sorry, but this reintroduces the bug. Probably because id(cred) will
be different each time even if the content is the same. I'll look at a
whay to preserve your cache and get rid of the leak anyway, if possible.


On Wed, Oct 26, 2005 at 02:21:42PM +0200, Adrien Di Mascio at BerliOS wrote:
> Author: adimasci
> Date: 2005-10-26 14:21:23 +0200 (Wed, 26 Oct 2005)
> New Revision: 229
> 
> Modified:
>    trunk/maay/server.py
> Log:
> keep a cache of creds/queriers instead of keeping a single
> querier in cache, because we don't want to provide the same
> querier to 2 different users ! (Even if, for our current
> use cases, it can't happen)
> 
> 
> 
> Modified: trunk/maay/server.py
> ===================================================================
> --- trunk/maay/server.py	2005-10-26 10:55:47 UTC (rev 228)
> +++ trunk/maay/server.py	2005-10-26 12:21:23 UTC (rev 229)
> @@ -401,18 +401,23 @@
>          self.realm = realm
>          self.dbhost = dbhost
>          self.dbname = dbname
> -        self.querier = None # reusing the same querier has some benefits :)
> +	# Keeping a cache of queriers reusing the same has some benefits :)
> +        self.querierCache = {}
>      
>      def requestAvatarId(self, creds):
>          print "DBAuthChecker : checking credentials for DB access"
>          try:
> -            if not self.querier:
> -                self.querier = MaayQuerier(host=self.dbhost, database=self.dbname,
> -                                        user=creds.username, password=creds.password)
> +	    try:
> +		querier = self.querierCache[creds]
> +	    except KeyError:
> +		querier = MaayQuerier(host=self.dbhost, database=self.dbname,
> +				      user=creds.username,
> +				      password=creds.password)
> +		self.querierCache[creds] = querier
>          except MaayAuthenticationError:
>              print "DBAuthChecker : Authentication Error"
>              return failure.Failure(error.UnauthorizedLogin())
> -        self.realm.createUserSession(creds.username, self.querier)
> +        self.realm.createUserSession(creds.username, querier)
>          return defer.succeed(creds.username)
>  
>  
> 
> _______________________________________________
> Maay-svncheckins mailing list
> Maay-svncheckins at lists.berlios.de
> http://lists.berlios.de/mailman/listinfo/maay-svncheckins


From adimasci at gmail.com  Thu Oct 27 00:37:52 2005
From: adimasci at gmail.com (Adrien Di Mascio)
Date: Wed, 26 Oct 2005 18:37:52 -0400
Subject: [Maay-svncheckins] r229 - trunk/maay
In-Reply-To: <20051026171712.GA6814@logilab.fr>
References: <200510261221.j9QCLguo013160@sheep.berlios.de>
	 <20051026171712.GA6814@logilab.fr>
Message-ID: <437de8500510261537m34f6b50evaaa9b5857feea07b@mail.gmail.com>

On 10/26/05, Aur?lien Camp?as <aurelien.campeas at logilab.fr> wrote:
> Sorry, but this reintroduces the bug. Probably because id(cred) will
> be different each time even if the content is the same. I'll look at a
> whay to preserve your cache and get rid of the leak anyway, if possible.

I see. I should have imagined that. I guess the easiest solution would
then be to directly use the (creds.username, creds.password) tuple
as the dictionary key instead of the credential instance.

But ... there is still the problem (If I understood correctly from the last
mails / checkins) that the connection to the database is not closed
when the querier is not used anymore, and that should be solved.

BTW, why (where) do we instantiate several queriers ? Should we
call "cnx.close()" in the Querier.__del__ method ?

Cheers,
Adrien.


From aurelien.campeas at logilab.fr  Thu Oct 27 10:12:29 2005
From: aurelien.campeas at logilab.fr (=?unknown-8bit?Q?Aur=E9lien_Camp=E9as?=)
Date: Thu, 27 Oct 2005 10:12:29 +0200
Subject: [Maay-svncheckins] r229 - trunk/maay
In-Reply-To: <437de8500510261537m34f6b50evaaa9b5857feea07b@mail.gmail.com>
References: <200510261221.j9QCLguo013160@sheep.berlios.de> <20051026171712.GA6814@logilab.fr> <437de8500510261537m34f6b50evaaa9b5857feea07b@mail.gmail.com>
Message-ID: <20051027081229.GA1099@logilab.fr>

On Wed, Oct 26, 2005 at 06:37:52PM -0400, Adrien Di Mascio wrote:
> On 10/26/05, Aur?lien Camp?as <aurelien.campeas at logilab.fr> wrote:
> > Sorry, but this reintroduces the bug. Probably because id(cred) will
> > be different each time even if the content is the same. I'll look at a
> > whay to preserve your cache and get rid of the leak anyway, if possible.
> 
> I see. I should have imagined that. I guess the easiest solution would
> then be to directly use the (creds.username, creds.password) tuple
> as the dictionary key instead of the credential instance.
> 

Yup, that's what I am going to do.

> But ... there is still the problem (If I understood correctly from the last
> mails / checkins) that the connection to the database is not closed
> when the querier is not used anymore, and that should be solved.

I'll investigate if we really miss an explicit cnx.close() on
XQuerier.del()... or if the instantiated queriers are in fact
abusively stored somewhere (eg in the MaayRealm session dict).

> 
> BTW, why (where) do we instantiate several queriers ? 

AFAIK in requestAvatarId of DBAuthChecker, the place of the
leak. That's what I had fixed I think.

I still don't understand why the cache is needed here since there
should be only one local user...

Nor why we might need (in other places)
different (anonymous) queriers for different (anonymous) users. After
all, anonymous is anonymous is ...kind of the same user all the time.

In short : 1 maayquerier for the local user, 1 anonymous querier for
the distant users. Wrong ?

> Should we
> call "cnx.close()" in the Querier.__del__ method ?
> 

I'll check that.

Bye,
Aur?lien.


From aurelienc at berlios.de  Thu Oct 27 11:15:55 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Thu, 27 Oct 2005 11:15:55 +0200
Subject: [Maay-svncheckins] r230 - trunk/maay
Message-ID: <200510270915.j9R9FtID018716@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-27 11:15:48 +0200 (Thu, 27 Oct 2005)
New Revision: 230

Modified:
   trunk/maay/querier.py
   trunk/maay/server.py
Log:
Introduces WEB_AVATARID, resets ANONYMOUS_AVATARID to '__anonymous__', fixes the cache leak of DBAuthChecker, a few print fixes.


Modified: trunk/maay/querier.py
===================================================================
--- trunk/maay/querier.py	2005-10-26 12:21:23 UTC (rev 229)
+++ trunk/maay/querier.py	2005-10-27 09:15:48 UTC (rev 230)
@@ -38,7 +38,7 @@
 class MaayAuthenticationError(Exception):
     """raised on db authentication failure"""
 
-ANONYMOUS_AVATARID = '__anonymous__'
+ANONYMOUS_AVATARID = '__anonymous__' 
     
 class IQuerier(Interface):
     """defines the High-Level interface to Maay SQL database"""
@@ -133,6 +133,10 @@
     def close(self):
         self._cnx.close()
 
+    def __del__(self):
+        print self, "being GCed ..."
+        self.close()
+
     def findDocuments(self, query):
         """Find all indexed documents matching the query"""
         # TODO: order results using document_scores information

Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-26 12:21:23 UTC (rev 229)
+++ trunk/maay/server.py	2005-10-27 09:15:48 UTC (rev 230)
@@ -64,14 +64,16 @@
 from maay import registrationclient
 from maay.query import Query
 
-ANONYMOUS_AVATARID = 'maay' # it's only a matter of definition after all ...
+ANONYMOUS_AVATARID = '__anonymous__'
+WEB_AVATARID = 'maay' 
 
+
 class MaayPage(rend.Page):
     docFactory = loaders.xmlfile(get_path_of('skeleton.html'))
     child_maaycss = static.File(get_path_of('maay.css'))
     child_images = static.File(get_path_of('images/'))
 
-    def __init__(self, maayId=ANONYMOUS_AVATARID):
+    def __init__(self, maayId=WEB_AVATARID):
         rend.Page.__init__(self)
         self.maayId = maayId
 
@@ -314,10 +316,10 @@
     def _getQuerier(self, avatarId):
         try:
             querier = self._sessions[avatarId]
-            print "Querier of type", type(querier), "for avatar",
-            print avatarId, "was in the cache. Good."
+            print "MaayRealm : querier of type", type(querier), "for avatar",
+            print avatarId, "was in the cache."
         except KeyError:
-            print "No querier in cache for", str(avatarId)+ \
+            print "MaayRealm : no querier in cache for", str(avatarId)+ \
                   ". What are we supposed to do ?"
             querier = None
         return querier
@@ -354,7 +356,7 @@
             print "***"
             webQuerier = None
         else:
-            realm.createUserSession(ANONYMOUS_AVATARID, webQuerier)
+            realm.createUserSession(WEB_AVATARID, webQuerier)
             webQuerier.registerNode(self.config.get_node_id(),
                                     ip=socket.gethostbyname(socket.gethostname()),
                                     port=webappConfig.rpcserver_port,
@@ -407,16 +409,19 @@
     def requestAvatarId(self, creds):
         print "DBAuthChecker : checking credentials for DB access"
         try:
-	    try:
-		querier = self.querierCache[creds]
-	    except KeyError:
-		querier = MaayQuerier(host=self.dbhost, database=self.dbname,
-				      user=creds.username,
-				      password=creds.password)
-		self.querierCache[creds] = querier
-        except MaayAuthenticationError:
-            print "DBAuthChecker : Authentication Error"
-            return failure.Failure(error.UnauthorizedLogin())
+            querier = self.querierCache[(creds.username, creds.password)]
+            print " querier was in the cache for",
+        except KeyError:
+            print " no querier in cache for",
+            try:
+                querier = MaayQuerier(host=self.dbhost, database=self.dbname,
+                                      user=creds.username,
+                                      password=creds.password)
+                self.querierCache[(creds.username, creds.password)] = querier
+            except MaayAuthenticationError:
+                print ; print "DBAuthChecker : Authentication Error"
+                return failure.Failure(error.UnauthorizedLogin())
+        print creds.username
         self.realm.createUserSession(creds.username, querier)
         return defer.succeed(creds.username)
 



From aurelienc at berlios.de  Thu Oct 27 13:50:33 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Thu, 27 Oct 2005 13:50:33 +0200
Subject: [Maay-svncheckins] r231 - trunk/maay
Message-ID: <200510271150.j9RBoXT1004260@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-27 13:50:31 +0200 (Thu, 27 Oct 2005)
New Revision: 231

Added:
   trunk/maay/exif.py
Modified:
   trunk/maay/texttool.py
Log:
Additional support for EXIF information (now we actually get some).


Added: trunk/maay/exif.py
===================================================================
--- trunk/maay/exif.py	2005-10-27 09:15:48 UTC (rev 230)
+++ trunk/maay/exif.py	2005-10-27 11:50:31 UTC (rev 231)
@@ -0,0 +1,68 @@
+"""This module provides tools for
+   the exploitation of EXIF codes
+   embedded in image files.
+"""
+
+#XXX: robustify this against missing PIL
+import Image
+    
+    
+# Mapping from number to (descriptor, type)
+exif_dict = {
+    256 : ('ImageWidth', int),
+    257 : ('ImageLength', int),
+    258 : ('BitPerSample', int),
+    259 : ('Compression', int),
+    270 : ('ImageDescription', str),
+    271 : ('Make', str),
+    272 : ('Model', str),
+    274 : ('Orientation', int),
+    305 : ('Software', str),
+    306 : ('DateTime', str),
+    315 : ('Artist', str),
+
+
+    33434 : ('ExposureTime', (int, int)),
+
+    36864 : ('ExifVersion', None),
+    37122 : ('CompressedBitsPerPixel', (int, int)),
+
+#    37500 : ('MakerNote', None), too much garbage there
+
+    36867 : ('DateTimeOriginal', str),
+    36868 : ('DateTimeDigitized', str),
+
+    40962 : ('PixelXDimension', int),
+    40963 : ('PixelYDimension', int),
+    
+    }
+
+def raw_get_exif(file_path):
+    """gets a mapping from exif codes to values"""
+    return Image.open(file_path)._getexif()
+
+def get_exif(file_path):
+    """returns a mapping from exif attributes to values"""
+    res = {}
+    for k, v in raw_get_exif(file_path).items():
+        if exif_dict.has_key(k):
+            res[exif_dict[k][0]] = v
+    return res
+
+def get_string_from_exif(filepath):
+    """returns a well formed string from
+       exif attributes to values"""
+    d = get_exif(filepath)
+    res = ''
+    for k, v in d.items():
+        res += k+' : '+str(v)+'\n'
+    return res
+
+def get_ustring_from_exif(filepath):
+    """returns a well formed string from
+       exif attributes to values"""
+    d = get_exif(filepath)
+    res = u''
+    for k, v in d.items():
+        res += unicode(k)+u' : '+unicode(v)+u'\n'
+    return res

Modified: trunk/maay/texttool.py
===================================================================
--- trunk/maay/texttool.py	2005-10-27 09:15:48 UTC (rev 230)
+++ trunk/maay/texttool.py	2005-10-27 11:50:31 UTC (rev 231)
@@ -27,6 +27,8 @@
 import gzip
 import bz2
 
+from maay.exif import get_ustring_from_exif
+
 WORD_MIN_LEN = 2
 WORD_MAX_LEN = 50
 MAX_STORED_SIZE = 65535
@@ -116,11 +118,12 @@
 
 class AbstractParser:
     """base-class for file parsers"""
+
     def parseFile(self, filepath, pristineFilename, encoding=None):
         """returns a 4-uple (title, normalized_text, links, offset)
         TODO: port original code from htmltotext
         :param encoding: if None, then need to be guessed
-
+        
         When a title cannot be computed from file content,
         the last component of the filepath is used instead
         """
@@ -199,9 +202,21 @@
 class ExifParser(AbstractParser):
     """A parser for Exif information found in image files"""
 
-    def parseString(self, source):
-        return u'', u'The image', [], 0
+    def parseFile(self, filepath, pristineFilename, encoding=None):
+        """returns a 4-uple (title, normalized_text, links, offset)
+        TODO: port original code from htmltotext
+        :param encoding: if None, then need to be guessed
 
+        When a title cannot be computed from file content,
+        the last component of the filepath is used instead
+        """
+        title = unicode(pristineFilename)
+        try:    
+            result = get_ustring_from_exif (filepath)
+            return title, result, [], 0
+        except:
+            return title, u'No EXIF information available', [], 0
+
         
 _table = {}
 for i in xrange(32):



From aurelienc at berlios.de  Thu Oct 27 13:52:57 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Thu, 27 Oct 2005 13:52:57 +0200
Subject: [Maay-svncheckins] r232 - trunk/maay
Message-ID: <200510271152.j9RBqvVJ005533@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-27 13:52:53 +0200 (Thu, 27 Oct 2005)
New Revision: 232

Modified:
   trunk/maay/querier.py
Log:
Add __del__ method on AnonymousQuerier, which also closes the connection. This make the test whine, but not fail.


Modified: trunk/maay/querier.py
===================================================================
--- trunk/maay/querier.py	2005-10-27 11:50:31 UTC (rev 231)
+++ trunk/maay/querier.py	2005-10-27 11:52:53 UTC (rev 232)
@@ -134,8 +134,9 @@
         self._cnx.close()
 
     def __del__(self):
-        print self, "being GCed ..."
-        self.close()
+        print "Querier", self, "is being GCed ... "
+        print " conection stats :", self._cnx.stat()
+        self.close ()
 
     def findDocuments(self, query):
         """Find all indexed documents matching the query"""



From aurelienc at berlios.de  Thu Oct 27 13:55:41 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Thu, 27 Oct 2005 13:55:41 +0200
Subject: [Maay-svncheckins] r233 - trunk/maay
Message-ID: <200510271155.j9RBtfKo006404@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-27 13:55:37 +0200 (Thu, 27 Oct 2005)
New Revision: 233

Modified:
   trunk/maay/exif.py
Log:
+unicode


Modified: trunk/maay/exif.py
===================================================================
--- trunk/maay/exif.py	2005-10-27 11:52:53 UTC (rev 232)
+++ trunk/maay/exif.py	2005-10-27 11:55:37 UTC (rev 233)
@@ -59,7 +59,7 @@
     return res
 
 def get_ustring_from_exif(filepath):
-    """returns a well formed string from
+    """returns a well formed unicode string from
        exif attributes to values"""
     d = get_exif(filepath)
     res = u''



From aurelienc at berlios.de  Thu Oct 27 13:57:22 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Thu, 27 Oct 2005 13:57:22 +0200
Subject: [Maay-svncheckins] r234 - trunk/maay
Message-ID: <200510271157.j9RBvMwS006963@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-27 13:56:58 +0200 (Thu, 27 Oct 2005)
New Revision: 234

Modified:
   trunk/maay/server.py
Log:
"fixes" (!) (to be seriously reviewed) to make web connection work again (after the previous WEB_AVATARID fix)


Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-27 11:55:37 UTC (rev 233)
+++ trunk/maay/server.py	2005-10-27 11:56:58 UTC (rev 234)
@@ -64,7 +64,6 @@
 from maay import registrationclient
 from maay.query import Query
 
-ANONYMOUS_AVATARID = '__anonymous__'
 WEB_AVATARID = 'maay' 
 
 
@@ -283,7 +282,7 @@
     def createUserSession(self, avatarId, querier):
         """associate a querier to an avatarId.
         Use avatarId=None for the internal private database connection"""
-        print "Maay Realm : creating session for avatar", avatarId,
+        print "MaayRealm : creating session for avatar", avatarId,
         print "with a", type(querier), "querier."
         self._sessions[avatarId] = querier
 
@@ -317,7 +316,7 @@
         try:
             querier = self._sessions[avatarId]
             print "MaayRealm : querier of type", type(querier), "for avatar",
-            print avatarId, "was in the cache."
+            print avatarId, "was in the session cache."
         except KeyError:
             print "MaayRealm : no querier in cache for", str(avatarId)+ \
                   ". What are we supposed to do ?"
@@ -383,8 +382,9 @@
         self.anonymousAllowed = False
         
     def requestAvatarId(self, credentials):
+        print "AnonymousChecker : requestAvatarId", credentials
         if self.anonymousAllowed:
-            return ANONYMOUS_AVATARID
+            return WEB_AVATARID #XXX: FIXME
         else:
             return failure.Failure(error.UnauthorizedLogin(
                 "No anonymous querier available !"))
@@ -560,11 +560,12 @@
     def login(self, request, session, credentials, segments):
         # d = SessionWrapper.login()
         # d.addErrback(..)
+        print "MaaySessionWrapper login", credentials, session, request, segments
         mind = self.mindFactory(request, credentials)
         session.mind = mind
         d = self.portal.login(credentials, mind, self.credInterface)
         d.addCallback(self._cbLoginSuccess, session, segments)
-        d.addErrback(self._forceLoginPage)
+        #d.addErrback(self._forceLoginPage)
         return d
 
     def _forceLoginPage(self, *args):



From aurelienc at berlios.de  Thu Oct 27 14:39:46 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Thu, 27 Oct 2005 14:39:46 +0200
Subject: [Maay-svncheckins] r235 - trunk/maay
Message-ID: <200510271239.j9RCdkr7030712@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-27 14:39:42 +0200 (Thu, 27 Oct 2005)
New Revision: 235

Modified:
   trunk/maay/converter.py
   trunk/maay/indexer.py
Log:
Displaced the mimetype update to converter.py


Modified: trunk/maay/converter.py
===================================================================
--- trunk/maay/converter.py	2005-10-27 11:56:58 UTC (rev 234)
+++ trunk/maay/converter.py	2005-10-27 12:39:42 UTC (rev 235)
@@ -53,6 +53,19 @@
 # REGISTRY is a mimetype / converterList map
 REGISTRY = {}
 
+types_map.update ({
+    '.conf': 'text/plain',
+    '.flac':  'audio/x-flac',
+    '.diff': 'application/x-executable',
+    '.ogg':   'application/ogg',
+    '.swf':   'application/x-shockwave-flash',
+    '.tgz':   'application/x-gtar',
+    '.wml':   'text/vnd.wap.wml',
+    '.xul':   'application/vnd.mozilla.xul+xml',
+    '.patch': 'text/plain'
+    })
+
+
 class IndexationFailure(Exception):
     """raised when an indexation has failed"""
 

Modified: trunk/maay/indexer.py
===================================================================
--- trunk/maay/indexer.py	2005-10-27 11:56:58 UTC (rev 234)
+++ trunk/maay/indexer.py	2005-10-27 12:39:42 UTC (rev 235)
@@ -38,32 +38,7 @@
 from maay.querier import MaayAuthenticationError
 from maay.texttool import removeControlChar
 
-# grabbed from nevow, but useless
-# mimetypes.types_map.update( 
-#     {
-#             '.conf':  'text/plain',
-#             '.diff':  'text/plain',
-#             '.exe':   'application/x-executable',
-#             '.flac':  'audio/x-flac',
-#             '.java':  'text/plain',
-#             '.ogg':   'application/ogg',
-#             '.oz':    'text/x-oz',
-#             '.swf':   'application/x-shockwave-flash',
-#             '.tgz':   'application/x-gtar',
-#             '.wml':   'text/vnd.wap.wml',
-#             '.xul':   'application/vnd.mozilla.xul+xml',
-#             '.py':    'text/plain',
-#             '.patch': 'text/plain',
-#             '.c' :    'text/plain',
-#             '.h':     'text/plain',
-#             '.C':     'text/plain',
-#             '.cpp':   'text/plain',
-#             '.cc':    'text/plain',
-#             '.c++':   'text/plain',
-#         }
-#     )
 
-
 def makeDocumentId(filename):
     """return the SHA hash value from of the contents of the file"""
     stream = file(filename, 'rb')



From aurelienc at berlios.de  Thu Oct 27 15:37:24 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Thu, 27 Oct 2005 15:37:24 +0200
Subject: [Maay-svncheckins] r238 - trunk/maay/data
Message-ID: <200510271337.j9RDbO1E009084@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-27 15:37:16 +0200 (Thu, 27 Oct 2005)
New Revision: 238

Modified:
   trunk/maay/data/peers.html
Log:
Disable loginurl stuff.


Modified: trunk/maay/data/peers.html
===================================================================
--- trunk/maay/data/peers.html	2005-10-27 13:22:48 UTC (rev 237)
+++ trunk/maay/data/peers.html	2005-10-27 13:37:16 UTC (rev 238)
@@ -2,7 +2,12 @@
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
 
 <nevow:invisible xmlns="http://www.w3.org/1999/xhtml" lang="en" xmlns:nevow="http://nevow.com/ns/nevow/0.1">
-  <a nevow:render="loginurl"><nevow:attr name="href"><nevow:slot name="loginurl" /></nevow:attr><nevow:slot name="actionlabel" /></a>
+<!--     <a nevow:render="loginurl"> -->
+<!--       <nevow:attr name="href"> -->
+<!--         <nevow:slot name="loginurl" /> -->
+<!--       </nevow:attr> -->
+<!--       <nevow:slot name="actionlabel" /> -->
+<!--     </a> -->
   <table class="peersTable" nevow:render="sequence" nevow:data="peers">
     <tr nevow:pattern="header">
       <th>Node id</th>



From aurelienc at berlios.de  Thu Oct 27 15:40:35 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Thu, 27 Oct 2005 15:40:35 +0200
Subject: [Maay-svncheckins] r239 - trunk/maay
Message-ID: <200510271340.j9RDeZvx009302@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-27 15:40:32 +0200 (Thu, 27 Oct 2005)
New Revision: 239

Modified:
   trunk/maay/querier.py
   trunk/maay/rpc.py
   trunk/maay/server.py
Log:
Cleanup of the ANONYMOUS/WEB_AVATARID saga.


Modified: trunk/maay/querier.py
===================================================================
--- trunk/maay/querier.py	2005-10-27 13:37:16 UTC (rev 238)
+++ trunk/maay/querier.py	2005-10-27 13:40:32 UTC (rev 239)
@@ -38,7 +38,8 @@
 class MaayAuthenticationError(Exception):
     """raised on db authentication failure"""
 
-ANONYMOUS_AVATARID = '__anonymous__' 
+ANONYMOUS_AVATARID = '__anonymous__'
+WEB_AVATARID = '__may__'
     
 class IQuerier(Interface):
     """defines the High-Level interface to Maay SQL database"""
@@ -305,7 +306,7 @@
         rows = cursor.execute('DELETE FROM files WHERE file_name = %s', filename)
         cursor.close()
         self._cnx.commit()
-        print "removed %s" % filename
+        #print "removed %s" % filename
         return rows
 
     def removeUnreferencedDocuments(self):

Modified: trunk/maay/rpc.py
===================================================================
--- trunk/maay/rpc.py	2005-10-27 13:37:16 UTC (rev 238)
+++ trunk/maay/rpc.py	2005-10-27 13:40:32 UTC (rev 239)
@@ -24,7 +24,7 @@
 from twisted.internet import defer, reactor
 ## from twisted.python.failure import Failure
 
-from maay.querier import MaayQuerier, IQuerier, ANONYMOUS_AVATARID
+from maay.querier import MaayQuerier, IQuerier, ANONYMOUS_AVATARID, WEB_AVATARID
 from maay.dbentity import Document
 from maay.p2pquerier import P2pQuerier, P2pQuery
 from maay.query import Query
@@ -43,8 +43,8 @@
         assert nodeId == portal.config.get_node_id ()
         self._sessions = {}
         self.portal = portal
-        self.nodeId = portal.config.get_node_id() # hmmm ...
-        self._sessions[ANONYMOUS_AVATARID] = portal.webQuerier
+        self.nodeId = portal.config.get_node_id() 
+        self._sessions[WEB_AVATARID] = portal.webQuerier # update with WEB_AVATARID ?
         self._p2pQuerier = P2pQuerier(nodeId, portal.webQuerier)
         
     def _attachUser(self, (interface, querier, logout), username, password):

Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-27 13:37:16 UTC (rev 238)
+++ trunk/maay/server.py	2005-10-27 13:40:32 UTC (rev 239)
@@ -57,16 +57,14 @@
 from logilab.common.textutils import normalize_text
 
 from maay.querier import MaayQuerier, IQuerier, \
-     MaayAuthenticationError, ANONYMOUS_AVATARID
+     MaayAuthenticationError, ANONYMOUS_AVATARID, WEB_AVATARID
 from maay.rpc import MaayRPCServer
 from maay.configuration import get_path_of, Configuration
 from maay.texttool import makeAbstract, WORDS_RGX, normalizeText
 from maay import registrationclient
 from maay.query import Query
 
-WEB_AVATARID = 'maay' 
 
-
 class MaayPage(rend.Page):
     docFactory = loaders.xmlfile(get_path_of('skeleton.html'))
     child_maaycss = static.File(get_path_of('maay.css'))



From aurelienc at berlios.de  Thu Oct 27 16:19:30 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Thu, 27 Oct 2005 16:19:30 +0200
Subject: [Maay-svncheckins] r241 - trunk/maay
Message-ID: <200510271419.j9REJU1o012935@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-27 16:19:29 +0200 (Thu, 27 Oct 2005)
New Revision: 241

Modified:
   trunk/maay/rpc.py
Log:
Update to _session objects (defaults to one Anonymous and one Maay queriers), link to findDocument of the AnonymousQuerier.


Modified: trunk/maay/rpc.py
===================================================================
--- trunk/maay/rpc.py	2005-10-27 13:55:46 UTC (rev 240)
+++ trunk/maay/rpc.py	2005-10-27 14:19:29 UTC (rev 241)
@@ -44,10 +44,12 @@
         self._sessions = {}
         self.portal = portal
         self.nodeId = portal.config.get_node_id() 
-        self._sessions[WEB_AVATARID] = portal.webQuerier # update with WEB_AVATARID ?
+        self._sessions[WEB_AVATARID] = portal.webQuerier 
+        self._sessions[ANONYMOUS_AVATARID] = portal.anonymousQuerier
         self._p2pQuerier = P2pQuerier(nodeId, portal.webQuerier)
         
     def _attachUser(self, (interface, querier, logout), username, password):
+        print "MaayRPCServer _attachUser", username, type(querier)
         if interface is not IQuerier or querier is None:
             errmsg = "Could not get Querier for", username
             print errmsg
@@ -59,6 +61,7 @@
 
     def xmlrpc_authenticate(self, username, password):
         """server authentication method"""
+        print "MaayRPCServer xmlrpc_authenticate", username
         # anonymous login
         if (username, password) == ('', ''):
             creds = Anonymous()
@@ -94,6 +97,12 @@
             querier = self._sessions[cnxId]
             return querier.getIndexedFiles()
         return []
+
+    def xmlrpc_findDocuments(self, cnxId, query):
+        if self.cnxIsValid(cnxId):
+            queryAsObj = Query.fromRawQuery(query)
+            return self._sessions[cnxId].findDocuments(queryAsObj)
+        return []
         
     def xmlrpc_removeFileInfo(self, cnxId, filename):
         if self.cnxIsValid(cnxId):
@@ -149,5 +158,5 @@
     def cnxIsValid(self, cnxId):
         if cnxId in self._sessions:
             return True
-        print "We're under attack !"
+        print "MaayRPCServer cnxIsvalid Not !", cnxId
         return False



From aurelienc at berlios.de  Thu Oct 27 16:22:24 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Thu, 27 Oct 2005 16:22:24 +0200
Subject: [Maay-svncheckins] r242 - trunk/maay
Message-ID: <200510271422.j9REMOBA013336@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-27 16:22:24 +0200 (Thu, 27 Oct 2005)
New Revision: 242

Modified:
   trunk/maay/server.py
Log:
Add default anonymous querier to maay portal.


Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-27 14:19:29 UTC (rev 241)
+++ trunk/maay/server.py	2005-10-27 14:22:24 UTC (rev 242)
@@ -56,7 +56,7 @@
 
 from logilab.common.textutils import normalize_text
 
-from maay.querier import MaayQuerier, IQuerier, \
+from maay.querier import MaayQuerier, IQuerier, AnonymousQuerier, \
      MaayAuthenticationError, ANONYMOUS_AVATARID, WEB_AVATARID
 from maay.rpc import MaayRPCServer
 from maay.configuration import get_path_of, Configuration
@@ -360,7 +360,12 @@
                                     port=webappConfig.rpcserver_port,
                                     bandwidth=webappConfig.bandwidth)
         self.webQuerier = webQuerier
+        self.anonymousQuerier = AnonymousQuerier(host=webappConfig.db_host,
+                                                 database=webappConfig.db_name,
+                                                 user=webappConfig.user,
+                                                 password=webappConfig.password)
 
+
     def getWebQuerier(self):
         return getattr(self, '_webQuerier', None)
 



From dnf at berlios.de  Thu Oct 27 15:12:57 2005
From: dnf at berlios.de (Frdric DANG NGOC at BerliOS)
Date: Thu, 27 Oct 2005 15:12:57 +0200
Subject: [Maay-svncheckins] r236 - trunk/maay
Message-ID: <200510271312.j9RDCv7U020132@sheep.berlios.de>

Author: dnf
Date: 2005-10-27 15:12:55 +0200 (Thu, 27 Oct 2005)
New Revision: 236

Modified:
   trunk/maay/texttool.py
Log:
Rewrite makeAbstract function.


Modified: trunk/maay/texttool.py
===================================================================
--- trunk/maay/texttool.py	2005-10-27 12:39:42 UTC (rev 235)
+++ trunk/maay/texttool.py	2005-10-27 13:12:55 UTC (rev 236)
@@ -302,26 +302,76 @@
     return text.translate(table)
 del _table2
     
+def boldifyText(text, words):
+    rgx = re.compile('|'.join(words), re.I)
+    s = StringIO.StringIO()
+    lastStart = 0
+    for occurence in rgx.finditer(text):
+        wordFound = occurence.group(0)
+        start, end = occurence.start(), occurence.end()
+	s.write(text[lastStart:start])
+	s.write("<b>%s</b>" % wordFound)
+	lastStart = end
 
+    s.write(text[end:])
+    return s.getvalue()
+
 def makeAbstract(text, words):
-    """return the original text with HTML emphasis tags
-    around <words> occurences
-    XXX: this is a quick and dirty implementation
+    """return excerpts of the original text surrounding the word occurrences
+    XXX: this is a less quick and dirty implementation
     """
-    rgx = re.compile('|'.join(words), re.I)
+
+    # To build the abstract, we only display the first occurrence of each
+    # word in the text.
+    # Each occurrence is shown in an excerpt (approx 60 caracters).
+    # If two excerpts are close, we merge them into one.
+
+    # excerptPositions = [(word,position)]
+    excerptPositions = []
+
     text = untagText(text)
-    buf = []
-    size = 0
-    for occurence in rgx.finditer(text):
-        wordFound = occurence.group(0)
-        start, end = occurence.start(), occurence.end()
-        before = text[start-30:start-1]
-        after = text[end+1:end+30]
-        size += len(wordFound) + 60
-        buf.append('%s <b>%s</b> %s' % (before, wordFound, after))
-        if size >= 200:
-            break
-    else:
-        # case where we have less than 200 characters to display
+    text_length = len(text)
+
+    for word in words:
+        m = re.search(word, text, re.I)
+	if m:
+	        excerptPositions.append((word, m.start()))
+
+    if not excerptPositions:
         return text[:200]
-    return u' <b>[...]</b> '.join(buf)
+
+    # sort by position
+    excerptPositions.sort(lambda x, y: x[1] - y [1])
+
+    s = StringIO.StringIO()
+    start = -1
+    last_position = -100
+    last_word = 0
+
+    for word, position in excerptPositions:
+        if position - last_position < 30:
+            last_position = position
+	    last_word = word
+	    continue
+	    
+	if start !=-1:
+            end = min(last_position + 30 + len(last_word), text_length - 1)
+            while not text[end].isspace(): end -= 1
+            s.write(" <b>...</b>")
+            s.write(boldifyText(text[start:end], words))
+            print "repl = %s" % str('|'.join(words))
+
+        start = max(0, position - 30)
+        while not text[start].isspace(): start += 1
+
+        last_position = position
+        last_word = word
+
+    end = min(last_position + 30 + len(word), text_length - 1)
+    while not text[end].isspace(): end -= 1
+    s.write("<b>...</b>")
+    s.write(boldifyText(text[start:end], words))
+    s.write("<b>...</b>")
+
+    return u"%s" % s.getvalue()
+



From dnf at berlios.de  Thu Oct 27 15:22:50 2005
From: dnf at berlios.de (Frdric DANG NGOC at BerliOS)
Date: Thu, 27 Oct 2005 15:22:50 +0200
Subject: [Maay-svncheckins] r237 - trunk/maay
Message-ID: <200510271322.j9RDMofF006146@sheep.berlios.de>

Author: dnf
Date: 2005-10-27 15:22:48 +0200 (Thu, 27 Oct 2005)
New Revision: 237

Modified:
   trunk/maay/texttool.py
Log:
minor update : forget to add import StringIO.


Modified: trunk/maay/texttool.py
===================================================================
--- trunk/maay/texttool.py	2005-10-27 13:12:55 UTC (rev 236)
+++ trunk/maay/texttool.py	2005-10-27 13:22:48 UTC (rev 237)
@@ -26,6 +26,7 @@
 import mimetypes
 import gzip
 import bz2
+import StringIO
 
 from maay.exif import get_ustring_from_exif
 



From dnf at berlios.de  Thu Oct 27 15:55:47 2005
From: dnf at berlios.de (Frdric DANG NGOC at BerliOS)
Date: Thu, 27 Oct 2005 15:55:47 +0200
Subject: [Maay-svncheckins] r240 - in trunk/maay: . data
Message-ID: <200510271355.j9RDtlGt011125@sheep.berlios.de>

Author: dnf
Date: 2005-10-27 15:55:46 +0200 (Thu, 27 Oct 2005)
New Revision: 240

Modified:
   trunk/maay/data/maay.css
   trunk/maay/data/resultpage.html
   trunk/maay/server.py
   trunk/maay/texttool.py
Log:
Some cosmetic (web pages) change.


Modified: trunk/maay/data/maay.css
===================================================================
--- trunk/maay/data/maay.css	2005-10-27 13:40:32 UTC (rev 239)
+++ trunk/maay/data/maay.css	2005-10-27 13:55:46 UTC (rev 240)
@@ -1,3 +1,5 @@
+body,td,div,.p,a{font-family:arial,sans-serif }
+
 /** login page ********/
 table.loginTable {
   width: 100%;
@@ -36,7 +38,6 @@
 span.resultUrl {
   font-size: 90%;
   font-family: "New Century Schoolbook", serif;
-  font-weight: bold;
   color: green;
   text-decoration: none;
 }
@@ -65,4 +66,5 @@
 
 table.peersTable td.nodeId {
   background: lightgrey;
-}
\ No newline at end of file
+}
+

Modified: trunk/maay/data/resultpage.html
===================================================================
--- trunk/maay/data/resultpage.html	2005-10-27 13:40:32 UTC (rev 239)
+++ trunk/maay/data/resultpage.html	2005-10-27 13:55:46 UTC (rev 240)
@@ -3,10 +3,14 @@
 <nevow:invisible xmlns="http://www.w3.org/1999/xhtml" lang="en" xmlns:nevow="http://nevow.com/ns/nevow/0.1">
   <!-- <a nevow:render="loginurl"><nevow:attr name="href"><nevow:slot name="loginurl" /></nevow:attr><nevow:slot name="actionlabel" /></a> -->
   <div class="reSearch">
-    <img src="images/smallmaay.png" />
     <form action="search" accept-charset="utf-8">
-      <input type="text" name="words" nevow:render="searchfield"><nevow:attr name="value" ><nevow:slot name="words" /></nevow:attr></input>
-      <input type="submit" class="searchButton" value="search" />
+      <table>
+        <tr>
+          <td><img src="images/smallmaay.png" /></td>
+          <td><input type="text" name="words" nevow:render="searchfield"><nevow:attr name="value" ><nevow:slot name="words" /></nevow:attr></input></td>
+          <td><input type="submit" class="searchButton" value="search" /></td>
+	</tr>
+      </table>
     </form>      
   </div>
   <div class="message" nevow:render="title">Results for "<nevow:slot name="words" />"</div>

Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-27 13:40:32 UTC (rev 239)
+++ trunk/maay/server.py	2005-10-27 13:55:46 UTC (rev 240)
@@ -60,7 +60,7 @@
      MaayAuthenticationError, ANONYMOUS_AVATARID, WEB_AVATARID
 from maay.rpc import MaayRPCServer
 from maay.configuration import get_path_of, Configuration
-from maay.texttool import makeAbstract, WORDS_RGX, normalizeText
+from maay.texttool import makeAbstract, WORDS_RGX, normalizeText, boldifyText
 from maay import registrationclient
 from maay.query import Query
 
@@ -245,21 +245,22 @@
     
     def render_row(self, context, data):
         document = data
-        context.fillSlots('doctitle',  document.title)
+	words = self.query.split()
+        context.fillSlots('doctitle', tags.xml(boldifyText(document.title, words)))
         # XXX abstract attribute should be a unicode string
         try:
-            abstract = makeAbstract(document.text, self.query.split())
+            abstract = makeAbstract(document.text, words)
             abstract = normalize_text(unicode(abstract))
         except Exception, exc:
             print exc
             abstract = u'No abstract available for this document [%s]' % exc
         context.fillSlots('abstract', tags.xml(abstract))
         context.fillSlots('docid', document.db_document_id)
-        context.fillSlots('docurl', document.url)
+        context.fillSlots('docurl', tags.xml(boldifyText(document.url, words)))
         context.fillSlots('words', self.query)
         context.fillSlots('readable_size', document.readable_size())
         date = datetime.fromtimestamp(document.publication_time)
-        context.fillSlots('publication_date', date.strftime('%d/%m/%Y'))
+        context.fillSlots('publication_date', date.strftime('%d %b %Y'))
         return context.tag
 
 ## nevow app/server setup ############################################

Modified: trunk/maay/texttool.py
===================================================================
--- trunk/maay/texttool.py	2005-10-27 13:40:32 UTC (rev 239)
+++ trunk/maay/texttool.py	2005-10-27 13:55:46 UTC (rev 240)
@@ -307,6 +307,7 @@
     rgx = re.compile('|'.join(words), re.I)
     s = StringIO.StringIO()
     lastStart = 0
+    end = 0
     for occurence in rgx.finditer(text):
         wordFound = occurence.group(0)
         start, end = occurence.start(), occurence.end()



From afayolle at berlios.de  Thu Oct 27 23:15:39 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Thu, 27 Oct 2005 23:15:39 +0200
Subject: [Maay-svncheckins] r243 - trunk/maay
Message-ID: <200510272115.j9RLFdXB007359@sheep.berlios.de>

Author: afayolle
Date: 2005-10-27 23:15:38 +0200 (Thu, 27 Oct 2005)
New Revision: 243

Modified:
   trunk/maay/texttool.py
Log:
fixed indentation

Modified: trunk/maay/texttool.py
===================================================================
--- trunk/maay/texttool.py	2005-10-27 14:22:24 UTC (rev 242)
+++ trunk/maay/texttool.py	2005-10-27 21:15:38 UTC (rev 243)
@@ -26,7 +26,7 @@
 import mimetypes
 import gzip
 import bz2
-import StringIO
+from cStringIO import StringIO
 
 from maay.exif import get_ustring_from_exif
 
@@ -55,12 +55,12 @@
 
 def guessEncoding(filename): #may throw IOError
     """try to guess encoding from a buffer
-        Bytes  	Encoding Form
-        00 00 FE FF 	UTF-32, big-endian
-        FF FE 00 00 	UTF-32, little-endian
-        FE FF 	        UTF-16, big-endian
-        FF FE 	        UTF-16, little-endian
-        EF BB BF 	UTF-8
+        Bytes           Encoding Form
+        00 00 FE FF     UTF-32, big-endian
+        FF FE 00 00     UTF-32, little-endian
+        FE FF           UTF-16, big-endian
+        FF FE           UTF-16, little-endian
+        EF BB BF        UTF-8
     """
     if filename.endswith(".gz"):
         stream = gzip.open(filename, 'rb')
@@ -305,15 +305,15 @@
     
 def boldifyText(text, words):
     rgx = re.compile('|'.join(words), re.I)
-    s = StringIO.StringIO()
+    s = StringIO()
     lastStart = 0
     end = 0
     for occurence in rgx.finditer(text):
         wordFound = occurence.group(0)
         start, end = occurence.start(), occurence.end()
-	s.write(text[lastStart:start])
-	s.write("<b>%s</b>" % wordFound)
-	lastStart = end
+        s.write(text[lastStart:start])
+        s.write("<b>%s</b>" % wordFound)
+        lastStart = end
 
     s.write(text[end:])
     return s.getvalue()
@@ -336,8 +336,8 @@
 
     for word in words:
         m = re.search(word, text, re.I)
-	if m:
-	        excerptPositions.append((word, m.start()))
+        if m:
+            excerptPositions.append((word, m.start()))
 
     if not excerptPositions:
         return text[:200]
@@ -345,7 +345,7 @@
     # sort by position
     excerptPositions.sort(lambda x, y: x[1] - y [1])
 
-    s = StringIO.StringIO()
+    s = StringIO()
     start = -1
     last_position = -100
     last_word = 0
@@ -353,12 +353,13 @@
     for word, position in excerptPositions:
         if position - last_position < 30:
             last_position = position
-	    last_word = word
-	    continue
-	    
-	if start !=-1:
+            last_word = word
+            continue
+            
+        if start !=-1:
             end = min(last_position + 30 + len(last_word), text_length - 1)
-            while not text[end].isspace(): end -= 1
+            while not text[end].isspace():
+                end -= 1
             s.write(" <b>...</b>")
             s.write(boldifyText(text[start:end], words))
             print "repl = %s" % str('|'.join(words))
@@ -370,7 +371,8 @@
         last_word = word
 
     end = min(last_position + 30 + len(word), text_length - 1)
-    while not text[end].isspace(): end -= 1
+    while not text[end].isspace():
+        end -= 1
     s.write("<b>...</b>")
     s.write(boldifyText(text[start:end], words))
     s.write("<b>...</b>")



From aurelienc at berlios.de  Fri Oct 28 11:29:03 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Fri, 28 Oct 2005 11:29:03 +0200
Subject: [Maay-svncheckins] r244 - trunk/maay
Message-ID: <200510280929.j9S9T35b000546@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-28 11:29:02 +0200 (Fri, 28 Oct 2005)
New Revision: 244

Modified:
   trunk/maay/dbentity.py
Log:
Fixes a crash when an empty query is received.


Modified: trunk/maay/dbentity.py
===================================================================
--- trunk/maay/dbentity.py	2005-10-27 21:15:38 UTC (rev 243)
+++ trunk/maay/dbentity.py	2005-10-28 09:29:02 UTC (rev 244)
@@ -212,8 +212,6 @@
     abstract = property(get_abstract)
 
     def _selectContainingQuery(cls, words, mimetype=None, offset=0, allowPrivate=False):
-        if not words:
-            return ''
         words = [normalizeText(unicode(w))
                  for w in words
                  if WORD_MIN_LEN <= len(w) <= WORD_MAX_LEN]        
@@ -255,6 +253,8 @@
     _selectContainingQuery = classmethod(_selectContainingQuery)
 
     def selectContaining(cls, cursor, words, mimetype=None, offset=0, allowPrivate=False):
+        if not words:
+            return []
         query, params = cls._selectContainingQuery(words, mimetype,
                                                    offset=offset,
                                                    allowPrivate=allowPrivate)



From aurelienc at berlios.de  Fri Oct 28 11:29:30 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Fri, 28 Oct 2005 11:29:30 +0200
Subject: [Maay-svncheckins] r245 - trunk/maay
Message-ID: <200510280929.j9S9TUPw000588@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-28 11:29:29 +0200 (Fri, 28 Oct 2005)
New Revision: 245

Modified:
   trunk/maay/texttool.py
Log:
Remove wrong comment.


Modified: trunk/maay/texttool.py
===================================================================
--- trunk/maay/texttool.py	2005-10-28 09:29:02 UTC (rev 244)
+++ trunk/maay/texttool.py	2005-10-28 09:29:29 UTC (rev 245)
@@ -207,9 +207,6 @@
         """returns a 4-uple (title, normalized_text, links, offset)
         TODO: port original code from htmltotext
         :param encoding: if None, then need to be guessed
-
-        When a title cannot be computed from file content,
-        the last component of the filepath is used instead
         """
         title = unicode(pristineFilename)
         try:    



From aurelienc at berlios.de  Fri Oct 28 11:30:03 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Fri, 28 Oct 2005 11:30:03 +0200
Subject: [Maay-svncheckins] r246 - trunk/maay
Message-ID: <200510280930.j9S9U3Sk000727@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-28 11:30:02 +0200 (Fri, 28 Oct 2005)
New Revision: 246

Modified:
   trunk/maay/server.py
Log:
Remove useless comment.


Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-28 09:29:29 UTC (rev 245)
+++ trunk/maay/server.py	2005-10-28 09:30:02 UTC (rev 246)
@@ -407,7 +407,6 @@
         self.realm = realm
         self.dbhost = dbhost
         self.dbname = dbname
-	# Keeping a cache of queriers reusing the same has some benefits :)
         self.querierCache = {}
     
     def requestAvatarId(self, creds):



From aurelienc at berlios.de  Fri Oct 28 11:32:10 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Fri, 28 Oct 2005 11:32:10 +0200
Subject: [Maay-svncheckins] r247 - trunk/maay
Message-ID: <200510280932.j9S9WAjA001329@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-28 11:32:08 +0200 (Fri, 28 Oct 2005)
New Revision: 247

Modified:
   trunk/maay/querier.py
Log:
Minor robustification and edits.


Modified: trunk/maay/querier.py
===================================================================
--- trunk/maay/querier.py	2005-10-28 09:30:02 UTC (rev 246)
+++ trunk/maay/querier.py	2005-10-28 09:32:08 UTC (rev 247)
@@ -108,10 +108,11 @@
             except dbapiMod.OperationalError:
                 raise MaayAuthenticationError("Failed to authenticate user %r"
                                               % user)
-            except Exception:
+            except Exception, e:
                 import traceback
                 traceback.print_exc()
-                raise
+                raise MaayAuthenticationError("Failed to authenticate user %r, cause is %s"
+                                              % (user, e))
         self._cnx = connection
 
     def _execute(self, query, args=None):
@@ -136,7 +137,8 @@
 
     def __del__(self):
         print "Querier", self, "is being GCed ... "
-        print " conection stats :", self._cnx.stat()
+        if self._cnx:
+            print " conection stats :", self._cnx.stat()
         self.close ()
 
     def findDocuments(self, query):
@@ -337,8 +339,7 @@
         # ourselves or if the indexer should do it and pass the values as an argument
         cursor = self._cnx.cursor()
         # insert or update in table file_info
-        fileinfo = FileInfo.selectWhere(cursor,
-                                        file_name=filename)
+        fileinfo = FileInfo.selectWhere(cursor, file_name=filename)
         # insert title into text to be able to find documents according
         # to their title (e.g: searching 'foo' should find 'foo.pdf')
         text = '%s %s' % (title, text)



From aurelienc at berlios.de  Fri Oct 28 14:07:41 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Fri, 28 Oct 2005 14:07:41 +0200
Subject: [Maay-svncheckins] r248 - in trunk/maay: . test
Message-ID: <200510281207.j9SC7fHd028698@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-28 14:07:36 +0200 (Fri, 28 Oct 2005)
New Revision: 248

Modified:
   trunk/maay/dbentity.py
   trunk/maay/indexer.py
   trunk/maay/querier.py
   trunk/maay/rpc.py
   trunk/maay/test/test_querier.py
Log:
Big cosmetic rewrite : a new FutureDocument class is added. It is intended to hold the many parameters passed back and forth in indexDocuments and co and enhance, generally, readability. Feel free to complain :)


Modified: trunk/maay/dbentity.py
===================================================================
--- trunk/maay/dbentity.py	2005-10-28 09:32:08 UTC (rev 247)
+++ trunk/maay/dbentity.py	2005-10-28 12:07:36 UTC (rev 248)
@@ -123,7 +123,14 @@
                                       for attr in self.boundAttributes()]))
     def __repr__(self):
         return str(self)
-    
+
+
+class FutureDocument(DBEntity):
+    """Represents a Document before it gets fed to the database"""
+    attributes = ('filename', 'title', 'text', 'fileSize', 'lastModificationTime',
+                  'content_hash', 'mime_type', 'state', 'file_state')
+    key = ('content_hash',)
+
 class Document(DBEntity):
     """Represent a Document in the database
     A Document is different from a file, because several files can store

Modified: trunk/maay/indexer.py
===================================================================
--- trunk/maay/indexer.py	2005-10-28 09:32:08 UTC (rev 247)
+++ trunk/maay/indexer.py	2005-10-28 12:07:36 UTC (rev 248)
@@ -34,7 +34,7 @@
 
 from maay import converter
 from maay.configuration import Configuration
-from maay.dbentity import Document, FileInfo
+from maay.dbentity import FutureDocument, Document, FileInfo
 from maay.querier import MaayAuthenticationError
 from maay.texttool import removeControlChar
 
@@ -142,9 +142,11 @@
                 docId = makeDocumentId(filename)
                 mime_type = mimetypes.guess_type(filename)[0]
 
-                self.indexDocument(filename, title, text, fileSize,
-                                   lastModificationTime,
-                                   docId, mime_type, state)
+                self.indexDocument(FutureDocument(filename=filename, title=title, text=text,
+                                                  fileSize=fileSize,
+                                                  lastModificationTime=lastModificationTime,
+                                                  content_hash=docId, mime_type=mime_type,
+                                                  state=state))
         return existingFiles
         
     def getLastIndexationTimeAndState(self, filename):
@@ -154,26 +156,25 @@
         lastTime, lastState = answer
         return lastTime, lastState
 
-    def indexDocument(self, filename, title, text, fileSize,
-                      lastModTime, content_hash, mime_type, state,
-                      file_state=FileInfo.CREATED_FILE_STATE):
+    def indexDocument(self, futureDoc):
+        futureDoc.file_state=FileInfo.CREATED_FILE_STATE
         if self.verbose:
-            print "Requesting indexation of %s" % filename,
+            print "Requesting indexation of %s" % futureDoc.filename,
         try:
-            title = removeControlChar(title) 
-            text = removeControlChar(text)
+            futureDoc.title = removeControlChar(futureDoc.title) 
+            futureDoc.text = removeControlChar(futureDoc.text)
             if self.verbose:
-                print u'('+title.encode('utf-8')+u')'
-            self.serverProxy.indexDocument(self.cnxId, filename, title, text,
-                                           fileSize, lastModTime, content_hash,
-                                           mime_type, state, file_state)
+                print u'('+futureDoc.title.encode('utf-8')+u')'
+            self.serverProxy.indexDocument(self.cnxId, futureDoc)
+
         except (Fault, ProtocolError), exc:
             if self.verbose:
-                print "An error occured on the server while indexing %s" % filename.encode('iso-8859-1')
+                print "An error occured on the server while indexing %s" % \
+                      futureDoc.filename.encode('iso-8859-1')
                 print exc
                 print "See server log for details"
             else:
-                print "Error indexing %s: %s" % (filename.encode('iso-8859-1'), exc)
+                print "Error indexing %s: %s" % (futureDoc.filename.encode('iso-8859-1'), exc)
         
     
      

Modified: trunk/maay/querier.py
===================================================================
--- trunk/maay/querier.py	2005-10-28 09:32:08 UTC (rev 247)
+++ trunk/maay/querier.py	2005-10-28 12:07:36 UTC (rev 248)
@@ -31,8 +31,8 @@
 
 from logilab.common.db import get_dbapi_compliant_module
 
-from maay.dbentity import Document, FileInfo, DocumentProvider, DocumentScore, \
-     Word, Node
+from maay.dbentity import FutureDocument, Document, FileInfo, DocumentProvider, \
+     DocumentScore, Word, Node
 from maay.texttool import normalizeText, WORDS_RGX, MAX_STORED_SIZE
 
 class MaayAuthenticationError(Exception):
@@ -56,8 +56,7 @@
         """returns a list of indexed file names as strings
         """
 
-    def indexDocument(nodeId, filename, title, text, fileSize, lastModifiedOn,
-                      content_hash, mime_type, state, file_state):
+    def indexDocument(nodeId, futureDoc):
         """Inserts or update information in table documents,
         file_info, document_score and word"""
 
@@ -331,45 +330,36 @@
         print "removed %d rows related to unreferenced documents" % rows
         return rows
 
-    def indexDocument(self, nodeId, filename, title, text, fileSize, lastModifiedOn,
-                      content_hash, mime_type, state, file_state):
+    def indexDocument(self, nodeId, futureDoc):
         """Inserts or update information in table documents,
         file_info, document_score and word"""
         # XXX Decide if we can compute the content_hash and mime_type
         # ourselves or if the indexer should do it and pass the values as an argument
         cursor = self._cnx.cursor()
         # insert or update in table file_info
-        fileinfo = FileInfo.selectWhere(cursor, file_name=filename)
+        fileinfo = FileInfo.selectWhere(cursor, file_name=futureDoc.filename)
         # insert title into text to be able to find documents according
         # to their title (e.g: searching 'foo' should find 'foo.pdf')
-        text = '%s %s' % (title, text)
+        futureDoc.text = '%s %s' % (futureDoc.title, futureDoc.text)
         if fileinfo:
             fileinfo = fileinfo[0]
-            fileinfo.file_time = lastModifiedOn
-            fileinfo.state = state
-            fileinfo.file_state = file_state
+            fileinfo.file_time = futureDoc.lastModificationTime
+            fileinfo.state = futureDoc.state
+            fileinfo.file_state = futureDoc.file_state
             doc = Document.selectWhere(cursor,
                                        db_document_id=fileinfo.db_document_id)
-            if not doc or doc[0].document_id!=content_hash :
+            if not doc or doc[0].document_id!=futureDoc.content_hash :
                 # no document was found or a document with another content
                 # in both case, we create a new Document in database
                 # (we don't want to modify the existing one, because it
                 # can be shared by several files)
-                doc = self._createDocument(cursor,
-                                           content_hash,
-                                           title,
-                                           text,
-                                           fileSize,
-                                           lastModifiedOn,
-                                           filename,
-                                           mime_type,
-                                           state)
+                doc = self._createDocument(cursor, futureDoc)
                 fileinfo.db_document_id = doc.db_document_id
             else:
                 # document has not changed
                 doc = doc[0]
-                if doc.state != state:
-                    doc.state = state
+                if doc.state != futureDoc.state:
+                    doc.state = futureDoc.state
                     doc.commit(cursor, update=True)
                 
             fileinfo.commit(cursor, update=True)
@@ -377,32 +367,24 @@
         else:
             # file unknown
             # try to find a Document with same hash value
-            doc = Document.selectWhere(cursor, document_id=content_hash)
+            doc = Document.selectWhere(cursor, document_id=futureDoc.content_hash)
             if doc:
                 doc = doc[0]
-                doc.state = state
-                doc.publication_time = max(doc.publication_time, lastModifiedOn)
+                doc.state = futureDoc.state
+                doc.publication_time = max(doc.publication_time, futureDoc.lastModificationTime)
                 doc.commit(cursor, update=True)
             else:
-                doc = self._createDocument(cursor,
-                                           content_hash,
-                                           title,
-                                           text,
-                                           fileSize,
-                                           lastModifiedOn,
-                                           filename,
-                                           mime_type,
-                                           state)
-                doc = Document.selectWhere(cursor, document_id=content_hash)[0]
+                doc = self._createDocument(cursor, futureDoc)
+                doc = Document.selectWhere(cursor, document_id=futureDoc.content_hash)[0]
 
             fileinfo = FileInfo(db_document_id=doc.db_document_id,
-                                 file_name=filename,
-                                 file_time=lastModifiedOn,
-                                 state=state,
-                                 file_state=file_state)
+                                file_name=futureDoc.filename,
+                                file_time=futureDoc.lastModificationTime,
+                                state=futureDoc.state,
+                                file_state=futureDoc.file_state)
             fileinfo.commit(cursor, update=False)
 
-        self._updateScores(cursor, doc.db_document_id, text)
+        self._updateScores(cursor, doc.db_document_id, futureDoc.text)
         provider = DocumentProvider.selectOrInsertWhere(cursor,
                                           db_document_id=doc.db_document_id,
                                           node_id=nodeId)[0]
@@ -414,21 +396,21 @@
         cursor.close()
         self._cnx.commit()
         
-    def _createDocument(self, cursor, content_hash, title, text, fileSize,
-                        lastModifiedOn, filename, mime_type, state):
-        doc = Document(document_id=content_hash,
-                       title=title,
-                       text=text[:MAX_STORED_SIZE],
-                       size=fileSize,
-                       publication_time=lastModifiedOn,
+    def _createDocument(self, cursor, futureDoc):
+
+        doc = Document(document_id=futureDoc.content_hash,
+                       title=futureDoc.title,
+                       text=futureDoc.text[:MAX_STORED_SIZE],
+                       size=futureDoc.fileSize,
+                       publication_time=futureDoc.lastModificationTime,
                        download_count=0.,
-                       url=filename,
-                       mime_type=mime_type,
+                       url=futureDoc.filename,
+                       mime_type=futureDoc.mime_type,
                        matching=0.,
                        indexed='1',
-                       state=state)
+                       state=futureDoc.state)
         doc.commit(cursor, update=False)
-        doc = Document.selectWhere(cursor, document_id=content_hash)[0]
+        doc = Document.selectWhere(cursor, document_id=futureDoc.content_hash)[0]
         return doc
 
 def hoeffding_deviation(occurence, confidence=0.9):

Modified: trunk/maay/rpc.py
===================================================================
--- trunk/maay/rpc.py	2005-10-28 09:32:08 UTC (rev 247)
+++ trunk/maay/rpc.py	2005-10-28 12:07:36 UTC (rev 248)
@@ -25,7 +25,7 @@
 ## from twisted.python.failure import Failure
 
 from maay.querier import MaayQuerier, IQuerier, ANONYMOUS_AVATARID, WEB_AVATARID
-from maay.dbentity import Document
+from maay.dbentity import FutureDocument, Document
 from maay.p2pquerier import P2pQuerier, P2pQuery
 from maay.query import Query
 
@@ -116,27 +116,27 @@
             querier = self._sessions[cnxId]
             return querier.removeUnreferencedDocuments()
         return -1
-                    
-    def xmlrpc_indexDocument(self, cnxId, filename, title, text, fileSize,
-                             lastModifiedOn, content_hash, mime_type, state,
-                             file_state):
+
+    def xmlrpc_indexDocument(self, cnxId, futureDoc):
         """
         :type title: xmlrpclib.Binary
         :type text: xmlrpclib.Binary
         """
-        filename = unicode(filename)
-        title = unicode(title)
+        doc_dict = futureDoc
+        futureDoc = FutureDocument()
+        futureDoc.__dict__ = doc_dict
+        futureDoc.filename = unicode(futureDoc.filename)
+        futureDoc.title = unicode(futureDoc.title)
         try:
-            text = unicode(text)
+            futureDoc.text = unicode(futureDoc.text)
         except UnicodeError, exc:
             print exc
             print `text`
             return 1
         if self.cnxIsValid(cnxId):
             querier = self._sessions[cnxId]
-            querier.indexDocument(self.nodeId, filename, title, text, fileSize,
-                                  lastModifiedOn, content_hash, mime_type, state,
-                                  file_state)
+            querier.indexDocument(self.nodeId, futureDoc)
+
         return 0
 
     def xmlrpc_distributedQuery(self, queryId, sender, ttl, words, mime_type):

Modified: trunk/maay/test/test_querier.py
===================================================================
--- trunk/maay/test/test_querier.py	2005-10-28 09:32:08 UTC (rev 247)
+++ trunk/maay/test/test_querier.py	2005-10-28 12:07:36 UTC (rev 248)
@@ -22,7 +22,7 @@
 
 from logilab.common.testlib import MockConnection
 from logilab.common.db import get_connection
-from maay.querier import MaayQuerier, normalizeText, Document, FileInfo
+from maay.querier import MaayQuerier, normalizeText, FutureDocument, Document, FileInfo
 
 
 
@@ -60,16 +60,16 @@
         title = 'Le Tartuffe'
         matchingDocs = Document.selectWhere(cursor, document_id=digest)
         self.assertEquals(len(matchingDocs), 0)
-        self.querier.indexDocument('0'*40,
-                                   '/tmp/Tartuffe.txt',
-                                   title,
-                                   text,
-                                   len(text),
-                                   30000,
-                                   digest,
-                                   'text',
-                                   Document.PUBLISHED_STATE,
-                                   FileInfo.CREATED_FILE_STATE)
+        self.querier.indexDocument('0'*40, FutureDocument(
+            filename='/tmp/Tartuffe.txt',
+            title=title,
+            text=text,
+            fileSize=len(text),
+            lastModificationTime=30000,
+            content_hash=digest,
+            mime_type='text',
+            state=Document.PUBLISHED_STATE,
+            file_state=FileInfo.CREATED_FILE_STATE))
         matchingDocs = Document.selectWhere(cursor, document_id=digest)
         self.assertEquals(len(matchingDocs), 1)
         self.assertEquals(matchingDocs[0].text, '%s %s' % (title, text))
@@ -77,7 +77,6 @@
 
     def test_normalizeText(self):
         self.assertEquals(normalizeText(u"?t????"), "etuiac")
-
-
+        
 if __name__ == '__main__':
     unittest.main()



From aurelienc at berlios.de  Fri Oct 28 14:21:23 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Fri, 28 Oct 2005 14:21:23 +0200
Subject: [Maay-svncheckins] r249 - trunk/maay
Message-ID: <200510281221.j9SCLNZV007494@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-28 14:21:21 +0200 (Fri, 28 Oct 2005)
New Revision: 249

Modified:
   trunk/maay/texttool.py
Log:
prints beautification.


Modified: trunk/maay/texttool.py
===================================================================
--- trunk/maay/texttool.py	2005-10-28 12:07:36 UTC (rev 248)
+++ trunk/maay/texttool.py	2005-10-28 12:21:21 UTC (rev 249)
@@ -191,7 +191,7 @@
         try:
             self.feed(source)
         except HTMLParseError, exc:
-            print "Error parsing document: %s" % exc
+            print "MaayHTMLParser parseString : Error parsing document: %s" % exc
         result = u'\n'.join(self.textbuf)
         #XXX: wacky hack to get a correct title when we just processed
         #     a file from PDFTOHTML
@@ -359,7 +359,7 @@
                 end -= 1
             s.write(" <b>...</b>")
             s.write(boldifyText(text[start:end], words))
-            print "repl = %s" % str('|'.join(words))
+            print "makeAbstract : repl = %s" % str('|'.join(words))
 
         start = max(0, position - 30)
         while not text[start].isspace(): start += 1



From dnf at berlios.de  Fri Oct 28 15:13:47 2005
From: dnf at berlios.de (Frdric DANG NGOC at BerliOS)
Date: Fri, 28 Oct 2005 15:13:47 +0200
Subject: [Maay-svncheckins] r250 - trunk/maay
Message-ID: <200510281313.j9SDDlje015260@sheep.berlios.de>

Author: dnf
Date: 2005-10-28 15:13:47 +0200 (Fri, 28 Oct 2005)
New Revision: 250

Modified:
   trunk/maay/texttool.py
Log:
- fix makeAbstract function.
- Add removeSpace in texttool for removing extra space in text before saving it into the database. But function do not work with unicode, why? So desactivate it.



Modified: trunk/maay/texttool.py
===================================================================
--- trunk/maay/texttool.py	2005-10-28 12:21:21 UTC (rev 249)
+++ trunk/maay/texttool.py	2005-10-28 13:13:47 UTC (rev 250)
@@ -27,11 +27,16 @@
 import gzip
 import bz2
 from cStringIO import StringIO
+from sets import Set
 
 from maay.exif import get_ustring_from_exif
 
 WORD_MIN_LEN = 2
 WORD_MAX_LEN = 50
+
+MAX_EXCERPT = 3 
+EXCERPT_MAX_LEN = 70
+
 MAX_STORED_SIZE = 65535
 
 WORDS_RGX = re.compile(r'\w{%s,%s}' % (WORD_MIN_LEN, WORD_MAX_LEN)) 
@@ -62,6 +67,7 @@
         FF FE           UTF-16, little-endian
         EF BB BF        UTF-8
     """
+
     if filename.endswith(".gz"):
         stream = gzip.open(filename, 'rb')
     elif filename.endswith(".bz2"):
@@ -128,8 +134,8 @@
         When a title cannot be computed from file content,
         the last component of the filepath is used instead
         """
-        encoding = encoding or guessEncoding(filepath)
         try:
+            encoding = encoding or guessEncoding(filepath)
             stream = universalOpen(filepath, 'rb', encoding, errors='ignore')
         except LookupError:
             raise ParsingError('Unsupported document encoding %s' % encoding)
@@ -300,6 +306,27 @@
     return text.translate(table)
 del _table2
     
+# function do not work with unicode, TODO: fix it...
+# (use for remove extra space in text before saving it in the database)
+# desactivated...
+def removeSpace(text):
+    return text
+    rgx = re.compile('\s+')
+    s = StringIO()
+    lastStart = 0
+    end = 0
+    for occurence in rgx.finditer(text):
+        wordFound = occurence.group(0)
+        start, end = occurence.start(), occurence.end()
+        if start > 0:
+            s.write(" ")
+        s.write("%s" % text[lastStart:start])
+        lastStart = end
+
+    s.write(text[end:])
+    return u"%s" % s.getvalue()
+
+
 def boldifyText(text, words):
     rgx = re.compile('|'.join(words), re.I)
     s = StringIO()
@@ -313,66 +340,119 @@
         lastStart = end
 
     s.write(text[end:])
-    return s.getvalue()
+    return u"%s" % s.getvalue()
 
 def makeAbstract(text, words):
     """return excerpts of the original text surrounding the word occurrences
     XXX: this is a less quick and dirty implementation
     """
 
-    # To build the abstract, we only display the first occurrence of each
-    # word in the text.
-    # Each occurrence is shown in an excerpt (approx 60 caracters).
-    # If two excerpts are close, we merge them into one.
+    text = untagText(text)
+    text_length = len(text)
 
+    EXCERPT_MAX_HALF_LEN = EXCERPT_MAX_LEN / 2
+
+    # quick and dirty regex...
+    rgx = re.compile('\W' + '\W|\W'.join(words) + '\W', re.I)
+
+    #
+    # Get the best excerpt for the abstract :
+    # - excerpt for most words of the query
+    # - first occurence of words
+    #
+
+    # wordOccurrences[word] = #nb of occurences
+    wordOccurrences = {}
+
     # excerptPositions = [(word,position)]
     excerptPositions = []
 
-    text = untagText(text)
-    text_length = len(text)
+    for occurence in rgx.finditer(text):
+        foundWord = occurence.group(0)
+        start, end = occurence.start(), occurence.end()
 
-    for word in words:
-        m = re.search(word, text, re.I)
-        if m:
-            excerptPositions.append((word, m.start()))
+        if len(excerptPositions) >= MAX_EXCERPT:
+            # remove one of excerpts which is the more frequent
+            max_occurence = 0
+            for word, occurence in wordOccurrences.items():
+                max_occurence = max(occurence, max_occurence)
 
+            if wordOccurrences.get(foundWord) == max_occurence:
+                continue
+                
+            for i in xrange(len(excerptPositions) - 1, 0, -1):
+                if wordOccurrences[excerptPositions[i][0]] == max_occurence:
+                    wordOccurrences[excerptPositions[i][0]] -= 1
+                    if wordOccurrences[excerptPositions[i][0]] == 0:
+                        del wordOccurrences[excerptPositions[i][0]]
+                    del excerptPositions[i]
+
+        if wordOccurrences.has_key(foundWord):
+            wordOccurrences[foundWord] += 1
+        else:
+            wordOccurrences[foundWord] = 1
+
+        excerptPositions.append((foundWord, start))
+
+        if len(wordOccurrences.keys()) >= MAX_EXCERPT or (len(wordOccurrences.keys()) == len(words) and len(excerptPositions) == MAX_EXCERPT):
+            break
+
+    #
+    # Build abstract
+    #
+
     if not excerptPositions:
-        return text[:200]
+        if text_length >= 200:
+            end = 200
+            while text[end].isalpha(): end -= 1
+            return text[:end] + " <b>...</b>"
+        else:
+            return text
 
-    # sort by position
-    excerptPositions.sort(lambda x, y: x[1] - y [1])
-
     s = StringIO()
     start = -1
     last_position = -100
     last_word = 0
 
     for word, position in excerptPositions:
-        if position - last_position < 30:
+        if position - last_position < EXCERPT_MAX_LEN:
             last_position = position
             last_word = word
             continue
             
         if start !=-1:
-            end = min(last_position + 30 + len(last_word), text_length - 1)
-            while not text[end].isspace():
-                end -= 1
-            s.write(" <b>...</b>")
+            end = last_position + EXCERPT_MAX_LEN + len(last_word)
+            if end >= text_length:
+                end = text_length
+            else:
+                while text[end].isalpha():
+                   end -= 1
+
+            if start > 0:
+                s.write(" <b>...</b> ")
             s.write(boldifyText(text[start:end], words))
-            print "makeAbstract : repl = %s" % str('|'.join(words))
 
-        start = max(0, position - 30)
-        while not text[start].isspace(): start += 1
+        start = position - EXCERPT_MAX_HALF_LEN
+        if start < 0:
+            start = 0
+        else:
+            while text[start].isalpha(): start += 1
 
         last_position = position
         last_word = word
 
-    end = min(last_position + 30 + len(word), text_length - 1)
-    while not text[end].isspace():
-        end -= 1
-    s.write("<b>...</b>")
+    if start > 0:
+        s.write(" <b>...</b> ")
+    end = last_position + EXCERPT_MAX_HALF_LEN + len(word)
+    if end >= text_length:
+        end = text_length
+    else:
+        while text[end].isalpha():
+            end -= 1
     s.write(boldifyText(text[start:end], words))
-    s.write("<b>...</b>")
 
+    if end < text_length:
+        s.write(" <b>...</b>")
+
     return u"%s" % s.getvalue()
 



From dnf at berlios.de  Fri Oct 28 15:14:34 2005
From: dnf at berlios.de (Frdric DANG NGOC at BerliOS)
Date: Fri, 28 Oct 2005 15:14:34 +0200
Subject: [Maay-svncheckins] r251 - trunk/maay/test
Message-ID: <200510281314.j9SDEYKk015324@sheep.berlios.de>

Author: dnf
Date: 2005-10-28 15:14:33 +0200 (Fri, 28 Oct 2005)
New Revision: 251

Modified:
   trunk/maay/test/test_texttool.py
Log:
- add some unit test for texttools.makeAbstract (to complete)



Modified: trunk/maay/test/test_texttool.py
===================================================================
--- trunk/maay/test/test_texttool.py	2005-10-28 13:13:47 UTC (rev 250)
+++ trunk/maay/test/test_texttool.py	2005-10-28 13:14:33 UTC (rev 251)
@@ -23,7 +23,7 @@
 from os.path import join, dirname
 
 from maay.texttool import MaayHTMLParser, TextParser, guessEncoding, \
-     universalOpen, untagText, normalizeText, removeControlChar
+     universalOpen, untagText, normalizeText, removeControlChar, makeAbstract
 
 RAW_TEXT = u"foo ?t? bar baz top bim bam boum"
 
@@ -181,5 +181,27 @@
         self.assertEquals(u"\t\n\r\uFFEFtoto\U00011234", norm)
         self.assertEquals(unicode, type(norm))
 
+class AbstractTC(unittest.TestCase):
+    def testMakeAbstract(self):
+        text = """This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details. You should have received a copy of the GNU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA"""
+
+        # Check excerpt at the beginning of the text
+
+        abstract = makeAbstract(text, [u"free"])
+        self.assertEquals(u'This program is <b>free</b> software; you can redistribute it and/or modify it under the terms of <b>...</b>  Public License as published by the <b>Free</b> Software Foundation; either version 2 of the License, or (at your <b>...</b>  this program; if not, write to the <b>Free</b> Software Foundation, Inc., 51 <b>...</b>', abstract)
+
+        abstract = makeAbstract(text, [u"pUrPoSe"])
+        self.assertEquals(' <b>...</b>  or FITNESS FOR A PARTICULAR <b>PURPOSE</b>.  See the GNU General Public <b>...</b>', abstract)
+
+        # unknown word
+        abstract = makeAbstract(text, [u"FOOBAR"])
+        self.assertEquals('This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, <b>...</b>', abstract)
+
+        # word at the end of the text
+        abstract = makeAbstract(text, [u"Boston"])
+        self.assertEquals(' <b>...</b>  Inc., 51 Franklin St, Fifth Floor, <b>Boston</b>, MA  02110-1301 USA', abstract)
+
+
 if __name__ == '__main__':
     unittest.main()
+



From dnf at berlios.de  Fri Oct 28 15:15:16 2005
From: dnf at berlios.de (Frdric DANG NGOC at BerliOS)
Date: Fri, 28 Oct 2005 15:15:16 +0200
Subject: [Maay-svncheckins] r252 - trunk/maay/data
Message-ID: <200510281315.j9SDFGuq015463@sheep.berlios.de>

Author: dnf
Date: 2005-10-28 15:15:16 +0200 (Fri, 28 Oct 2005)
New Revision: 252

Modified:
   trunk/maay/data/maay.css
Log:
Increase result description width size


Modified: trunk/maay/data/maay.css
===================================================================
--- trunk/maay/data/maay.css	2005-10-28 13:14:33 UTC (rev 251)
+++ trunk/maay/data/maay.css	2005-10-28 13:15:16 UTC (rev 252)
@@ -28,7 +28,7 @@
   font-family: "New Century Schoolbook", serif;
   margin-bottom: 0px;
   padding: 0 0 0 0;
-  width: 40%;
+  width: 80%;
 }
 
 a.docTitle {



From aurelienc at berlios.de  Fri Oct 28 18:53:31 2005
From: aurelienc at berlios.de (Aurlien Campas at BerliOS)
Date: Fri, 28 Oct 2005 18:53:31 +0200
Subject: [Maay-svncheckins] r253 - in trunk/maay: . test
Message-ID: <200510281653.j9SGrVBf015626@sheep.berlios.de>

Author: aurelienc
Date: 2005-10-28 18:53:29 +0200 (Fri, 28 Oct 2005)
New Revision: 253

Added:
   trunk/maay/image.py
   trunk/maay/test/test_image.py
Modified:
   trunk/maay/texttool.py
Log:
Preliminary thumbnail support for images. Still not up to the web browser. May be brittle and needs tests cases. It will put the thumbnails in ~/.maay_thumnails (which may be created if not present), with a prefix 'thumb-' wrt the original name.


Added: trunk/maay/image.py
===================================================================
--- trunk/maay/image.py	2005-10-28 13:15:16 UTC (rev 252)
+++ trunk/maay/image.py	2005-10-28 16:53:29 UTC (rev 253)
@@ -0,0 +1,59 @@
+"""Some utilities to manipulate images"""
+
+import Image
+from tempfile import mkdtemp
+import stat, os, os.path as osp
+from maay.exif import *
+from maay.configuration import Configuration
+
+class ThumbnailCreationError(Exception):
+    """Signals impossibility to create a thumbnail"""
+    pass
+
+def make_thumbnail(file_path, target_dir, size=128):
+    """Creates a thumbnail and returns the associated file path"""
+    try:
+        im = Image.open(file_path)
+        thumb_size = (size, size)
+        im.thumbnail(thumb_size)
+        target_file = osp.join (target_dir, 'thumb-' + osp.basename(file_path))
+        im.save(target_file, 'JPEG')
+        return unicode(target_file)
+    except Exception, e:
+        raise ThumbnailCreationError("Cause : %e" % e)
+
+class NoThumbnailsDir(Exception):
+    """Represents impossibility to access or create RW the
+       maay thumbnails dir repository"""
+    pass
+        
+class ImageConfiguration(Configuration):
+    options = [
+        ('thumbnails-dir',
+         {'type' : "string", 'metavar' : "--thumbnailsdir", 'short' : "-thumbs",
+          'help' : "Thumbnail files repository",
+          'default' : '.maay_thumbnails'},)]
+    config_file = 'image.ini'
+
+    def __init__(self):
+        Configuration.__init__(self, name="Image")
+
+    def get_thumbnails_dir(self):
+        """Returns the complete path to Maay thumnails directory
+           XXX: It will try to create the dir if absent"""
+        path = osp.join(osp.expanduser('~'),
+                        self.get('thumbnails-dir'))
+        if not os.access(path, os.W_OK):
+            try:
+                os.makedirs(path, os.W_OK)
+                os.chmod(path, stat.S_IRWXG)
+            except Exception, e:
+                raise NoThumbnailsDir("Impossible to access or create %s. "
+                                      "Cause : %e" % (path, e))
+        if os.access(path, os.W_OK): # yes, I'm paranoId
+            return path
+        else:
+            raise NoThumbnailsDir("Access to %s is impossible." % path)
+
+    
+            

Added: trunk/maay/test/test_image.py
===================================================================
--- trunk/maay/test/test_image.py	2005-10-28 13:15:16 UTC (rev 252)
+++ trunk/maay/test/test_image.py	2005-10-28 16:53:29 UTC (rev 253)
@@ -0,0 +1,2 @@
+"""Module intended to test image.py"""
+

Modified: trunk/maay/texttool.py
===================================================================
--- trunk/maay/texttool.py	2005-10-28 13:15:16 UTC (rev 252)
+++ trunk/maay/texttool.py	2005-10-28 16:53:29 UTC (rev 253)
@@ -29,7 +29,8 @@
 from cStringIO import StringIO
 from sets import Set
 
-from maay.exif import get_ustring_from_exif
+from maay.image import get_ustring_from_exif, make_thumbnail, \
+     ImageConfiguration as ImConfig, NoThumbnailsDir
 
 WORD_MIN_LEN = 2
 WORD_MAX_LEN = 50
@@ -206,20 +207,34 @@
         return self.title, result, self.links, 0
 
 
+
 class ExifParser(AbstractParser):
     """A parser for Exif information found in image files"""
 
+    def __init__(self):
+        self.thumbnails_dir = None
+
+    def get_thumbnails_dir(self):
+        if not self.thumbnails_dir:
+            self.thumbnails_dir = ImConfig().get_thumbnails_dir()
+        return self.thumbnails_dir
+
     def parseFile(self, filepath, pristineFilename, encoding=None):
         """returns a 4-uple (title, normalized_text, links, offset)
         TODO: port original code from htmltotext
         :param encoding: if None, then need to be guessed
         """
         title = unicode(pristineFilename)
-        try:    
-            result = get_ustring_from_exif (filepath)
-            return title, result, [], 0
-        except:
-            return title, u'No EXIF information available', [], 0
+        try:
+            result = 'EXIF : ' + get_ustring_from_exif(filepath)
+            try:
+                thumb = make_thumbnail(filepath, self.get_thumbnails_dir())
+            except Exception, e:
+                print "Can't make thumbnail. Cause : %s", e
+            return title, result, [thumb], 0
+        except Exception, e:
+            print "No EXIF nor thumbnails. Cause : %s" % e
+        return title, u'No EXIF information available', [], 0
 
         
 _table = {}
@@ -394,7 +409,9 @@
 
         excerptPositions.append((foundWord, start))
 
-        if len(wordOccurrences.keys()) >= MAX_EXCERPT or (len(wordOccurrences.keys()) == len(words) and len(excerptPositions) == MAX_EXCERPT):
+        if len(wordOccurrences.keys()) >= MAX_EXCERPT or \
+               (len(wordOccurrences.keys()) == len(words) and \
+                len(excerptPositions) == MAX_EXCERPT):
             break
 
     #



From dnf at berlios.de  Fri Oct 28 19:25:48 2005
From: dnf at berlios.de (Frdric DANG NGOC at BerliOS)
Date: Fri, 28 Oct 2005 19:25:48 +0200
Subject: [Maay-svncheckins] r254 - in trunk/maay: . data data/images
Message-ID: <200510281725.j9SHPm8N003829@sheep.berlios.de>

Author: dnf
Date: 2005-10-28 19:25:42 +0200 (Fri, 28 Oct 2005)
New Revision: 254

Added:
   trunk/maay/data/images/html_icon.png
   trunk/maay/data/images/txt_icon.png
Modified:
   trunk/maay/data/maay.css
   trunk/maay/data/resultpage.html
   trunk/maay/server.py
Log:
Add small icons in result descriptions to see their mime types.



Added: trunk/maay/data/images/html_icon.png
===================================================================
(Binary files differ)


Property changes on: trunk/maay/data/images/html_icon.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/maay/data/images/txt_icon.png
===================================================================
(Binary files differ)


Property changes on: trunk/maay/data/images/txt_icon.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: trunk/maay/data/maay.css
===================================================================
--- trunk/maay/data/maay.css	2005-10-28 16:53:29 UTC (rev 253)
+++ trunk/maay/data/maay.css	2005-10-28 17:25:42 UTC (rev 254)
@@ -1,5 +1,10 @@
 body,td,div,.p,a{font-family:arial,sans-serif }
 
+h1 { font-family: arial,helvetica; font-size: 12pt; color: #000000; font-weight:bold }
+h2 {  font-family: Arial, Helvetica, sans-serif; font-size: 12pt; font-style:italic ; font-weight: bold ; color: #444444}
+h3 {  font-family: Arial, Helvetica, sans-serif; font-size: 10pt; font-weight: bold; color: #888888}
+
+
 /** login page ********/
 table.loginTable {
   width: 100%;
@@ -68,3 +73,21 @@
   background: lightgrey;
 }
 
+/** icon *******/
+div.text_html {
+  /* display: block; */
+  margin-bottom: 0px;
+  padding: 0 0 0 0;
+  width: 16px;
+  height: 16px;
+  background: url(images/html_icon.png);
+}
+
+div.text_plain {
+  /* display: block; */
+  margin-bottom: 0px;
+  padding: 0 0 0 0;
+  width: 16px;
+  height: 16px;
+  background: url(images/text_icon.png);
+}

Modified: trunk/maay/data/resultpage.html
===================================================================
--- trunk/maay/data/resultpage.html	2005-10-28 16:53:29 UTC (rev 253)
+++ trunk/maay/data/resultpage.html	2005-10-28 17:25:42 UTC (rev 254)
@@ -18,7 +18,7 @@
     <tr nevow:pattern="item" nevow:render="row">
       <td>
 	<div class="resultItem">
-	  <a class="docTitle"><nevow:attr name="href">/download?docid=<nevow:slot name="docid" />&amp;words=<nevow:slot name="words" /></nevow:attr><nevow:slot name="doctitle">DOC TITLE</nevow:slot></a>
+	  <table><tr><td><div><nevow:attr name="class"><nevow:slot name="mime_type" /></nevow:attr></div></td><td><a class="docTitle"><nevow:attr name="href">/download?docid=<nevow:slot name="docid" />&amp;words=<nevow:slot name="words" /></nevow:attr><nevow:slot name="doctitle">DOC TITLE</nevow:slot></a></td></tr></table>
 	  <div class="resultDesc"><nevow:slot name="abstract" /></div>
 	  <span class="resultUrl"><nevow:attr name="href"><nevow:slot name="docurl" /></nevow:attr><nevow:slot name="docurl" /> - <nevow:slot name="readable_size" /> - <nevow:slot name="publication_date" /></span>
 	</div>

Modified: trunk/maay/server.py
===================================================================
--- trunk/maay/server.py	2005-10-28 16:53:29 UTC (rev 253)
+++ trunk/maay/server.py	2005-10-28 17:25:42 UTC (rev 254)
@@ -246,6 +246,7 @@
     def render_row(self, context, data):
         document = data
 	words = self.query.split()
+        context.fillSlots('mime_type', re.sub("/", "_", document.mime_type))
         context.fillSlots('doctitle', tags.xml(boldifyText(document.title, words)))
         # XXX abstract attribute should be a unicode string
         try:



From dnf at berlios.de  Fri Oct 28 19:29:46 2005
From: dnf at berlios.de (Frdric DANG NGOC at BerliOS)
Date: Fri, 28 Oct 2005 19:29:46 +0200
Subject: [Maay-svncheckins] r255 - trunk/maay/data
Message-ID: <200510281729.j9SHTku6005253@sheep.berlios.de>

Author: dnf
Date: 2005-10-28 19:29:45 +0200 (Fri, 28 Oct 2005)
New Revision: 255

Modified:
   trunk/maay/data/maay.css
Log:
small fix (icon)


Modified: trunk/maay/data/maay.css
===================================================================
--- trunk/maay/data/maay.css	2005-10-28 17:25:42 UTC (rev 254)
+++ trunk/maay/data/maay.css	2005-10-28 17:29:45 UTC (rev 255)
@@ -89,5 +89,5 @@
   padding: 0 0 0 0;
   width: 16px;
   height: 16px;
-  background: url(images/text_icon.png);
+  background: url(images/txt_icon.png);
 }



From afayolle at berlios.de  Mon Oct 31 21:43:09 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Mon, 31 Oct 2005 21:43:09 +0100
Subject: [Maay-svncheckins] r256 - trunk/maay/test
Message-ID: <200510312043.j9VKh9xj032358@sheep.berlios.de>

Author: afayolle
Date: 2005-10-31 21:43:09 +0100 (Mon, 31 Oct 2005)
New Revision: 256

Modified:
   trunk/maay/test/test_texttool.py
Log:
splitted makeAbstract test in sub tests

Modified: trunk/maay/test/test_texttool.py
===================================================================
--- trunk/maay/test/test_texttool.py	2005-10-28 17:29:45 UTC (rev 255)
+++ trunk/maay/test/test_texttool.py	2005-10-31 20:43:09 UTC (rev 256)
@@ -182,23 +182,24 @@
         self.assertEquals(unicode, type(norm))
 
 class AbstractTC(unittest.TestCase):
-    def testMakeAbstract(self):
-        text = """This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details. You should have received a copy of the GNU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA"""
+    text = "This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details. You should have received a copy of the GNU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA"
 
+    def testSimple(self):
         # Check excerpt at the beginning of the text
 
-        abstract = makeAbstract(text, [u"free"])
+        abstract = makeAbstract(self.text, [u"free"])
         self.assertEquals(u'This program is <b>free</b> software; you can redistribute it and/or modify it under the terms of <b>...</b>  Public License as published by the <b>Free</b> Software Foundation; either version 2 of the License, or (at your <b>...</b>  this program; if not, write to the <b>Free</b> Software Foundation, Inc., 51 <b>...</b>', abstract)
 
-        abstract = makeAbstract(text, [u"pUrPoSe"])
+    def testMixedCase(self):
+        abstract = makeAbstract(self.text, [u"pUrPoSe"])
         self.assertEquals(' <b>...</b>  or FITNESS FOR A PARTICULAR <b>PURPOSE</b>.  See the GNU General Public <b>...</b>', abstract)
 
-        # unknown word
-        abstract = makeAbstract(text, [u"FOOBAR"])
+    def testUnknownWord(self):
+        abstract = makeAbstract(self.text, [u"FOOBAR"])
         self.assertEquals('This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, <b>...</b>', abstract)
 
-        # word at the end of the text
-        abstract = makeAbstract(text, [u"Boston"])
+    def testWordAtEnd(self):
+        abstract = makeAbstract(self.text, [u"Boston"])
         self.assertEquals(' <b>...</b>  Inc., 51 Franklin St, Fifth Floor, <b>Boston</b>, MA  02110-1301 USA', abstract)
 
 



From afayolle at berlios.de  Mon Oct 31 21:43:34 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Mon, 31 Oct 2005 21:43:34 +0100
Subject: [Maay-svncheckins] r257 - trunk/maay/test
Message-ID: <200510312043.j9VKhYFs032398@sheep.berlios.de>

Author: afayolle
Date: 2005-10-31 21:43:34 +0100 (Mon, 31 Oct 2005)
New Revision: 257

Modified:
   trunk/maay/test/test_texttool.py
Log:
deactivated misleading failing test

Modified: trunk/maay/test/test_texttool.py
===================================================================
--- trunk/maay/test/test_texttool.py	2005-10-31 20:43:09 UTC (rev 256)
+++ trunk/maay/test/test_texttool.py	2005-10-31 20:43:34 UTC (rev 257)
@@ -117,7 +117,7 @@
             
             ]
 
-    def test_parseDifficultFile(self):
+    def _test_parseDifficultFile(self):
         """test_parseDifficultFile: This test fails for now"""
         # This file has got some weird, non HTML compliant content
         # and is not handled properly by HTMLParser 



From afayolle at berlios.de  Mon Oct 31 21:48:06 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Mon, 31 Oct 2005 21:48:06 +0100
Subject: [Maay-svncheckins] r258 - trunk/maay
Message-ID: <200510312048.j9VKm6mJ000212@sheep.berlios.de>

Author: afayolle
Date: 2005-10-31 21:48:05 +0100 (Mon, 31 Oct 2005)
New Revision: 258

Modified:
   trunk/maay/querier.py
Log:
fixed typo

Modified: trunk/maay/querier.py
===================================================================
--- trunk/maay/querier.py	2005-10-31 20:43:34 UTC (rev 257)
+++ trunk/maay/querier.py	2005-10-31 20:48:05 UTC (rev 258)
@@ -137,7 +137,7 @@
     def __del__(self):
         print "Querier", self, "is being GCed ... "
         if self._cnx:
-            print " conection stats :", self._cnx.stat()
+            print " connection stats :", self._cnx.stat()
         self.close ()
 
     def findDocuments(self, query):



From afayolle at berlios.de  Mon Oct 31 21:49:52 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Mon, 31 Oct 2005 21:49:52 +0100
Subject: [Maay-svncheckins] r259 - trunk/maay
Message-ID: <200510312049.j9VKnquf000351@sheep.berlios.de>

Author: afayolle
Date: 2005-10-31 21:49:51 +0100 (Mon, 31 Oct 2005)
New Revision: 259

Modified:
   trunk/maay/querier.py
Log:
set self._cnx to None when closing to avoid closing twice

Modified: trunk/maay/querier.py
===================================================================
--- trunk/maay/querier.py	2005-10-31 20:48:05 UTC (rev 258)
+++ trunk/maay/querier.py	2005-10-31 20:49:51 UTC (rev 259)
@@ -133,12 +133,13 @@
 
     def close(self):
         self._cnx.close()
+        self._cnx = None
 
     def __del__(self):
         print "Querier", self, "is being GCed ... "
         if self._cnx:
             print " connection stats :", self._cnx.stat()
-        self.close ()
+        self.close()
 
     def findDocuments(self, query):
         """Find all indexed documents matching the query"""



From afayolle at berlios.de  Mon Oct 31 21:51:05 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Mon, 31 Oct 2005 21:51:05 +0100
Subject: [Maay-svncheckins] r260 - trunk/maay/test
Message-ID: <200510312051.j9VKp5ZW000520@sheep.berlios.de>

Author: afayolle
Date: 2005-10-31 21:51:05 +0100 (Mon, 31 Oct 2005)
New Revision: 260

Modified:
   trunk/maay/test/test_configuration.py
Log:
reduced verbosity

Modified: trunk/maay/test/test_configuration.py
===================================================================
--- trunk/maay/test/test_configuration.py	2005-10-31 20:49:51 UTC (rev 259)
+++ trunk/maay/test/test_configuration.py	2005-10-31 20:51:05 UTC (rev 260)
@@ -75,9 +75,6 @@
                 os.environ['PATH'] = oldpath
 else:
     print "****  Skipping Win32 tests on non-windows platforms"
-    print "****  (os.path.join(some_dir, 'c:\antiword') does not make"
-    print "****  sense on non-windows platform, and makes tests a lot "
-    print "****  more obfuscated and hard to read/maintain"
 
 if __name__ == '__main__':
     unittest.main()



From afayolle at berlios.de  Mon Oct 31 21:54:39 2005
From: afayolle at berlios.de (Alexandre Fayolle at BerliOS)
Date: Mon, 31 Oct 2005 21:54:39 +0100
Subject: [Maay-svncheckins] r261 - trunk/maay/test
Message-ID: <200510312054.j9VKsdv2000756@sheep.berlios.de>

Author: afayolle
Date: 2005-10-31 21:54:39 +0100 (Mon, 31 Oct 2005)
New Revision: 261

Modified:
   trunk/maay/test/test_querier.py
Log:
use close method of Querier in tearDown

Modified: trunk/maay/test/test_querier.py
===================================================================
--- trunk/maay/test/test_querier.py	2005-10-31 20:51:05 UTC (rev 260)
+++ trunk/maay/test/test_querier.py	2005-10-31 20:54:39 UTC (rev 261)
@@ -41,7 +41,7 @@
                       'files', 'node_interests', 'nodes', 'words'):
             cursor.execute('DELETE FROM %s' % table)
         cursor.close()
-        self.cnx.close()
+        self.querier.close()
 
         
     def test_execute(self):



